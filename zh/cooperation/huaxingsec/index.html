<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.142.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>华兴证券：混合云原生架构下的 Kitex 实践 | CloudWeGo</title>
<meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/zh/cooperation/huaxingsec/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="华兴证券：混合云原生架构下的 Kitex 实践"><meta property="og:description" content="2022 年 6 月，CloudWeGo 社区邀请到了来自字节跳动、森马电商和华兴证券的资深开发者，向社区分享 CloudWeGo 的最新企业落地实践。本文为 华兴证券研发工程师 张天 分享内容。
案例介绍 本文将从以下 4 个方面介绍华兴证券基于 Kitex 在多机房 K8s 集群下的实践经验，包括：
针对 Kitex 的可观测性系统搭建经验； 服务压力测试中遇到的问题以及解决方案； Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案； 实践中遇到的其他问题以及解决方案； Kitex 的可观性系统搭建 华兴证券 CloudWeGo-Kitex 使用情况 去年 6 月 1 日，华兴证券相关研发团队成立。Kitex 在 7 月 12 日发布了首个版本，10 天后就引入了 Kitex。
选择 Kitex 的原因是：团队早期成员比较了解 Kitex，为了快速支撑业务迭代和验证，选择最熟悉的框架，不但使用上比较习惯，对性能和功能方面也比较有把握。
后来也支撑了华兴证券 APP 的快速上线，大约 4 个月之后就上线了 APP 的第一个版本。
下图是业务的微服务调用关系图，一共有三十多个微服务，调用链路数超过 70。服务分别部署在两个机房。核心业务比如交易、行情等部署在私有机房。 非核心的业务，比如资讯、股票信息等部署在阿里的金融云，这样能够更好地利用金融云已有的基础设施比如 MySQL、Kafka 等，作为初创团队，能够降低整体的运维压力。 考虑到性能以及安全方面的因素，两个机房之间专门拉了专线。服务之间存在一些跨机房的依赖。跨机房调用会产生很多问题，后文会详细说明。
Tracing 选型 服务数多了之后，我们需要一套链路追踪系统来描绘调用链路每个环节的耗时情况。考虑到 Kitex 原生支持 Opentracing，为减少集成成本，我们调研了符合 Opentracing 规范的产品。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="cooperation"><meta property="article:modified_time" content="2025-03-07T17:25:05+08:00"><meta itemprop=name content="华兴证券：混合云原生架构下的 Kitex 实践"><meta itemprop=description content="2022 年 6 月，CloudWeGo 社区邀请到了来自字节跳动、森马电商和华兴证券的资深开发者，向社区分享 CloudWeGo 的最新企业落地实践。本文为 华兴证券研发工程师 张天 分享内容。
案例介绍 本文将从以下 4 个方面介绍华兴证券基于 Kitex 在多机房 K8s 集群下的实践经验，包括：
针对 Kitex 的可观测性系统搭建经验； 服务压力测试中遇到的问题以及解决方案； Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案； 实践中遇到的其他问题以及解决方案； Kitex 的可观性系统搭建 华兴证券 CloudWeGo-Kitex 使用情况 去年 6 月 1 日，华兴证券相关研发团队成立。Kitex 在 7 月 12 日发布了首个版本，10 天后就引入了 Kitex。
选择 Kitex 的原因是：团队早期成员比较了解 Kitex，为了快速支撑业务迭代和验证，选择最熟悉的框架，不但使用上比较习惯，对性能和功能方面也比较有把握。
后来也支撑了华兴证券 APP 的快速上线，大约 4 个月之后就上线了 APP 的第一个版本。
下图是业务的微服务调用关系图，一共有三十多个微服务，调用链路数超过 70。服务分别部署在两个机房。核心业务比如交易、行情等部署在私有机房。 非核心的业务，比如资讯、股票信息等部署在阿里的金融云，这样能够更好地利用金融云已有的基础设施比如 MySQL、Kafka 等，作为初创团队，能够降低整体的运维压力。 考虑到性能以及安全方面的因素，两个机房之间专门拉了专线。服务之间存在一些跨机房的依赖。跨机房调用会产生很多问题，后文会详细说明。
Tracing 选型 服务数多了之后，我们需要一套链路追踪系统来描绘调用链路每个环节的耗时情况。考虑到 Kitex 原生支持 Opentracing，为减少集成成本，我们调研了符合 Opentracing 规范的产品。"><meta itemprop=dateModified content="2025-03-07T17:25:05+08:00"><meta itemprop=wordCount content="858"><meta name=twitter:card content="summary"><meta name=twitter:title content="华兴证券：混合云原生架构下的 Kitex 实践"><meta name=twitter:description content="2022 年 6 月，CloudWeGo 社区邀请到了来自字节跳动、森马电商和华兴证券的资深开发者，向社区分享 CloudWeGo 的最新企业落地实践。本文为 华兴证券研发工程师 张天 分享内容。
案例介绍 本文将从以下 4 个方面介绍华兴证券基于 Kitex 在多机房 K8s 集群下的实践经验，包括：
针对 Kitex 的可观测性系统搭建经验； 服务压力测试中遇到的问题以及解决方案； Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案； 实践中遇到的其他问题以及解决方案； Kitex 的可观性系统搭建 华兴证券 CloudWeGo-Kitex 使用情况 去年 6 月 1 日，华兴证券相关研发团队成立。Kitex 在 7 月 12 日发布了首个版本，10 天后就引入了 Kitex。
选择 Kitex 的原因是：团队早期成员比较了解 Kitex，为了快速支撑业务迭代和验证，选择最熟悉的框架，不但使用上比较习惯，对性能和功能方面也比较有把握。
后来也支撑了华兴证券 APP 的快速上线，大约 4 个月之后就上线了 APP 的第一个版本。
下图是业务的微服务调用关系图，一共有三十多个微服务，调用链路数超过 70。服务分别部署在两个机房。核心业务比如交易、行情等部署在私有机房。 非核心的业务，比如资讯、股票信息等部署在阿里的金融云，这样能够更好地利用金融云已有的基础设施比如 MySQL、Kafka 等，作为初创团队，能够降低整体的运维压力。 考虑到性能以及安全方面的因素，两个机房之间专门拉了专线。服务之间存在一些跨机房的依赖。跨机房调用会产生很多问题，后文会详细说明。
Tracing 选型 服务数多了之后，我们需要一套链路追踪系统来描绘调用链路每个环节的耗时情况。考虑到 Kitex 原生支持 Opentracing，为减少集成成本，我们调研了符合 Opentracing 规范的产品。"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css as=style><link href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>文档</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/zh/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/zh/docs/volo/>Volo</a>
<a class=dropdown-item href=/zh/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/zh/docs/cwgo/>Cwgo</a>
<a class=dropdown-item href=/zh/docs/eino/>Eino</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/about/><span>关于</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/blog/><span>博客</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>社区</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/community/overview/>概述</a>
<a class=dropdown-item href=/zh/community/meeting_notes/>会议记录</a>
<a class=dropdown-item href=/zh/community/weekly_report/>周报</a>
<a class=dropdown-item href=/zh/community/past_activities/>往期活动</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/zh/cooperation/><span class=active>用户案例</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>[new]企业级解决方案</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://www.volcengine.com/docs/6431/1469323>可观测解决方案</a></div></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>安全</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/security/safety-bulletin/>安全公告</a>
<a class=dropdown-item href=/zh/security/vulnerability-reporting/>漏洞管理</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/cooperation/huaxingsec/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/cooperation/huaxingsec/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhcooperation-li><a href=/zh/cooperation/ title=案例 class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhcooperation><span>用户案例</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zhcooperationhuaxingsec-li><input type=checkbox id=m-zhcooperationhuaxingsec-check checked>
<label for=m-zhcooperationhuaxingsec-check><a href=/zh/cooperation/huaxingsec/ title="华兴证券：混合云原生架构下的 Kitex 实践" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhcooperationhuaxingsec><span class=td-sidebar-nav-active-item>华兴证券</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationsemir-li><input type=checkbox id=m-zhcooperationsemir-check checked>
<label for=m-zhcooperationsemir-check><a href=/zh/cooperation/semir/ title="Kitex 在森马电商场景的落地实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationsemir><span>森马</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationfeishu-li><input type=checkbox id=m-zhcooperationfeishu-check checked>
<label for=m-zhcooperationfeishu-check><a href=/zh/cooperation/feishu/ title="引入 CloudWeGo 后飞书管理后台平台化改造的演进史" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationfeishu><span>飞书</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationtanwan-li><input type=checkbox id=m-zhcooperationtanwan-check checked>
<label for=m-zhcooperationtanwan-check><a href=/zh/cooperation/tanwan/ title="CloudWeGo 在贪玩游戏 SDK 接口上的应用实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationtanwan><span>贪玩游戏</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationshumei-li><input type=checkbox id=m-zhcooperationshumei-check checked>
<label for=m-zhcooperationshumei-check><a href=/zh/cooperation/shumei/ title="Kitex 在数美科技可用性治理的落地实践践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationshumei><span>数美科技</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationinterface_testing-li><input type=checkbox id=m-zhcooperationinterface_testing-check checked>
<label for=m-zhcooperationinterface_testing-check><a href=/zh/cooperation/interface_testing/ title=字节跳动微服务体系下接口测试平台实践 class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationinterface_testing><span>字节跳动-接口测试平台</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationfoundersc-li><input type=checkbox id=m-zhcooperationfoundersc-check checked>
<label for=m-zhcooperationfoundersc-check><a href=/zh/cooperation/foundersc/ title=方正证券-金融科技云原生微服务建设实践 class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationfoundersc><span>方正证券</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationflow-li><input type=checkbox id=m-zhcooperationflow-check checked>
<label for=m-zhcooperationflow-check><a href=/zh/cooperation/flow/ title="Kitex Thrift Streaming 在 Prompt 平台的实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationflow><span>字节跳动-Flow</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhcooperationconstruct-li><input type=checkbox id=m-zhcooperationconstruct-check checked>
<label for=m-zhcooperationconstruct-check><a href=/zh/cooperation/construct/ title="Construct - 从 0 到 1 基于 Kitex + Istio 的微服务系统建设" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhcooperationconstruct><span>Construct</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/zh//cooperation/huaxingsec target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/zh//cooperation/huaxingsec?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?labels=bug&amp;template=DOCS_UPDATE.md&amp;title=%e5%8d%8e%e5%85%b4%e8%af%81%e5%88%b8%ef%bc%9a%e6%b7%b7%e5%90%88%e4%ba%91%e5%8e%9f%e7%94%9f%e6%9e%b6%e6%9e%84%e4%b8%8b%e7%9a%84%20Kitex%20%e5%ae%9e%e8%b7%b5" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/cloudwego/kitex/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#案例介绍>案例介绍</a></li><li><a href=#kitex-的可观性系统搭建>Kitex 的可观性系统搭建</a><ul><li><a href=#华兴证券-cloudwego-kitex-使用情况>华兴证券 CloudWeGo-Kitex 使用情况</a></li><li><a href=#tracing-选型>Tracing 选型</a></li><li><a href=#kitex-接入-tracing>Kitex 接入 Tracing</a></li><li><a href=#tracing-基础库>Tracing 基础库</a></li><li><a href=#对错误的监控>对错误的监控</a></li><li><a href=#监控告警>监控告警</a></li></ul></li><li><a href=#服务压力测试中遇到的问题以及解决方案>服务压力测试中遇到的问题以及解决方案</a><ul><li><a href=#kitex-v008连接超时问题>Kitex v0.0.8：连接超时问题</a></li><li><a href=#kitex-v013连接池问题修复>Kitex v0.1.3：连接池问题修复</a></li></ul></li><li><a href=#kitex-的不同连接类型在-k8s-同集群跨集群调用下的一些问题和解决方案>Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案</a><ul><li><a href=#长连接的问题跨集群调用>长连接的问题：跨集群调用</a></li><li><a href=#连接多路复用的问题滚动升级>连接多路复用的问题：滚动升级</a></li><li><a href=#连接多路复用的滚动升级测试headless-service-模式>连接多路复用的滚动升级测试：Headless Service 模式</a></li><li><a href=#连接多路复用的滚动升级测试service-模式>连接多路复用的滚动升级测试：Service 模式</a></li><li><a href=#连接多路复用的问题下游扩容>连接多路复用的问题：下游扩容</a></li></ul></li><li><a href=#实践中遇到的其他问题以及解决方案>实践中遇到的其他问题以及解决方案</a><ul><li><a href=#rpc-timeout-context-canceled-错误>RPC Timeout Context Canceled 错误</a></li></ul></li><li><a href=#展望>展望</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/cooperation/>用户案例</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudwego.io/zh/cooperation/huaxingsec/>华兴证券</a></li></ol></nav><div class=td-content><h1>华兴证券：混合云原生架构下的 Kitex 实践</h1><header class=article-meta></header><blockquote><p>2022 年 6 月，CloudWeGo 社区邀请到了来自字节跳动、森马电商和华兴证券的资深开发者，向社区分享 CloudWeGo 的最新企业落地实践。本文为 <strong>华兴证券研发工程师 张天</strong> 分享内容。</p></blockquote><h2 id=案例介绍>案例介绍</h2><div align=center><img src=/img/usedby/huaxing.png width=400 alt=huaxingsec></div><br><br><p>本文将从以下 4 个方面介绍华兴证券基于 Kitex 在多机房 K8s 集群下的实践经验，包括：</p><ol><li>针对 Kitex 的可观测性系统搭建经验；</li><li>服务压力测试中遇到的问题以及解决方案；</li><li>Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案；</li><li>实践中遇到的其他问题以及解决方案；</li></ol><h2 id=kitex-的可观性系统搭建>Kitex 的可观性系统搭建</h2><h3 id=华兴证券-cloudwego-kitex-使用情况>华兴证券 CloudWeGo-Kitex 使用情况</h3><p>去年 6 月 1 日，华兴证券相关研发团队成立。Kitex 在 7 月 12 日发布了首个版本，10 天后就引入了 Kitex。</p><p>选择 Kitex 的原因是：团队早期成员比较了解 Kitex，为了快速支撑业务迭代和验证，选择最熟悉的框架，不但使用上比较习惯，对性能和功能方面也比较有把握。</p><p>后来也支撑了华兴证券 APP 的快速上线，大约 4 个月之后就上线了 APP 的第一个版本。</p><p><img src=/img/users/huaxingsec/huaxing1.png alt=huaxing1></p><p>下图是业务的微服务调用关系图，一共有三十多个微服务，调用链路数超过 70。服务分别部署在两个机房。核心业务比如交易、行情等部署在私有机房。
非核心的业务，比如资讯、股票信息等部署在阿里的金融云，这样能够更好地利用金融云已有的基础设施比如 MySQL、Kafka 等，作为初创团队，能够降低整体的运维压力。
考虑到性能以及安全方面的因素，两个机房之间专门拉了专线。服务之间存在一些跨机房的依赖。跨机房调用会产生很多问题，后文会详细说明。</p><p><img src=/img/users/huaxingsec/huaxing2.png alt=huaxing2></p><h3 id=tracing-选型>Tracing 选型</h3><p>服务数多了之后，我们需要一套链路追踪系统来描绘调用链路每个环节的耗时情况。考虑到 Kitex 原生支持 Opentracing，为减少集成成本，我们调研了符合 Opentracing 规范的产品。</p><p>排除掉收费的、客户端不支持 Go 之后，就剩阿里云的链路追踪产品和 Uber 公司出品的 Jaeger，考虑到私有机房也要部署，最终选择了 Jaeger。</p><h3 id=kitex-接入-tracing>Kitex 接入 Tracing</h3><p>选定方案之后，开始对 Kitex 的这个功能进行测试，结果发现当时去年 9 月初的 Kitex 版本并不支持跨服务的 Tracing，原因是调用的时候，没有把 Trace 信息发送给下游，如图所示，
这样上下游是两个孤立的 Trace（OpenTracing 规范里称为 Span），于是就无法通过一个 TraceID 去串起整条链路。当时任务比较急，于是我们没有等 Kitex 官方的实现，决定自研。</p><p><img src=/img/users/huaxingsec/huaxing3.png alt=huaxing3></p><p>为了自研，我们结合 Kitex 的源码，梳理出客户端和服务端的流程。可以看出 Kitex 的上下游都内置了 Tracer 的 Hook。这里我们要解决的问题是，如何把 Span 信息进行跨服务传输？</p><p><img src=/img/users/huaxingsec/huaxing4.png alt=huaxing4></p><p>经调研，实现透传有三种方案。</p><p>第一种是在消息层搞一个 Thrift 协议的拓展，把 Trace 信息塞进去。原因是 Thrift 本身没有 Header 结构，只能进行协议的拓展。好在 Kitex 支持自定义的协议拓展，因此具备可行性，然而开发成本较高，所以没选择这种方案。</p><p>第二种是在 IDL 里增加通用参数，在字段里存 Trace 信息。缺点是业务无关的字段要在 IDL 里，对性能有一定的影响。毕竟需要通过 Kitex 的中间件，通过反射来提取。</p><p>第三种是利用了 Kitex 提供的传输层透传能力，对业务没有侵入性。最后选择了这一种方案。</p><p><img src=/img/users/huaxingsec/huaxing5.png alt=huaxing5></p><p>透传方案定了之后，整体的流程就清晰了。首先客户端会在 metaHandler.write 里通过 CTX 获取当前 Span，提取并写入 spanContext 到 TransInfo 中。</p><p>然后服务端，在 metaHandler.Read 里读取 spanContext 并创建 ChildOf 关系的 Span，中间件结束时 span.finish()，最后为了防止产生孤立 Trace，New 服务端时不使用 Kitex 提供的 Tracing 的 Option。</p><p>这里是因为同一个服务可能分别作为 Kitex 上下游，Tracer 如果共用，需要分别加特殊逻辑，实现上有点复杂。</p><p><img src=/img/users/huaxingsec/huaxing6.png alt=huaxing6></p><h3 id=tracing-基础库>Tracing 基础库</h3><p>为了充分利用 Tracing 的能力，除了 Kitex，我们在基础库中也增加了 Gin、Gorm、Redis、Kafka 等组件的 Tracing。</p><p>下面展示实际的一条链路。功能是通过短信验证码进行登录。先是作为 HTTP 服务的 API 入口，然后调用了一个短信的 RPC 服务，RPC 服务里面通过 Redis 来检查验证码。
通过之后调用用户服务，里面可能进行一些增加用户的 MySQL 操作。最后把用户登录事件发给 Kafka，然后运营平台进行消费，驱动一些营销活动。可以看出最耗时的部分是关于新增用户的一堆 MySQL 操作。</p><p><img src=/img/users/huaxingsec/huaxing7.png alt=huaxing7></p><h3 id=对错误的监控>对错误的监控</h3><p>Tracing 一般只关注调用耗时，然而一条链路中可能出现各种错误：</p><ol><li>Kitex</li></ol><ul><li><p>Kitex RPC 返回的 err（Conn Timeout、Read Timeout 等）；</p></li><li><p>IDL 里自定义的业务 Code（111: 用户不存在）。</p><p>2.HTTP</p></li><li><p>返回的 HTTP 状态码（404、503）；</p></li><li><p>JSON 里的业务 Code（-1: 内部错误）。</p></li></ul><p><img src=/img/users/huaxingsec/huaxing8.png alt=huaxing8></p><p>如何对这类错误进行监控？主要有以下三种方案：</p><ol><li><p>打日志 + 日志监控，然后通过监控组件，这种方案需要解析日志，所以不方便；</p></li><li><p>写个中间件上报到自定义指标收集服务，这种方案优点是足够通用，但是需要新增中间件。同时自定义指标更关注具体的业务指标；</p></li><li><p>利用 Tracing 的 Tag，这种方案通用且集成成本低。</p></li></ol><p>具体实现如下：</p><ul><li>Kitex 的 err、以及 HTTP 的状态码，定义为系统码；</li><li>IDL 里的 Code 以及 HTTP 返回的 JSON 里的 Code，定义成业务码；</li><li>Tracing 基础库里提取相应的值，设置到 span.tag 里；</li><li>Jaeger 的 tag-as-field 配置里加上相应的字段（原始的 Tags，为 es 里的 Nested 对象，无法在 Grafana 里使用 Group By）。</li></ul><h3 id=监控告警>监控告警</h3><p>在增加错误监控的基础上，我们构建了一套监控告警系统体系。</p><p>这里重点看一下刚才的链路追踪相关的内容。首先每个业务容器会把指标发送到 Jaeger 服务里。Jaeger 最终把数据落盘到 es 中。然后我们在 Grafana 上配置了一堆看板以及对应的告警规则。</p><p>触发报警时，最终会发送到我们自研的 alert-webhook 里。</p><p>自研的部分首先进行告警内容的解析，提取服务名等信息，然后根据服务的业务分类，分发到不同的飞书群里，级别高的报警会打加急电话。这里也是用到了飞书的功能。</p><p><img src=/img/users/huaxingsec/huaxing9.png alt=huaxing9></p><p>Grafana 里我们配置了各类型服务调用耗时、错误码一体化看板，描述了一个服务的方方面面的指标。包括日志监控、错误码监控、QPS 和调用耗时、容器事件监控、容器资源监控等。</p><p><img src=/img/users/huaxingsec/huaxing10.png alt=huaxing10></p><p>下图展示了飞书告警卡片。包括 RPC 调用超时、系统码错误、业务码错误。</p><p>这里我们做了两个简单的工作，一个是带上了 TraceID，方便查询链路情况。另一个是把业务码对应的含义也展示出来，研发收到报警之后就不用再去查表了。</p><p><img src=/img/users/huaxingsec/huaxing11.png alt=huaxing11></p><p>本章小结</p><ul><li>完成了 Tracing 接入 Kitex，实现跨服务传递；</li><li>对 Tracing 基础库扩展了其他类型中间件（Gin、Gorm、Redis、Kafka）的支持；</li><li>对 Tracing 基础库增加了系统码、错误码实现对错误的监控；</li><li>配置了全方位的服务指标看板；</li><li>结合 es、Grafana、飞书以及自研告警服务，搭建了针对微服务的监控告警系统。</li></ul><p>这样我们就完成了可观测性体系的搭建。</p><h2 id=服务压力测试中遇到的问题以及解决方案>服务压力测试中遇到的问题以及解决方案</h2><p>完成了监控告警体系之后，我们希望对服务进行压测，来找出性能瓶颈。第二部分介绍一下服务压测中遇到的问题和解决方案。</p><h3 id=kitex-v008连接超时问题>Kitex v0.0.8：连接超时问题</h3><p>首先我们发现，QPS=150 左右，Kitex 出现连接建立超时的错误。当时我们检查了下 CPU、网络、内存等均没有达到限制。先是怀疑连接池大小不太够，于是测了下 10 和 1000，如上图所示，结果在报错数目上没有区别。
另外观察到的一个现象是，压测期间出现接近 5000 的 Time Wait 状态。</p><p><img src=/img/users/huaxingsec/huaxing12.png alt=huaxing12></p><p>5000 的限制，是因为达到了 <code>tcp_max_tw_buckets</code> 的设置的值。超过这个值之后，新的处于 Time Wait 状态的连接会被销毁，这样最大值就保持在 5000 了。
于是我们尝试进行排查，但没有思路，于是去翻看 Kitex 的 Issue，发现有人遇到相同的问题。</p><p><img src=/img/users/huaxingsec/huaxing13.png alt=huaxing13></p><p>原来，v0.0.8 版本的 Kitex，在使用域名的方式来新建 Client 的时候，会导致连接池失效。因为把连接放回连接池时，用的 Key 是解析之后的 IP，而 GET 的时候，用的是解析前的域名，这样根本 Get 不到连接，于是不停创建短连接。
这样的两个后果是：建立连接比较耗时，另一方面请求执行完毕之后都会关闭掉连接，于是导致了大量的 Time Wait。</p><p><img src=/img/users/huaxingsec/huaxing14.png alt=huaxing14></p><p>为了进行验证，我把测试服务改成了 IP 访问，然后比较了 IP 访问和域名访问以及不同连接池大小的情况。可以看出：IP 访问（连接池有效），但是连接池比较小的情况，出现减少的 Timeout。
连接池 100，Timeout 消失。而中间的域名访问的情况下，出现大量 Timeout。</p><p><img src=/img/users/huaxingsec/huaxing15.png alt=huaxing15></p><h3 id=kitex-v013连接池问题修复>Kitex v0.1.3：连接池问题修复</h3><p>看代码得知在 Kitex v0.1.3 修复了这个问题。</p><p><img src=/img/users/huaxingsec/huaxing16.png alt=huaxing16></p><p>于是我们打算升级 Kitex 的版本，因为当时已经上了生产环境，在升级基础组件之前，需要进行验证，看一下不同连接池大小状态下的表现。还是域名模式，QPS 为 150 的情况下，随着连接池大小的增加，Timeout 的情况逐渐变少到消失。</p><p><img src=/img/users/huaxingsec/huaxing17.png alt=huaxing17></p><p>继续进行压测，我们发现 QPS=2000 的时候又出现了报错。结合监控，发现原因是连接建立的时候超过了默认的 50ms。</p><p><img src=/img/users/huaxingsec/huaxing18.png alt=huaxing18></p><p>我们讨论了几种解决方案：</p><ol><li>修改超时配置。然而，交易日的 9:30-9:35 有⼀堆集中交易请求，突发的流量，耗时长了体验不好，可能会影响 APP 收入，我们希望系统性能保持稳定。</li><li>进行连接耗时的优化。然而 Kitex 已经使用了 Epoll 来处理创建连接的事件，作为使用方，进一步优化的难度和成本都太大。</li><li>MaxidleTimeout 参数改成无限大？比如先创建一个足够大的池，然后随着用户请求，池变得越来越大，最终稳定下来。但是每次服务升级之后，这个池就空了，需要慢慢恢复。</li><li>进行连接预热。</li></ol><p><img src=/img/users/huaxingsec/huaxing19.png alt=huaxing19></p><p>其实连接预热就相当于压测结束之后立马趁热再压一次，如图，可以发现 QPS=2000 的情况下，几乎都走了连接池，没有报错。因此，如果服务启动时能够进行连接预热，就可以省下建立连接的时间，使服务的性能保持稳定。</p><p><img src=/img/users/huaxingsec/huaxing20.png alt=huaxing20></p><p>当时 CloudWeGo 团队针对我们公司建了企业用户交流群，于是我们就向群里的 Kitex 研发提了连接预热的需求。其开发之后提供了连接预热个数的选项。我们也进行了测试。按照 QPS=2000 进行测试，</p><ul><li>WARM_UP_CONN_NUM=0：大约 1s 报错；</li><li>WARM_UP_CONN_NUM=100：大约 4s 报错；</li></ul><p><img src=/img/users/huaxingsec/huaxing21.png alt=huaxing21></p><ul><li>WARM_UP_CONN_NUM=1000：大约 4s 报错，但可以看出一开始都无需新建连接；</li><li>WARM_UP_CONN_NUM=2000：无报错。</li></ul><p><img src=/img/users/huaxingsec/huaxing22.png alt=huaxing22></p><p>本章小结如下：</p><ul><li>Kitex v0.0.8：域名模式下存在连接池失效问题，v0.1.3 中修复；</li><li>Kitex v0.1.3：可进一步通过连接预热功能提高系统性能。</li></ul><h2 id=kitex-的不同连接类型在-k8s-同集群跨集群调用下的一些问题和解决方案>Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案</h2><h3 id=长连接的问题跨集群调用>长连接的问题：跨集群调用</h3><p>第三部分我们讨论一下 Kitex 的不同连接类型在 K8s 同集群/跨集群调用下的一些问题和解决方案。</p><p>首先是长连接跨集群调用下的问题。服务在跨集群调用时，其源 IP: 端口为宿主机的，数量有限，而目的 IP: 端口为下游集群的 LB，一般是固定的。</p><p>那么，当长连接池数目比较大（比如数千），且上游较多（各种服务、每个都多副本，加起来可能数十个）的情况下，请求高峰时段可能导致上游宿主机的源端口不够用。同集群内跨机器调用走了 vxlan，因此没有这个问题。</p><p>解决方案有两类：</p><ul><li>硬件方案：机器；</li><li>软件方案：对于下游为 Kitex 服务，改用 Mux 模式（这样少量连接就可以处理大量并发的请求）。下游不是 Kitex 框架，因为 Mux 是私有协议，不支持非 Kitex。此时可考虑增加下游服务的 LB 数量，比如每个 LB 上分配多个端口。</li></ul><p>比较起来，改造成 Mux 模式成本最低。</p><h3 id=连接多路复用的问题滚动升级>连接多路复用的问题：滚动升级</h3><p>但是多路复用模式，在 K8s 场景下，存在一个滚动升级相关的问题。我们先介绍下 Service 模式， K8s 的 Service 模式采用了 IPVS 的 Nat 模式（DR 和隧道模式不支持端口映射），链路为：</p><p>上游容器←→ClusterIP（服务的虚拟 IP）←→下游容器</p><p>然后我们看看滚动升级流程：</p><ol><li>新容器启动。</li><li>新容器 Readiness Check 通过，之后做两件事情：<ul><li>更新 Endpoints 列表：新增新容器，删除旧容器；</li><li>发送 sigTerm 到旧容器的 1 号进程。</li></ul></li><li>由于更新了 Endpoints 列表，Endpoints 列表发生更新事件，立即回调触发规则更新逻辑（syncProxyRules）：<ul><li>添加新容器到 IPVS 的 rs，权重为 1；</li><li>如果此时 IPVS 的旧容器的中 ActiveConn + InactiveConn > 0（即已有连接还在），旧容器的权重会改成 0，但不会删除 rs。</li></ul></li></ol><p>经过步骤 3 之后，已有的连接仍然能够正常工作（因为旧容器 rs 未删），但新建的连接会走到新的容器上（因为旧容器权重 =0）。</p><p>在 Service 模式下，上游通过一个固定的 IP: 端口来访问下游，当下游滚动升级的时候，上游看到的地址并未变化，即无法感知到滚动升级。于是，下游即使有优雅退出，但上游并不知道下游开始优雅退出了。之后可能的情况是：</p><ol><li>下游发现连接繁忙，一直没有主动关闭，导致 K8s 配置的优雅升级时间超时，强制 Kill 进程，连接关闭，上游报错。</li><li>下游发现连接空闲，主动关闭，然而客户端在关闭之前恰好拿到了连接（且认为可用），然后发起请求，实际上由于连接关闭，发起请求失败报错。</li></ol><p>针对此问题，解决方案如下：</p><ol><li>同集群调用：改用 Headless Service 模式（结合 DNSResolver）：通过 DNS 列表的增删来感知下游变动；</li><li>跨集群调用：借鉴 HTTP2 的 GOAWAY 机制。</li></ol><p><img src=/img/users/huaxingsec/huaxing23.png alt=huaxing23></p><p>具体，可采用如下方式：</p><ol><li>收到 sigTerm 的下游直接告诉上游（通过之前建立的 Conn1），同时下游继续处理发来的请求。</li><li>上游收到关闭信息之后：<ul><li>新请求通过新建 Conn2 来发；</li><li>已有的请求仍然通过 Conn1，且处理完了之后，等下游优雅关闭 Conn1。</li></ul></li></ol><p>这种方式的优点是同集群跨集群均可使用，缺点是需要 Kitex 框架支持。在我们找 Kitex 团队讨论之后，他们也提供了排期支持本需求。</p><h3 id=连接多路复用的滚动升级测试headless-service-模式>连接多路复用的滚动升级测试：Headless Service 模式</h3><p>在 Kitex 团队开发期间，我们测下 Kitex 已有版本对 Headless Service 模式下的滚动升级功能。</p><p>测试方案如下：</p><ul><li>Kitex 版本 v0.1.3；</li><li>上下游均为 Mux 模式；</li><li>上游的加了个自定义 DNSResolver，刷新时间为 1s，加日志打印解析结果；</li><li>下游的退出信号处理，收到 sigTerm 之后特意 Sleep 10s（用来排除这个 Case：服务端发现连接空闲关闭了，但客户端在关闭之前恰好拿到连接，接着认为未关闭，实际上已经关闭，而客户端发起了请求，于是导致报错）；</li><li>QPS=100 恒定压上游，然后触发下游滚动升级。</li></ul><p>实测报错如下图：</p><p><img src=/img/users/huaxingsec/huaxing24.png alt=huaxing24></p><p>时序分析如下：</p><ul><li>旧下游收到 sigTerm，开始 Sleep 10s；</li><li>上游解析到旧下游的 IP，向旧下游发起请求；</li><li>DNS 规则更新：旧上游 IP 解析项消失，新下游解析项出现；</li><li>上游请求报错；</li><li>旧下游sleep完成，开始退出逻辑。</li></ul><p>可见报错时旧下游还未执行退出逻辑，排除旧下游主动关闭连接。请求旧下游期间，且此时解析到新容器 IP（移除了旧容器 IP），报错是因为还没到退出逻辑的时候。因此推测，解析条目变化导致了报错。</p><p>根据推测，结合代码（Kitex 客户端部分）分析，可能出现以下并发问题：</p><ul><li>【协程1】客户端从 Mux池里取出 conn1，即将发起请求（所以没有机会再检查 conn1 状态了）；</li><li>【协程2】DNS 更新，移除了 IP，于是 Clean 方法中关闭了 conn1；</li><li>【协程1】客户端用 conn1 发起请求，导致报错 conn closed。</li></ul><p><img src=/img/users/huaxingsec/huaxing25.png alt=huaxing25></p><p>于是我们向 CloudWeGo 提了 Issue，他们很快修复了这个问题。</p><p><img src=/img/users/huaxingsec/huaxing26.png alt=huaxing26></p><h3 id=连接多路复用的滚动升级测试service-模式>连接多路复用的滚动升级测试：Service 模式</h3><p>同样地，在 Service 模式中，测试方案如下：</p><ul><li>Kitex 版本使用 Feature 分支：mux-graceful-shutdown；</li><li>上下游均为 Mux 模式、服务发现使用 Service 模式；</li><li>恒定 QPS=200 压上游，20s 触发下游滚动升级；</li><li>另外写个服务打印期间的 IPVS 的日志；</li><li>下游的退出信号处理，收到 SigTerm 之后特意 sleep 10s（保证 ipvs 规则已更新）。</li></ul><p>测试结果如下：
报错：INFO[0050] &ldquo;{"code":-1,"message":"remote or network error: conn closed"}"。</p><p>时序分析为：</p><ol><li>旧下游收到 sigTerm，开始 sleep 10s。</li><li>IPVS规则变化：<ul><li>新下游 weight=1，ac=0，inac=0；</li><li>旧下游 weight=0，ac=2，inac=0。</li></ul></li><li>旧下游 sleep 完成，进入最长为 15s（WithExitWaitTime）的优雅退出。</li><li>上游请求报错。</li><li>旧下游打印了最后一条日志。</li><li>IPVS 规则变化：<ul><li>新下游 weight=1，ac=2，inac=0 => ac=2 说明上游新建连接到新容器；</li><li>旧下游 weight=0，ac=0，inac=2 => inac=2 表示连接关闭。</li></ul></li><li>IPVS 规则变化：旧下游的规则被移除。</li></ol><p><img src=/img/users/huaxingsec/huaxing27.png alt=huaxing27></p><p>因此我们得出结论，报错发生在优雅退出期间。最后一条日志时刻大于报错时刻，因此，排除 K8s 的问题，确认 Conn Closed 是由 Kitex 导致的。
之后我们和 Kitex 研发团队沟通了分析结果，找到了 Root Cause，是因为假设了新的下游会有一个新的地址（但实际中 Service 模式都是一个地址），导致新请求取到了老请求的连接并进行关闭。对此进行了修复：</p><p><img src=/img/users/huaxingsec/huaxing28.png alt=huaxing28></p><h3 id=连接多路复用的问题下游扩容>连接多路复用的问题：下游扩容</h3><p>如果⽤ Service 模式（上游看到的下游就是体现为⼀个 IP），创建的 TCP 连接会在最开始固定的几个下游 POD 上，之后如果扩容增加 POD，新创建的 POD 就不会路由到了，导致扩容实际上无效。</p><p>解决方案如下：</p><ol><li>同集群调用：可用 Headless Service 模式，由于 DNS 解析能够得到所有 POD，路由没问题。</li><li>跨集群调用：不在同集群内， Headless Service 模式无效，考虑如下方案：</li></ol><ul><li>方案1：修改服务发现机制。
优点：Kitex 无需改动。
缺点：增加依赖项（服务发现组件）。</li><li>方案2：下游先升级，之后上游 Redeploy 一下，让连接分布到下游的各种实例上。
优点：Kitex 无需改动。
缺点：上游可能很多，逐个 Redeploy 非常不优雅。</li><li>方案3：上游定期把 Mux 给过期掉，然后新建连接。
优点：彻底解决。
缺点：需要 Kitex 支持。</li></ul><p>本章小结如下：</p><ul><li>首先，针对长连接模式分析了跨集群时上游源端口数问题，希望通过多路复用模式解决；</li><li>其次，针对多路复用模式 + K8s Headless Service 模式的优雅升级，实测报错，分析定位了原因，Kitex 研发团队及时解决了相应问题；</li><li>再次，针对多路复用模式 + K8s Service 模式下的优雅升级提出了方案，Kitex 团队完成了实现，迭代了一轮，测试通过；</li><li>最后，针对多路复用模式 + K8s Service 模式下的下游副本扩容时路由不到的问题分析了原因，提出了方案，目前方案待实现。</li></ul><h2 id=实践中遇到的其他问题以及解决方案>实践中遇到的其他问题以及解决方案</h2><h3 id=rpc-timeout-context-canceled-错误>RPC Timeout Context Canceled 错误</h3><p>第四部分我们分析下实践中遇到的其他问题以及解决方案。研发同学发现日志出现 <code>contexe canceled</code> 的错误，分析日志发现出现频率低，一天只有几十条，属于偶发报错。</p><p><img src=/img/users/huaxingsec/huaxing29.png alt=huaxing29></p><p>我们推测是用户手机因为某种原因关闭了进行中的连接所导致，对此进行本地验证。三个部分：首先Gin 客户端设置了 500ms 超时限制，去请求 Gin 服务端接口；
其次，Gin 服务端收到请求之后，转而去调用 Kitex 服务；最后，Kitex 服务端 sleep 1s 模拟耗时超时，保证 Gin 客户端在请求过程中关闭连接。</p><p>实测能够稳定地复现。</p><p><img src=/img/users/huaxingsec/huaxing30.png alt=huaxing30></p><p>我们梳理了源码逻辑，客户端关闭连接之后，Gin 读取到 EOF，调用 cancelCtx，被 Kitex 客户端的 rpcTimeoutMW 捕获到，于是返回了 err。</p><p>那么问题就变成，请求未完成时，连接为何会被关闭？我们按照设备的 ID 去分析日志，发现两类情况：一类是报错对应的请求是该设备短期内的最后一条，于是考虑 APP 被手动关闭；
二是报错对应的请求非短期内的最后一条，客户端研发反馈，有些接口例如搜索，上一条请求执行中（未返回），且新的请求来时，会 Close 掉上一次请求的连接。
第二种情况比较确定，关于第一种情况，APP 被关闭时，IOS 和 Android 是否会关闭连接？客户端同学没有给出肯定的答复。</p><p>于是我们考虑实际测试一下，两端分别写一个测试的应用，持续发起请求，但是不释放连接，此时关闭 APP，分析 TCP 包。实测我们在两端上均看到了 4 次挥手的 Fin 包。所以这个问题得到了确认。</p><p><img src=/img/users/huaxingsec/huaxing31.png alt=huaxing31></p><p>那么如何进行修复呢？我们采取在 GIN 的中间件上拦截掉 Done 方法的方式。</p><p><img src=/img/users/huaxingsec/huaxing32.png alt=huaxing32></p><p>上线之后，再没有出现这种情况。</p><p><img src=/img/users/huaxingsec/huaxing33.png alt=huaxing33></p><p>还有一个问题，我们在测试环境发现，跨集群调用的时候，经常出现连接被重置的问题。生产环境搜日志，无此现象。</p><p><img src=/img/users/huaxingsec/huaxing34.png alt=huaxing34></p><p>我们分析了环境差异：</p><ul><li>生产环境是专线直连；</li><li>测试环境，因为专线比较昂贵，机房之前通过公网访问，中间有个 NAT 设备。</li></ul><p>我们找网络同事咨询，得知 NAT 表项的过期时间是 60s。连接过期时，NAT 设备并不会通知上下游。因此，上游调用的时候，如果 NAT 设备发现表项不存在，会认为是一个失效的连接，就返回了 rst。
于是我们的解决方案是 Kitex 上游的 MaxIdleTimeout 改成 30s。实测再未出现报错。</p><p><img src=/img/users/huaxingsec/huaxing35.png alt=huaxing35></p><p>本章小结如下：</p><ul><li>Rpc Timeout：Tontext Tanceled 问题分析和解决；</li><li>Rpc Error：Connection Reset 问题分析和解决。</li></ul><h2 id=展望>展望</h2><p>未来我们计划把 Gin 更换为更高性能（QPS/时延）的 CloudWeGo-Hertz。因为我们 K 线服务的 Response Size 比较大（~202KiB），更换后 QPS 预计可达原先的 5 倍。
同时，为回馈开源社区，我们打算贡献 Tracing 基础库的代码到 Kitex-contrib/Tracer-opentracing。欢迎持续关注 CloudWeGo 项目，加入社区一起交流。</p><p><img src=/img/users/huaxingsec/huaxing36.png alt=huaxing36></p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>反馈</h2><p class=feedback--question>当前页面对你有帮助吗？</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">是</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">否</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">最后修改
March 7, 2025
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/590388601ba4c26232b5ba3dcdef1bb571867ba4>doc: update plugin install guide (#1272) (5903886)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fab fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/main.min.9a8648b987db06195f5768f0d7516e8df7c27669e91e383e25c5d07cd6325605.js integrity="sha256-moZIuYfbBhlfV2jw11FujffCdmnpHjg+JcXQfNYyVgU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>