<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.142.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>高效 Debug | CloudWeGo</title>
<meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/zh/docs/kitex/best-practice/integration-testing/debug_efficiently/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="高效 Debug"><meta property="og:description" content="通过模仿真实错误示例，描述不同现象背后可能是什么样的原因类型，并提供分析原因的方法。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2024-02-18T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-07T17:25:05+08:00"><meta itemprop=name content="高效 Debug"><meta itemprop=description content="通过模仿真实错误示例，描述不同现象背后可能是什么样的原因类型，并提供分析原因的方法。"><meta itemprop=datePublished content="2024-02-18T00:00:00+00:00"><meta itemprop=dateModified content="2025-03-07T17:25:05+08:00"><meta itemprop=wordCount content="1538"><meta name=twitter:card content="summary"><meta name=twitter:title content="高效 Debug"><meta name=twitter:description content="通过模仿真实错误示例，描述不同现象背后可能是什么样的原因类型，并提供分析原因的方法。"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css as=style><link href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu active"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>文档</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/zh/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/zh/docs/volo/>Volo</a>
<a class=dropdown-item href=/zh/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/zh/docs/cwgo/>Cwgo</a>
<a class=dropdown-item href=/zh/docs/eino/>Eino</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/about/><span>关于</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/blog/><span>博客</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>社区</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/community/overview/>概述</a>
<a class=dropdown-item href=/zh/community/meeting_notes/>会议记录</a>
<a class=dropdown-item href=/zh/community/weekly_report/>周报</a>
<a class=dropdown-item href=/zh/community/past_activities/>往期活动</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/cooperation/><span>用户案例</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>[new]企业级解决方案</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://www.volcengine.com/docs/6431/1469323>可观测解决方案</a></div></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>安全</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/security/safety-bulletin/>安全公告</a>
<a class=dropdown-item href=/zh/security/vulnerability-reporting/>漏洞管理</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/best-practice/integration-testing/debug_efficiently/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/best-practice/integration-testing/debug_efficiently/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocs-li><a href=/zh/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhdocs><span>文档</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocskitex-li><input type=checkbox id=m-zhdocskitex-check checked>
<label for=m-zhdocskitex-check><a href=/zh/docs/kitex/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitex><span>Kitex</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexoverview-li><input type=checkbox id=m-zhdocskitexoverview-check checked>
<label for=m-zhdocskitexoverview-check><a href=/zh/docs/kitex/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexoverview><span>概览</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitexgetting-started-li><input type=checkbox id=m-zhdocskitexgetting-started-check checked>
<label for=m-zhdocskitexgetting-started-check><a href=/zh/docs/kitex/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexgetting-started><span>快速开始</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexgetting-startedpre-knowledge-li><input type=checkbox id=m-zhdocskitexgetting-startedpre-knowledge-check>
<label for=m-zhdocskitexgetting-startedpre-knowledge-check><a href=/zh/docs/kitex/getting-started/pre-knowledge/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexgetting-startedpre-knowledge><span>前置知识</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexgetting-startedprerequisite-li><input type=checkbox id=m-zhdocskitexgetting-startedprerequisite-check>
<label for=m-zhdocskitexgetting-startedprerequisite-check><a href=/zh/docs/kitex/getting-started/prerequisite/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexgetting-startedprerequisite><span>环境准备</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexgetting-startedquick_start-li><input type=checkbox id=m-zhdocskitexgetting-startedquick_start-check>
<label for=m-zhdocskitexgetting-startedquick_start-check><a href=/zh/docs/kitex/getting-started/quick_start/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexgetting-startedquick_start><span>基础示例</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexgetting-startedtutorial-li><input type=checkbox id=m-zhdocskitexgetting-startedtutorial-check>
<label for=m-zhdocskitexgetting-startedtutorial-check><a href=/zh/docs/kitex/getting-started/tutorial/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexgetting-startedtutorial><span>进阶教程</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexgetting-startedexamples-li><input type=checkbox id=m-zhdocskitexgetting-startedexamples-check>
<label for=m-zhdocskitexgetting-startedexamples-check><a href=/zh/docs/kitex/getting-started/examples/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexgetting-startedexamples><span>示例代码</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorials-li><input type=checkbox id=m-zhdocskitextutorials-check checked>
<label for=m-zhdocskitextutorials-check><a href=/zh/docs/kitex/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorials><span>指南</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-feature-li><input type=checkbox id=m-zhdocskitextutorialsbasic-feature-check>
<label for=m-zhdocskitextutorialsbasic-feature-check><a href=/zh/docs/kitex/tutorials/basic-feature/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-feature><span>基本特性</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featuremessage_type-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featuremessage_type-check>
<label for=m-zhdocskitextutorialsbasic-featuremessage_type-check><a href=/zh/docs/kitex/tutorials/basic-feature/message_type/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featuremessage_type><span>消息类型</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-featurestreamx-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamx-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamx-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-featurestreamx><span>StreamX</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurestreamxstreambasicprogramming-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamxstreambasicprogramming-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamxstreambasicprogramming-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/stream+basic+programming/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurestreamxstreambasicprogramming><span>StreamX 基础流编程</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurestreamxstreammiddleware-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamxstreammiddleware-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamxstreammiddleware-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/stream+middleware/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurestreamxstreammiddleware><span>StreamX 流中间件最佳实践</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurestreamxstreammetainfo-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamxstreammetainfo-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamxstreammetainfo-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/stream+metainfo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurestreamxstreammetainfo><span>StreamX 流元消息透传最佳实践</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurestreamxstreamerrorhandling-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamxstreamerrorhandling-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamxstreamerrorhandling-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/stream+error+handling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurestreamxstreamerrorhandling><span>StreamX 流错误处理最佳实践</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurestreamxstreamfaq-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurestreamxstreamfaq-check>
<label for=m-zhdocskitextutorialsbasic-featurestreamxstreamfaq-check><a href=/zh/docs/kitex/tutorials/basic-feature/streamx/stream+faq/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurestreamxstreamfaq><span>StreamX 流编程常见问题 QA</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-featureprotocol-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocol-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocol-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-featureprotocol><span>协议</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocoltransport_protocol-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocoltransport_protocol-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocoltransport_protocol-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/transport_protocol/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocoltransport_protocol><span>传输协议</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-featureprotocolstreaming-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolstreaming-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolstreaming-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/streaming/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-featureprotocolstreaming><span>Streaming</span></a></label><ul class="ul-6 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpc-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpc-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpc-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/streaming/grpc/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpc><span>gRPC</span></a></label><ul class="ul-7 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcthrift_streaming-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcthrift_streaming-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcthrift_streaming-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/streaming/grpc/thrift_streaming/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcthrift_streaming><span>Thrift Streaming over gRPC</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcgraceful_shutdown-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcgraceful_shutdown-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcgraceful_shutdown-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/streaming/grpc/graceful_shutdown/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocolstreaminggrpcgraceful_shutdown><span>gRPC Streaming 优雅退出</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocol-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocol-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocol-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/serialization-protocol/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocol><span>序列化协议</span></a></label><ul class="ul-6 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolbinary-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolbinary-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolbinary-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/serialization-protocol/binary/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolbinary><span>Binary</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolprotobuf-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolprotobuf-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolprotobuf-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/serialization-protocol/protobuf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolprotobuf><span>Protobuf</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolhessian2-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolhessian2-check>
<label for=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolhessian2-check><a href=/zh/docs/kitex/tutorials/basic-feature/protocol/serialization-protocol/hessian2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureprotocolserialization-protocolhessian2><span>Hessian2</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurevisit_directly-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurevisit_directly-check>
<label for=m-zhdocskitextutorialsbasic-featurevisit_directly-check><a href=/zh/docs/kitex/tutorials/basic-feature/visit_directly/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurevisit_directly><span>直连访问</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureconnection_type-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureconnection_type-check>
<label for=m-zhdocskitextutorialsbasic-featureconnection_type-check><a href=/zh/docs/kitex/tutorials/basic-feature/connection_type/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureconnection_type><span>连接类型</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurebizstatuserr-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurebizstatuserr-check>
<label for=m-zhdocskitextutorialsbasic-featurebizstatuserr-check><a href=/zh/docs/kitex/tutorials/basic-feature/bizstatuserr/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurebizstatuserr><span>业务异常</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurewarming_up-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurewarming_up-check>
<label for=m-zhdocskitextutorialsbasic-featurewarming_up-check><a href=/zh/docs/kitex/tutorials/basic-feature/warming_up/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurewarming_up><span>预热</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featurepanic-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featurepanic-check>
<label for=m-zhdocskitextutorialsbasic-featurepanic-check><a href=/zh/docs/kitex/tutorials/basic-feature/panic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featurepanic><span>Panic 处理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsbasic-featureacquire_rpcinfo-li><input type=checkbox id=m-zhdocskitextutorialsbasic-featureacquire_rpcinfo-check>
<label for=m-zhdocskitextutorialsbasic-featureacquire_rpcinfo-check><a href=/zh/docs/kitex/tutorials/basic-feature/acquire_rpcinfo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsbasic-featureacquire_rpcinfo><span>框架 RPC 信息的获取</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsservice-governance-li><input type=checkbox id=m-zhdocskitextutorialsservice-governance-check>
<label for=m-zhdocskitextutorialsservice-governance-check><a href=/zh/docs/kitex/tutorials/service-governance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsservice-governance><span>治理特性</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governanceloadbalance-li><input type=checkbox id=m-zhdocskitextutorialsservice-governanceloadbalance-check>
<label for=m-zhdocskitextutorialsservice-governanceloadbalance-check><a href=/zh/docs/kitex/tutorials/service-governance/loadbalance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governanceloadbalance><span>负载均衡</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governancetimeout-li><input type=checkbox id=m-zhdocskitextutorialsservice-governancetimeout-check>
<label for=m-zhdocskitextutorialsservice-governancetimeout-check><a href=/zh/docs/kitex/tutorials/service-governance/timeout/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governancetimeout><span>超时控制</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governanceretry-li><input type=checkbox id=m-zhdocskitextutorialsservice-governanceretry-check>
<label for=m-zhdocskitextutorialsservice-governanceretry-check><a href=/zh/docs/kitex/tutorials/service-governance/retry/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governanceretry><span>请求重试</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governancecircuitbreaker-li><input type=checkbox id=m-zhdocskitextutorialsservice-governancecircuitbreaker-check>
<label for=m-zhdocskitextutorialsservice-governancecircuitbreaker-check><a href=/zh/docs/kitex/tutorials/service-governance/circuitbreaker/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governancecircuitbreaker><span>熔断</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governancefallback-li><input type=checkbox id=m-zhdocskitextutorialsservice-governancefallback-check>
<label for=m-zhdocskitextutorialsservice-governancefallback-check><a href=/zh/docs/kitex/tutorials/service-governance/fallback/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governancefallback><span>Fallback</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governancelimiting-li><input type=checkbox id=m-zhdocskitextutorialsservice-governancelimiting-check>
<label for=m-zhdocskitextutorialsservice-governancelimiting-check><a href=/zh/docs/kitex/tutorials/service-governance/limiting/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governancelimiting><span>限流</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsservice-governanceaccess_control-li><input type=checkbox id=m-zhdocskitextutorialsservice-governanceaccess_control-check>
<label for=m-zhdocskitextutorialsservice-governanceaccess_control-check><a href=/zh/docs/kitex/tutorials/service-governance/access_control/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsservice-governanceaccess_control><span>自定义访问控制</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsobservability-li><input type=checkbox id=m-zhdocskitextutorialsobservability-check>
<label for=m-zhdocskitextutorialsobservability-check><a href=/zh/docs/kitex/tutorials/observability/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsobservability><span>可观测性</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsobservabilityinstrumentation-li><input type=checkbox id=m-zhdocskitextutorialsobservabilityinstrumentation-check>
<label for=m-zhdocskitextutorialsobservabilityinstrumentation-check><a href=/zh/docs/kitex/tutorials/observability/instrumentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsobservabilityinstrumentation><span>埋点粒度</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsobservabilitytracing-li><input type=checkbox id=m-zhdocskitextutorialsobservabilitytracing-check>
<label for=m-zhdocskitextutorialsobservabilitytracing-check><a href=/zh/docs/kitex/tutorials/observability/tracing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsobservabilitytracing><span>链路跟踪</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsobservabilitylogging-li><input type=checkbox id=m-zhdocskitextutorialsobservabilitylogging-check>
<label for=m-zhdocskitextutorialsobservabilitylogging-check><a href=/zh/docs/kitex/tutorials/observability/logging/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsobservabilitylogging><span>日志</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsadvanced-feature-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-feature-check>
<label for=m-zhdocskitextutorialsadvanced-feature-check><a href=/zh/docs/kitex/tutorials/advanced-feature/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsadvanced-feature><span>高级特性</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featurepayload_validator-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featurepayload_validator-check>
<label for=m-zhdocskitextutorialsadvanced-featurepayload_validator-check><a href=/zh/docs/kitex/tutorials/advanced-feature/payload_validator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featurepayload_validator><span>Payload 校验</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsadvanced-featuregeneric-call-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregeneric-call-check>
<label for=m-zhdocskitextutorialsadvanced-featuregeneric-call-check><a href=/zh/docs/kitex/tutorials/advanced-feature/generic-call/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsadvanced-featuregeneric-call><span>泛化调用</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregeneric-callbasic_usage-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregeneric-callbasic_usage-check>
<label for=m-zhdocskitextutorialsadvanced-featuregeneric-callbasic_usage-check><a href=/zh/docs/kitex/tutorials/advanced-feature/generic-call/basic_usage/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregeneric-callbasic_usage><span>基本使用</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregeneric-callthrift_idl_annotation_standards-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregeneric-callthrift_idl_annotation_standards-check>
<label for=m-zhdocskitextutorialsadvanced-featuregeneric-callthrift_idl_annotation_standards-check><a href=/zh/docs/kitex/tutorials/advanced-feature/generic-call/thrift_idl_annotation_standards/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregeneric-callthrift_idl_annotation_standards><span>Thrift-HTTP 映射的 IDL 规范</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-dynamicgo-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-dynamicgo-check>
<label for=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-dynamicgo-check><a href=/zh/docs/kitex/tutorials/advanced-feature/generic-call/generic-call-dynamicgo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-dynamicgo><span>泛化调用接入 dynamicgo 指南</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-reflection-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-reflection-check>
<label for=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-reflection-check><a href=/zh/docs/kitex/tutorials/advanced-feature/generic-call/generic-call-reflection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregeneric-callgeneric-call-reflection><span>使用 Thrift 反射提升泛化调用性能</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuremetainfo-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuremetainfo-check>
<label for=m-zhdocskitextutorialsadvanced-featuremetainfo-check><a href=/zh/docs/kitex/tutorials/advanced-feature/metainfo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuremetainfo><span>Metainfo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featureinvoker-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featureinvoker-check>
<label for=m-zhdocskitextutorialsadvanced-featureinvoker-check><a href=/zh/docs/kitex/tutorials/advanced-feature/invoker/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featureinvoker><span>Server SDK化</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featureerror_handler-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featureerror_handler-check>
<label for=m-zhdocskitextutorialsadvanced-featureerror_handler-check><a href=/zh/docs/kitex/tutorials/advanced-feature/error_handler/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featureerror_handler><span>定制框架错误处理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featurestart_shutdown_hook-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featurestart_shutdown_hook-check>
<label for=m-zhdocskitextutorialsadvanced-featurestart_shutdown_hook-check><a href=/zh/docs/kitex/tutorials/advanced-feature/start_shutdown_hook/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featurestart_shutdown_hook><span>服务端 启动/退出 前后定制业务逻辑</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregrpcproxy-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregrpcproxy-check>
<label for=m-zhdocskitextutorialsadvanced-featuregrpcproxy-check><a href=/zh/docs/kitex/tutorials/advanced-feature/grpcproxy/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregrpcproxy><span>gRPC Proxy</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featurecodec_frugal-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featurecodec_frugal-check>
<label for=m-zhdocskitextutorialsadvanced-featurecodec_frugal-check><a href=/zh/docs/kitex/tutorials/advanced-feature/codec_frugal/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featurecodec_frugal><span>Frugal</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featurexds-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featurexds-check>
<label for=m-zhdocskitextutorialsadvanced-featurexds-check><a href=/zh/docs/kitex/tutorials/advanced-feature/xds/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featurexds><span>xDS 支持</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featurefieldmask-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featurefieldmask-check>
<label for=m-zhdocskitextutorialsadvanced-featurefieldmask-check><a href=/zh/docs/kitex/tutorials/advanced-feature/fieldmask/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featurefieldmask><span>按需序列化使用指南</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featureprofiler-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featureprofiler-check>
<label for=m-zhdocskitextutorialsadvanced-featureprofiler-check><a href=/zh/docs/kitex/tutorials/advanced-feature/profiler/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featureprofiler><span>请求成本度量</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsadvanced-featuremulti_service-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuremulti_service-check>
<label for=m-zhdocskitextutorialsadvanced-featuremulti_service-check><a href=/zh/docs/kitex/tutorials/advanced-feature/multi_service/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsadvanced-featuremulti_service><span>单 Server 多 Service</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_service-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_service-check>
<label for=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_service-check><a href=/zh/docs/kitex/tutorials/advanced-feature/multi_service/multi_service/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_service><span>单 Server 多 Service</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_handler-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_handler-check>
<label for=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_handler-check><a href=/zh/docs/kitex/tutorials/advanced-feature/multi_service/multi_handler/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuremulti_servicemulti_handler><span>多 Service 多 Handler 生成</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsadvanced-featuregls-li><input type=checkbox id=m-zhdocskitextutorialsadvanced-featuregls-check>
<label for=m-zhdocskitextutorialsadvanced-featuregls-check><a href=/zh/docs/kitex/tutorials/advanced-feature/gls/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsadvanced-featuregls><span>Goroutine-Local-Storage 功能使用</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialscode-gen-li><input type=checkbox id=m-zhdocskitextutorialscode-gen-check>
<label for=m-zhdocskitextutorialscode-gen-check><a href=/zh/docs/kitex/tutorials/code-gen/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialscode-gen><span>代码生成</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genthrift-reflection-li><input type=checkbox id=m-zhdocskitextutorialscode-genthrift-reflection-check>
<label for=m-zhdocskitextutorialscode-genthrift-reflection-check><a href=/zh/docs/kitex/tutorials/code-gen/thrift-reflection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genthrift-reflection><span>Thriftgo 反射使用文档</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-gencode_generation-li><input type=checkbox id=m-zhdocskitextutorialscode-gencode_generation-check>
<label for=m-zhdocskitextutorialscode-gencode_generation-check><a href=/zh/docs/kitex/tutorials/code-gen/code_generation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-gencode_generation><span>代码生成工具</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-gencombine_service-li><input type=checkbox id=m-zhdocskitextutorialscode-gencombine_service-check>
<label for=m-zhdocskitextutorialscode-gencombine_service-check><a href=/zh/docs/kitex/tutorials/code-gen/combine_service/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-gencombine_service><span>Combine Service [已弃用]</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genvalidator-li><input type=checkbox id=m-zhdocskitextutorialscode-genvalidator-check>
<label for=m-zhdocskitextutorialscode-genvalidator-check><a href=/zh/docs/kitex/tutorials/code-gen/validator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genvalidator><span>Thrift Validator</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genfastpb-li><input type=checkbox id=m-zhdocskitextutorialscode-genfastpb-check>
<label for=m-zhdocskitextutorialscode-genfastpb-check><a href=/zh/docs/kitex/tutorials/code-gen/fastpb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genfastpb><span>Fastpb</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-gentemplate_extension-li><input type=checkbox id=m-zhdocskitextutorialscode-gentemplate_extension-check>
<label for=m-zhdocskitextutorialscode-gentemplate_extension-check><a href=/zh/docs/kitex/tutorials/code-gen/template_extension/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-gentemplate_extension><span>扩展 Service 代码生成模板</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genstruct_reference_generator-li><input type=checkbox id=m-zhdocskitextutorialscode-genstruct_reference_generator-check>
<label for=m-zhdocskitextutorialscode-genstruct_reference_generator-check><a href=/zh/docs/kitex/tutorials/code-gen/struct_reference_generator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genstruct_reference_generator><span>生成引用结构体</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-gencustom_tpl-li><input type=checkbox id=m-zhdocskitextutorialscode-gencustom_tpl-check>
<label for=m-zhdocskitextutorialscode-gencustom_tpl-check><a href=/zh/docs/kitex/tutorials/code-gen/custom_tpl/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-gencustom_tpl><span>自定义脚手架模板</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genidl_trimmer-li><input type=checkbox id=m-zhdocskitextutorialscode-genidl_trimmer-check>
<label for=m-zhdocskitextutorialscode-genidl_trimmer-check><a href=/zh/docs/kitex/tutorials/code-gen/idl_trimmer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genidl_trimmer><span>Thriftgo IDL 裁切工具</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genprotoc_validator-li><input type=checkbox id=m-zhdocskitextutorialscode-genprotoc_validator-check>
<label for=m-zhdocskitextutorialscode-genprotoc_validator-check><a href=/zh/docs/kitex/tutorials/code-gen/protoc_validator/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genprotoc_validator><span>Protoc Validator</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-gencustom_struct_tags-li><input type=checkbox id=m-zhdocskitextutorialscode-gencustom_struct_tags-check>
<label for=m-zhdocskitextutorialscode-gencustom_struct_tags-check><a href=/zh/docs/kitex/tutorials/code-gen/custom_struct_tags/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-gencustom_struct_tags><span>自定义结构体 Tags</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialscode-genskip_decoder-li><input type=checkbox id=m-zhdocskitextutorialscode-genskip_decoder-check>
<label for=m-zhdocskitextutorialscode-genskip_decoder-check><a href=/zh/docs/kitex/tutorials/code-gen/skip_decoder/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialscode-genskip_decoder><span>SkipDecoder</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsframework-exten-li><input type=checkbox id=m-zhdocskitextutorialsframework-exten-check>
<label for=m-zhdocskitextutorialsframework-exten-check><a href=/zh/docs/kitex/tutorials/framework-exten/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsframework-exten><span>框架扩展</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenmiddleware-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenmiddleware-check>
<label for=m-zhdocskitextutorialsframework-extenmiddleware-check><a href=/zh/docs/kitex/tutorials/framework-exten/middleware/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenmiddleware><span>Middleware 扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extensuite-li><input type=checkbox id=m-zhdocskitextutorialsframework-extensuite-check>
<label for=m-zhdocskitextutorialsframework-extensuite-check><a href=/zh/docs/kitex/tutorials/framework-exten/suite/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extensuite><span>Suite 扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenregistry-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenregistry-check>
<label for=m-zhdocskitextutorialsframework-extenregistry-check><a href=/zh/docs/kitex/tutorials/framework-exten/registry/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenregistry><span>服务注册扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenservice_discovery-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenservice_discovery-check>
<label for=m-zhdocskitextutorialsframework-extenservice_discovery-check><a href=/zh/docs/kitex/tutorials/framework-exten/service_discovery/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenservice_discovery><span>服务发现扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenloadbalance-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenloadbalance-check>
<label for=m-zhdocskitextutorialsframework-extenloadbalance-check><a href=/zh/docs/kitex/tutorials/framework-exten/loadbalance/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenloadbalance><span>负载均衡扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenmonitoring-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenmonitoring-check>
<label for=m-zhdocskitextutorialsframework-extenmonitoring-check><a href=/zh/docs/kitex/tutorials/framework-exten/monitoring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenmonitoring><span>监控扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extencodec-li><input type=checkbox id=m-zhdocskitextutorialsframework-extencodec-check>
<label for=m-zhdocskitextutorialsframework-extencodec-check><a href=/zh/docs/kitex/tutorials/framework-exten/codec/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extencodec><span>编解码 (协议) 扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extentransport-li><input type=checkbox id=m-zhdocskitextutorialsframework-extentransport-check>
<label for=m-zhdocskitextutorialsframework-extentransport-check><a href=/zh/docs/kitex/tutorials/framework-exten/transport/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extentransport><span>传输模块扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extentrans_pipeline-li><input type=checkbox id=m-zhdocskitextutorialsframework-extentrans_pipeline-check>
<label for=m-zhdocskitextutorialsframework-extentrans_pipeline-check><a href=/zh/docs/kitex/tutorials/framework-exten/trans_pipeline/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extentrans_pipeline><span>Transport Pipeline-Bound 扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extentransmeta-li><input type=checkbox id=m-zhdocskitextutorialsframework-extentransmeta-check>
<label for=m-zhdocskitextutorialsframework-extentransmeta-check><a href=/zh/docs/kitex/tutorials/framework-exten/transmeta/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extentransmeta><span>元信息传递扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extendiagnosis-li><input type=checkbox id=m-zhdocskitextutorialsframework-extendiagnosis-check>
<label for=m-zhdocskitextutorialsframework-extendiagnosis-check><a href=/zh/docs/kitex/tutorials/framework-exten/diagnosis/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extendiagnosis><span>诊断模块扩展</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsframework-extenimplemented_extension-li><input type=checkbox id=m-zhdocskitextutorialsframework-extenimplemented_extension-check>
<label for=m-zhdocskitextutorialsframework-extenimplemented_extension-check><a href=/zh/docs/kitex/tutorials/framework-exten/implemented_extension/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsframework-extenimplemented_extension><span>已实现的扩展</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsoptions-li><input type=checkbox id=m-zhdocskitextutorialsoptions-check>
<label for=m-zhdocskitextutorialsoptions-check><a href=/zh/docs/kitex/tutorials/options/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsoptions><span>Option</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsoptionsclient_options-li><input type=checkbox id=m-zhdocskitextutorialsoptionsclient_options-check>
<label for=m-zhdocskitextutorialsoptionsclient_options-check><a href=/zh/docs/kitex/tutorials/options/client_options/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsoptionsclient_options><span>Client Option</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsoptionsserver_options-li><input type=checkbox id=m-zhdocskitextutorialsoptionsserver_options-check>
<label for=m-zhdocskitextutorialsoptionsserver_options-check><a href=/zh/docs/kitex/tutorials/options/server_options/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsoptionsserver_options><span>Server Option</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsoptionscall_options-li><input type=checkbox id=m-zhdocskitextutorialsoptionscall_options-check>
<label for=m-zhdocskitextutorialsoptionscall_options-check><a href=/zh/docs/kitex/tutorials/options/call_options/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsoptionscall_options><span>Call Option</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsthird-party-li><input type=checkbox id=m-zhdocskitextutorialsthird-party-check>
<label for=m-zhdocskitextutorialsthird-party-check><a href=/zh/docs/kitex/tutorials/third-party/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsthird-party><span>三方扩展</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsthird-partyservice_discovery-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discovery-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discovery-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsthird-partyservice_discovery><span>服务发现</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryetcd-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryetcd-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryetcd-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/etcd/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryetcd><span>Etcd</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryconsul-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryconsul-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryconsul-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/consul/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryconsul><span>Consul</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryeureka-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryeureka-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryeureka-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/eureka/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryeureka><span>Eureka</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoverynacos-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoverynacos-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoverynacos-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/nacos/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoverynacos><span>Nacos</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoverypolaris-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoverypolaris-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoverypolaris-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/polaris/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoverypolaris><span>Polaris</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryservice-comb-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryservice-comb-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryservice-comb-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/service-comb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryservice-comb><span>ServiceComb</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryzookeeper-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryzookeeper-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryzookeeper-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/zookeeper/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryzookeeper><span>Zookeeper</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoverydns-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoverydns-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoverydns-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/dns/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoverydns><span>DNS</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyservice_discoveryrule-based-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyservice_discoveryrule-based-check>
<label for=m-zhdocskitextutorialsthird-partyservice_discoveryrule-based-check><a href=/zh/docs/kitex/tutorials/third-party/service_discovery/rule-based/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyservice_discoveryrule-based><span>服务过滤</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialsthird-partyconfig-center-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-center-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-center-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialsthird-partyconfig-center><span>配置中心</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centeretcd-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centeretcd-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centeretcd-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/etcd/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centeretcd><span>Etcd</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centerapollo-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centerapollo-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centerapollo-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/apollo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centerapollo><span>Apollo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centernacos-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centernacos-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centernacos-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/nacos/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centernacos><span>Nacos</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centerfile-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centerfile-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centerfile-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centerfile><span>File</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centerzookeeper-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centerzookeeper-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centerzookeeper-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/zookeeper/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centerzookeeper><span>Zookeeper</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyconfig-centerconsul-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyconfig-centerconsul-check>
<label for=m-zhdocskitextutorialsthird-partyconfig-centerconsul-check><a href=/zh/docs/kitex/tutorials/third-party/config-center/consul/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyconfig-centerconsul><span>Consul</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialsthird-partyobservability-li><input type=checkbox id=m-zhdocskitextutorialsthird-partyobservability-check>
<label for=m-zhdocskitextutorialsthird-partyobservability-check><a href=/zh/docs/kitex/tutorials/third-party/observability/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialsthird-partyobservability><span>可观测性</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitextutorialstool-li><input type=checkbox id=m-zhdocskitextutorialstool-check>
<label for=m-zhdocskitextutorialstool-check><a href=/zh/docs/kitex/tutorials/tool/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitextutorialstool><span>工具</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitextutorialstoolkitexcall-li><input type=checkbox id=m-zhdocskitextutorialstoolkitexcall-check>
<label for=m-zhdocskitextutorialstoolkitexcall-check><a href=/zh/docs/kitex/tutorials/tool/kitexcall/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitextutorialstoolkitexcall><span>kitexcall: 发送 JSON 格式 RPC 请求的 CLI 工具</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitexreference-li><input type=checkbox id=m-zhdocskitexreference-check checked>
<label for=m-zhdocskitexreference-check><a href=/zh/docs/kitex/reference/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexreference><span>参考</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexreferencetransport_protocol_ttheader-li><input type=checkbox id=m-zhdocskitexreferencetransport_protocol_ttheader-check>
<label for=m-zhdocskitexreferencetransport_protocol_ttheader-check><a href=/zh/docs/kitex/reference/transport_protocol_ttheader/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexreferencetransport_protocol_ttheader><span>TTHeader</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexreferenceexception-li><input type=checkbox id=m-zhdocskitexreferenceexception-check>
<label for=m-zhdocskitexreferenceexception-check><a href=/zh/docs/kitex/reference/exception/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexreferenceexception><span>异常说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexreferenceversion-li><input type=checkbox id=m-zhdocskitexreferenceversion-check>
<label for=m-zhdocskitexreferenceversion-check><a href=/zh/docs/kitex/reference/version/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexreferenceversion><span>版本说明</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocskitexbest-practice-li><input type=checkbox id=m-zhdocskitexbest-practice-check checked>
<label for=m-zhdocskitexbest-practice-check><a href=/zh/docs/kitex/best-practice/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexbest-practice><span>最佳实践</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceusage_attention-li><input type=checkbox id=m-zhdocskitexbest-practiceusage_attention-check>
<label for=m-zhdocskitexbest-practiceusage_attention-check><a href=/zh/docs/kitex/best-practice/usage_attention/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceusage_attention><span>使用注意事项</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practicegraceful_shutdown-li><input type=checkbox id=m-zhdocskitexbest-practicegraceful_shutdown-check>
<label for=m-zhdocskitexbest-practicegraceful_shutdown-check><a href=/zh/docs/kitex/best-practice/graceful_shutdown/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practicegraceful_shutdown><span>优雅停机</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceerror_handle-li><input type=checkbox id=m-zhdocskitexbest-practiceerror_handle-check>
<label for=m-zhdocskitexbest-practiceerror_handle-check><a href=/zh/docs/kitex/best-practice/error_handle/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceerror_handle><span>错误处理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceremove_apache_codec-li><input type=checkbox id=m-zhdocskitexbest-practiceremove_apache_codec-check>
<label for=m-zhdocskitexbest-practiceremove_apache_codec-check><a href=/zh/docs/kitex/best-practice/remove_apache_codec/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceremove_apache_codec><span>Kitex 去 Apache Thrift 用户手册</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocskitexbest-practiceintegration-testing-li><input type=checkbox id=m-zhdocskitexbest-practiceintegration-testing-check checked>
<label for=m-zhdocskitexbest-practiceintegration-testing-check><a href=/zh/docs/kitex/best-practice/integration-testing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexbest-practiceintegration-testing><span>集成测试</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceintegration-testingmock_client-li><input type=checkbox id=m-zhdocskitexbest-practiceintegration-testingmock_client-check>
<label for=m-zhdocskitexbest-practiceintegration-testingmock_client-check><a href=/zh/docs/kitex/best-practice/integration-testing/mock_client/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceintegration-testingmock_client><span>如何 Mock Client 调用</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zhdocskitexbest-practiceintegration-testingdebug_efficiently-li><input type=checkbox id=m-zhdocskitexbest-practiceintegration-testingdebug_efficiently-check checked>
<label for=m-zhdocskitexbest-practiceintegration-testingdebug_efficiently-check><a href=/zh/docs/kitex/best-practice/integration-testing/debug_efficiently/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceintegration-testingdebug_efficiently><span class=td-sidebar-nav-active-item>高效 Debug</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocskitexbest-practiceself_check-li><input type=checkbox id=m-zhdocskitexbest-practiceself_check-check>
<label for=m-zhdocskitexbest-practiceself_check-check><a href=/zh/docs/kitex/best-practice/self_check/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexbest-practiceself_check><span>自查手册</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceself_checkpanic_self_check-li><input type=checkbox id=m-zhdocskitexbest-practiceself_checkpanic_self_check-check>
<label for=m-zhdocskitexbest-practiceself_checkpanic_self_check-check><a href=/zh/docs/kitex/best-practice/self_check/panic_self_check/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceself_checkpanic_self_check><span>Panic 自查手册</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceself_checkmem_leak_self_check-li><input type=checkbox id=m-zhdocskitexbest-practiceself_checkmem_leak_self_check-check>
<label for=m-zhdocskitexbest-practiceself_checkmem_leak_self_check-check><a href=/zh/docs/kitex/best-practice/self_check/mem_leak_self_check/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceself_checkmem_leak_self_check><span>内存泄漏自查手册</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexbest-practiceself_checkfast_write_read_panic-li><input type=checkbox id=m-zhdocskitexbest-practiceself_checkfast_write_read_panic-check>
<label for=m-zhdocskitexbest-practiceself_checkfast_write_read_panic-check><a href=/zh/docs/kitex/best-practice/self_check/fast_write_read_panic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocskitexbest-practiceself_checkfast_write_read_panic><span>FastWrite/FastRead 报错 Panic</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocskitexfaq-li><input type=checkbox id=m-zhdocskitexfaq-check checked>
<label for=m-zhdocskitexfaq-check><a href=/zh/docs/kitex/faq/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocskitexfaq><span>FAQ</span></a></label></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/zh//docs/kitex/best-practice/integration-testing/debug_efficiently target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/zh//docs/kitex/best-practice/integration-testing/debug_efficiently?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?labels=bug&amp;template=DOCS_UPDATE.md&amp;title=%e9%ab%98%e6%95%88%20Debug" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/cloudwego/kitex/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#排查-panic-原因>排查 Panic 原因</a><ul><li><a href=#通过-stack-排查>通过 Stack 排查</a></li><li><a href=#通过-race-溯源>通过 Race 溯源</a></li></ul></li><li><a href=#排查-crash-问题>排查 Crash 问题</a><ul><li><a href=#获取-coredump-文件>获取 Coredump 文件</a></li><li><a href=#通过-delve-分析>通过 Delve 分析</a></li></ul></li><li><a href=#排查内存泄漏问题>排查内存泄漏问题</a><ul><li><a href=#定位泄漏对象>定位泄漏对象</a></li><li><a href=#追溯泄漏源头>追溯泄漏源头</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/kitex/>Kitex</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/kitex/best-practice/>最佳实践</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/kitex/best-practice/integration-testing/>集成测试</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudwego.io/zh/docs/kitex/best-practice/integration-testing/debug_efficiently/>高效 Debug</a></li></ol></nav><div class=td-content><h1>高效 Debug</h1><div class=lead>通过模仿真实错误示例，描述不同现象背后可能是什么样的原因类型，并提供分析原因的方法。</div><header class=article-meta></header><h2 id=排查-panic-原因>排查 Panic 原因</h2><p>虽然 Panic 问题不全是因为并发导致的，但是非并发导致的 Panic 往往都比较容易通过代码 Review 排查，所以这里只讨论并发引起的 Panic 问题。</p><p>假设我们现在有如下代码，Handle 函数在 ctx 超时结束时，会直接返回 resp。但该函数存在一个潜在的并发问题是，当 Process 函数已经获得 Response 变量时，依然有可能在之后被修改，从而产生了并发问题。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Handle</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Response</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>done</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span>
</span></span><span style=display:flex><span>   <span style=color:#000>resp</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;12345&#34;</span><span style=color:#000;font-weight:700>)}</span> <span style=color:#8f5902;font-style:italic>// default value</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gosched</span><span style=color:#000;font-weight:700>()</span> <span style=color:#8f5902;font-style:italic>// mock network call¬s</span>
</span></span><span style=display:flex><span>      <span style=color:#000>resp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87>close</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span> <span style=color:#8f5902;font-style:italic>// canceled</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>done</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resp</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Process</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>resp</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Handle</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>size</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gosched</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>[:</span><span style=color:#000>size</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=通过-stack-排查>通过 Stack 排查</h3><p>上述代码在遇到并发冲突时的 Stack 如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>slice</span> <span style=color:#000>bounds</span> <span style=color:#000>out</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>with</span> <span style=color:#000>capacity</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>recovered</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>slice</span> <span style=color:#000>bounds</span> <span style=color:#000>out</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>with</span> <span style=color:#000>capacity</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>goroutine</span> <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>running</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#0000cf;font-weight:700>.2</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x113c6c0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc00008c000</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1144</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x332</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000001380</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1147</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x4b6</span>
</span></span><span style=display:flex><span><span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x113c6c0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc00008c000</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>965</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x1b9</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Process</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x1178d68</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc000022480</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>36</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xf8</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TestPanic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000001380</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>44</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x85</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000001380</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x11557f8</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1194</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xef</span>
</span></span><span style=display:flex><span><span style=color:#000>created</span> <span style=color:#000>by</span> <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>T</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Run</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1239</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x2b3</span>
</span></span></code></pre></div><ol><li>找到 panic 原因</li></ol><p>​ 首先我们需要知道导致我们 Panic 的真正原因是什么，可以在完整的 panic stack 最上面一行找到。</p><p>​ 如这里就是 <strong><code>panic: runtime error: slice bounds out of range [:5] with capacity 0 [recovered]</code></strong>。</p><ol start=2><li><p>找到原始 panic 位置</p><p>其次，我们还需要找到真正触发 Panic 的代码在哪里。任何 panic stack 都会包含至少一条 <code>runtime/panic.go</code> 的日志，该日志的下一条便是真正触发 Panic 的代码行。如这里是 <strong><code>example/panic_test.go:36</code></strong>。</p><p>但有些时候，用户的 panic 会被上层 recover 函数所包裹，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>WrapPanic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>recover</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Process</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>此时的 panic 会变成如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>slice</span> <span style=color:#000>bounds</span> <span style=color:#000>out</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>with</span> <span style=color:#000>capacity</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>recovered</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>slice</span> <span style=color:#000>bounds</span> <span style=color:#000>out</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>with</span> <span style=color:#000>capacity</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>recovered</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>        <span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>slice</span> <span style=color:#000>bounds</span> <span style=color:#000>out</span> <span style=color:#000>of</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000>with</span> <span style=color:#000>capacity</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>goroutine</span> <span style=color:#0000cf;font-weight:700>18</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>running</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#0000cf;font-weight:700>.2</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x113c7c0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc00011c000</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1144</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x332</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000082600</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1147</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x4b6</span>
</span></span><span style=display:flex><span><span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x113c7c0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc00011c000</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>965</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x1b9</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WrapPanic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>47</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x55</span>
</span></span><span style=display:flex><span><span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x113c7c0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc00011c000</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>965</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x1b9</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Process</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x1178e68</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc000022480</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>38</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xf8</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WrapPanic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x1178e68</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0xc000022480</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>50</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x57</span>
</span></span><span style=display:flex><span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TestPanic</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000082600</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>57</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x85</span>
</span></span><span style=display:flex><span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0xc000082600</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x1155900</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1194</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xef</span>
</span></span><span style=display:flex><span><span style=color:#000>created</span> <span style=color:#000>by</span> <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>T</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Run</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1239</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x2b3</span>
</span></span></code></pre></div><p>panic stack 的顺序是越往下，越是在函数调用链最外层。我们需要找到最先“调用” panic() 的地方，所以需要找最下面的 runtime/panic.go 段，其下面一行便是真正触发 panic 的代码行位置。</p></li></ol><h3 id=通过-race-溯源>通过 Race 溯源</h3><p>依然以上面的示例代码举例，在代码量很少的情况下，我们能够非常清楚的看到是哪个异步逻辑修改了变量。但在业务代码量非常庞大的情况下，尤其是涉及到第三方库的情况下，我们通过肉眼已经很难判断，此时需要借助工具来帮我们找出罪魁祸首。</p><h4 id=单测排查>单测排查</h4><p>对于示例中这种修改逻辑都在同一个函数内的情况，我们可以简单写一个单元测试便可以发现问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>TestPanic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>T</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancelFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Millisecond</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>cancelFn</span><span style=color:#000;font-weight:700>()</span> <span style=color:#8f5902;font-style:italic>// ctx is done</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Process</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>然后我们通过 go test -race ./panic_test.go 在开启 race 检测下运行测试函数。Go 会输出日志告诉我们哪些 Goroutine 在并发读写哪些变量，并且会告诉我们这些 Goroutine 的创建位置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>WARNING</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>DATA</span> <span style=color:#000>RACE</span>
</span></span><span style=display:flex><span><span style=color:#000>Write</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>0x00c000124030</span> <span style=color:#000>by</span> <span style=color:#000>goroutine</span> <span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handle</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>21</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x44</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Previous</span> <span style=color:#000>read</span> <span style=color:#000>at</span> <span style=color:#0000cf;font-weight:700>0x00c000124030</span> <span style=color:#000>by</span> <span style=color:#000>goroutine</span> <span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Process</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>35</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x5b</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WrapPanic</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>50</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x6c</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TestPanic</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>56</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x9a</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1194</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x202</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Goroutine</span> <span style=color:#0000cf;font-weight:700>8</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>running</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>created</span> <span style=color:#000>at</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handle</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>19</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x116</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Process</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>34</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x46</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WrapPanic</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>50</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x6c</span>
</span></span><span style=display:flex><span>  <span style=color:#000>command</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>line</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>arguments</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TestPanic</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Users</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>bytedance</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>Code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>example</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic_test</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>56</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x9a</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1194</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x202</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>Goroutine</span> <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>finished</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>created</span> <span style=color:#000>at</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>T</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1239</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x5d7</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>runTests</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1512</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xa6</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tRunner</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1194</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x202</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>runTests</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1510</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x612</span>
</span></span><span style=display:flex><span>  <span style=color:#000>testing</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>M</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Run</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>testing</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1418</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x3b3</span>
</span></span><span style=display:flex><span>  <span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#000>_testmain</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>43</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x236</span>
</span></span></code></pre></div><p>通过上述 race 报告，我们可以看出以下信息：</p><ul><li>goroutine 8 在 <strong>panic_test.go:21</strong> 行出现了一次有 race 的写入</li><li>goroutine 7 在 <strong>panic_test.go:35</strong> 行出现了一次有 race 的读取</li><li>goroutine 7 已经结束，但是 goroutine 8 依然还在运行</li></ul><p>根据以上信息，基本上我们已经能够清楚知道问题所在了。</p><h4 id=线上排查>线上排查</h4><p>有些时候我们并不容易对一些业务逻辑写单测，尤其是涉及到多个上下游服务共同配合才能触发的逻辑。此时就需要依赖于线上排查来验证问题所在。</p><p>假如我们有下列代码：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Request</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Id</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Response</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Data</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//go:noinline</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>RPCCall</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>req</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Response</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>resp</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;hello&#34;</span><span style=color:#000;font-weight:700>)}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>req</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Id</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#0000cf;font-weight:700>100</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#8f5902;font-style:italic>// Logic Bug</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>resp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;world&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>resp</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>resp</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>RPCCall</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Id</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>string</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resp</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#4e9a06>&#34;hello&#34;</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;abnormal response!&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>RPCCall 函数用来模拟一个仅会对于特定线上请求参数时，才会出现逻辑 Bug 的 Race 问题。然后我们使用 <code>go build -race</code> 来编译这个程序。</p><p>需要注意的是，这种编译方法会大幅降低程序性能， 我们如果能够有流量重放的环境，可以单独针对该实例去重放线上流量以此来复现问题。如果不能流量重放，也只能在个别实例中开启，并做好因为性能降低可能引发超时的准备。</p><h2 id=排查-crash-问题>排查 Crash 问题</h2><p>在 Go 中，进程的非预期退出一般有以下两种原因引起：</p><ul><li>unrecovered panic: 任何一个 Goroutine 中，出现了一个没有被 recover 的 panic 错误</li><li>unexpected exception: Go Runtime 遇到了一个无法恢复的致命错误，常见的比如并发写 Map 冲突（concurrent map writes），访问非法地址（unexpected fault address）等。</li></ul><p>Go 默认会对所有异常退出都打印对应的 Stack，对于简单的项目，使用前面排查 Panic 问题时的 Stack 定位方法依然可以直观地看出问题所在。但对于复杂的项目，即便我们能够知道导致退出的位置在哪里，但依然无法判断为什么代码会走到该位置。这时，我们便需要引入能够对整个系统当时状态进行细致分析的工具了。</p><p>在 C/C++ 中，一般使用 GDB 进行这类调试，而在 Go 中，我们可以使用专为 Go 运行时特性和数据结构优化的 Delve 工具。</p><h3 id=获取-coredump-文件>获取 Coredump 文件</h3><h4 id=被动获取>被动获取</h4><p>Delve 工具需要我们传入进程退出时，保存的 coredump 文件。我们需要使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 不限制 coredump 的文件大小</span>
</span></span><span style=display:flex><span><span style=color:#204a87>ulimit</span> -c unlimited
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看 coredump 文件目录</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 对于由公司统一控制的机器来说，一般这个目录会被指定到 /opt/tiger/cores 。</span>
</span></span><span style=display:flex><span>cat /proc/sys/kernel/core_pattern
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指示 Go Runtime 处理 coredump</span>
</span></span><span style=display:flex><span><span style=color:#000>GOTRACEBACK</span><span style=color:#ce5c00;font-weight:700>=</span>crash ./<span style=color:#ce5c00;font-weight:700>{</span>bin_exec<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>需要注意的是，Go 对于那些被 recover 的 panic 并不会异常退出，也不会产生 coredump 文件。</p><h4 id=主动获取>主动获取</h4><p>此外，也并不一定只有程序退出时才能产生 coredump ，如果我们判断某个程序已经进入到异常状态（例如卡死），但是又没有异常退出，此时我们可以通过主动发送 core 信号，让其产生 coredump 以保存现场：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制生成 coredump</span>
</span></span><span style=display:flex><span>apt install gdb
</span></span><span style=display:flex><span>gcore -o server.coredump <span style=color:#ce5c00;font-weight:700>{</span>pid<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># gcore 会暂时让程序停止响应，但并不会杀死程序</span>
</span></span></code></pre></div><h3 id=通过-delve-分析>通过 Delve 分析</h3><p>我们通过下面一个会偶发 Crash 的示例代码来展示如何使用 Delve 深入分析问题：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;log&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#4e9a06>&#34;sync&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>_</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span><span style=color:#000;font-weight:700>)(</span><span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>store</span> <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Map</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>Item</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Item-%d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)}</span>
</span></span><span style=display:flex><span>      <span style=color:#000>store</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Store</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>MyError</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Reason</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>e</span> <span style=color:#000>MyError</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;MyError: %s&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Buy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span>
</span></span><span style=display:flex><span>   <span style=color:#000>val</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>store</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAndDelete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>val</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Item</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Buy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buy[%d] get error: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buy item success: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>wg</span> <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitGroup</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>         <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Handling: %d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Wait</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Item</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Name</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>该程序首先在 <code>init</code> 函数中，为 <code>store</code> 变量创建了 1000 个商品 <code>Item</code>，然后在 <code>main</code> 函数中使用 1000 个 Groutine 并发调用 <code>Buy</code> 函数从 <code>store</code> 获取商品。由于购买过程中有可能出现各种异常情况，所以我们封装了 <code>MyError</code> 用来表达购买失败的原因。</p><p>该程序运行时，会出现以下 panic 错误并退出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>runtime</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>invalid</span> <span style=color:#000>memory</span> <span style=color:#000>address</span> <span style=color:#000>or</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000>pointer</span> <span style=color:#000>dereference</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#000>signal</span> <span style=color:#000>SIGSEGV</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>segmentation</span> <span style=color:#000>violation</span> <span style=color:#000>code</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x1</span> <span style=color:#000>addr</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x0</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x491101</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>goroutine</span> <span style=color:#0000cf;font-weight:700>48</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>running</span><span style=color:#000;font-weight:700>]:</span>
</span></span><span style=display:flex><span><span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>({</span><span style=color:#0000cf;font-weight:700>0x49c4e0</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0x53e0b0</span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>941</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x397</span> <span style=color:#000>fp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004ad50</span> <span style=color:#000>sp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004ac90</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x437337</span>
</span></span><span style=display:flex><span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>panicmem</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>220</span>
</span></span><span style=display:flex><span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigpanic</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>826</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x31d</span> <span style=color:#000>fp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004ada0</span> <span style=color:#000>sp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004ad50</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x44be1d</span>
</span></span><span style=display:flex><span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>0x39</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>41</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x121</span> <span style=color:#000>fp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004aef8</span> <span style=color:#000>sp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004ada0</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x491101</span>
</span></span><span style=display:flex><span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>55</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x159</span> <span style=color:#000>fp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004afe0</span> <span style=color:#000>sp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004aef8</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x491619</span>
</span></span><span style=display:flex><span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>goexit</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>asm_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1571</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0x1</span> <span style=color:#000>fp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004afe8</span> <span style=color:#000>sp</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0xc00004afe0</span> <span style=color:#000>pc</span><span style=color:#000;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0x4635e1</span>
</span></span><span style=display:flex><span><span style=color:#000>created</span> <span style=color:#000>by</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>main</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>52</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>0xf1</span>
</span></span></code></pre></div><p>如果你对 Go 的一些常见的编码的坑有一定了解，可能通过阅读这里的代码就能够发现其中蕴藏的几个 Bug，但假设这里的函数都是一些嵌套了几十层复杂代码，甚至牵涉到第三方 SDK 的处理，那么就已经很难通过人肉阅读代码来排查了。</p><h4 id=定位直接原因>定位直接原因</h4><p>通过前面讲的方法，我们首先在本机目录中找到 coredump 文件，然后运行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>dlv core <span style=color:#ce5c00;font-weight:700>{</span>elf_exec<span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#ce5c00;font-weight:700>{</span>coredump_file<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>进入 coredump 文件后，我们先输入 stack 查看发生 crash 时，程序的 stack 停留在哪里：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>stack</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>0</span>  <span style=color:#0000cf;font-weight:700>0x0000000000464f01</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>raise</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>sys_linux_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>170</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0x000000000044bf45</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>dieFromSignal</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>860</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>2</span>  <span style=color:#0000cf;font-weight:700>0x000000000044c516</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigfwdgo</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1074</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>3</span>  <span style=color:#0000cf;font-weight:700>0x000000000044ac2a</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigtrampgo</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>430</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>4</span>  <span style=color:#0000cf;font-weight:700>0x0000000000465cce</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigtrampgo</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>autogenerated</span><span style=color:#000;font-weight:700>&gt;:</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>5</span>  <span style=color:#0000cf;font-weight:700>0x00000000004651dd</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigtramp</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>sys_linux_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>363</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>6</span>  <span style=color:#0000cf;font-weight:700>0x00000000004652e0</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigreturn</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>sys_linux_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>468</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>7</span>  <span style=color:#0000cf;font-weight:700>0x0000000000437b69</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crash</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>952</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>8</span>  <span style=color:#0000cf;font-weight:700>0x0000000000437b69</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fatalpanic</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1092</span>
</span></span><span style=display:flex><span> <span style=color:#0000cf;font-weight:700>9</span>  <span style=color:#0000cf;font-weight:700>0x0000000000437337</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>gopanic</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>941</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>10</span>  <span style=color:#0000cf;font-weight:700>0x000000000044be1d</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>panicmem</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>panic</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>220</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>11</span>  <span style=color:#0000cf;font-weight:700>0x000000000044be1d</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>sigpanic</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>signal_unix</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>826</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>12</span>  <span style=color:#0000cf;font-weight:700>0x0000000000491101</span> <span style=color:#000>in</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>41</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>13</span>  <span style=color:#0000cf;font-weight:700>0x0000000000491619</span> <span style=color:#000>in</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>func1</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>55</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>14</span>  <span style=color:#0000cf;font-weight:700>0x00000000004635e1</span> <span style=color:#000>in</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>goexit</span>
</span></span><span style=display:flex><span>    <span style=color:#000>at</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>asm_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>1571</span>
</span></span></code></pre></div><p>最左边的数字表示了 stack 中每一个 frame 的层级序号，我们可以使用 frame N 命令进入具体的 frame 中，查看更多信息：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>frame</span> <span style=color:#0000cf;font-weight:700>12</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>&gt;</span> <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>raise</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>usr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>local</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>src</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>runtime</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>sys_linux_amd64</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>170</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PC</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>0x464f01</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>Frame</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>41</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PC</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>491101</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>36</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>37</span><span style=color:#000;font-weight:700>:</span>        <span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>38</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Buy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>39</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>40</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>=&gt;</span>  <span style=color:#0000cf;font-weight:700>41</span><span style=color:#000;font-weight:700>:</span>                                <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buy[%d] get error: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>43</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#204a87;font-weight:700>return</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>44</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>45</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buy item success: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>目前为止的所有信息量，只能让我们知道导致 panic 的直接原因是什么，那就是 merr 不知为何在这里成了 nil 。其实这些信息我们单纯分析 crash 时候的 panic 日志都能获得，但它们远不足以让我们弄清楚事故现场究竟发生了什么，所以我们还需要后续步骤进一步分析找到造成问题的根本原因。</p><h4 id=溯源根本原因>溯源根本原因</h4><p>从第 41 行代码中我们可以看到，为了拿到真实的 MyError 对象，我们已经做了很多安全保护，先检查了是否为 nil，再检查了是否可以进行类型转换，但依然还是报了 <code>invalid memory address or nil pointer dereference</code> 的错误。所以，我们首先就需要看下 <code>merr</code> 和 <code>err</code> 变量到底在这里是一个什么：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>print</span> <span style=color:#000>merr</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MyError</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>print</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span><span style=color:#204a87>error</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MyError</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span></code></pre></div><p>可以看到这里 merr 的类型是指针，值为 nil。而 err 的类型是 interface ，它的显示规则为 <code>&lt;interface name>(&lt;concrete type>)&lt;value> </code>，所以我们得知它是一个类型为 <code>*MyError</code> 值为 nil 的对象。</p><p>通过阅读 Go 的源码和文档，我们可以知道在 Go 中，一个有具体类型但是值为 nil 的 interface 对象，并不是等于 nil 的。</p><p>接下来的问题是，在什么情况下，会导致 err 有类型，但是值为 nil 呢？我们可以在代码中搜索所有可能声明 var err *MyError 的地方，找到如下位置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Buy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span>
</span></span><span style=display:flex><span>   <span style=color:#000>val</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>store</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LoadAndDelete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>val</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Item</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>这里的 Buy 函数可以很直观的发现，当在 store 中查找不到 id 对象时，就会返回 item 为 nil ，同时 err 值为 nil 类型不为 nil 的对象。</p><p>但如果阅读代码最开始的 init 函数，我们实现已经创建了 ID 为 [0, 1000) 范围的所有 Item，且 main 函数也是从 [0,1000) 去调用的 Buy 函数，那么为什么会查不到值呢？于是，我们可以进一步往调用链的深处查找所有相关变量：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>frame</span> <span style=color:#0000cf;font-weight:700>13</span>
</span></span><span style=display:flex><span><span style=color:#000>Frame</span> <span style=color:#0000cf;font-weight:700>13</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>55</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PC</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>491619</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>51</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>52</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>53</span><span style=color:#000;font-weight:700>:</span>                                <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>54</span><span style=color:#000;font-weight:700>:</span>                                <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Handling: %d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>=&gt;</span>  <span style=color:#0000cf;font-weight:700>55</span><span style=color:#000;font-weight:700>:</span>                                <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>56</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>57</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>print</span> <span style=color:#000>id</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>58</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>frame</span> <span style=color:#0000cf;font-weight:700>12</span>
</span></span><span style=display:flex><span><span style=color:#000>Frame</span> <span style=color:#0000cf;font-weight:700>12</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>home</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>wangzhuowei</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>code</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>chore</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>main</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>go</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>41</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>PC</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>491101</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>37</span><span style=color:#000;font-weight:700>:</span>        <span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>38</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#000>item</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Buy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>39</span><span style=color:#000;font-weight:700>:</span>                <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>item</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>40</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>MyError</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>=&gt;</span>  <span style=color:#0000cf;font-weight:700>41</span><span style=color:#000;font-weight:700>:</span>                                <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Buy[%d] get error: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>merr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>    <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>:</span>                        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dlv</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>print</span> <span style=color:#000>id</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>57</span>
</span></span></code></pre></div><p>由于这里的 <code>Handler</code> 函数与上层调用函数唯一的联系只有参数 id ，所以我们只需要打印它的值即可。可以看到，在外层 frame 13 中，id 的值为 58，而内层 frame 12 中，它的值为 57，所以我们可以知道，在开始 Handler 调用的时候，id 值为 57 ，而发生 panic 的时候，id 值已经被修改为 58 了。而这是不符合我们预期的，因为这证明了在调用 Handler 函数前，很可能 id 也被修改了，从而使得内层 Buy 函数出现访问到了已经被访问并删除的对象。进而出现上面最终的错误。
当找到这个线索后，我们再根据线索去找会修改 id 值的代码段，便可以清晰地找到真正的问题所在了。即，在 50 行修改了此时正被其他 Goroutine 对象持有的 id 对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>wg</span> <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitGroup</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>id</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>id</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>         <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>         <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Printf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Handling: %d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Handler</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>wg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Wait</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h2 id=排查内存泄漏问题>排查内存泄漏问题</h2><p>在 Go 中，排查内存泄露类型问题只要有两大难点：</p><ol><li>Go 是自带垃圾回收的语言，不需要用户手动管理对象的生命周期，这也变相导致了，代码中任何一段如果可能会长期持有某个变量，或是部分持有（例如切片）某个地址空间，都可能会导致内存泄露。</li><li>Go pprof heap 只能看到由哪个函数创建了内存，并不能看到谁依然在持有内存引用。目前只能靠阅读代码完成。</li></ol><p>假设我们有如下代码，将用户的 SSH RSA key 缩写成 &ldquo;xx&mldr;x&rdquo; 的形式保存在 cache 中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>global</span> <span style=color:#204a87;font-weight:700>string</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>cache</span> <span style=color:#000>sync</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Map</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>SSHData</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>UserId</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>   <span style=color:#000>RSAKey</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>AddSSH</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>SSHData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>// Mask RSAKey to xx...x format</span>
</span></span><span style=display:flex><span>   <span style=color:#000>cache</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Store</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UserId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>],</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]))</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ListenAndServe</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;localhost:6060&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#000>global</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>string</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>make</span><span style=color:#000;font-weight:700>([]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>req</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>SSHData</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>req</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UserId</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>i</span>
</span></span><span style=display:flex><span>      <span style=color:#000>req</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>randBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2048</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>AddSSH</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>req</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Millisecond</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>randBytes</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>size</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>([]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>size</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#000>size</span><span style=color:#000;font-weight:700>;</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>++</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>data</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>i</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;a&#39;</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>i</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>data</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=定位泄漏对象>定位泄漏对象</h3><p>我们首先访问 http://localhost:6060/debug/pprof/heap 对服务进行一次初次采样，并将结果保存为 <code>heap.old</code>。此时，我们可以看到 heap 的图像显示结果。</p><p><img src=/img/docs/debug_efficiently/1.png alt=image></p><p>由于我们服务自身一启动就会创建 100MB 数据，所以这段 heap profiling 事实上并没有太大参考意义。我们需要查看的，是在一段时间内的两次 heap 采样之间，相对来说增加的那部分内存。</p><p>所以我们可以在 1 分钟后，再次访问一样的 URL 进行一次采样，结果保存为 <code>heap.new</code> 。然后执行 <code>go tool pprof -http=:8000 -diff_base=heap.old heap.new</code> ，所得 heap diff 图如下：</p><p><img src=/img/docs/debug_efficiently/2.png alt=image></p><p>由此我们可以看出，新增内存都是由于 <code>randBytes</code> 这个函数所创建的，而根据代码可知，引用了这个函数返回内容的对象是 <code>RSAKey</code>。</p><h3 id=追溯泄漏源头>追溯泄漏源头</h3><p>定位到了泄漏对象，我们就要去追溯代码哪里会持久化引用该对象。由于示例代码很简单，我们可以发现唯一的持久化函数为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>AddSSH</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>SSHData</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>cache</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Store</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UserId</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>[:</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>],</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RSAKey</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]))</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>该函数理论上，对于每一个 UserId，会在 Map 里存储 6 字节的对象。而由于 main 函数每秒会调用 <code>AddSSH</code> 1000 次，即每秒泄漏 6KB 的内存。即便如此，我们就算程序运行一小时，也无非泄漏 6 _ 60 _ 60 = 21600KB = 21MB 的数据，不至于一分钟内就泄漏了 60MB。</p><p>但如果再进一步去细看 <code>append</code> 函数的细节，我们会发现它最终返回的那个切片对象，底层数组的引用，依然还是原始 <code>randBytes</code> 函数所创建的那个，而切片的部分引用，依然会导致原始对象不能够被完全释放。</p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>反馈</h2><p class=feedback--question>当前页面对你有帮助吗？</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">是</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">否</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">最后修改
March 7, 2025
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/590388601ba4c26232b5ba3dcdef1bb571867ba4>doc: update plugin install guide (#1272) (5903886)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fab fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/main.min.9a8648b987db06195f5768f0d7516e8df7c27669e91e383e25c5d07cd6325605.js integrity="sha256-moZIuYfbBhlfV2jw11FujffCdmnpHjg+JcXQfNYyVgU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>