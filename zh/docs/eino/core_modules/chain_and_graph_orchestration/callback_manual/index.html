<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.142.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Eino: Callback 用户手册 | CloudWeGo</title>
<meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="Eino: Callback 用户手册"><meta property="og:description" content="解决的问题 Component（包括 Lambda）、Graph 编排共同解决“把业务逻辑定义出来”的问题。而 logging, tracing, metrics, 上屏展示等横切面性质的功能，需要有机制把功能注入到 Component（包括 Lambda）、Graph 中。
另一方面，用户可能想拿到某个具体 Component 实现的执行过程中的中间信息，比如 VikingDBRetriever 额外给出查询的 DB Name，ArkChatModel 额外给出请求的 temperature 等参数。需要有机制把中间状态透出。
Callbacks 支持“横切面功能注入”和“中间状态透出”，具体是：用户提供、注册“function”（Callback Handler），Component 和 Graph 在固定的“时机”（或者说切面、位点）回调这些 function，给出对应的信息。
核心概念 核心概念串起来，就是：Eino 中的 Component 和 Graph 等实体，在固定的时机 (Callback Timing)，回调用户提供的 function (Callback Handler)，并把自己是谁 (RunInfo)，以及当时发生了什么 (Callback Input & Output) 传出去。
触发实体 Component（包括官方定义的组件类型和 Lambda），Graph Node（以及 Chain Node），Graph 自身（以及 Chain）。这三类实体，都有横切面功能注入、中间状态透出的需求，因此都会触发 callback。具体见下面的“触发方式”一节。
触发时机 // CallbackTiming enumerates all the timing of callback aspects. type CallbackTiming = callbacks.CallbackTiming const ( TimingOnStart CallbackTiming = iota // 进入并开始执行 TimingOnEnd // 成功完成即将 return TimingOnError // 失败并即将 return err TimingOnStartWithStreamInput // OnStart，但是输入是 StreamReader TimingOnEndWithStreamOutput // OnEnd，但是输出是 StreamReader ) 不同的触发实体，在不同场景下，是触发 OnStart 还是 OnStartWithStreamInput (OnEnd/OnEndWithStreamOutput 同理），具体的规则，详见下面的“触发方式”一节。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-02-19T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-07T17:25:05+08:00"><meta itemprop=name content="Eino: Callback 用户手册"><meta itemprop=description content="解决的问题 Component（包括 Lambda）、Graph 编排共同解决“把业务逻辑定义出来”的问题。而 logging, tracing, metrics, 上屏展示等横切面性质的功能，需要有机制把功能注入到 Component（包括 Lambda）、Graph 中。
另一方面，用户可能想拿到某个具体 Component 实现的执行过程中的中间信息，比如 VikingDBRetriever 额外给出查询的 DB Name，ArkChatModel 额外给出请求的 temperature 等参数。需要有机制把中间状态透出。
Callbacks 支持“横切面功能注入”和“中间状态透出”，具体是：用户提供、注册“function”（Callback Handler），Component 和 Graph 在固定的“时机”（或者说切面、位点）回调这些 function，给出对应的信息。
核心概念 核心概念串起来，就是：Eino 中的 Component 和 Graph 等实体，在固定的时机 (Callback Timing)，回调用户提供的 function (Callback Handler)，并把自己是谁 (RunInfo)，以及当时发生了什么 (Callback Input & Output) 传出去。
触发实体 Component（包括官方定义的组件类型和 Lambda），Graph Node（以及 Chain Node），Graph 自身（以及 Chain）。这三类实体，都有横切面功能注入、中间状态透出的需求，因此都会触发 callback。具体见下面的“触发方式”一节。
触发时机 // CallbackTiming enumerates all the timing of callback aspects. type CallbackTiming = callbacks.CallbackTiming const ( TimingOnStart CallbackTiming = iota // 进入并开始执行 TimingOnEnd // 成功完成即将 return TimingOnError // 失败并即将 return err TimingOnStartWithStreamInput // OnStart，但是输入是 StreamReader TimingOnEndWithStreamOutput // OnEnd，但是输出是 StreamReader ) 不同的触发实体，在不同场景下，是触发 OnStart 还是 OnStartWithStreamInput (OnEnd/OnEndWithStreamOutput 同理），具体的规则，详见下面的“触发方式”一节。"><meta itemprop=datePublished content="2025-02-19T00:00:00+00:00"><meta itemprop=dateModified content="2025-03-07T17:25:05+08:00"><meta itemprop=wordCount content="1631"><meta name=twitter:card content="summary"><meta name=twitter:title content="Eino: Callback 用户手册"><meta name=twitter:description content="解决的问题 Component（包括 Lambda）、Graph 编排共同解决“把业务逻辑定义出来”的问题。而 logging, tracing, metrics, 上屏展示等横切面性质的功能，需要有机制把功能注入到 Component（包括 Lambda）、Graph 中。
另一方面，用户可能想拿到某个具体 Component 实现的执行过程中的中间信息，比如 VikingDBRetriever 额外给出查询的 DB Name，ArkChatModel 额外给出请求的 temperature 等参数。需要有机制把中间状态透出。
Callbacks 支持“横切面功能注入”和“中间状态透出”，具体是：用户提供、注册“function”（Callback Handler），Component 和 Graph 在固定的“时机”（或者说切面、位点）回调这些 function，给出对应的信息。
核心概念 核心概念串起来，就是：Eino 中的 Component 和 Graph 等实体，在固定的时机 (Callback Timing)，回调用户提供的 function (Callback Handler)，并把自己是谁 (RunInfo)，以及当时发生了什么 (Callback Input & Output) 传出去。
触发实体 Component（包括官方定义的组件类型和 Lambda），Graph Node（以及 Chain Node），Graph 自身（以及 Chain）。这三类实体，都有横切面功能注入、中间状态透出的需求，因此都会触发 callback。具体见下面的“触发方式”一节。
触发时机 // CallbackTiming enumerates all the timing of callback aspects. type CallbackTiming = callbacks.CallbackTiming const ( TimingOnStart CallbackTiming = iota // 进入并开始执行 TimingOnEnd // 成功完成即将 return TimingOnError // 失败并即将 return err TimingOnStartWithStreamInput // OnStart，但是输入是 StreamReader TimingOnEndWithStreamOutput // OnEnd，但是输出是 StreamReader ) 不同的触发实体，在不同场景下，是触发 OnStart 还是 OnStartWithStreamInput (OnEnd/OnEndWithStreamOutput 同理），具体的规则，详见下面的“触发方式”一节。"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css as=style><link href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/zh/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu active"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>文档</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/zh/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/zh/docs/volo/>Volo</a>
<a class=dropdown-item href=/zh/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/zh/docs/cwgo/>Cwgo</a>
<a class=dropdown-item href=/zh/docs/eino/>Eino</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/about/><span>关于</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/blog/><span>博客</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>社区</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/community/overview/>概述</a>
<a class=dropdown-item href=/zh/community/meeting_notes/>会议记录</a>
<a class=dropdown-item href=/zh/community/weekly_report/>周报</a>
<a class=dropdown-item href=/zh/community/past_activities/>往期活动</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/zh/cooperation/><span>用户案例</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>[new]企业级解决方案</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=https://www.volcengine.com/docs/6431/1469323>可观测解决方案</a></div></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>安全</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/security/safety-bulletin/>安全公告</a>
<a class=dropdown-item href=/zh/security/vulnerability-reporting/>漏洞管理</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>English</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>中文</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>English</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocs-li><a href=/zh/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-zhdocs><span>文档</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocseino-li><input type=checkbox id=m-zhdocseino-check checked>
<label for=m-zhdocseino-check><a href=/zh/docs/eino/ title="Eino 用户手册" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseino><span>Eino</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinooverview-li><input type=checkbox id=m-zhdocseinooverview-check checked>
<label for=m-zhdocseinooverview-check><a href=/zh/docs/eino/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinooverview><span>Eino: 概述</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinooverviewbytedance_eino_practice-li><input type=checkbox id=m-zhdocseinooverviewbytedance_eino_practice-check>
<label for=m-zhdocseinooverviewbytedance_eino_practice-check><a href=/zh/docs/eino/overview/bytedance_eino_practice/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinooverviewbytedance_eino_practice><span>字节跳动大模型应用 Go 开发框架 —— Eino 实践</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoovervieweino_open_source-li><input type=checkbox id=m-zhdocseinoovervieweino_open_source-check>
<label for=m-zhdocseinoovervieweino_open_source-check><a href=/zh/docs/eino/overview/eino_open_source/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoovervieweino_open_source><span>大语言模型应用开发框架 —— Eino 正式开源！</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoquick_start-li><input type=checkbox id=m-zhdocseinoquick_start-check checked>
<label for=m-zhdocseinoquick_start-check><a href=/zh/docs/eino/quick_start/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoquick_start><span>Eino: 快速开始</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoquick_startsimple_llm_application-li><input type=checkbox id=m-zhdocseinoquick_startsimple_llm_application-check>
<label for=m-zhdocseinoquick_startsimple_llm_application-check><a href=/zh/docs/eino/quick_start/simple_llm_application/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoquick_startsimple_llm_application><span>实现一个最简 LLM 应用</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoquick_startagent_llm_with_tools-li><input type=checkbox id=m-zhdocseinoquick_startagent_llm_with_tools-check>
<label for=m-zhdocseinoquick_startagent_llm_with_tools-check><a href=/zh/docs/eino/quick_start/agent_llm_with_tools/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoquick_startagent_llm_with_tools><span>Agent-让大模型拥有双手</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocseinocore_modules-li><input type=checkbox id=m-zhdocseinocore_modules-check checked>
<label for=m-zhdocseinocore_modules-check><a href=/zh/docs/eino/core_modules/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_modules><span>Eino: 核心模块</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinocore_modulescomponents-li><input type=checkbox id=m-zhdocseinocore_modulescomponents-check>
<label for=m-zhdocseinocore_modulescomponents-check><a href=/zh/docs/eino/core_modules/components/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_modulescomponents><span>Eino: Components 组件</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinocore_modulescomponentsdocument_loader_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsdocument_loader_guide-check>
<label for=m-zhdocseinocore_modulescomponentsdocument_loader_guide-check><a href=/zh/docs/eino/core_modules/components/document_loader_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_modulescomponentsdocument_loader_guide><span>Eino: Document Loader 使用说明</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-check>
<label for=m-zhdocseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-check><a href=/zh/docs/eino/core_modules/components/document_loader_guide/document_parser_interface_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide><span>Eino: Document Parser 接口使用说明</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentsembedding_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsembedding_guide-check>
<label for=m-zhdocseinocore_modulescomponentsembedding_guide-check><a href=/zh/docs/eino/core_modules/components/embedding_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentsembedding_guide><span>Eino: Embedding 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentsdocument_transformer_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsdocument_transformer_guide-check>
<label for=m-zhdocseinocore_modulescomponentsdocument_transformer_guide-check><a href=/zh/docs/eino/core_modules/components/document_transformer_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentsdocument_transformer_guide><span>Eino: Document Transformer 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentslambda_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentslambda_guide-check>
<label for=m-zhdocseinocore_modulescomponentslambda_guide-check><a href=/zh/docs/eino/core_modules/components/lambda_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentslambda_guide><span>Eino: Lambda 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentsindexer_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsindexer_guide-check>
<label for=m-zhdocseinocore_modulescomponentsindexer_guide-check><a href=/zh/docs/eino/core_modules/components/indexer_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentsindexer_guide><span>Eino: Indexer 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentstools_node_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentstools_node_guide-check>
<label for=m-zhdocseinocore_modulescomponentstools_node_guide-check><a href=/zh/docs/eino/core_modules/components/tools_node_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentstools_node_guide><span>Eino: ToolsNode 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentschat_model_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentschat_model_guide-check>
<label for=m-zhdocseinocore_modulescomponentschat_model_guide-check><a href=/zh/docs/eino/core_modules/components/chat_model_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentschat_model_guide><span>Eino: ChatModel 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentsretriever_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentsretriever_guide-check>
<label for=m-zhdocseinocore_modulescomponentsretriever_guide-check><a href=/zh/docs/eino/core_modules/components/retriever_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentsretriever_guide><span>Eino: Retriever 使用说明</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulescomponentschat_template_guide-li><input type=checkbox id=m-zhdocseinocore_modulescomponentschat_template_guide-check>
<label for=m-zhdocseinocore_modulescomponentschat_template_guide-check><a href=/zh/docs/eino/core_modules/components/chat_template_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulescomponentschat_template_guide><span>Eino: ChatTemplate 使用说明</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-zhdocseinocore_moduleschain_and_graph_orchestration-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestration-check checked>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestration-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_moduleschain_and_graph_orchestration><span>Eino: Chain & Graph 编排功能</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-check>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/chain_graph_introduction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction><span>Eino: Chain/Graph 编排介绍</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-check>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/orchestration_design_principles/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles><span>Eino: 编排的设计理念</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcallback_manual-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcallback_manual-check checked>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestrationcallback_manual-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcallback_manual><span class=td-sidebar-nav-active-item>Eino: Callback 用户手册</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-check>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials><span>Eino 流式编程要点</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-li><input type=checkbox id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-check>
<label for=m-zhdocseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-check><a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/call_option_capabilities/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities><span>Eino: CallOption 能力与规范</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinocore_modulesflow_integration_components-li><input type=checkbox id=m-zhdocseinocore_modulesflow_integration_components-check>
<label for=m-zhdocseinocore_modulesflow_integration_components-check><a href=/zh/docs/eino/core_modules/flow_integration_components/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_modulesflow_integration_components><span>Eino: Flow 集成组件</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulesflow_integration_componentsreact_agent_manual-li><input type=checkbox id=m-zhdocseinocore_modulesflow_integration_componentsreact_agent_manual-check>
<label for=m-zhdocseinocore_modulesflow_integration_componentsreact_agent_manual-check><a href=/zh/docs/eino/core_modules/flow_integration_components/react_agent_manual/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulesflow_integration_componentsreact_agent_manual><span>Eino: React Agent 使用手册</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulesflow_integration_componentsmulti_agent_hosting-li><input type=checkbox id=m-zhdocseinocore_modulesflow_integration_componentsmulti_agent_hosting-check>
<label for=m-zhdocseinocore_modulesflow_integration_componentsmulti_agent_hosting-check><a href=/zh/docs/eino/core_modules/flow_integration_components/multi_agent_hosting/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulesflow_integration_componentsmulti_agent_hosting><span>Eino Tutorial: Host Multi-Agent</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinocore_modulesdevops-li><input type=checkbox id=m-zhdocseinocore_modulesdevops-check>
<label for=m-zhdocseinocore_modulesdevops-check><a href=/zh/docs/eino/core_modules/devops/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinocore_modulesdevops><span>EinoDev: 应用开发工具链</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulesdevopside_plugin_guide-li><input type=checkbox id=m-zhdocseinocore_modulesdevopside_plugin_guide-check>
<label for=m-zhdocseinocore_modulesdevopside_plugin_guide-check><a href=/zh/docs/eino/core_modules/devops/ide_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulesdevopside_plugin_guide><span>Eino Dev 插件安装指南</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulesdevopsvisual_orchestration_plugin_guide-li><input type=checkbox id=m-zhdocseinocore_modulesdevopsvisual_orchestration_plugin_guide-check>
<label for=m-zhdocseinocore_modulesdevopsvisual_orchestration_plugin_guide-check><a href=/zh/docs/eino/core_modules/devops/visual_orchestration_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulesdevopsvisual_orchestration_plugin_guide><span>EinoDev 可视化编排插件功能指南</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinocore_modulesdevopsvisual_debug_plugin_guide-li><input type=checkbox id=m-zhdocseinocore_modulesdevopsvisual_debug_plugin_guide-check>
<label for=m-zhdocseinocore_modulesdevopsvisual_debug_plugin_guide-check><a href=/zh/docs/eino/core_modules/devops/visual_debug_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinocore_modulesdevopsvisual_debug_plugin_guide><span>EinoDev 可视化调试插件功能指南</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integration-li><input type=checkbox id=m-zhdocseinoecosystem_integration-check checked>
<label for=m-zhdocseinoecosystem_integration-check><a href=/zh/docs/eino/ecosystem_integration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integration><span>Eino: 生态集成</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationchat_model-li><input type=checkbox id=m-zhdocseinoecosystem_integrationchat_model-check>
<label for=m-zhdocseinoecosystem_integrationchat_model-check><a href=/zh/docs/eino/ecosystem_integration/chat_model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationchat_model><span>ChatModel</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_openai-li><input type=checkbox id=m-zhdocseinoecosystem_integrationchat_modelchat_model_openai-check>
<label for=m-zhdocseinoecosystem_integrationchat_modelchat_model_openai-check><a href=/zh/docs/eino/ecosystem_integration/chat_model/chat_model_openai/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_openai><span>ChatModel - OpenAI</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ollama-li><input type=checkbox id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ollama-check>
<label for=m-zhdocseinoecosystem_integrationchat_modelchat_model_ollama-check><a href=/zh/docs/eino/ecosystem_integration/chat_model/chat_model_ollama/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ollama><span>ChatModel - Ollama</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ark-li><input type=checkbox id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ark-check>
<label for=m-zhdocseinoecosystem_integrationchat_modelchat_model_ark-check><a href=/zh/docs/eino/ecosystem_integration/chat_model/chat_model_ark/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationchat_modelchat_model_ark><span>ChatModel - ARK</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationcallbacks-li><input type=checkbox id=m-zhdocseinoecosystem_integrationcallbacks-check>
<label for=m-zhdocseinoecosystem_integrationcallbacks-check><a href=/zh/docs/eino/ecosystem_integration/callbacks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationcallbacks><span>Callbacks</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationcallbackscallback_apmplus-li><input type=checkbox id=m-zhdocseinoecosystem_integrationcallbackscallback_apmplus-check>
<label for=m-zhdocseinoecosystem_integrationcallbackscallback_apmplus-check><a href=/zh/docs/eino/ecosystem_integration/callbacks/callback_apmplus/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationcallbackscallback_apmplus><span>Callback - APMPlus</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationcallbackscallback_langfuse-li><input type=checkbox id=m-zhdocseinoecosystem_integrationcallbackscallback_langfuse-check>
<label for=m-zhdocseinoecosystem_integrationcallbackscallback_langfuse-check><a href=/zh/docs/eino/ecosystem_integration/callbacks/callback_langfuse/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationcallbackscallback_langfuse><span>Callback - Langfuse</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationindexer-li><input type=checkbox id=m-zhdocseinoecosystem_integrationindexer-check>
<label for=m-zhdocseinoecosystem_integrationindexer-check><a href=/zh/docs/eino/ecosystem_integration/indexer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationindexer><span>Indexer</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationindexerindexer_volc_vikingdb-li><input type=checkbox id=m-zhdocseinoecosystem_integrationindexerindexer_volc_vikingdb-check>
<label for=m-zhdocseinoecosystem_integrationindexerindexer_volc_vikingdb-check><a href=/zh/docs/eino/ecosystem_integration/indexer/indexer_volc_vikingdb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationindexerindexer_volc_vikingdb><span>Indexer - volc VikingDB</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationretriever-li><input type=checkbox id=m-zhdocseinoecosystem_integrationretriever-check>
<label for=m-zhdocseinoecosystem_integrationretriever-check><a href=/zh/docs/eino/ecosystem_integration/retriever/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationretriever><span>Retriever</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationretrieverretriever_volc_vikingdb-li><input type=checkbox id=m-zhdocseinoecosystem_integrationretrieverretriever_volc_vikingdb-check>
<label for=m-zhdocseinoecosystem_integrationretrieverretriever_volc_vikingdb-check><a href=/zh/docs/eino/ecosystem_integration/retriever/retriever_volc_vikingdb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationretrieverretriever_volc_vikingdb><span>Retriever - volc VikingDB</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationtool-li><input type=checkbox id=m-zhdocseinoecosystem_integrationtool-check>
<label for=m-zhdocseinoecosystem_integrationtool-check><a href=/zh/docs/eino/ecosystem_integration/tool/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationtool><span>Tool</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationtooltool_duckduckgo_search-li><input type=checkbox id=m-zhdocseinoecosystem_integrationtooltool_duckduckgo_search-check>
<label for=m-zhdocseinoecosystem_integrationtooltool_duckduckgo_search-check><a href=/zh/docs/eino/ecosystem_integration/tool/tool_duckduckgo_search/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationtooltool_duckduckgo_search><span>Tool - DuckDuckGoSearch</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationtooltool_googlesearch-li><input type=checkbox id=m-zhdocseinoecosystem_integrationtooltool_googlesearch-check>
<label for=m-zhdocseinoecosystem_integrationtooltool_googlesearch-check><a href=/zh/docs/eino/ecosystem_integration/tool/tool_googlesearch/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationtooltool_googlesearch><span>Tool - Googlesearch</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationdocument-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocument-check>
<label for=m-zhdocseinoecosystem_integrationdocument-check><a href=/zh/docs/eino/ecosystem_integration/document/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationdocument><span>Document</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentloader_amazon_s3-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentloader_amazon_s3-check>
<label for=m-zhdocseinoecosystem_integrationdocumentloader_amazon_s3-check><a href=/zh/docs/eino/ecosystem_integration/document/loader_amazon_s3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentloader_amazon_s3><span>Loader - amazon s3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentloader_local_file-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentloader_local_file-check>
<label for=m-zhdocseinoecosystem_integrationdocumentloader_local_file-check><a href=/zh/docs/eino/ecosystem_integration/document/loader_local_file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentloader_local_file><span>Loader - local file</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentloader_web_url-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentloader_web_url-check>
<label for=m-zhdocseinoecosystem_integrationdocumentloader_web_url-check><a href=/zh/docs/eino/ecosystem_integration/document/loader_web_url/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentloader_web_url><span>Loader - web url</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentparser_html-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentparser_html-check>
<label for=m-zhdocseinoecosystem_integrationdocumentparser_html-check><a href=/zh/docs/eino/ecosystem_integration/document/parser_html/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentparser_html><span>Parser - html</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentparser_pdf-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentparser_pdf-check>
<label for=m-zhdocseinoecosystem_integrationdocumentparser_pdf-check><a href=/zh/docs/eino/ecosystem_integration/document/parser_pdf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentparser_pdf><span>Parser - pdf</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentsplitter_recursive-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentsplitter_recursive-check>
<label for=m-zhdocseinoecosystem_integrationdocumentsplitter_recursive-check><a href=/zh/docs/eino/ecosystem_integration/document/splitter_recursive/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentsplitter_recursive><span>Splitter - recursive</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentsplitter_semantic-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentsplitter_semantic-check>
<label for=m-zhdocseinoecosystem_integrationdocumentsplitter_semantic-check><a href=/zh/docs/eino/ecosystem_integration/document/splitter_semantic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentsplitter_semantic><span>Splitter - semantic</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationdocumentsplitter_markdown-li><input type=checkbox id=m-zhdocseinoecosystem_integrationdocumentsplitter_markdown-check>
<label for=m-zhdocseinoecosystem_integrationdocumentsplitter_markdown-check><a href=/zh/docs/eino/ecosystem_integration/document/splitter_markdown/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationdocumentsplitter_markdown><span>Splitter - markdown</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-zhdocseinoecosystem_integrationembedding-li><input type=checkbox id=m-zhdocseinoecosystem_integrationembedding-check>
<label for=m-zhdocseinoecosystem_integrationembedding-check><a href=/zh/docs/eino/ecosystem_integration/embedding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-zhdocseinoecosystem_integrationembedding><span>Embedding</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationembeddingembedding_ark-li><input type=checkbox id=m-zhdocseinoecosystem_integrationembeddingembedding_ark-check>
<label for=m-zhdocseinoecosystem_integrationembeddingembedding_ark-check><a href=/zh/docs/eino/ecosystem_integration/embedding/embedding_ark/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationembeddingembedding_ark><span>Embedding - ARK</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-zhdocseinoecosystem_integrationembeddingembedding_openai-li><input type=checkbox id=m-zhdocseinoecosystem_integrationembeddingembedding_openai-check>
<label for=m-zhdocseinoecosystem_integrationembeddingembedding_openai-check><a href=/zh/docs/eino/ecosystem_integration/embedding/embedding_openai/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-zhdocseinoecosystem_integrationembeddingembedding_openai><span>Embedding - OpenAI</span></a></label></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/zh//docs/eino/core_modules/chain_and_graph_orchestration/callback_manual target=_blank><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/zh//docs/eino/core_modules/chain_and_graph_orchestration/callback_manual?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?labels=bug&amp;template=DOCS_UPDATE.md&amp;title=Eino:%20Callback%20%e7%94%a8%e6%88%b7%e6%89%8b%e5%86%8c" target=_blank><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
<a href=https://github.com/cloudwego/eino/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#解决的问题>解决的问题</a></li><li><a href=#核心概念>核心概念</a><ul><li><a href=#触发实体>触发实体</a></li><li><a href=#触发时机>触发时机</a></li><li><a href=#callback-handler>Callback Handler</a></li><li><a href=#runinfo>RunInfo</a></li><li><a href=#callback-input--output>Callback Input & Output</a></li></ul></li><li><a href=#注入-handler>注入 Handler</a><ul><li><a href=#全局注入-handler>全局注入 Handler</a></li><li><a href=#向-graph-中注入-handler>向 Graph 中注入 Handler</a></li><li><a href=#在-graph-外注入-handler>在 Graph 外注入 Handler</a></li><li><a href=#handler-继承>Handler 继承</a></li></ul></li><li><a href=#注入-runinfo>注入 RunInfo</a><ul><li><a href=#graph-托管-runinfo>Graph 托管 RunInfo</a></li><li><a href=#在-graph-外注入-runinfo>在 Graph 外注入 RunInfo</a></li></ul></li><li><a href=#触发方式>触发方式</a><ul><li><a href=#组件实现内部触发component-callback>组件实现内部触发(Component Callback)</a></li><li><a href=#graph-node-触发node-callback>Graph Node 触发(Node Callback)</a></li><li><a href=#graph-自身触发graph-callback>Graph 自身触发(Graph Callback)</a></li></ul></li><li><a href=#解析-callback-input--output>解析 Callback Input & Output</a></li><li><a href=#handler-实现方式>Handler 实现方式</a><ul><li><a href=#handlerhelper>HandlerHelper</a></li><li><a href=#handlerbuilder>HandlerBuilder</a></li></ul></li><li><a href=#最佳实践>最佳实践</a><ul><li><a href=#在-graph-中使用>在 Graph 中使用</a></li><li><a href=#在-graph-外使用>在 Graph 外使用</a></li><li><a href=#handler-内读写-input--output>Handler 内读写 input & output</a></li><li><a href=#handler-间传递信息>Handler 间传递信息</a></li><li><a href=#流切记要-close>流切记要 Close</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/>文档</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/eino/>Eino</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/eino/core_modules/>Eino: 核心模块</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/zh/docs/eino/core_modules/chain_and_graph_orchestration/>Eino: Chain & Graph 编排功能</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudwego.io/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>Eino: Callback 用户手册</a></li></ol></nav><div class=td-content><h1>Eino: Callback 用户手册</h1><header class=article-meta></header><h2 id=解决的问题>解决的问题</h2><p>Component（包括 Lambda）、Graph 编排共同解决“把业务逻辑定义出来”的问题。而 logging, tracing, metrics, 上屏展示等横切面性质的功能，需要有机制把功能注入到 Component（包括 Lambda）、Graph 中。</p><p>另一方面，用户可能想拿到某个具体 Component 实现的执行过程中的中间信息，比如 VikingDBRetriever 额外给出查询的 DB Name，ArkChatModel 额外给出请求的 temperature 等参数。需要有机制把中间状态透出。</p><p>Callbacks 支持“<strong>横切面功能注入</strong>”和“<strong>中间状态透出</strong>”，具体是：用户提供、注册“function”（Callback Handler），Component 和 Graph 在固定的“时机”（或者说切面、位点）回调这些 function，给出对应的信息。</p><h2 id=核心概念>核心概念</h2><p>核心概念串起来，就是：Eino 中的 Component 和 Graph 等<strong>实体</strong>，在固定的<strong>时机</strong> (Callback Timing)，回调用户提供的 <strong>function</strong> (Callback Handler)，并把<strong>自己是谁</strong> (RunInfo)，以及<strong>当时发生了什么</strong> (Callback Input & Output) 传出去。</p><h3 id=触发实体>触发实体</h3><p>Component（包括官方定义的组件类型和 Lambda），Graph Node（以及 Chain Node），Graph 自身（以及 Chain）。这三类实体，都有横切面功能注入、中间状态透出的需求，因此都会触发 callback。具体见下面的“<a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>触发方式</a>”一节。</p><h3 id=触发时机>触发时机</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackTiming enumerates all the timing of callback aspects.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackTiming</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackTiming</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnStart</span> <span style=color:#000>CallbackTiming</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>iota</span> <span style=color:#8f5902;font-style:italic>// 进入并开始执行</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnEnd</span> <span style=color:#8f5902;font-style:italic>// 成功完成即将 return</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnError</span> <span style=color:#8f5902;font-style:italic>// 失败并即将 return err </span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnStartWithStreamInput</span> <span style=color:#8f5902;font-style:italic>// OnStart，但是输入是 StreamReader</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnEndWithStreamOutput</span> <span style=color:#8f5902;font-style:italic>// OnEnd，但是输出是 StreamReader</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>不同的触发实体，在不同场景下，是触发 OnStart 还是 OnStartWithStreamInput (OnEnd/OnEndWithStreamOutput 同理），具体的规则，详见下面的“<a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>触发方式</a>”一节。</p><h3 id=callback-handler>Callback Handler</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Handler</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>input</span> <span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStartWithStreamInput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEndWithStreamOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>一个 Handler 是一个实现了上面 5 个方法（对应 5 个触发时机）的结构体。每个方法都会接收三个信息：</p><ul><li>Context: 用于<strong>接收同一个 Handler 的前序触发时机</strong>可能设置的定制信息。</li><li>RunInfo: 触发回调的实体元信息。</li><li>Input/Output/InputStream/OutputStream: 触发回调时的业务信息。</li></ul><p>并都会返回新的 Context：用于<strong>同一个 Handler 的不同触发时机之间</strong>传递信息。</p><p>如果一个 Handler，不想关注所有的 5 个触发时机，只想关注一部分，比如只关注 OnStart，建议使用 <code>NewHandlerBuilder().OnStartFn(...).Build()</code>。如果不想关注所有的组件类型，只想关注特定组件，比如 ChatModel，建议使用 <code>NewHandlerHelper().ChatModel(...).Handler()</code>，可以只接收 ChatModel 的回调并拿到一个具体类型的 CallbackInput/CallbackOutput。具体见“<a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>Handler 实现方式</a>”一节。</p><p>不同 Handler 之间，触发顺序<strong>没有</strong>保证。</p><h3 id=runinfo>RunInfo</h3><p>描述了触发 Callback 的实体自身的元信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RunInfo contains information about the running component that triggers callbacks.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>RunInfo</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Name</span>      <span style=color:#204a87;font-weight:700>string</span>               <span style=color:#8f5902;font-style:italic>// the &#39;Name&#39; with semantic meaning for the running component, specified by end-user</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Type</span>      <span style=color:#204a87;font-weight:700>string</span>               <span style=color:#8f5902;font-style:italic>// the specific implementation &#39;Type&#39; of the component, e.g. &#39;OpenAI&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Component</span> <span style=color:#000>components</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Component</span> <span style=color:#8f5902;font-style:italic>// the component abstract type, e.g. &#39;ChatModel&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>Name：有业务含义的名称，需用户指定，不指定就是空字符串。对不同的触发实体：<ul><li>Component：在 Graph 中时，用 Node Name。在 Graph 外单独的使用时，用户手动设置。详见“注入 RunInfo” 和 “单独使用 Component”</li><li>Graph Node：用 Node Name <code>func WithNodeName(n string) GraphAddNodeOpt</code></li><li>Graph 自身：<ul><li>顶层图用 Graph Name <code>func WithGraphName(graphName string) GraphCompileOption</code></li><li>内部嵌套图，会用加入到上级图时添加的 Node Name</li></ul></li></ul></li><li>Type：组件具体实现来规定：<ul><li>有接口的 Component：如果实现了 Typer 接口，用 GetType() 方法的结果。否则用反射获取 Struct/Func 名。</li><li>Lambda：如果用 <code>func WithLambdaType(t string) LambdaOpt</code> 指定了 Type，用这个，否则是空字符串。</li><li>Graph Node：用内部 Component/Lambda/Graph 的值。</li><li>Graph 自身：空字符串。</li></ul></li><li>Component:<ul><li>有接口的 Component：是啥接口，就是啥</li><li>Lambda：固定值 Lambda</li><li>Graph Node: 用内部的 Component/Lambda/Graph 的值。</li><li>Graph 自身：固定值 Graph / Chain. （之前曾有 StateGraph / StateChain ，现已整合到 Graph / Chain 中）</li></ul></li></ul><h3 id=callback-input--output>Callback Input & Output</h3><p>本质是任意类型，因为不同的 Component 的输入输出、内部状态完全不同。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackInput</span> <span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackOutput</span> <span style=color:#204a87;font-weight:700>any</span>
</span></span></code></pre></div><p>具体到某个组件，有更具体的类型，比如 Chat Model</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackInput is the input for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackInput</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Messages is the messages to be sent to the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Messages</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Tools is the tools to be used in the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Tools</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToolInfo</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Config is the config for the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Config</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Extra is the extra information for the callback.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Extra</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackOutput is the output for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackOutput</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Message is the message generated by the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Message</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Config is the config for the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Config</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// TokenUsage is the token usage of this request.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TokenUsage</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TokenUsage</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Extra is the extra information for the callback.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Extra</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>在 Chat Model 的具体实现，比如 OpenAI Chat Model 中，建议组件作者向 Callback Handler 中传入具体的 Input/Output 类型，而不是 Any。这样可以透出更具体的、定制化的中间状态信息。</p><p>如果是 Graph Node 来触发 Callback，因为 Node 拿不到组件内部中间状态信息，只能拿到组件接口中规定的输入和输出，所以给 Callback Handler 的只能是这些。对 Chat Model，就是 []*schema.Message 和 *schema.Message。</p><p>Graph 自身触发 Callback 时，输入输出就是 Graph 整体的输入和输出。</p><h2 id=注入-handler>注入 Handler</h2><p>Handler 需要注入到 Context 中才能被触发。</p><h3 id=全局注入-handler>全局注入 Handler</h3><p>通过 <code>callbacks.InitCallbackHandlers</code> 注入全局的 Handler。注入后，所有的触发回调行为，都会自动触发这些全局的 Handler。典型的场景是 tracing，logging 等全局一致、业务场景无关的功能。</p><p>不是并发安全的。建议在服务初始化时注入一次。</p><h3 id=向-graph-中注入-handler>向 Graph 中注入 Handler</h3><p>通过 <code>compose.WithCallbacks</code> 在 graph 运行时注入 Handler，这些 Handler 会在 graph 的本次运行整体上生效，包括 Graph 内各 Node 和 Graph 自身（以及各内嵌的 graph）。</p><p>通过 <code>compose.WithCallbacks(...).DesignateNode(...)</code> 向顶层 Graph 的某个 Node 注入 Handler。当这个 Node 自身是个内嵌的 Graph 时，会注入到这个内嵌 Graph 自身和其内部的各 Node。</p><p>通过 <code>compose.WithCallbacks(...).DesignateNodeForPath(...)</code> 向内部嵌套的 Graph 的某个 Node 注入 Handler。</p><h3 id=在-graph-外注入-handler>在 Graph 外注入 Handler</h3><p>不想使用 Graph，但却想使用 Callback，则：</p><p>通过 <code>InitCallbacks(ctx context.Context, info *RunInfo, handlers ...Handler)</code> 获取一个新的 Context 并注入 Handlers 以及 RunInfo。</p><h3 id=handler-继承>Handler 继承</h3><p>与子 Context 继承父 Context 中的所有 Values 相同，子 Context 也会继承父 Context 中的所有 Handlers。举个例子，Graph 运行时传入的 Context 中如果已经有了 Handler，则这些 Handlers 都会被整个 Graph 的这次运行继承和生效。</p><h2 id=注入-runinfo>注入 RunInfo</h2><p>RunInfo 也需要注入到 Context 中，才会在触发回调时给到 Handler。</p><h3 id=graph-托管-runinfo>Graph 托管 RunInfo</h3><p>Graph 会为内部所有的 Node 自动注入 RunInfo。机制是每个 Node 的运行，都是一个新的子 Context，Graph 向这个新的 Context 中注入对应 Node 的 RunInfo。</p><h3 id=在-graph-外注入-runinfo>在 Graph 外注入 RunInfo</h3><p>不想使用 Graph，但却想使用 Callback，则：</p><p>通过 <code>InitCallbacks(ctx context.Context, info *RunInfo, handlers ...Handler)</code> 获取一个新的 Context 并注入 Handlers 以及 RunInfo。</p><p>通过 <code>ReuseHandlers(ctx context.Context, info *RunInfo)</code> 来获取一个新的 Context，复用之前 Context 中的 Handler，并设置新的 RunInfo。</p><h2 id=触发方式>触发方式</h2><p><a href=/img/eino/graph_node_callback_run_place.png target=_blank><img src=/img/eino/graph_node_callback_run_place.png width=100%></a></p><h3 id=组件实现内部触发component-callback>组件实现内部触发(Component Callback)</h3><p>在组件实现的代码中，调用 callbacks 包中的 <code>OnStart(), OnEnd(), OnError(), OnStartWithStreamInput(), OnEndWithStreamInput()</code>。以 Ark 的 ChatModel 实现为例，在 Generate 方法中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Generate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>in</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>opts</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>outMsg</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... instantiate req conf</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#000>ctx</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Tools</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rawTools</span><span style=color:#000;font-weight:700>),</span> <span style=color:#8f5902;font-style:italic>// join tool info from call options</span>
</span></span><span style=display:flex><span>       <span style=color:#000>ToolChoice</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span>                 <span style=color:#8f5902;font-style:italic>// not support in api</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... invoke Ark chat API and get the response</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span>    <span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>TokenUsage</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>toModelCallbackUsage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseMeta</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>在 Stream 方法中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Stream</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>in</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>opts</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span> <span style=color:#8f5902;font-style:italic>// byted_s_too_many_lines_in_func</span>
</span></span><span style=display:flex><span>    <span style=color:#000>outStream</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... instantiate req conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>ctx</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Tools</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rawTools</span><span style=color:#000;font-weight:700>),</span> <span style=color:#8f5902;font-style:italic>// join tool info from call options</span>
</span></span><span style=display:flex><span>       <span style=color:#000>ToolChoice</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span>                 <span style=color:#8f5902;font-style:italic>// not support in api</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... make request to Ark API and convert response stream to StreamReader[model.*CallbackOutput]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sr</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnEndWithStreamOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReaderWithConvert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sr</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrNoValue</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>可以看到 Generate 调用时，触发的是 OnEnd，而 Stream 调用时，触发的是 OneEndWithStreamOutput：</p><p>组件实现内部触发 Callbacks 时:</p><ul><li><strong>当组件输入为 StreamReader 时，触发 OnStartWithStreamInput，否则触发 OnStart</strong></li><li><strong>当组件输出为 StreamReader 时，触发 OnEndWithStreamOutput，否则触发 OnEnd</strong></li></ul><p>内部实现了 callback 触发的组件，应当实现 Checker 接口，IsCallbacksEnabled 返回 true，向外部传达“我内部实现了 callback 触发”的信息：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Checker tells callback aspect status of component&#39;s implementation</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// When the Checker interface is implemented and returns true, the framework will not start the default aspect.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Instead, the component will decide the callback execution location and the information to be injected.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Checker</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>IsCallbacksEnabled</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>如果一个组件实现，没有实现 Checker 接口，或者 IsCallbacksEnabled 返回 false，可以认为该组件内部没有触发回调，需要 Graph Node 来负责注入和触发（在 Graph 内使用时）。</p><h3 id=graph-node-触发node-callback>Graph Node 触发(Node Callback)</h3><p>当一个 Component 被编排入 Graph 时，成为一个 Node。这时，如果 Component 自身会触发 callback，Node 就复用 Component 的 callback 处理。否则，Node 会在 Component 外面埋上 callback handler 触发点位。这些点位与 Component 自身的流式范式对应。比如一个 ChatModelNode，会在 Generate 方法外面埋上 OnStart/OnEnd/OnError，同时会在 Stream 方法外面埋上 OnStart/OnEndWithStreamOutput/OnError。</p><p>在 Graph 运行时，各组件会以 Invoke 或 Transform 范式运行，又会根据组件具体实现的业务流式范式，调用对应的组件方法。比如 Graph 以 Invoke 运行，Chat Model Node 会以 Invoke 运行，调用 Generate 方法。而当 Graph 以 Stream 运行，Chat Model Node 会以 Transform 运行，但 Chat Model 的业务流式范式中没有 Transform，会自动降级成调用 Stream 方法。因此：</p><p><strong>Graph Node 具体触发哪个位点（OnStart 还是 OnStartWithStreamInput），取决于组件实现的业务流式范式和 Graph 运行方式两个因素。</strong></p><p>关于 Eino 流式编程的详细介绍，参见 <a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials>Eino 流式编程要点</a></p><h3 id=graph-自身触发graph-callback>Graph 自身触发(Graph Callback)</h3><p>Graph 在自身的开始、结束、err 的时机触发 Callback Handler。如果 Graph 以 Invoke 形式调用，触发 OnStart/OnEnd/OnError。如果以 Stream/Collect/Transform 形式调用，触发 OnStartWithStreamInput/OnEndWithStreamOutput/OnError。这是因为 <strong>Graph 内部会始终以 Invoke 或 Transform 执行</strong>。参见 <a href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials>Eino 流式编程要点</a></p><p>值得注意的是：graph 也是 component 的一种，因此 graph callback 也是 component callback 的一种特殊形式。根据 Node Callback 的定义，当 Node 内部的 component 实现了对触发时机的感知和处理时，Node 会直接复用 Component 的实现，不会再实现 Node Callback。这意味着当一个 graph 通过 AddGraphNode 的方式加入到另外一个 Graph 中作为一个 Node 时，这个 Node 会复用内部 graph 的 graph callback。</p><h2 id=解析-callback-input--output>解析 Callback Input & Output</h2><p>从上文得知，Callback Input & Output 的底层是 Any，只是不同组件类型在具体触发回调时，可能会传入自己特定的类型。并且 Callback Handler 的接口定义中，各方法的入参也是 Any 类型的 Callback Input & Output。</p><p>因此，具体的 Handler 实现中，需要做两个事情：</p><ol><li>根据 RunInfo 判断当前触发回调的是哪个组件类型，比如 RunInfo.Component == &ldquo;ChatModel&rdquo;，或者 RunInfo.Type == &ldquo;xxx Chat Model&rdquo;。</li><li>把 any 类型的 Callback Input & Output 转成对应的具体类型，以 RunInfo.Component == &ldquo;ChatModel&rdquo; 为例：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ConvCallbackInput converts the callback input to the model callback input.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>ConvCallbackInput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackInput</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is triggered within component implementation, the input is usually already a typed *model.CallbackInput</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is injected by graph node, not the component implementation itself, the input is the input of Chat Model interface, which is []*schema.Message</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ConvCallbackOutput converts the callback output to the model callback output.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>ConvCallbackOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackOutput</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is triggered within component implementation, the output is usually already a typed *model.CallbackOutput</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is injected by graph node, not the component implementation itself, the output is the output of Chat Model interface, which is *schema.Message</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>如果 Handler 里面需要增加 switch case 来判断 RunInfo.Component，并且对每一个 case，需要调对应的转换函数把 Any 转成具体类型，确实有些复杂。为了减少写胶水代码的重复劳动，我们提供了两种实现 Handler 的便捷工具函数。</p><h2 id=handler-实现方式>Handler 实现方式</h2><p>除了直接实现 Handler 接口外，Eino 提供了两种 Handler 的便捷实现工具。</p><h3 id=handlerhelper>HandlerHelper</h3><p>如果用户的 Handler 只关注特定类型的组件，比如 ReactAgent 的场景，只关注 ChatModel 和 Tool，建议使用 HandlerHelper 来快速创建具体类型的 Callback Handler：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerHelper</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>modelHandler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Tool</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toolHandler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>其中 modelHandler 是 Chat Model 组件对 callback handler 的进一步封装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ModelCallbackHandler is the handler for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ModelCallbackHandler</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStart</span>               <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEnd</span>                 <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEndWithStreamOutput</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnError</span>               <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>上面的 ModelCallbackHandler，封装了三个操作：</p><ol><li>不再需要判断 RunInfo.Component 来选择属于 ChatModel 触发的回调，而是已经自动做了过滤。</li><li>只要求实现 Chat Model 这个组件支持的触发时机，这里去掉了不支持的 OnStartWithStreamInput。同时，如果用户只关注 Chat Model 支持的四个时机的某几个，比如只有 OnStart，也可以只实现 OnStart。</li><li>Input / Output 不再是 Any 类型，而是已经转化好的 model.CallbackInput, model.CallbackOutput。</li></ol><p>HandlerHelper 支持全部的官方组件，目前的列表是：ChatModel, ChatTemplate, Retriever, Indexer, Embedding, Document.Loader, Document.Transformer, Tool, ToolsNode.</p><p>针对 Lambda，Graph，Chain 这些输入输出类型不确定的“组件”，也可以使用 HandlerHelper，但是只能做到上面的第 1 点，即按照组件类型做自动的过滤，2、3 点依然需要用户自己实现：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerHelper</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Lambda</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Graph</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>这时，NewHandlerHelper().Lambda() 需要传入 callbacks.Handler 可以用下面的 HandlerBuilder 来实现。</p><h3 id=handlerbuilder>HandlerBuilder</h3><p>如果用户的 Handler 需要关注多个组件类型，但却只需要关注部分的触发时机，可以使用 HandlerBuilder：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerBuilder</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>OnStartFn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>Build</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><h2 id=最佳实践>最佳实践</h2><h3 id=在-graph-中使用>在 Graph 中使用</h3><ul><li>积极使用 Global Handlers，注册始终生效的 Handlers。</li><li>通过 WithHandlers option 在运行时注入 Handler，通过 DesignateNode 或 DesignateNodeByPath 指定生效的 Node / 嵌套的内部 Graph / 内部 Graph 的 Node。</li></ul><h3 id=在-graph-外使用>在 Graph 外使用</h3><p>使用 InitCallbacks 注入 RunInfo 和 Handlers。RunInfo 的各字段需自行设置。Global Handlers 会自动注入。</p><pre tabindex=0><code>ctx = callbacks.InitCallbacks(ctx, runInfo, handlers...)
componentA.Invoke(ctx, input)
</code></pre><p>如果一个 componentA 内部调用了其他的 componentB (比如 ToolsNode 内部调用 Tool），需要在 componentB 执行前替换 RunInfo：</p><pre tabindex=0><code>func ComponentARun(ctx, inputA) {
    // 复用 ctx 中已有的 Handlers（包括 Global Handlers），只替换 RunInfo
    ctx = callbacks.ReuseHandlers(ctx, newRunInfo)
    componentB.Invoke(ctx, inputB)
    
    // RunInfo 和 Handlers 都替换
    ctx = callbacks.InitCallbacks(ctx, newRunInfo, newHandlers...)
    componentB.Invoke(ctx, inputB)
}
</code></pre><h3 id=handler-内读写-input--output>Handler 内读写 input & output</h3><p>Input & output 在 graph 中流转时，是直接变量赋值。如下图所示，NodeA.Output, NodeB.Input, NodeC.Input, 以及各个 Handler 中拿到的 input & output，如果是结构体指针或 Map 等引用类型，则都是同一份数据。因此，无论在 Node 内还是 Handler 内，都不建议修改 Input & Output，会产生并发问题：即使同步情况下，Node B 和 Node C 有并发，导致内部的 handler1 和 handler2 有并发。存在异步处理逻辑时，并发的可能场景更多。</p><p><a href=/img/eino/eino_callback_start_end_place.png target=_blank><img src=/img/eino/eino_callback_start_end_place.png width=60%></a></p><p>在流传递的场景，所有下游节点和 handler 中的输入流，都是 StreamReader.Copy(n) 得到的流，可相互独立的读取流。但是，流中的每个 chunk，是直接变量赋值，如果 chunk 是结构体指针或 Map 等引用类型，各个 Copy 后的流读到的是同一份数据。因此，在 Node 和 Handler 内，同样不建议修改流的 chunk，有并发问题。</p><p><a href=/img/eino/eino_callback_stream_place.png target=_blank><img src=/img/eino/eino_callback_stream_place.png width=100%></a></p><h3 id=handler-间传递信息>Handler 间传递信息</h3><p>同一个 Handler 的不同时机之间，可通过 ctx 传递信息，如 OnStart 中通过 context.WithValue 返回一个新的 context，在 OnEnd 中从 context 中再取出这个 value。</p><p>不同 Handler 之间，没有执行顺序的保证，因此不建议通过上面的机制在不同 Handler 间传递信息。本质上是无法保证某一个 Handler 返回的 context，一定会进入下一个 Handler 的函数执行中。</p><p>如果需要在不同 Handler 之间传递信息，建议的方式是在最外层的 context（如 graph 执行时传入的 context）中，设置一个全局的、请求维度的变量作为公共信息的存取空间，在各个 Handler 中按需读取和更新这个公共变量。用户需要自行保证这个公共变量的并发安全。</p><h3 id=流切记要-close>流切记要 Close</h3><p>以存在 ChatModel 这种具有真流输出的节点为例，当存在 Callback 切面时，ChatModel 的输出流：</p><ul><li>既要被下游节点作为输入来消费，又要被 Callback 切面来消费</li><li>一个流中的一个帧(Chunk)，只能被一个消费方消费到，即流不是广播模型</li></ul><p>所以此时需要将流进行复制，其复制关系如下：</p><p><a href=/img/eino/graph_stream_chunk_copy.png target=_blank><img src=/img/eino/graph_stream_chunk_copy.png width=100%></a></p><ul><li>如果其中一个 Callback n 没有 Close 对应的流，可能导致原始 Stream 无法 Close 和释放资源。</li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>反馈</h2><p class=feedback--question>当前页面对你有帮助吗？</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">是</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">否</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>请告诉我们如何改进</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">最后修改
March 7, 2025
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/590388601ba4c26232b5ba3dcdef1bb571867ba4>doc: update plugin install guide (#1272) (5903886)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fab fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/main.min.9a8648b987db06195f5768f0d7516e8df7c27669e91e383e25c5d07cd6325605.js integrity="sha256-moZIuYfbBhlfV2jw11FujffCdmnpHjg+JcXQfNYyVgU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>