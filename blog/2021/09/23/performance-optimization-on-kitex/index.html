<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.142.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Performance Optimization on Kitex | CloudWeGo</title>
<meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/blog/2021/09/23/performance-optimization-on-kitex/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="Performance Optimization on Kitex"><meta property="og:description" content="This blog introduces the performance optimization practice of Bytedance Go RPC framework Kitex, which includes Netpoll, Thrift, serialization and so on."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-07T17:25:05+08:00"><meta itemprop=name content="Performance Optimization on Kitex"><meta itemprop=description content="This blog introduces the performance optimization practice of Bytedance Go RPC framework Kitex, which includes Netpoll, Thrift, serialization and so on."><meta itemprop=datePublished content="2021-09-23T00:00:00+00:00"><meta itemprop=dateModified content="2025-03-07T17:25:05+08:00"><meta itemprop=wordCount content="4427"><meta itemprop=keywords content="Kitex,Optimization,Netpoll,Thrift,Serialization"><meta name=twitter:card content="summary"><meta name=twitter:title content="Performance Optimization on Kitex"><meta name=twitter:description content="This blog introduces the performance optimization practice of Bytedance Go RPC framework Kitex, which includes Netpoll, Thrift, serialization and so on."><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css as=style><link href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/docs/volo/>Volo</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/docs/cwgo/>Cwgo</a>
<a class=dropdown-item href=/docs/eino/>Eino</a>
<a class=dropdown-item href=/docs/monolake/>Monolake</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cooperation/><span>Cooperation</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Security</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/security/safety-bulletin/>safety-bulletin</a>
<a class=dropdown-item href=/security/vulnerability-reporting/>vulnerability-reporting</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2021/09/23/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8-go-rpc-%E6%A1%86%E6%9E%B6-kitex-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/blog/2021/09/23/%E5%AD%97%E8%8A%82%E8%B7%B3%E5%8A%A8-go-rpc-%E6%A1%86%E6%9E%B6-kitex-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E8%B7%B5/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blognews-li><input type=checkbox id=m-blognews-check checked>
<label for=m-blognews-check><a href=/blog/news/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blognews><span>News</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240221delving-deeper-enriching-microservices-with-golang-with-cloudwego-li><input type=checkbox id=m-blog20240221delving-deeper-enriching-microservices-with-golang-with-cloudwego-check checked>
<label for=m-blog20240221delving-deeper-enriching-microservices-with-golang-with-cloudwego-check><a href=/blog/2024/02/21/delving-deeper-enriching-microservices-with-golang-with-cloudwego/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240221delving-deeper-enriching-microservices-with-golang-with-cloudwego><span>Delving Deeper: Enriching Microservices with Golang with CloudWeGo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240129enhancing-performance-in-microservice-architecture-with-kitex-li><input type=checkbox id=m-blog20240129enhancing-performance-in-microservice-architecture-with-kitex-check checked>
<label for=m-blog20240129enhancing-performance-in-microservice-architecture-with-kitex-check><a href=/blog/2024/01/29/enhancing-performance-in-microservice-architecture-with-kitex/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240129enhancing-performance-in-microservice-architecture-with-kitex><span>Enhancing Performance in Microservice Architecture with Kitex</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240118harnessing-the-power-of-rust-for-cloud-development-with-volo-li><input type=checkbox id=m-blog20240118harnessing-the-power-of-rust-for-cloud-development-with-volo-check checked>
<label for=m-blog20240118harnessing-the-power-of-rust-for-cloud-development-with-volo-check><a href=/blog/2024/01/18/harnessing-the-power-of-rust-for-cloud-development-with-volo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240118harnessing-the-power-of-rust-for-cloud-development-with-volo><span>Harnessing the Power of Rust for Cloud Development with Volo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240110mastering-golang-microservices-a-practical-guide-embrace-high-performance-with-kitex-and-hertz-li><input type=checkbox id=m-blog20240110mastering-golang-microservices-a-practical-guide-embrace-high-performance-with-kitex-and-hertz-check checked>
<label for=m-blog20240110mastering-golang-microservices-a-practical-guide-embrace-high-performance-with-kitex-and-hertz-check><a href=/blog/2024/01/10/mastering-golang-microservices-a-practical-guide-embrace-high-performance-with-kitex-and-hertz/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240110mastering-golang-microservices-a-practical-guide-embrace-high-performance-with-kitex-and-hertz><span>Mastering Golang Microservices - A Practical Guide: Embrace High-Performance with Kitex and Hertz</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231128the-role-of-cloudwego-in-modern-cloud-native-applications-li><input type=checkbox id=m-blog20231128the-role-of-cloudwego-in-modern-cloud-native-applications-check checked>
<label for=m-blog20231128the-role-of-cloudwego-in-modern-cloud-native-applications-check><a href=/blog/2023/11/28/the-role-of-cloudwego-in-modern-cloud-native-applications/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231128the-role-of-cloudwego-in-modern-cloud-native-applications><span>The Role of CloudWeGo in Modern Cloud-Native Applications</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230615cloudwego-a-leading-practice-for-building-enterprise-cloud-native-middleware-li><input type=checkbox id=m-blog20230615cloudwego-a-leading-practice-for-building-enterprise-cloud-native-middleware-check checked>
<label for=m-blog20230615cloudwego-a-leading-practice-for-building-enterprise-cloud-native-middleware-check><a href=/blog/2023/06/15/cloudwego-a-leading-practice-for-building-enterprise-cloud-native-middleware/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230615cloudwego-a-leading-practice-for-building-enterprise-cloud-native-middleware><span>CloudWeGo: A leading practice for building enterprise cloud native middleware!</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230417introducing-monoio-a-high-performance-rust-runtime-based-on-io-uring-li><input type=checkbox id=m-blog20230417introducing-monoio-a-high-performance-rust-runtime-based-on-io-uring-check checked>
<label for=m-blog20230417introducing-monoio-a-high-performance-rust-runtime-based-on-io-uring-check><a href=/blog/2023/04/17/introducing-monoio-a-high-performance-rust-runtime-based-on-io-uring/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230417introducing-monoio-a-high-performance-rust-runtime-based-on-io-uring><span>Introducing Monoio: a high-performance Rust Runtime based on io-uring</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230404introducing-shmipc-a-high-performance-inter-process-communication-library-li><input type=checkbox id=m-blog20230404introducing-shmipc-a-high-performance-inter-process-communication-library-check checked>
<label for=m-blog20230404introducing-shmipc-a-high-performance-inter-process-communication-library-check><a href=/blog/2023/04/04/introducing-shmipc-a-high-performance-inter-process-communication-library/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230404introducing-shmipc-a-high-performance-inter-process-communication-library><span>Introducing Shmipc: A High Performance Inter-process Communication Library</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230224getting-started-with-hertz-performance-testing-guide-li><input type=checkbox id=m-blog20230224getting-started-with-hertz-performance-testing-guide-check checked>
<label for=m-blog20230224getting-started-with-hertz-performance-testing-guide-check><a href=/blog/2023/02/24/getting-started-with-hertz-performance-testing-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230224getting-started-with-hertz-performance-testing-guide><span>Getting Started with Hertz: Performance Testing Guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221220kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry-li><input type=checkbox id=m-blog20221220kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry-check checked>
<label for=m-blog20221220kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry-check><a href=/blog/2022/12/20/kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221220kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry><span>Kitex Proxyless Practice：Traffic Lane Implementation with Istio and OpenTelemetry</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220930kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework-li><input type=checkbox id=m-blog20220930kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework-check checked>
<label for=m-blog20220930kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework-check><a href=/blog/2022/09/30/kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220930kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework><span>Kitex: Unifying Open Source Practice for a High-Performance RPC Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220830chinas-first-rust-based-rpc-framework-volo-is-officially-open-source-li><input type=checkbox id=m-blog20220830chinas-first-rust-based-rpc-framework-volo-is-officially-open-source-check checked>
<label for=m-blog20220830chinas-first-rust-based-rpc-framework-volo-is-officially-open-source-check><a href=/blog/2022/08/30/chinas-first-rust-based-rpc-framework-volo-is-officially-open-source/ title="China's First Rust-based RPC Framework - Volo is Officially Open Source!" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220830chinas-first-rust-based-rpc-framework-volo-is-officially-open-source><span>China's first RPC framework based on Rust language - Volo is officially open source!</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220621hertz-an-ultra-large-scale-enterprise-level-microservice-http-framework-is-now-officially-open-source-li><input type=checkbox id=m-blog20220621hertz-an-ultra-large-scale-enterprise-level-microservice-http-framework-is-now-officially-open-source-check checked>
<label for=m-blog20220621hertz-an-ultra-large-scale-enterprise-level-microservice-http-framework-is-now-officially-open-source-check><a href=/blog/2022/06/21/hertz-an-ultra-large-scale-enterprise-level-microservice-http-framework-is-now-officially-open-source/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220621hertz-an-ultra-large-scale-enterprise-level-microservice-http-framework-is-now-officially-open-source><span>Hertz, an Ultra Large Scale Enterprise-Level Microservice HTTP Framework, is Now Officially Open Source!</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego-li><input type=checkbox id=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego-check checked>
<label for=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego-check><a href=/blog/2022/03/25/an-article-to-learn-about-bytedance-microservices-middleware-cloudwego/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220325an-article-to-learn-about-bytedance-microservices-middleware-cloudwego><span>An Article to Learn About ByteDance Microservices Middleware CloudWeGo</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide-li><input type=checkbox id=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide-check checked>
<label for=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide-check><a href=/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211124getting-started-with-kitexs-practice-performance-testing-guide><span>Getting Started With Kitex's Practice: Performance Testing Guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20210923performance-optimization-on-kitex-li><input type=checkbox id=m-blog20210923performance-optimization-on-kitex-check checked>
<label for=m-blog20210923performance-optimization-on-kitex-check><a href=/blog/2021/09/23/performance-optimization-on-kitex/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20210923performance-optimization-on-kitex><span class=td-sidebar-nav-active-item>Performance Optimization on Kitex</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210913cloudwego-open-source-announcement-li><input type=checkbox id=m-blog20210913cloudwego-open-source-announcement-check checked>
<label for=m-blog20210913cloudwego-open-source-announcement-check><a href=/blog/2021/09/13/cloudwego-open-source-announcement/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210913cloudwego-open-source-announcement><span>CloudWeGo Open Source Announcement</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20200524bytedance-practices-on-go-network-library-li><input type=checkbox id=m-blog20200524bytedance-practices-on-go-network-library-check checked>
<label for=m-blog20200524bytedance-practices-on-go-network-library-check><a href=/blog/2020/05/24/bytedance-practices-on-go-network-library/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20200524bytedance-practices-on-go-network-library><span>ByteDance Practices on Go Network Library</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleases-li><input type=checkbox id=m-blogreleases-check checked>
<label for=m-blogreleases-check><a href=/blog/releases/ title="New Releases" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleases><span>Releases</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleaseskitex-li><input type=checkbox id=m-blogreleaseskitex-check checked>
<label for=m-blogreleaseskitex-check><a href=/blog/releases/kitex/ title="Kitex Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleaseskitex><span>Kitex</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20250103kitex-release-v0120-li><input type=checkbox id=m-blog20250103kitex-release-v0120-check>
<label for=m-blog20250103kitex-release-v0120-check><a href=/blog/2025/01/03/kitex-release-v0.12.0/ title="Kitex Release v0.12.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20250103kitex-release-v0120><span>Release v0.12.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240912kitex-release-v0110-li><input type=checkbox id=m-blog20240912kitex-release-v0110-check>
<label for=m-blog20240912kitex-release-v0110-check><a href=/blog/2024/09/12/kitex-release-v0.11.0/ title="Kitex Release v0.11.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240912kitex-release-v0110><span>Release v0.11.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240612kitex-release-v0100-li><input type=checkbox id=m-blog20240612kitex-release-v0100-check>
<label for=m-blog20240612kitex-release-v0100-check><a href=/blog/2024/06/12/kitex-release-v0.10.0/ title="Kitex Release v0.10.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240612kitex-release-v0100><span>Release v0.10.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240304kitex-release-v090-li><input type=checkbox id=m-blog20240304kitex-release-v090-check>
<label for=m-blog20240304kitex-release-v090-check><a href=/blog/2024/03/04/kitex-release-v0.9.0/ title="Kitex Release v0.9.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240304kitex-release-v090><span>Release v0.9.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231130kitex-release-v080-li><input type=checkbox id=m-blog20231130kitex-release-v080-check>
<label for=m-blog20231130kitex-release-v080-check><a href=/blog/2023/11/30/kitex-release-v0.8.0/ title="Kitex Release v0.8.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231130kitex-release-v080><span>Release v0.8.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230927kitex-release-v072-li><input type=checkbox id=m-blog20230927kitex-release-v072-check>
<label for=m-blog20230927kitex-release-v072-check><a href=/blog/2023/09/27/kitex-release-v0.7.2/ title="Kitex Release v0.7.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230927kitex-release-v072><span>Release v0.7.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230814kitex-release-v070-li><input type=checkbox id=m-blog20230814kitex-release-v070-check>
<label for=m-blog20230814kitex-release-v070-check><a href=/blog/2023/08/14/kitex-release-v0.7.0/ title="Kitex Release v0.7.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230814kitex-release-v070><span>Release v0.7.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230619kitex-release-v061-li><input type=checkbox id=m-blog20230619kitex-release-v061-check>
<label for=m-blog20230619kitex-release-v061-check><a href=/blog/2023/06/19/kitex-release-v0.6.1/ title="Kitex Release v0.6.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230619kitex-release-v061><span>Release v0.6.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230614kitex-release-v060-li><input type=checkbox id=m-blog20230614kitex-release-v060-check>
<label for=m-blog20230614kitex-release-v060-check><a href=/blog/2023/06/14/kitex-release-v0.6.0/ title="Kitex Release v0.6.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230614kitex-release-v060><span>Release v0.6.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230421kitex-release-v053-li><input type=checkbox id=m-blog20230421kitex-release-v053-check>
<label for=m-blog20230421kitex-release-v053-check><a href=/blog/2023/04/21/kitex-release-v0.5.3/ title="Kitex Release v0.5.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230421kitex-release-v053><span>Release v0.5.3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230308kitex-release-v050-li><input type=checkbox id=m-blog20230308kitex-release-v050-check>
<label for=m-blog20230308kitex-release-v050-check><a href=/blog/2023/03/08/kitex-release-v0.5.0/ title="Kitex Release v0.5.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230308kitex-release-v050><span>Release v0.5.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221102kitex-release-v043-li><input type=checkbox id=m-blog20221102kitex-release-v043-check>
<label for=m-blog20221102kitex-release-v043-check><a href=/blog/2022/11/02/kitex-release-v0.4.3/ title="Kitex Release v0.4.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221102kitex-release-v043><span>Release v0.4.3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220826kitex-release-v040-li><input type=checkbox id=m-blog20220826kitex-release-v040-check>
<label for=m-blog20220826kitex-release-v040-check><a href=/blog/2022/08/26/kitex-release-v0.4.0/ title="Kitex Release v0.4.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220826kitex-release-v040><span>Release v0.4.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220602kitex-release-v032-li><input type=checkbox id=m-blog20220602kitex-release-v032-check>
<label for=m-blog20220602kitex-release-v032-check><a href=/blog/2022/06/02/kitex-release-v0.3.2/ title="Kitex Release v0.3.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220602kitex-release-v032><span>Release v0.3.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220429kitex-release-v030-li><input type=checkbox id=m-blog20220429kitex-release-v030-check>
<label for=m-blog20220429kitex-release-v030-check><a href=/blog/2022/04/29/kitex-release-v0.3.0/ title="Kitex Release v0.3.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220429kitex-release-v030><span>Release v0.3.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220324kitex-release-v021-li><input type=checkbox id=m-blog20220324kitex-release-v021-check>
<label for=m-blog20220324kitex-release-v021-check><a href=/blog/2022/03/24/kitex-release-v0.2.1/ title="Kitex Release v0.2.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220324kitex-release-v021><span>Release v0.2.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220224kitex-release-v020-li><input type=checkbox id=m-blog20220224kitex-release-v020-check>
<label for=m-blog20220224kitex-release-v020-check><a href=/blog/2022/02/24/kitex-release-v0.2.0/ title="Kitex Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220224kitex-release-v020><span>Release v0.2.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220118kitex-release-v014-li><input type=checkbox id=m-blog20220118kitex-release-v014-check>
<label for=m-blog20220118kitex-release-v014-check><a href=/blog/2022/01/18/kitex-release-v0.1.4/ title="Kitex Release v0.1.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220118kitex-release-v014><span>Release v0.1.4</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211230kitex-release-v013-li><input type=checkbox id=m-blog20211230kitex-release-v013-check>
<label for=m-blog20211230kitex-release-v013-check><a href=/blog/2021/12/30/kitex-release-v0.1.3/ title="Kitex Release v0.1.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211230kitex-release-v013><span>Release v0.1.3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211222kitex-release-v012-li><input type=checkbox id=m-blog20211222kitex-release-v012-check>
<label for=m-blog20211222kitex-release-v012-check><a href=/blog/2021/12/22/kitex-release-v0.1.2/ title="Kitex Release v0.1.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211222kitex-release-v012><span>Release v0.1.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211213kitex-release-v010-li><input type=checkbox id=m-blog20211213kitex-release-v010-check>
<label for=m-blog20211213kitex-release-v010-check><a href=/blog/2021/12/13/kitex-release-v0.1.0/ title="Kitex Release v0.1.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211213kitex-release-v010><span>Release v0.1.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211105kitex-release-v008-li><input type=checkbox id=m-blog20211105kitex-release-v008-check>
<label for=m-blog20211105kitex-release-v008-check><a href=/blog/2021/11/05/kitex-release-v0.0.8/ title="Kitex Release v0.0.8" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211105kitex-release-v008><span>Release v0.0.8</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210926kitex-release-v005-li><input type=checkbox id=m-blog20210926kitex-release-v005-check>
<label for=m-blog20210926kitex-release-v005-check><a href=/blog/2021/09/26/kitex-release-v0.0.5/ title="Kitex Release v0.0.5" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210926kitex-release-v005><span>Release v0.0.5</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210826kitex-release-v004-li><input type=checkbox id=m-blog20210826kitex-release-v004-check>
<label for=m-blog20210826kitex-release-v004-check><a href=/blog/2021/08/26/kitex-release-v0.0.4/ title="Kitex Release v0.0.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210826kitex-release-v004><span>Release v0.0.4</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210801kitex-release-v003-li><input type=checkbox id=m-blog20210801kitex-release-v003-check>
<label for=m-blog20210801kitex-release-v003-check><a href=/blog/2021/08/01/kitex-release-v0.0.3/ title="Kitex Release v0.0.3" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210801kitex-release-v003><span>Release v0.0.3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210730kitex-release-v002-li><input type=checkbox id=m-blog20210730kitex-release-v002-check>
<label for=m-blog20210730kitex-release-v002-check><a href=/blog/2021/07/30/kitex-release-v0.0.2/ title="Kitex Release v0.0.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210730kitex-release-v002><span>Release v0.0.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210712kitex-release-v001-li><input type=checkbox id=m-blog20210712kitex-release-v001-check>
<label for=m-blog20210712kitex-release-v001-check><a href=/blog/2021/07/12/kitex-release-v0.0.1/ title="Kitex Release v0.0.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210712kitex-release-v001><span>Release v0.0.1</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleaseshertz-li><input type=checkbox id=m-blogreleaseshertz-check checked>
<label for=m-blogreleaseshertz-check><a href=/blog/releases/hertz/ title="Hertz Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleaseshertz><span>Hertz</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240530hertz-release-v090-li><input type=checkbox id=m-blog20240530hertz-release-v090-check>
<label for=m-blog20240530hertz-release-v090-check><a href=/blog/2024/05/30/hertz-release-v0.9.0/ title="Hertz Release v0.9.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240530hertz-release-v090><span>Release v0.9.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240112hertz-release-v080-li><input type=checkbox id=m-blog20240112hertz-release-v080-check>
<label for=m-blog20240112hertz-release-v080-check><a href=/blog/2024/01/12/hertz-release-v0.8.0/ title="Hertz Release v0.8.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240112hertz-release-v080><span>Release v0.8.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230926hertz-release-v070-li><input type=checkbox id=m-blog20230926hertz-release-v070-check>
<label for=m-blog20230926hertz-release-v070-check><a href=/blog/2023/09/26/hertz-release-v0.7.0/ title="Hertz Release v0.7.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230926hertz-release-v070><span>Release v0.7.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230302hertz-release-v060-li><input type=checkbox id=m-blog20230302hertz-release-v060-check>
<label for=m-blog20230302hertz-release-v060-check><a href=/blog/2023/03/02/hertz-release-v0.6.0/ title="Hertz Release v0.6.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230302hertz-release-v060><span>Release v0.6.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230112hertz-release-v050-li><input type=checkbox id=m-blog20230112hertz-release-v050-check>
<label for=m-blog20230112hertz-release-v050-check><a href=/blog/2023/01/12/hertz-release-v0.5.0/ title="Hertz Release v0.5.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230112hertz-release-v050><span>Release v0.5.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221028hertz-release-v040-li><input type=checkbox id=m-blog20221028hertz-release-v040-check>
<label for=m-blog20221028hertz-release-v040-check><a href=/blog/2022/10/28/hertz-release-v0.4.0/ title="Hertz Release v0.4.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221028hertz-release-v040><span>Release v0.4.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220920hertz-release-v032-li><input type=checkbox id=m-blog20220920hertz-release-v032-check>
<label for=m-blog20220920hertz-release-v032-check><a href=/blog/2022/09/20/hertz-release-v0.3.2/ title="Hertz Release v0.3.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220920hertz-release-v032><span>Release v0.3.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220829hertz-release-v030-li><input type=checkbox id=m-blog20220829hertz-release-v030-check>
<label for=m-blog20220829hertz-release-v030-check><a href=/blog/2022/08/29/hertz-release-v0.3.0/ title="Hertz Release v0.3.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220829hertz-release-v030><span>Release v0.3.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220722hertz-release-v020-li><input type=checkbox id=m-blog20220722hertz-release-v020-check>
<label for=m-blog20220722hertz-release-v020-check><a href=/blog/2022/07/22/hertz-release-v0.2.0/ title="Hertz Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220722hertz-release-v020><span>Release v0.2.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220620hertz-release-v010-li><input type=checkbox id=m-blog20220620hertz-release-v010-check>
<label for=m-blog20220620hertz-release-v010-check><a href=/blog/2022/06/20/hertz-release-v0.1.0/ title="Hertz Release v0.1.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220620hertz-release-v010><span>Release v0.1.0</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleasesnetpoll-li><input type=checkbox id=m-blogreleasesnetpoll-check checked>
<label for=m-blogreleasesnetpoll-check><a href=/blog/releases/netpoll/ title="Netpoll Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleasesnetpoll><span>Netpoll</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240304netpoll-release-v060-li><input type=checkbox id=m-blog20240304netpoll-release-v060-check>
<label for=m-blog20240304netpoll-release-v060-check><a href=/blog/2024/03/04/netpoll-release-v0.6.0/ title="Netpoll Release v0.6.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240304netpoll-release-v060><span>Release v0.6.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231018netpoll-release-v051-li><input type=checkbox id=m-blog20231018netpoll-release-v051-check>
<label for=m-blog20231018netpoll-release-v051-check><a href=/blog/2023/10/18/netpoll-release-v0.5.1/ title="Netpoll Release v0.5.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231018netpoll-release-v051><span>Release v0.5.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230926netpoll-release-v050-li><input type=checkbox id=m-blog20230926netpoll-release-v050-check>
<label for=m-blog20230926netpoll-release-v050-check><a href=/blog/2023/09/26/netpoll-release-v0.5.0/ title="Netpoll Release v0.5.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230926netpoll-release-v050><span>Release v0.5.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230614netpoll-release-v040-li><input type=checkbox id=m-blog20230614netpoll-release-v040-check>
<label for=m-blog20230614netpoll-release-v040-check><a href=/blog/2023/06/14/netpoll-release-v0.4.0/ title="Netpoll Release v0.4.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230614netpoll-release-v040><span>Release v0.4.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221109netpoll-release-v030-li><input type=checkbox id=m-blog20221109netpoll-release-v030-check>
<label for=m-blog20221109netpoll-release-v030-check><a href=/blog/2022/11/09/netpoll-release-v0.3.0/ title="Netpoll Release v0.3.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221109netpoll-release-v030><span>Release v0.3.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220428netpoll-release-v022-li><input type=checkbox id=m-blog20220428netpoll-release-v022-check>
<label for=m-blog20220428netpoll-release-v022-check><a href=/blog/2022/04/28/netpoll-release-v0.2.2/ title="Netpoll Release v0.2.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220428netpoll-release-v022><span>Release v0.2.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220222netpoll-release-v020-li><input type=checkbox id=m-blog20220222netpoll-release-v020-check>
<label for=m-blog20220222netpoll-release-v020-check><a href=/blog/2022/02/22/netpoll-release-v0.2.0/ title="Netpoll Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220222netpoll-release-v020><span>Release v0.2.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211213netpoll-release-v012-li><input type=checkbox id=m-blog20211213netpoll-release-v012-check>
<label for=m-blog20211213netpoll-release-v012-check><a href=/blog/2021/12/13/netpoll-release-v0.1.2/ title="Netpoll Release v0.1.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211213netpoll-release-v012><span>Release v0.1.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211209netpoll-release-v011-li><input type=checkbox id=m-blog20211209netpoll-release-v011-check>
<label for=m-blog20211209netpoll-release-v011-check><a href=/blog/2021/12/09/netpoll-release-v0.1.1/ title="Netpoll Release v0.1.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211209netpoll-release-v011><span>Release v0.1.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211201netpoll-release-v010-li><input type=checkbox id=m-blog20211201netpoll-release-v010-check>
<label for=m-blog20211201netpoll-release-v010-check><a href=/blog/2021/12/01/netpoll-release-v0.1.0/ title="Netpoll Release v0.1.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211201netpoll-release-v010><span>Release v0.1.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210916netpoll-release-v004-li><input type=checkbox id=m-blog20210916netpoll-release-v004-check>
<label for=m-blog20210916netpoll-release-v004-check><a href=/blog/2021/09/16/netpoll-release-v0.0.4/ title="Netpoll Release v0.0.4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210916netpoll-release-v004><span>Release v0.0.4</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-blogreleasesvolo-li><input type=checkbox id=m-blogreleasesvolo-check checked>
<label for=m-blogreleasesvolo-check><a href=/blog/releases/volo/ title="Volo Release" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-blogreleasesvolo><span>Volo</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240408volo-release-0100-li><input type=checkbox id=m-blog20240408volo-release-0100-check>
<label for=m-blog20240408volo-release-0100-check><a href=/blog/2024/04/08/volo-release-0.10.0/ title="Volo Release 0.10.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240408volo-release-0100><span>Release v0.10.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20240104volo-release-090-li><input type=checkbox id=m-blog20240104volo-release-090-check>
<label for=m-blog20240104volo-release-090-check><a href=/blog/2024/01/04/volo-release-0.9.0/ title="Volo Release 0.9.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20240104volo-release-090><span>Release v0.9.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20231023volo-release-080-li><input type=checkbox id=m-blog20231023volo-release-080-check>
<label for=m-blog20231023volo-release-080-check><a href=/blog/2023/10/23/volo-release-0.8.0/ title="Volo Release 0.8.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20231023volo-release-080><span>Release v0.8.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230320volo-release-041-li><input type=checkbox id=m-blog20230320volo-release-041-check>
<label for=m-blog20230320volo-release-041-check><a href=/blog/2023/03/20/volo-release-0.4.1/ title="Volo Release 0.4.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230320volo-release-041><span>Release v0.4.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230207volo-release-032-li><input type=checkbox id=m-blog20230207volo-release-032-check>
<label for=m-blog20230207volo-release-032-check><a href=/blog/2023/02/07/volo-release-0.3.2/ title="Volo Release 0.3.2" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230207volo-release-032><span>Release 0.3.2</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221222volo-release-030-li><input type=checkbox id=m-blog20221222volo-release-030-check>
<label for=m-blog20221222volo-release-030-check><a href=/blog/2022/12/22/volo-release-0.3.0/ title="Volo Release 0.3.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221222volo-release-030><span>Release 0.3.0</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221026volo-release-v021-li><input type=checkbox id=m-blog20221026volo-release-v021-check>
<label for=m-blog20221026volo-release-v021-check><a href=/blog/2022/10/26/volo-release-v0.2.1/ title="Volo Release v0.2.1" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221026volo-release-v021><span>Release v0.2.1</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221018volo-release-v020-li><input type=checkbox id=m-blog20221018volo-release-v020-check>
<label for=m-blog20221018volo-release-v020-check><a href=/blog/2022/10/18/volo-release-v0.2.0/ title="Volo Release v0.2.0" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221018volo-release-v020><span>Release v0.2.0</span></a></label></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en//blog/news/kitex_perf_optimize_practices target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en//blog/news/kitex_perf_optimize_practices?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?labels=bug&amp;template=DOCS_UPDATE.md&amp;title=Performance%20Optimization%20on%20Kitex" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/kitex/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#preface>Preface</a></li><li><a href=#optimization-of-the-network-library---netpoll>Optimization of the Network Library - Netpoll</a><ul><li><a href=#optimizing-scheduling-delays-when-calling-epoll_wait>Optimizing Scheduling Delays When Calling &ldquo;epoll_wait&rdquo;</a></li><li><a href=#utilizing-unsafepointer>Utilizing &ldquo;unsafe.Pointer&rdquo;</a></li></ul></li><li><a href=#serializationdeserialization-optimization-of-thrift>Serialization/Deserialization Optimization of Thrift</a><ul><li><a href=#research-on-serialization-strategy>Research on Serialization Strategy</a></li><li><a href=#approaches>Approaches</a></li><li><a href=#testing-results>Testing Results</a></li></ul></li><li><a href=#copy-free-serialization>Copy-free Serialization</a><ul><li><a href=#research-on-copy-free-serilization>Research on Copy-free Serilization</a></li><li><a href=#thrift-protocols-compatible-copy-free-serialization>Thrift Protocol‘s Compatible Copy-free Serialization</a></li></ul></li><li><a href=#postscript>Postscript</a></li><li><a href=#reference>Reference</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-projects"><h5 class=taxonomy-title>Out projects</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=/projects/cloudwego/ data-taxonomy-term=cloudwego><span class=taxonomy-label>CloudWeGo</span><span class=taxonomy-count>8</span></a></li><li><a class=taxonomy-term href=/projects/hertz/ data-taxonomy-term=hertz><span class=taxonomy-label>Hertz</span><span class=taxonomy-count>13</span></a></li><li><a class=taxonomy-term href=/projects/kitex/ data-taxonomy-term=kitex><span class=taxonomy-label>Kitex</span><span class=taxonomy-count>32</span></a></li><li><a class=taxonomy-term href=/projects/monoio/ data-taxonomy-term=monoio><span class=taxonomy-label>Monoio</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/projects/netpoll/ data-taxonomy-term=netpoll><span class=taxonomy-label>Netpoll</span><span class=taxonomy-count>13</span></a></li><li><a class=taxonomy-term href=/projects/shmipc/ data-taxonomy-term=shmipc><span class=taxonomy-label>Shmipc</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=/projects/volo/ data-taxonomy-term=volo><span class=taxonomy-label>Volo</span><span class=taxonomy-count>10</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Performance Optimization on Kitex</h1><div class=lead>This blog introduces the performance optimization practice of Bytedance Go RPC framework Kitex, which includes Netpoll, Thrift, serialization and so on.</div><div class="td-byline mb-4">By <b><a href=https://github.com/Hchenn target=_blank>Hchen</a>, <a href=https://github.com/PureWhiteWu target=_blank>Pure White</a>, <a href=https://github.com/simon0-o target=_blank>Simon Wang</a>, <a href=https://github.com/SinnerA target=_blank>bytexw</a></b> |
<time datetime=2021-09-23 class=text-muted>Thursday, September 23, 2021</time><div class=addthis_inline_share_toolbox style=display:inline-block></div></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-projects"><h5 class=taxonomy-title>Projects:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://www.cloudwego.io/projects/kitex/ data-taxonomy-term=kitex><span class=taxonomy-label>Kitex</span></a></li></ul></div></header><h2 id=preface>Preface</h2><p>Kitex is the next generation high-performance and extensible Go RPC framework developed by ByteDance Service Framework Team. Compared with other RPC frameworks, in addition to its rich features for service governance, it has the following characteristics: integrated with the self-developed network library - Netpoll; supports multiple Message Protocols (Thrift, Protobuf) and Interactive Models (Ping-Pong, Oneway, Streaming); provides a more flexible and extensible code generator.</p><p>Currently, Kitex has been widely used by the major lines of business in ByteDance, and statistics shows that the number of service access is up to 8K. We&rsquo;ve been continuously improving Kitex&rsquo;s performance since its launch. This article will share our work on optimizing Netpoll and serialization.</p><h2 id=optimization-of-the-network-library---netpoll>Optimization of the Network Library - Netpoll</h2><p>Netpoll, the self-developed network library based on Epoll. Compared with the previous version and the go net library, its performance has been significantly improved. Test results indicated that compared with the last version (2020.05), the latest version (2020.12) has ↑30% throughput capacity, ↓25% AVG latency, and ↓67% TP99 . Its performance is far better than the Go Net library. Below, we&rsquo;ll share two solutions that can significantly improve its performance.</p><h3 id=optimizing-scheduling-delays-when-calling-epoll_wait>Optimizing Scheduling Delays When Calling &ldquo;epoll_wait&rdquo;</h3><p>When Netpoll was newly released, it encountered the problem of low AVG latency but high TP99. Through our research and analysis on &ldquo;epoll_wait&rdquo;, we found that such a problem could be mitigated by integrating &ldquo;polling&rdquo; and &ldquo;event trigger&rdquo;. With such improvements in scheduling strategy, the latency can be reduced considerably.</p><p>Let&rsquo;s have a look at the &ldquo;syscall.EpollWait&rdquo; method provided by Go first:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>EpollWait</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epfd</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>events</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>EpollEvent</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msec</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>n</span> <span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Three parameters are provided here, they represent &ldquo;epoll fd&rdquo;, “callback events”, and &ldquo;milliseconds to wait&rdquo; respectively. Only &ldquo;msec&rdquo; is dynamic.</p><p>Normally, we would set &ldquo;msec = -1&rdquo; when we are actively calling &ldquo;EpollWait&rdquo;, as we want to wait for the event infinitely. In fact, many open-source net libraries were also using it in this way. But our research showed that setting &ldquo;msec =-1&rdquo; was not the optimal solution.</p><p>The kernel source (below) of &ldquo;epoll_wait&rdquo; shows that setting &ldquo;msec = -1&rdquo; arises extra &ldquo;fetch_events&rdquo; checks than setting &ldquo;msec = 0&rdquo;, and therefore consumes more time.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>static</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>ep_poll</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>eventpoll</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ep</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>epoll_event</span> <span style=color:#000>__user</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>events</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>                   <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>maxevents</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>long</span> <span style=color:#000>timeout</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>timeout</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>goto</span> <span style=color:#000>send_events</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>fetch_events</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>eavail</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>goto</span> <span style=color:#000>send_events</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>send_events</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span></code></pre></div><p>The Benchmark shows that when an event is triggered, setting &ldquo;msec = 0&rdquo; is about 18% faster than setting &ldquo;msec = -1&rdquo;. Thus, when triggering complex events, setting &ldquo;msec = 0&rdquo; is obviously a better choice.</p><table><thead><tr><th style=text-align:left>Benchmark</th><th style=text-align:left>time/op</th><th style=text-align:left>bytes/op</th></tr></thead><tbody><tr><td style=text-align:left>BenchmarkEpollWait, msec=0</td><td style=text-align:left>270 ns/op</td><td style=text-align:left>0 B/op</td></tr><tr><td style=text-align:left>BenchmarkEpollWait, msec=-1</td><td style=text-align:left>328 ns/op</td><td style=text-align:left>0 B/op</td></tr><tr><td style=text-align:left>EpollWait Delta</td><td style=text-align:left>-17.68%</td><td style=text-align:left>~</td></tr></tbody></table><p>However, setting &ldquo;msec = 0&rdquo; would lead to infinite polling when no event is triggered, consumes lots of resources.</p><p>Taking the previously mentioned factors into account, it&rsquo;s preferred to set &ldquo;msec = 0&rdquo; when an event is triggered and &ldquo;msec = -1&rdquo; when no event is triggered to reduce polling. The pseudocode is demonstrated as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>n</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>syscall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EpollWait</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>events</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msec</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Nevertheless, our experiments have proved that the improvement is insignificant. Setting &ldquo;msec = 0&rdquo; merely reduces the delay of a single call by 50ns, which is not a considerable improvement. If we want to further reduce latency, adjustment must be made in Go runtime scheduling.
Thus, let&rsquo;s further explore this issue:
In the pseudocode above, setting &ldquo;msec= -1&rdquo; with no triggered event, and &ldquo;continue&rdquo; directly will immediately execute &ldquo;EpollWait&rdquo; again. Since there is no triggered event while &ldquo;msec = -1&rdquo;, the current &ldquo;goroutine&rdquo; will block and be switched by &ldquo;P&rdquo; passively. However, it is less efficient, and we can save time if we actively switch &ldquo;goroutine&rdquo; for &ldquo;P&rdquo; before &ldquo;continue&rdquo;. So we modified the above pseudocode as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>n</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>syscall</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>EpollWait</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epfd</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>events</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msec</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>n</span> <span style=color:#ce5c00;font-weight:700>&lt;=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>      <span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Gosched</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>continue</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>msec</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The test results of the modified code showed that throughput ↑12% and TP99 ↓64%. The latency was significantly reduced.</p><h3 id=utilizing-unsafepointer>Utilizing &ldquo;unsafe.Pointer&rdquo;</h3><p>Through further study of &ldquo;epoll_wait&rdquo;, we find that the &ldquo;syscall.EpollWait&rdquo; published by Go and the &ldquo;epollwait&rdquo; used by &ldquo;runtime&rdquo; are two different versions, as they use different &ldquo;EpollEvent&rdquo;. They are demonstrated as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// @syscall</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EpollEvent</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Events</span> <span style=color:#204a87;font-weight:700>uint32</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Fd</span>     <span style=color:#204a87;font-weight:700>int32</span>
</span></span><span style=display:flex><span>   <span style=color:#000>Pad</span>    <span style=color:#204a87;font-weight:700>int32</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// @runtime</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>epollevent</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>events</span> <span style=color:#204a87;font-weight:700>uint32</span>
</span></span><span style=display:flex><span>   <span style=color:#000>data</span>   <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#8f5902;font-style:italic>// unaligned uintptr</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>As we can see, the &ldquo;epollevent&rdquo; used by &ldquo;runtime&rdquo; is the original structure defined by &ldquo;epoll&rdquo; at system layer. The published version encapsulates it and splits &ldquo;epoll_data(epollevent.data)&rdquo; into two fixed fields: &ldquo;Fd&rdquo; and &ldquo;Pad&rdquo;. For &ldquo;runtime&rdquo;, in its source code we found the following logic:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#000>pollDesc</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>unsafe</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pointer</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>ev</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>))</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>pd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>pd</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>**</span><span style=color:#000>pollDesc</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>unsafe</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pointer</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>ev</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>data</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p>Obviously, &ldquo;runtime&rdquo; uses &ldquo;epoll_data(&amp;ev.data)&rdquo; to store the pointer of the corresponding structure (pollDesc) of &ldquo;fd&rdquo; directly. Thus, when an event is triggered, the &ldquo;struct&rdquo; object can be found directly with the corresponding logic being executed. However, the external version can only obtain the encapsulated &ldquo;fd&rdquo; parameters. So it needs to introduce additional &ldquo;Map&rdquo; to manipulate the &ldquo;struct&rdquo; object, and the performance will be diminished.</p><p>Therefore, we abandoned &ldquo;syscall.EpollWait&rdquo; and designed our own &ldquo;EpollWait&rdquo; call by referring to &ldquo;runtime&rdquo;. We also use &ldquo;unsafe.Pointer&rdquo; to access &ldquo;struct&rdquo; objects. The test results showed that our &ldquo;EpollWait&rdquo; call contributed to ↑10% throughput and ↓10% TP99, which has significantly improved efficiency.</p><h2 id=serializationdeserialization-optimization-of-thrift>Serialization/Deserialization Optimization of Thrift</h2><p>Serialization refers to the process of converting a data structure or object into a binary or textual form. Deserialization is the opposite process. A serialization protocol needs to be agreed during RPC communication. The serialization process is executed before the client sends requests. The bytes are transmitted to the server over the network, and the server will logic-process the bytes to complete an RPC request. Thrift supports &ldquo;Binary&rdquo;, &ldquo;Compact&rdquo;, and &ldquo;JSON&rdquo; serialization protocols. Since &ldquo;Binary&rdquo; is the most common protocol used in Bytedance, we will only discuss about &ldquo;Binary&rdquo; protocol.</p><p>&ldquo;Binary&rdquo; protocol is &ldquo;TLV&rdquo; (&ldquo;Type&rdquo;, &ldquo;Length&rdquo;, &ldquo;Value&rdquo;) encoded, that is, each field is described using &ldquo;TLV&rdquo; structure. It emphasizes that the &ldquo;Value&rdquo; can also be a &ldquo;TLV&rdquo; structure, where the &ldquo;Type&rdquo; and &ldquo;Length&rdquo; are fixed in length, and the length of &ldquo;Value&rdquo; is determined by the input value of &ldquo;Length&rdquo;. The TLV coding structure is simple, clear, and scalable. However, since it requires the input of &ldquo;Type&rdquo; and &ldquo;Length&rdquo;, there is extra memory overhead incurred. It wastes considerable memory especially when most fields are in base types.</p><p>The performance of serialization and deserialization can be optimized from two dimensions - &ldquo;time&rdquo; & &ldquo;space&rdquo;. To be compatible with the existing &ldquo;binary&rdquo; protocols, optimization in &ldquo;space&rdquo; seems to be infeasible. Improvement can only be made in &ldquo;time&rdquo;, it includes:</p><ul><li>Reduce the frequency of operations on memory, notably memory allocation and copying. Try to pre-allocate memory to reduce unnecessary time consumption.</li><li>Reduce the frequency of function calls by adjusting code structure or using &ldquo;inline&rdquo; etc.</li></ul><h3 id=research-on-serialization-strategy>Research on Serialization Strategy</h3><p>Based on &ldquo;go_serialization_benchmarks&rdquo;, we investigated a number of serialization schemes that performed well to guide the optimization of our serialization strategy.</p><p>Analysis of &ldquo;protobuf&rdquo;, &ldquo;gogoprotobuf&rdquo;, and &ldquo;Cap &rsquo;n Proto&rdquo; has provided us the following results:</p><ul><li>Considering I/O, the transmitted data is usually compressed in size during network transmission. &ldquo;protobuf&rdquo; uses &ldquo;Varint&rdquo; encoding and has good data compression capabilities in most scenarios.</li><li>&ldquo;gogoprotobuf&rdquo; uses precomputation to reduce memory allocations and copies during serialization. Thus, it eliminates the cost of system calls, locks and GC arisen from memory allocations.</li><li>&ldquo;Cap &rsquo;n Proto&rdquo; directly operates buffer, which also reduces memory allocations and copies. In addition, it also designs &ldquo;struct pointer&rdquo; in a way that processes fixed-length data and non-fixed-length data separately, which enables fast processing for fixed-length data.</li></ul><p>For compatibility reasons, it is impossible to change the existing &ldquo;TLV&rdquo; encoding format, so data compression is not feasible. But finding 2 and 3 are inspiring to our optimization work, and in fact we have taken a similar approach.</p><h3 id=approaches>Approaches</h3><h4 id=reducing-operations-on-memory>Reducing Operations on Memory</h4><p><strong>Buffer management</strong><br>Both serialization and deserialization involve copying data from one piece of memory to another. It involves memory allocation and memory copying. Avoiding memory operations can reduce unnecessary overhead such as system calls, locks, and GC.</p><p>In fact, Kitex has provided &ldquo;LinkBuffer&rdquo; for buffer management purposes. &ldquo;LinkBuffer&rdquo; is designed with a linked structure and consists of multiple blocks, among which blocks are memory chunks with a fixed size. Object pool is constructed to maintain unoccupied block and support block multiplexing, thus, reduce memory usage and GC.</p><p>Initially we simply used &ldquo;sync.Pool&rdquo; to multiplex the &ldquo;LinkBufferNode&rdquo; of netpoll, but it didn&rsquo;t significantly contribute to multiplexing in large data package scenarios (large nodes can&rsquo;t be reclaimed or it would cause memory leaking). At present, we have changed our strategy to maintain a group of &ldquo;sync.Pool&rdquo;, and the buffer size in each chunk is different. When new blocks are created, it is obtained from the pool with the closest size to the required size, so that the memory can be multiplexed as much as possible. And the test results also proved that it contributed to significant improvement in terms of memory allocation and GC.</p><p><strong>Copy-free String / Binary</strong><br>For some services, such as video-related services, during its request or return processes, large-size &ldquo;Binary&rdquo; data will be arisen, representing the processed video or image data. Meanwhile, some services will return large-size &ldquo;String&rdquo; data (such as full-text information, etc.). In this scenario, all the hot spots we see through the flame graph are on the copies of the data. So we thought, can we reduce the frequency of such copies?</p><p>The answer is positive. Since our underlying buffer is a linked list, it is easy to insert a node in the middle of the list.</p><p><img src=/img/blog/buffer-linkerd-list.png alt=!image></p><p>Thus, we have taken a similar approach, when a &ldquo;string&rdquo; or &ldquo;binary&rdquo; data exists during serialization processes. First, split the node&rsquo;s buffer into two segments and then insert the buffer of the &ldquo;string&rdquo; / &ldquo;binary&rdquo; objects in the middle correspondingly. This avoids the copy of large &ldquo;string&rdquo; / &ldquo;binary&rdquo; .</p><p>Furthermore, a copy will occur if we convert a string to &ldquo;[]byte&rdquo; using &ldquo;[]byte(string)&rdquo;. Because &ldquo;string&rdquo; is immutable and &ldquo;[]byte&rdquo; is mutable in Golang language. &ldquo;unsafe&rdquo; is needed if you don&rsquo;t want to copy during the conversion:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>StringToSliceByte</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>unsafe</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pointer</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>reflect</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SliceHeader</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Data</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>reflect</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StringHeader</span><span style=color:#000;font-weight:700>)(</span><span style=color:#000>unsafe</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Pointer</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>))).</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Len</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#000>l</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>      <span style=color:#000>Cap</span><span style=color:#000;font-weight:700>:</span>  <span style=color:#000>l</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}))</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The meaning of this demonstrated code is to take the address of the string first, and then give it a slice byte header, so that the &ldquo;string&rdquo; can be converted into &ldquo;[]byte&rdquo; without copying the data. Note that the resulting &ldquo;[]byte&rdquo; is not writable, or the behavior is undefined.</p><p><strong>Pre-Calculation</strong><br>Some services support transmissions of large data package, which incurs considerable serialization / deserialization overhead. Generally, large packages are associated with the large size of the container type. If the buffer can be pre-calculated, some O(n) operations can be reduced to O(1), and further reduce the frequency of function calls. In the case of large data packages, the number of memory allocation can also be greatly reduced, bringing considerable benefits.</p><ul><li><p>Base types</p><ul><li>If the container element is defined as base type (bool, byte, i16, i32, i64, double), the total size can be pre-calculated during serialization as its size is fixed, and enough buffer can be allocated at once. The number of &ldquo;malloc&rdquo; operations of O(n) can be reduced to O(1), thus greatly reducing the frequency of &ldquo;malloc&rdquo; operations. Similarly, the number of &ldquo;next&rdquo; operations can be reduced during deserialization.</li></ul></li><li><p>Rearrangement of &ldquo;Struct&rdquo; Fields</p><ul><li>The above optimizations are valid only for container elements that are defined as base types. Can they be optimized for &ldquo;struct&rdquo; elements? The answer is yes.</li><li>If there are fields of base type in &ldquo;struct&rdquo;, we can pre-calculate the size of these fields, then allocate buffer for these fields in advance during serialization and write these fields in the first order. We can also reduce the frequency of &ldquo;malloc&rdquo;.</li></ul></li><li><p>Size calculation</p><ul><li>The optimization mentioned above is for base types. If you first iterate over all the fields of the request during serialization, you can calculate the size of the entire request, allocate buffer in advance, and directly manipulate buffer during serialization and deserialization, so that the optimization effect can be achieved for non-base types.</li><li>Define a new &ldquo;codec&rdquo; interface:</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>thriftMsgFastCodec</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>BLength</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#8f5902;font-style:italic>// count length of whole req/resp</span>
</span></span><span style=display:flex><span>   <span style=color:#000>FastWrite</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span>
</span></span><span style=display:flex><span>   <span style=color:#000>FastRead</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>Change the &ldquo;Marshal&rdquo; and &ldquo;Unmarshal&rdquo; interfaces accordingly:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>thriftCodec</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Marshal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>message</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>out</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ByteBuffer</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>thriftMsgFastCodec</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>msgBeginLen</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MessageBeginLength</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>thrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TMessageType</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msgType</span><span style=color:#000;font-weight:700>),</span> <span style=color:#204a87>int32</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>seqID</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>       <span style=color:#000>msgEndLen</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MessageEndLength</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>       <span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Malloc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msgBeginLen</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>BLength</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>+</span> <span style=color:#000>msgEndLen</span><span style=color:#000;font-weight:700>)</span><span style=color:#8f5902;font-style:italic>// malloc once</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>perrors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewProtocolErrorWithMsg</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;thrift marshal, Malloc failed: %s&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()))</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>       <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteMessageBegin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>methodName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>thrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TMessageType</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>msgType</span><span style=color:#000;font-weight:700>),</span> <span style=color:#204a87>int32</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>seqID</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>       <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FastWrite</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>       <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteMessageEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#000>thriftCodec</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Unmarshal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>message</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>in</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ByteBuffer</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>data</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Data</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>data</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>thriftMsgFastCodec</span><span style=color:#000;font-weight:700>);</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PayloadLen</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#000>msgBeginLen</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MessageBeginLength</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>methodName</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>msgType</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>seqID</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#000>buf</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>tProt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>next</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PayloadLen</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>msgBeginLen</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MessageEndLength</span><span style=color:#000;font-weight:700>())</span> <span style=color:#8f5902;font-style:italic>// next once</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewTransError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PROTOCOL_ERROR</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>msg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FastRead</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewTransError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PROTOCOL_ERROR</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>tProt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ReadMessageEnd</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>      <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewTransError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>remote</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PROTOCOL_ERROR</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#000>tProt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Recycle</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>   <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
</span></span><span style=display:flex><span>   <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>   <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>Modify the generated code accordingly:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Demo</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>BLength</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StructBeginLength</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Demo&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>field1Length</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>field2Length</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>                <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>field3Length</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FieldStopLength</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#000>l</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StructEndLength</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>l</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Demo</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>FastWrite</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>byte</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#0000cf;font-weight:700>0</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteStructBegin</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:],</span> <span style=color:#4e9a06>&#34;Demo&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>p</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fastWriteField2</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fastWriteField4</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fastWriteField1</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>                <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>p</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>fastWriteField3</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteFieldStop</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>        <span style=color:#000>offset</span> <span style=color:#ce5c00;font-weight:700>+=</span> <span style=color:#000>bthrift</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Binary</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WriteStructEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>buf</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>offset</span><span style=color:#000;font-weight:700>:])</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>offset</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=optimizing-thrift-encoding-with-simd>Optimizing Thrift Encoding with SIMD</h4><p>&ldquo;list&lt;i64/i32>&rdquo; is widely used in the company to carry the ID list, and the encoding method of &ldquo;list&lt;i64/i32>&rdquo; is highly consistent with the rule of vectorization. Thus, we use SIMD to optimize the encoding process of list&lt;i64/i32>.</p><p>We implement &ldquo;avx2&rdquo; to improve the encoding process, and the improved results are significant. When dealing with large amounts of data, the performance can be improved by 6 times for i64 and 12 times for i32. In the case of small data volume, the improvement is more obvious, which achieves 10 times for i64 and 20 times for I32.</p><h4 id=reducing-function-calls>Reducing Function Calls</h4><p><strong>inline</strong><br>The purpose of &ldquo;inline&rdquo; is to expand a function call during its compilation and replace it with the implementation of the function. It improves program performance by reducing the overhead of the function call.</p><p>&ldquo;inline&rdquo; can&rsquo;t be implemented on all functions in Go. Run the process with the argument - (gflags="-m") to display the functions that are inlined. The following conditions cannot be inlined:</p><ul><li>A function containing a loop;</li><li>Functions that include: closure calls, select, for, defer, coroutines created by the go keyword;</li><li>For Functions over a certain length, by default when parsing the AST, Go applies 80 nodes. Each node consumes one unit of inline budget. For example, a = a + 1 contains five nodes: AS, NAME, ADD, NAME, LITERAL. When the overhead of a function exceeds this budget, it cannot be inlined.</li></ul><p>You can specify the intensity (go 1.9+) of the compiler&rsquo;s inlined code by specifying &ldquo;-l&rdquo; at compile time. But it is not recommended, as in our test scenario, it is buggy and does not work:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// The debug[&#39;l&#39;] flag controls the aggressiveness. Note that main() swaps level 0 and 1, making 1 the default and -l disable. Additional levels (beyond -l) may be buggy and are not supported.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//      0: disabled</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//      1: 80-nodes leaf functions, oneliners, panic, lazy typechecking (default)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//      2: (unassigned)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//      3: (unassigned)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//      4: allow non-leaf functions</span>
</span></span></code></pre></div><p>Although using &ldquo;inline&rdquo; can reduce the overhead of function calls, it may also lead to lower CPU cache hit rate due to code redundancy. Therefore, excessive usage of &ldquo;inline&rdquo; should not be blindly pursued, and specific analysis should be carried out based on &ldquo;profile&rdquo; results.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>go <span style=color:#204a87>test</span> -gcflags<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;-m=2&#39;</span> -v -test.run TestNewCodec 2&gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;function too complex&#34;</span> <span style=color:#000;font-weight:700>|</span> wc -l
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>48</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>go <span style=color:#204a87>test</span> -gcflags<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;-m=2 -l=4&#39;</span> -v -test.run TestNewCodec 2&gt;<span style=color:#000;font-weight:700>&amp;</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> grep <span style=color:#4e9a06>&#34;function too complex&#34;</span> <span style=color:#000;font-weight:700>|</span> wc -l
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>25</span>
</span></span></code></pre></div><p>As you can see, from the output above, increasing the inline intensity does reduce the &ldquo;function too complex&rdquo;. Following are the benchmark results:</p><table><thead><tr><th style=text-align:left>Benchmark</th><th style=text-align:left>time/op</th><th style=text-align:left>bytes/op</th><th style=text-align:left>allocs/op</th></tr></thead><tbody><tr><td style=text-align:left>BenchmarkOldMarshal-4</td><td style=text-align:left>309 µs ± 2%</td><td style=text-align:left>218KB</td><td style=text-align:left>11</td></tr><tr><td style=text-align:left>BenchmarkNewMarshal-4</td><td style=text-align:left>310 µs ± 3%</td><td style=text-align:left>218KB</td><td style=text-align:left>11</td></tr></tbody></table><p>It reveals that turning on the highest level of inlining intensity does eliminate many functions that cannot be inlined due to &ldquo;function too complex&rdquo;, but the test results show that the improvement is insignificant.</p><h3 id=testing-results>Testing Results</h3><p>We built benchmarks to compare performance before and after optimization, and here are the results.
Testing Environment:
Go 1.13.5 darwin/amd64 on a 2.5 GHz Intel Core i7 16GB</p><p><strong>Small Data Size</strong></p><p>Data size: 20KB</p><table><thead><tr><th style=text-align:left>Benchmark</th><th style=text-align:left>time/op</th><th style=text-align:left>bytes/op</th><th style=text-align:left>allocs/op</th></tr></thead><tbody><tr><td style=text-align:left>BenchmarkOldMarshal-4</td><td style=text-align:left>138 µs ± 3%</td><td style=text-align:left>25.4KB</td><td style=text-align:left>19</td></tr><tr><td style=text-align:left>BenchmarkNewMarshal-4</td><td style=text-align:left>29 µs ± 3%</td><td style=text-align:left>26.4KB</td><td style=text-align:left>11</td></tr><tr><td style=text-align:left>Marshal Delta</td><td style=text-align:left>-78.97%</td><td style=text-align:left>3.87%</td><td style=text-align:left>-42.11%</td></tr><tr><td style=text-align:left>BenchmarkOldUnmarshal-4</td><td style=text-align:left>199 µs ± 3%</td><td style=text-align:left>4720</td><td style=text-align:left>1360</td></tr><tr><td style=text-align:left>BenchmarkNewUnmarshal-4</td><td style=text-align:left>94µs ± 5%</td><td style=text-align:left>4700</td><td style=text-align:left>1280</td></tr><tr><td style=text-align:left>Unmarshal Delta</td><td style=text-align:left>-52.93%</td><td style=text-align:left>-0.24%</td><td style=text-align:left>-5.38%</td></tr></tbody></table><p><strong>Large Data Size</strong></p><p>Data size: 6MB</p><table><thead><tr><th style=text-align:left>Benchmark</th><th style=text-align:left>time/op</th><th style=text-align:left>bytes/op</th><th style=text-align:left>allocs/op</th></tr></thead><tbody><tr><td style=text-align:left>BenchmarkOldMarshal-4</td><td style=text-align:left>58.7ms ± 5%</td><td style=text-align:left>6.96MB</td><td style=text-align:left>3350</td></tr><tr><td style=text-align:left>BenchmarkNewMarshal-4</td><td style=text-align:left>13.3ms ± 3%</td><td style=text-align:left>6.84MB</td><td style=text-align:left>10</td></tr><tr><td style=text-align:left>Marshal Delta</td><td style=text-align:left>-77.30%</td><td style=text-align:left>-1.71%</td><td style=text-align:left>-99.64%</td></tr><tr><td style=text-align:left>BenchmarkOldUnmarshal-4</td><td style=text-align:left>56.6ms ± 3%</td><td style=text-align:left>17.4MB</td><td style=text-align:left>391000</td></tr><tr><td style=text-align:left>BenchmarkNewUnmarshal-4</td><td style=text-align:left>26.8ms ± 5%</td><td style=text-align:left>17.5MB</td><td style=text-align:left>390000</td></tr><tr><td style=text-align:left>Unmarshal Delta</td><td style=text-align:left>-52.54%</td><td style=text-align:left>0.09%</td><td style=text-align:left>-0.37%</td></tr></tbody></table><h2 id=copy-free-serialization>Copy-free Serialization</h2><p>In some services with large request and response data, the cost of serialization and deserialization is high. There are two ways for optimization:</p><ul><li>Implement the optimization strategy on serialization and deserialization as described earlier.</li><li>Scheduling by copy-free serialization.</li></ul><h3 id=research-on-copy-free-serilization>Research on Copy-free Serilization</h3><p>RPC through copy-free serialization, which originated from the &ldquo;Cap &rsquo;n Proto&rdquo; project of Kenton Varda. &ldquo;Cap &rsquo;n Proto&rdquo; provides a set of data exchange formats and corresponding codec libraries.</p><p>In essence, &ldquo;Cap &rsquo;n Proto&rdquo; creates a bytes slice as buffer, and all read & write operations on data structures are directly operated on buffer. After reading & writing, information contained by the buffer is added to the head and can be sent directly. And the peer end can read it after receiving it. Since there is no Go structure as an intermediate storage, serialization and deserialization are not required.</p><p>To briefly summarize the characteristics of &ldquo;Cap &rsquo;n Proto&rdquo;:</p><ul><li>All data is read and written to a contiguous memory.</li><li>The serialization operation is preceded. &ldquo;Get/Set&rdquo; data and encoding process in parallel.</li><li>In the data exchange format, pointer (&ldquo;offset&rdquo; at the data memory) mechanism is used to store data at any location in the contiguous memory, so that data in the structure can be read and written in any order.<ul><li>Fixed-size fields of a structure are rearranged so that they are stored in contiguous memory.</li><li>Fields with indeterminate size of a structure (e.g. list), are represented by a fixed-size pointer that stores information including the location of the data.</li></ul></li></ul><p>First of all, &ldquo;Cap &rsquo;n Proto&rdquo; has no Go language structure as an intermediate carrier, which can reduce a copy. Then, &ldquo;Cap &rsquo;n Proto&rdquo; operates on a contiguous memory, and the read and write of coded data can be completed at once. Because of these two reasons, Cap &rsquo;n Proto has excellent performance.</p><p>Here are the benchmarks of &ldquo;Thrift&rdquo; and &ldquo;Cap &rsquo;n Proto&rdquo; for the same data structure. Considering that &ldquo;Cap &rsquo;n Proto&rdquo; presets the codec operation, we compare the complete process including data initialization. That is, structure data initialization + (serialization) + write buffer + read from buffer + (deserialization) + read from structure.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Thrift data-lang=Thrift><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MyTest</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Num</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ano</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ano</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>list</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Nums</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// 长度131072 大小1MB
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ano</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Num</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>Benchmark</th><th style=text-align:left>Iter</th><th style=text-align:left>time/op</th><th style=text-align:left>bytes/op</th><th style=text-align:left>alloc/op</th></tr></thead><tbody><tr><td style=text-align:left>BenchmarkThriftReadWrite</td><td style=text-align:left>172</td><td style=text-align:left>6855840 ns/op</td><td style=text-align:left>3154209 B/op</td><td style=text-align:left>545 allocs/op</td></tr><tr><td style=text-align:left>BenchmarkCapnpReadWrite</td><td style=text-align:left>1500</td><td style=text-align:left>844924 ns/op</td><td style=text-align:left>2085713 B/op</td><td style=text-align:left>9 allocs/op</td></tr><tr><td style=text-align:left>ReadWrite Delta</td><td style=text-align:left>/</td><td style=text-align:left>-87.68%</td><td style=text-align:left>-33.88%</td><td style=text-align:left>-98.35%</td></tr></tbody></table><p>(deserialization) + read data, depending on the size of data package,&ldquo;Cap &rsquo;n Proto&rdquo; performance is about 8-9 times better than &ldquo;Thrift&rdquo;. Write data + (serialization), depending on the size of data package, &ldquo;Cap &rsquo;n Proto&rdquo; performance is approximately 2-8 times better than &ldquo;Thrift&rdquo;. Overall performance of &ldquo;Cap &rsquo;n Proto&rdquo; is approximately 4-8 times better than &ldquo;Thrift&rdquo;.</p><p>Previously, we discussed the advantages of &ldquo;Cap &rsquo;n Proto&rdquo;. We will then summarize some problems existing in &ldquo;Cap &rsquo;n Proto&rdquo;:</p><ul><li>One problem with the contiguous memory of Cap &rsquo;n Proto is that when the data of variable size is resized, and the required space is larger than the original space, the space of the original data can only be reallocated later. As a result, the original space becomes a hole that cannot be removed. This problem gets worse as the call link is resized, and can only be solved with strict constraints throughout the link: avoid resizing variable size fields, and when resize is necessary, rebuild a structure and make a deep copy of the data.</li><li>&ldquo;Cap &rsquo;n Proto&rdquo; has no Go language structure as an intermediate carrier, so all fields can only be read and written through the interface, resulting in poor user experience.</li></ul><h3 id=thrift-protocols-compatible-copy-free-serialization>Thrift Protocol‘s Compatible Copy-free Serialization</h3><p>In order to support copy-free serialization better and more efficiently, &ldquo;Cap &rsquo;n Proto&rdquo; uses a self-developed codec format, but it is difficult to be implemented in the current environment where &ldquo;Thrift&rdquo; and &ldquo;ProtoBuf&rdquo; are dominant. In order to achieve the performance of copy-free serialization with protocol compatibility, we started the exploration of copy-free serialization that is compatible with &ldquo;Thrift&rdquo; protocol.</p><p>&ldquo;Cap &rsquo;n Proto&rdquo; is a benchmark for copy-free serialization, so let&rsquo;s see if the optimizations on &ldquo;Cap &rsquo;n Proto&rdquo; can be applied to Thrift:</p><ul><li>Nature is the core of copy-free serialization, which does not use Go structure as intermediate carriers to reduce one copy. This optimization is not about a particular protocol and can be applied to any existing protocol (So it&rsquo;s naturally compatible with the Thrift protocol), but the user experience of &ldquo;Cap &rsquo;n Proto&rdquo; reflects that it needs to be carefully polished.</li><li>&ldquo;Cap &rsquo;n Proto&rdquo; is operated on a contiguous memory. The read & write of the encoded data can be completed at once. &ldquo;Cap &rsquo;n Proto&rdquo; can operate on contiguous memory because there is a pointer mechanism that allows data to be stored anywhere, allowing fields to be written in any order without affecting decoding. However, it is very likely to leave a hole in the resize due to misoperation on contiguous memory. Besides, &ldquo;Thrift&rdquo; has no pointer alike mechanism, so it has stricter requirements on data layout. Here are two ways to approach such problems:<ul><li>Insist on operating in contiguous memory, while imposing strict regulations on users&rsquo; usage: 1. Resize operation must rebuild the data structure; 2. When a structure is nested, there are strict requirements on the order in which the fields are written (we can think of it as unfolding a nested structure from the outside in, and being written in the same order) . In addition, due to TLV encoding such as Binary, when writing begins for each nesting, it requires declaration (such as &ldquo;StartWriteFieldX&rdquo;).</li><li>Operating not entirely in contiguous memory, alterable fields are allocated a separate piece of memory. Since memory is not completely contiguous, the write operation can&rsquo;t complete the output at once. In order to get closer to the performance of writing data at once, we adopted a linked buffer scheme. On the one hand, when the variable field resize occurs, only one node of the linked buffer is replaced, and there is no need to reconstruct the structure like &ldquo;Cap &rsquo;n Proto”. On the other hand, there is no need to clarify the actual structure like &ldquo;Thrift&rdquo; when the output is needed, just write the buffer on the link.</li></ul></li></ul><p>To summarize what we have determined previously: 1. Do not use Go structure as the intermediate carrier, directly operate the underlying memory through the interface, and complete the codec at the same time of &ldquo;Get/Set&rdquo;. 2. Data is stored through a linked buffer.</p><p>Then let&rsquo;s take a look at the remaining issues:</p><ul><li>Degradation of the user experience caused by not using Go structures.<ul><li>Solution: Improve the user experience of &ldquo;Get/Set&rdquo; interface and make it as easy to use as the Go structure.</li></ul></li><li>Binary Format of &ldquo;Cap &rsquo;n Proto&rdquo; is designed specifically for copy-free serialization scenarios, and although decoding is performed once for every Get, the decoding costs are minimal. The &ldquo;Thrift&rdquo; protocol (taking &ldquo;Binary&rdquo; as an example) has no mechanism that is similar to pointer. When there are multiple fields of variable size or nesting, they must be resolved sequentially instead of directly calculating the offset to get the field data location. Moreover, the cost of sequential resolution for each Get is too high.<ul><li>Solution: In addition to recording the structure&rsquo;s buffer nodes, we also add an index that records the pointer to the buffer node at the beginning of each field with unfixed size. The following is the ultimate performance comparison test between the current copy-free serialization scheme and &ldquo;FastRead/Write&rdquo; under the condition of 4 cores:</li></ul></li></ul><table><thead><tr><th style=text-align:left>Package Size</th><th style=text-align:left>Type</th><th style=text-align:left>QPS</th><th style=text-align:left>TP90</th><th style=text-align:left>TP99</th><th style=text-align:left>TP999</th><th style=text-align:left>CPU</th></tr></thead><tbody><tr><td style=text-align:left>1KB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>70,700</td><td style=text-align:left>1 ms</td><td style=text-align:left>3 ms</td><td style=text-align:left>6 ms</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>82,490</td><td style=text-align:left>1 ms</td><td style=text-align:left>2 ms</td><td style=text-align:left>4 ms</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>2KB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>65,000</td><td style=text-align:left>1 ms</td><td style=text-align:left>4 ms</td><td style=text-align:left>9 ms</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>72,000</td><td style=text-align:left>1 ms</td><td style=text-align:left>2 ms</td><td style=text-align:left>8 ms</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>4KB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>56,400</td><td style=text-align:left>2 ms</td><td style=text-align:left>5 ms</td><td style=text-align:left>10 ms</td><td style=text-align:left>380%</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>52,700</td><td style=text-align:left>2 ms</td><td style=text-align:left>4 ms</td><td style=text-align:left>10 ms</td><td style=text-align:left>380%</td></tr><tr><td style=text-align:left>32KB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>27,400</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>19,500</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>1MB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>986</td><td style=text-align:left>53 ms</td><td style=text-align:left>56 ms</td><td style=text-align:left>59 ms</td><td style=text-align:left>260%</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>942</td><td style=text-align:left>55 ms</td><td style=text-align:left>59 ms</td><td style=text-align:left>62 ms</td><td style=text-align:left>290%</td></tr><tr><td style=text-align:left>10MB</td><td style=text-align:left>Non-serialization</td><td style=text-align:left>82</td><td style=text-align:left>630 ms</td><td style=text-align:left>640 ms</td><td style=text-align:left>645 ms</td><td style=text-align:left>240%</td></tr><tr><td style=text-align:left></td><td style=text-align:left>FastWrite/FastRead</td><td style=text-align:left>82</td><td style=text-align:left>630 ms</td><td style=text-align:left>640 ms</td><td style=text-align:left>640 ms</td><td style=text-align:left>270</td></tr></tbody></table><p>Summary of the test results:</p><ul><li>In small data package scenario, performance of non-serialization is poorer - about 85% of FastWrite/FastRead&rsquo;s performance.</li><li>In large data package scenario, the performance of non-serialization is better. When processing packages larger than 4K, the performance of non-serialization is 7%-40% better compared with &ldquo;FastWrite/FastRead&rdquo;.</li></ul><h2 id=postscript>Postscript</h2><p>Hope the above sharing can be helpful to the community. At the same time, we are trying to share memory-based IPC, io_uring, TCP zero copy, RDMA, etc., to better improve Kitex performance. And we will also focus on improving the communication scenarios of the same device and container. Welcome to join us and contribute to Go ecology together!</p><h2 id=reference>Reference</h2><ul><li><a href=https://github.com/alecthomas/go_serialization_benchmarks>https://github.com/alecthomas/go_serialization_benchmarks</a></li><li><a href=https://capnproto.org/>https://capnproto.org/</a></li><li><a href=https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html>Intel C++ Compiler Classic Developer Guide and Reference</a></li></ul><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/09/13/cloudwego-open-source-announcement/ aria-label="Previous - CloudWeGo Open Source Announcement" class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/ aria-label="Next - Getting Started With Kitex's Practice: Performance Testing Guide" class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-636ce3c5c9ef4828"></script></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fab fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/main.min.9a8648b987db06195f5768f0d7516e8df7c27669e91e383e25c5d07cd6325605.js integrity="sha256-moZIuYfbBhlfV2jw11FujffCdmnpHjg+JcXQfNYyVgU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>