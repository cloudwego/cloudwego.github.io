<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.142.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Eino: Callback Manual | CloudWeGo</title>
<meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="Eino: Callback Manual"><meta property="og:description" content="Problem Solved Components (including Lambda) and Graph orchestration together solve the problem of “defining business logic.” However, cross-cutting features such as logging, tracing, metrics, and on-screen display need mechanisms to inject functionality into Components (including Lambda) and Graphs.
On the other hand, users might want to obtain intermediate information during the execution process of a specific Component implementation. For instance, VikingDBRetriever might provide additional query DB Names, and ArkChatModel might provide additional parameters like the requested temperature. There needs to be a mechanism to expose intermediate states."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:published_time" content="2025-02-21T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-07T17:25:05+08:00"><meta itemprop=name content="Eino: Callback Manual"><meta itemprop=description content="Problem Solved Components (including Lambda) and Graph orchestration together solve the problem of “defining business logic.” However, cross-cutting features such as logging, tracing, metrics, and on-screen display need mechanisms to inject functionality into Components (including Lambda) and Graphs.
On the other hand, users might want to obtain intermediate information during the execution process of a specific Component implementation. For instance, VikingDBRetriever might provide additional query DB Names, and ArkChatModel might provide additional parameters like the requested temperature. There needs to be a mechanism to expose intermediate states."><meta itemprop=datePublished content="2025-02-21T00:00:00+00:00"><meta itemprop=dateModified content="2025-03-07T17:25:05+08:00"><meta itemprop=wordCount content="3323"><meta name=twitter:card content="summary"><meta name=twitter:title content="Eino: Callback Manual"><meta name=twitter:description content="Problem Solved Components (including Lambda) and Graph orchestration together solve the problem of “defining business logic.” However, cross-cutting features such as logging, tracing, metrics, and on-screen display need mechanisms to inject functionality into Components (including Lambda) and Graphs.
On the other hand, users might want to obtain intermediate information during the execution process of a specific Component implementation. For instance, VikingDBRetriever might provide additional query DB Names, and ArkChatModel might provide additional parameters like the requested temperature. There needs to be a mechanism to expose intermediate states."><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css as=style><link href=/scss/main.min.b3c21c777309e05201dd625b8a4ece4076249bfa52b71d58c6e352d84c6c0320.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")}</script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu active"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/docs/volo/>Volo</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/docs/cwgo/>Cwgo</a>
<a class=dropdown-item href=/docs/eino/>Eino</a>
<a class=dropdown-item href=/docs/monolake/>Monolake</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cooperation/><span>Cooperation</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Security</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/security/safety-bulletin/>safety-bulletin</a>
<a class=dropdown-item href=/security/vulnerability-reporting/>vulnerability-reporting</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li><a href=/docs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Documentation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docseino-li><input type=checkbox id=m-docseino-check checked>
<label for=m-docseino-check><a href=/docs/eino/ title="Eino: User Manual" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseino><span>Eino</span></a></label><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinooverview-li><input type=checkbox id=m-docseinooverview-check checked>
<label for=m-docseinooverview-check><a href=/docs/eino/overview/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinooverview><span>Eino: Overview</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinooverviewbytedance_eino_practice-li><input type=checkbox id=m-docseinooverviewbytedance_eino_practice-check>
<label for=m-docseinooverviewbytedance_eino_practice-check><a href=/docs/eino/overview/bytedance_eino_practice/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinooverviewbytedance_eino_practice><span>Bytedance LLM Application Go Development Framework-Eino Practice</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoovervieweino_framework_structure-li><input type=checkbox id=m-docseinoovervieweino_framework_structure-check>
<label for=m-docseinoovervieweino_framework_structure-check><a href=/docs/eino/overview/eino_framework_structure/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoovervieweino_framework_structure><span>The structure of the Eino Framework</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoovervieweino_open_source-li><input type=checkbox id=m-docseinoovervieweino_open_source-check>
<label for=m-docseinoovervieweino_open_source-check><a href=/docs/eino/overview/eino_open_source/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoovervieweino_open_source><span>Large Language Model Application Development Framework — Eino is Now Open Source!</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoquick_start-li><input type=checkbox id=m-docseinoquick_start-check checked>
<label for=m-docseinoquick_start-check><a href=/docs/eino/quick_start/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoquick_start><span>Eino: Quick start</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoquick_startsimple_llm_application-li><input type=checkbox id=m-docseinoquick_startsimple_llm_application-check>
<label for=m-docseinoquick_startsimple_llm_application-check><a href=/docs/eino/quick_start/simple_llm_application/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoquick_startsimple_llm_application><span>Implement an easy LLM application</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoquick_startagent_llm_with_tools-li><input type=checkbox id=m-docseinoquick_startagent_llm_with_tools-check>
<label for=m-docseinoquick_startagent_llm_with_tools-check><a href=/docs/eino/quick_start/agent_llm_with_tools/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoquick_startagent_llm_with_tools><span>Agent-Enable LLM to have hands</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docseinocore_modules-li><input type=checkbox id=m-docseinocore_modules-check checked>
<label for=m-docseinocore_modules-check><a href=/docs/eino/core_modules/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_modules><span>Eino: Core Modules</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinocore_modulesflow_integration_components-li><input type=checkbox id=m-docseinocore_modulesflow_integration_components-check>
<label for=m-docseinocore_modulesflow_integration_components-check><a href=/docs/eino/core_modules/flow_integration_components/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_modulesflow_integration_components><span>Eino: Flow integration components</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulesflow_integration_componentsmulti_agent_hosting-li><input type=checkbox id=m-docseinocore_modulesflow_integration_componentsmulti_agent_hosting-check>
<label for=m-docseinocore_modulesflow_integration_componentsmulti_agent_hosting-check><a href=/docs/eino/core_modules/flow_integration_components/multi_agent_hosting/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulesflow_integration_componentsmulti_agent_hosting><span>Eino Tutorial: Host Multi-Agent</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulesflow_integration_componentsreact_agent_manual-li><input type=checkbox id=m-docseinocore_modulesflow_integration_componentsreact_agent_manual-check>
<label for=m-docseinocore_modulesflow_integration_componentsreact_agent_manual-check><a href=/docs/eino/core_modules/flow_integration_components/react_agent_manual/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulesflow_integration_componentsreact_agent_manual><span>Eino: React Agent Manual</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docseinocore_moduleschain_and_graph_orchestration-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestration-check checked>
<label for=m-docseinocore_moduleschain_and_graph_orchestration-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_moduleschain_and_graph_orchestration><span>Eino: Chain & Graph Orchestration</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docseinocore_moduleschain_and_graph_orchestrationcallback_manual-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestrationcallback_manual-check checked>
<label for=m-docseinocore_moduleschain_and_graph_orchestrationcallback_manual-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docseinocore_moduleschain_and_graph_orchestrationcallback_manual><span class=td-sidebar-nav-active-item>Eino: Callback Manual</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-check>
<label for=m-docseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/chain_graph_introduction/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_moduleschain_and_graph_orchestrationchain_graph_introduction><span>Eino: Chain/Graph Orchestration Introduction</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-check>
<label for=m-docseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/orchestration_design_principles/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_moduleschain_and_graph_orchestrationorchestration_design_principles><span>Eino: The design concept of orchestration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-check>
<label for=m-docseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_moduleschain_and_graph_orchestrationstream_programming_essentials><span>Eino Points of Streaming Orchestration</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-li><input type=checkbox id=m-docseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-check>
<label for=m-docseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities-check><a href=/docs/eino/core_modules/chain_and_graph_orchestration/call_option_capabilities/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_moduleschain_and_graph_orchestrationcall_option_capabilities><span>Eino: CallOption capabilities and specification</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinocore_modulescomponents-li><input type=checkbox id=m-docseinocore_modulescomponents-check>
<label for=m-docseinocore_modulescomponents-check><a href=/docs/eino/core_modules/components/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_modulescomponents><span>Eino: Components</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentschat_model_guide-li><input type=checkbox id=m-docseinocore_modulescomponentschat_model_guide-check>
<label for=m-docseinocore_modulescomponentschat_model_guide-check><a href=/docs/eino/core_modules/components/chat_model_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentschat_model_guide><span>Eino: ChatModel guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentschat_template_guide-li><input type=checkbox id=m-docseinocore_modulescomponentschat_template_guide-check>
<label for=m-docseinocore_modulescomponentschat_template_guide-check><a href=/docs/eino/core_modules/components/chat_template_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentschat_template_guide><span>Eino: ChatTemplate guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinocore_modulescomponentsdocument_loader_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsdocument_loader_guide-check>
<label for=m-docseinocore_modulescomponentsdocument_loader_guide-check><a href=/docs/eino/core_modules/components/document_loader_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_modulescomponentsdocument_loader_guide><span>Eino: Document Loader guide</span></a></label><ul class="ul-5 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-check>
<label for=m-docseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide-check><a href=/docs/eino/core_modules/components/document_loader_guide/document_parser_interface_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentsdocument_loader_guidedocument_parser_interface_guide><span>Eino: Document Parser guide</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentsdocument_transformer_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsdocument_transformer_guide-check>
<label for=m-docseinocore_modulescomponentsdocument_transformer_guide-check><a href=/docs/eino/core_modules/components/document_transformer_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentsdocument_transformer_guide><span>Eino: Document Transformer guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentsembedding_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsembedding_guide-check>
<label for=m-docseinocore_modulescomponentsembedding_guide-check><a href=/docs/eino/core_modules/components/embedding_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentsembedding_guide><span>Eino: Embedding guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentsindexer_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsindexer_guide-check>
<label for=m-docseinocore_modulescomponentsindexer_guide-check><a href=/docs/eino/core_modules/components/indexer_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentsindexer_guide><span>Eino: Indexer guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentslambda_guide-li><input type=checkbox id=m-docseinocore_modulescomponentslambda_guide-check>
<label for=m-docseinocore_modulescomponentslambda_guide-check><a href=/docs/eino/core_modules/components/lambda_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentslambda_guide><span>Eino: Lambda guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentsretriever_guide-li><input type=checkbox id=m-docseinocore_modulescomponentsretriever_guide-check>
<label for=m-docseinocore_modulescomponentsretriever_guide-check><a href=/docs/eino/core_modules/components/retriever_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentsretriever_guide><span>Eino: Retriever guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulescomponentstools_node_guide-li><input type=checkbox id=m-docseinocore_modulescomponentstools_node_guide-check>
<label for=m-docseinocore_modulescomponentstools_node_guide-check><a href=/docs/eino/core_modules/components/tools_node_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulescomponentstools_node_guide><span>Eino: ToolsNode guide</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinocore_modulesdevops-li><input type=checkbox id=m-docseinocore_modulesdevops-check>
<label for=m-docseinocore_modulesdevops-check><a href=/docs/eino/core_modules/devops/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinocore_modulesdevops><span>EinoDev: Devops tools</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulesdevopside_plugin_guide-li><input type=checkbox id=m-docseinocore_modulesdevopside_plugin_guide-check>
<label for=m-docseinocore_modulesdevopside_plugin_guide-check><a href=/docs/eino/core_modules/devops/ide_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulesdevopside_plugin_guide><span>EinoDev IDE Plugin Introduction</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulesdevopsvisual_orchestration_plugin_guide-li><input type=checkbox id=m-docseinocore_modulesdevopsvisual_orchestration_plugin_guide-check>
<label for=m-docseinocore_modulesdevopsvisual_orchestration_plugin_guide-check><a href=/docs/eino/core_modules/devops/visual_orchestration_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulesdevopsvisual_orchestration_plugin_guide><span>EinoDev visual orchestration plugin guide</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinocore_modulesdevopsvisual_debug_plugin_guide-li><input type=checkbox id=m-docseinocore_modulesdevopsvisual_debug_plugin_guide-check>
<label for=m-docseinocore_modulesdevopsvisual_debug_plugin_guide-check><a href=/docs/eino/core_modules/devops/visual_debug_plugin_guide/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinocore_modulesdevopsvisual_debug_plugin_guide><span>EinoDev visual debug plugin guide</span></a></label></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystem-li><input type=checkbox id=m-docseinoecosystem-check checked>
<label for=m-docseinoecosystem-check><a href=/docs/eino/ecosystem/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystem><span>Eino: Ecosystem</span></a></label><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemcallbacks-li><input type=checkbox id=m-docseinoecosystemcallbacks-check>
<label for=m-docseinoecosystemcallbacks-check><a href=/docs/eino/ecosystem/callbacks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemcallbacks><span>Callbacks</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemcallbackscallback_apmplus-li><input type=checkbox id=m-docseinoecosystemcallbackscallback_apmplus-check>
<label for=m-docseinoecosystemcallbackscallback_apmplus-check><a href=/docs/eino/ecosystem/callbacks/callback_apmplus/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemcallbackscallback_apmplus><span>Callback - APMPlus</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemcallbackscallback_langfuse-li><input type=checkbox id=m-docseinoecosystemcallbackscallback_langfuse-check>
<label for=m-docseinoecosystemcallbackscallback_langfuse-check><a href=/docs/eino/ecosystem/callbacks/callback_langfuse/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemcallbackscallback_langfuse><span>Callback - Langfuse</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemchat_model-li><input type=checkbox id=m-docseinoecosystemchat_model-check>
<label for=m-docseinoecosystemchat_model-check><a href=/docs/eino/ecosystem/chat_model/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemchat_model><span>ChatModel</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemchat_modelchat_model_ark-li><input type=checkbox id=m-docseinoecosystemchat_modelchat_model_ark-check>
<label for=m-docseinoecosystemchat_modelchat_model_ark-check><a href=/docs/eino/ecosystem/chat_model/chat_model_ark/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemchat_modelchat_model_ark><span>ChatModel - ARK</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemchat_modelchat_model_ollama-li><input type=checkbox id=m-docseinoecosystemchat_modelchat_model_ollama-check>
<label for=m-docseinoecosystemchat_modelchat_model_ollama-check><a href=/docs/eino/ecosystem/chat_model/chat_model_ollama/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemchat_modelchat_model_ollama><span>ChatModel - Ollama</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemchat_modelchat_model_openai-li><input type=checkbox id=m-docseinoecosystemchat_modelchat_model_openai-check>
<label for=m-docseinoecosystemchat_modelchat_model_openai-check><a href=/docs/eino/ecosystem/chat_model/chat_model_openai/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemchat_modelchat_model_openai><span>ChatModel - OpenAI</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemdocument-li><input type=checkbox id=m-docseinoecosystemdocument-check>
<label for=m-docseinoecosystemdocument-check><a href=/docs/eino/ecosystem/document/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemdocument><span>Document</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentsplitter_markdown-li><input type=checkbox id=m-docseinoecosystemdocumentsplitter_markdown-check>
<label for=m-docseinoecosystemdocumentsplitter_markdown-check><a href=/docs/eino/ecosystem/document/splitter_markdown/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentsplitter_markdown><span>Splitter - markdown</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentloader_amazon_s3-li><input type=checkbox id=m-docseinoecosystemdocumentloader_amazon_s3-check>
<label for=m-docseinoecosystemdocumentloader_amazon_s3-check><a href=/docs/eino/ecosystem/document/loader_amazon_s3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentloader_amazon_s3><span>Loader - amazon s3</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentloader_local_file-li><input type=checkbox id=m-docseinoecosystemdocumentloader_local_file-check>
<label for=m-docseinoecosystemdocumentloader_local_file-check><a href=/docs/eino/ecosystem/document/loader_local_file/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentloader_local_file><span>Loader - local file</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentloader_web_url-li><input type=checkbox id=m-docseinoecosystemdocumentloader_web_url-check>
<label for=m-docseinoecosystemdocumentloader_web_url-check><a href=/docs/eino/ecosystem/document/loader_web_url/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentloader_web_url><span>Loader - web url</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentparser_html-li><input type=checkbox id=m-docseinoecosystemdocumentparser_html-check>
<label for=m-docseinoecosystemdocumentparser_html-check><a href=/docs/eino/ecosystem/document/parser_html/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentparser_html><span>Parser - html</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentparser_pdf-li><input type=checkbox id=m-docseinoecosystemdocumentparser_pdf-check>
<label for=m-docseinoecosystemdocumentparser_pdf-check><a href=/docs/eino/ecosystem/document/parser_pdf/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentparser_pdf><span>Parser - pdf</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentsplitter_recursive-li><input type=checkbox id=m-docseinoecosystemdocumentsplitter_recursive-check>
<label for=m-docseinoecosystemdocumentsplitter_recursive-check><a href=/docs/eino/ecosystem/document/splitter_recursive/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentsplitter_recursive><span>Splitter - recursive</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemdocumentsplitter_semantic-li><input type=checkbox id=m-docseinoecosystemdocumentsplitter_semantic-check>
<label for=m-docseinoecosystemdocumentsplitter_semantic-check><a href=/docs/eino/ecosystem/document/splitter_semantic/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemdocumentsplitter_semantic><span>Splitter - semantic</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemembedding-li><input type=checkbox id=m-docseinoecosystemembedding-check>
<label for=m-docseinoecosystemembedding-check><a href=/docs/eino/ecosystem/embedding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemembedding><span>Embedding</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemembeddingembedding_openai-li><input type=checkbox id=m-docseinoecosystemembeddingembedding_openai-check>
<label for=m-docseinoecosystemembeddingembedding_openai-check><a href=/docs/eino/ecosystem/embedding/embedding_openai/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemembeddingembedding_openai><span>Embedding - OpenAI</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemembeddingembedding_ark-li><input type=checkbox id=m-docseinoecosystemembeddingembedding_ark-check>
<label for=m-docseinoecosystemembeddingembedding_ark-check><a href=/docs/eino/ecosystem/embedding/embedding_ark/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemembeddingembedding_ark><span>Embedding - ARK</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemindexer-li><input type=checkbox id=m-docseinoecosystemindexer-check>
<label for=m-docseinoecosystemindexer-check><a href=/docs/eino/ecosystem/indexer/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemindexer><span>Indexer</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemindexerindexer_volc_vikingdb-li><input type=checkbox id=m-docseinoecosystemindexerindexer_volc_vikingdb-check>
<label for=m-docseinoecosystemindexerindexer_volc_vikingdb-check><a href=/docs/eino/ecosystem/indexer/indexer_volc_vikingdb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemindexerindexer_volc_vikingdb><span>Indexer - volc VikingDB</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemretriever-li><input type=checkbox id=m-docseinoecosystemretriever-check>
<label for=m-docseinoecosystemretriever-check><a href=/docs/eino/ecosystem/retriever/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemretriever><span>Retriever</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemretrieverretriever_volc_vikingdb-li><input type=checkbox id=m-docseinoecosystemretrieverretriever_volc_vikingdb-check>
<label for=m-docseinoecosystemretrieverretriever_volc_vikingdb-check><a href=/docs/eino/ecosystem/retriever/retriever_volc_vikingdb/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemretrieverretriever_volc_vikingdb><span>Retriever - volc VikingDB</span></a></label></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docseinoecosystemtool-li><input type=checkbox id=m-docseinoecosystemtool-check>
<label for=m-docseinoecosystemtool-check><a href=/docs/eino/ecosystem/tool/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docseinoecosystemtool><span>Tool</span></a></label><ul class="ul-4 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemtooltool_duckduckgo_search-li><input type=checkbox id=m-docseinoecosystemtooltool_duckduckgo_search-check>
<label for=m-docseinoecosystemtooltool_duckduckgo_search-check><a href=/docs/eino/ecosystem/tool/tool_duckduckgo_search/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemtooltool_duckduckgo_search><span>Tool - DuckDuckGoSearch</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docseinoecosystemtooltool_googlesearch-li><input type=checkbox id=m-docseinoecosystemtooltool_googlesearch-check>
<label for=m-docseinoecosystemtooltool_googlesearch-check><a href=/docs/eino/ecosystem/tool/tool_googlesearch/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docseinoecosystemtooltool_googlesearch><span>Tool - Googlesearch</span></a></label></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en//docs/eino/core_modules/chain_and_graph_orchestration/callback_manual target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en//docs/eino/core_modules/chain_and_graph_orchestration/callback_manual?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?labels=bug&amp;template=DOCS_UPDATE.md&amp;title=Eino:%20Callback%20Manual" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/eino/issues/new/choose target=_blank><i class="fas fa-tasks fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#problem-solved><strong>Problem Solved</strong></a></li><li><a href=#core-concepts><strong>Core Concepts</strong></a><ul><li><a href=#trigger-entities><strong>Trigger Entities</strong></a></li><li><a href=#trigger-timings><strong>Trigger Timings</strong></a></li><li><a href=#callback-handler><strong>Callback Handler</strong></a></li><li><a href=#runinfo><strong>RunInfo</strong></a></li><li><a href=#callback-input--output><strong>Callback Input & Output</strong></a></li></ul></li><li><a href=#injecting-handlers>Injecting Handlers</a><ul><li><a href=#globally-injecting-handlers><strong>Globally Injecting Handlers</strong></a></li><li><a href=#injecting-handlers-into-the-graph><strong>Injecting Handlers into the Graph</strong></a></li><li><a href=#injecting-handlers-outside-the-graph><strong>Injecting Handlers Outside the Graph</strong></a></li><li><a href=#handler-inheritance><strong>Handler Inheritance</strong></a></li></ul></li><li><a href=#injecting-runinfo><strong>Injecting RunInfo</strong></a><ul><li><a href=#runinfo-managed-by-the-graph><strong>RunInfo Managed by the Graph</strong></a></li><li><a href=#injecting-runinfo-outside-the-graph><strong>Injecting RunInfo Outside the Graph</strong></a></li></ul></li><li><a href=#trigger-methods><strong>Trigger Methods</strong></a><ul><li><a href=#component-callback><strong>Component Callback</strong></a></li><li><a href=#graph-node-trigger-node-callback>Graph Node Trigger (Node Callback)</a></li><li><a href=#graph-self-trigger-graph-callback><strong>Graph Self Trigger (Graph Callback)</strong></a></li></ul></li><li><a href=#parsing-callback-input--output><strong>Parsing Callback Input & Output</strong></a></li><li><a href=#handler-implementation>Handler Implementation</a><ul><li><a href=#handlerhelper><strong>HandlerHelper</strong></a></li><li><a href=#handlerbuilder><strong>HandlerBuilder</strong></a></li></ul></li><li><a href=#best-practices><strong>Best Practices</strong></a><ul><li><a href=#usage-in-graph><strong>Usage in Graph</strong></a></li><li><a href=#usage-outside-of-graph><strong>Usage Outside of Graph</strong></a></li><li><a href=#handler-readingwriting-of-input--output><strong>Handler Reading/Writing of Input & Output</strong></a></li><li><a href=#information-transfer-between-handlers><strong>Information Transfer Between Handlers</strong></a></li><li><a href=#always-close-streams><strong>Always Close Streams</strong></a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudwego.io/docs/>Documentation</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/docs/eino/>Eino</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/docs/eino/core_modules/>Eino: Core Modules</a></li><li class=breadcrumb-item><a href=https://www.cloudwego.io/docs/eino/core_modules/chain_and_graph_orchestration/>Eino: Chain & Graph Orchestration</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudwego.io/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual/>Eino: Callback Manual</a></li></ol></nav><div class=td-content><h1>Eino: Callback Manual</h1><header class=article-meta></header><h2 id=problem-solved><strong>Problem Solved</strong></h2><p>Components (including Lambda) and Graph orchestration together solve the problem of &ldquo;defining business logic.&rdquo; However, cross-cutting features such as logging, tracing, metrics, and on-screen display need mechanisms to inject functionality into Components (including Lambda) and Graphs.</p><p>On the other hand, users might want to obtain intermediate information during the execution process of a specific Component implementation. For instance, VikingDBRetriever might provide additional query DB Names, and ArkChatModel might provide additional parameters like the requested temperature. There needs to be a mechanism to expose intermediate states.</p><p>Callbacks support both &ldquo;<strong>cross-cutting feature injection</strong>&rdquo; and &ldquo;<strong>intermediate state exposure</strong>&rdquo;. Specifically, users provide and register &ldquo;functions&rdquo; (Callback Handlers). Components and Graphs call back these functions at designated &ldquo;times&rdquo; (or cut points, locations) and provide the corresponding information.</p><h2 id=core-concepts><strong>Core Concepts</strong></h2><p>The core concepts interconnected within Eino include entities such as Components and Graphs, which at specific <strong>timings</strong> (Callback Timing), callback user-provided <strong>functions</strong> (Callback Handlers), conveying <strong>what they are</strong> (RunInfo), and <strong>what happened</strong> at that moment (Callback Input & Output).</p><h3 id=trigger-entities><strong>Trigger Entities</strong></h3><p>Component (including types defined officially and Lambda), Graph Node (as well as Chain Node), and the Graph itself (including Chain). These three types of entities require cross-cutting functionality injection and intermediate state exposure, thus they all trigger callbacks. See the section on “<a href=/en/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>Trigger Methods</a>” below for details.</p><h3 id=trigger-timings><strong>Trigger Timings</strong></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackTiming enumerates all the timing of callback aspects.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackTiming</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackTiming</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>const</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnStart</span> <span style=color:#000>CallbackTiming</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>iota</span> <span style=color:#8f5902;font-style:italic>// Enter and begin execution</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnEnd</span> <span style=color:#8f5902;font-style:italic>// Successfully complete and about to return</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnError</span> <span style=color:#8f5902;font-style:italic>// Fail and about to return an error</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnStartWithStreamInput</span> <span style=color:#8f5902;font-style:italic>// OnStart, but the input is StreamReader</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TimingOnEndWithStreamOutput</span> <span style=color:#8f5902;font-style:italic>// OnEnd, but the output is StreamReader</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>Different trigger entities, in various scenarios, determine whether to trigger OnStart or OnStartWithStreamInput (similarly, OnEnd/OnEndWithStreamOutput). Specific rules are detailed in the section on “<a href=/en/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>Trigger Methods</a>” below.</p><h3 id=callback-handler><strong>Callback Handler</strong></h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Handler</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>input</span> <span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStartWithStreamInput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEndWithStreamOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>A Handler is a struct that implements the 5 methods above (corresponding to the 5 trigger timings). Each method receives three pieces of information:</p><ul><li>Context: Used for <strong>receiving custom information</strong> that might be set by previous trigger timings of the same Handler.</li><li>RunInfo: Metadata of the entity triggering the callback.</li><li>Input/Output/InputStream/OutputStream: Business information at the time of triggering the callback.</li></ul><p>Each method also returns a new context: used for <strong>passing information between different trigger timings</strong> of the same Handler.</p><p>If a Handler does not want to focus on all 5 trigger timings but only a subset, for example, just OnStart, it is recommended to use <code>NewHandlerBuilder().OnStartFn(...).Build()</code>. If it only wants to focus on specific components, such as ChatModel, it is recommended to use <code>NewHandlerHelper().ChatModel(...).Handler()</code>, which receives callbacks from only ChatModel and obtains a specific type of CallbackInput/CallbackOutput. See the section on “<a href=/en/docs/eino/core_modules/chain_and_graph_orchestration/callback_manual>Handler Implementation Methods</a>” for details.</p><p>The order of triggering between different Handlers is <strong>not</strong> guaranteed.</p><h3 id=runinfo><strong>RunInfo</strong></h3><p>Describes the metadata of the entity that triggers the Callback.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// RunInfo contains information about the running component that triggers callbacks.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>RunInfo</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Name</span>      <span style=color:#204a87;font-weight:700>string</span>               <span style=color:#8f5902;font-style:italic>// the &#39;Name&#39; with semantic meaning for the running component, specified by end-user</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Type</span>      <span style=color:#204a87;font-weight:700>string</span>               <span style=color:#8f5902;font-style:italic>// the specific implementation &#39;Type&#39; of the component, e.g. &#39;OpenAI&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Component</span> <span style=color:#000>components</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Component</span> <span style=color:#8f5902;font-style:italic>// the component abstract type, e.g. &#39;ChatModel&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li>Name: Meaningful business name, to be specified by the user; if not specified, it defaults to an empty string. For different triggering entities:<ul><li>Component: When in Graph, use Node Name. When used standalone outside Graph, user sets it manually. See &ldquo;Injecting RunInfo&rdquo; and &ldquo;Using Component Standalone&rdquo; for details.</li><li>Graph Node: Use Node Name <code>func WithNodeName(n string) GraphAddNodeOpt</code></li><li>Graph itself:<ul><li>For the top-level graph, use Graph Name <code>func WithGraphName(graphName string) GraphCompileOption</code></li><li>For nested graphs, use the Node Name added when joining the upper-level graph.</li></ul></li></ul></li><li>Type: Specified by the component&rsquo;s specific implementation:<ul><li>Component with interface: If it implements Typer interface, use the result of the GetType() method. Otherwise, use reflection to get the Struct/Func name.</li><li>Lambda: If Type is specified using <code>func WithLambdaType(t string) LambdaOpt</code>, use it, otherwise it defaults to an empty string.</li><li>Graph Node: Use the value of the internal Component/Lambda/Graph.</li><li>Graph itself: Defaults to an empty string.</li></ul></li><li>Component:<ul><li>Component with interface: Corresponds to its interface.</li><li>Lambda: Fixed value Lambda.</li><li>Graph Node: Use the value of the internal Component/Lambda/Graph.</li><li>Graph itself: Fixed values Graph / Chain. (Previously had StateGraph / StateChain, now consolidated into Graph / Chain.)</li></ul></li></ul><h3 id=callback-input--output><strong>Callback Input & Output</strong></h3><p>Essentially of any type, as the input, output, and internal state of different Components can vary greatly.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackInput</span> <span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackOutput</span> <span style=color:#204a87;font-weight:700>any</span>
</span></span></code></pre></div><p>For a specific component, there are more specific types, such as Chat Model.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackInput is the input for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackInput</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Messages is the messages to be sent to the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Messages</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Tools is the tools to be used in the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Tools</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ToolInfo</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Config is the config for the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Config</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Extra is the extra information for the callback.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Extra</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// CallbackOutput is the output for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>CallbackOutput</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Message is the message generated by the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Message</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Config is the config for the model.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Config</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Config</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// TokenUsage is the token usage of this request.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>TokenUsage</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>TokenUsage</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// Extra is the extra information for the callback.</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Extra</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>any</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>In the specific implementation of Chat Model, such as OpenAI Chat Model, it is recommended that component authors pass specific Input/Output types to the Callback Handler instead of Any. This allows for more specific, customized intermediate state information to be exposed.</p><p>If a Graph Node triggers the Callback, since the Node cannot obtain the internal intermediate state information of the component, it can only get the input and output specified by the component interface. For Chat Model, this would be []*schema.Message and *schema.Message.</p><p>When the Graph itself triggers the Callback, the input and output are the overall input and output of the Graph.</p><h2 id=injecting-handlers>Injecting Handlers</h2><p>Handlers need to be injected into the Context to be triggered.</p><h3 id=globally-injecting-handlers><strong>Globally Injecting Handlers</strong></h3><p>Use <code>callbacks.InitCallbackHandlers</code> to inject global Handlers. Once injected, all triggered callback actions will automatically trigger these global Handlers. Typical scenarios include tracing, logging, and other globally consistent, business-agnostic functions.</p><p>It is not thread-safe. It is recommended to inject it once during service initialization.</p><h3 id=injecting-handlers-into-the-graph><strong>Injecting Handlers into the Graph</strong></h3><p>Use <code>compose.WithCallbacks</code> to inject Handlers at runtime within the graph. These Handlers will be effective throughout the current execution of the graph, including each Node within the Graph and the Graph itself (as well as any nested graphs).</p><p>Use <code>compose.WithCallbacks(...).DesignateNode(...)</code> to inject a Handler into a specific Node of the top-level Graph. If this Node itself is a nested Graph, it will be injected into the nested Graph itself and each Node within it.</p><p>Use <code>compose.WithCallbacks(...).DesignateNodeForPath(...)</code> to inject a Handler into a specific Node of a nested Graph.</p><h3 id=injecting-handlers-outside-the-graph><strong>Injecting Handlers Outside the Graph</strong></h3><p>If you do not want to use the Graph but still want to use Callbacks:</p><p>Use <code>InitCallbacks(ctx context.Context, info *RunInfo, handlers ...Handler)</code> to get a new Context and inject Handlers and RunInfo.</p><h3 id=handler-inheritance><strong>Handler Inheritance</strong></h3><p>Similar to how a child Context inherits all Values from its parent Context, a child Context will also inherit all Handlers from its parent Context. For example, if Handlers are already present in the Context passed into the Graph at runtime, these Handlers will be inherited and effective throughout the entire execution of the Graph.</p><h2 id=injecting-runinfo><strong>Injecting RunInfo</strong></h2><p>RunInfo also needs to be injected into the Context to be available to Handlers when callbacks are triggered.</p><h3 id=runinfo-managed-by-the-graph><strong>RunInfo Managed by the Graph</strong></h3><p>The Graph will automatically inject RunInfo for all internal Nodes. The mechanism is that each Node&rsquo;s execution is a new child Context, and the Graph injects the corresponding Node&rsquo;s RunInfo into this new Context.</p><h3 id=injecting-runinfo-outside-the-graph><strong>Injecting RunInfo Outside the Graph</strong></h3><p>If you do not want to use the Graph but still want to use Callbacks:</p><p>Use <code>InitCallbacks(ctx context.Context, info *RunInfo, handlers ...Handler)</code> to get a new Context and inject Handlers and RunInfo.</p><p>Use <code>ReuseHandlers(ctx context.Context, info *RunInfo)</code> to get a new Context, reuse the Handlers from the previous Context, and set the new RunInfo.</p><h2 id=trigger-methods><strong>Trigger Methods</strong></h2><p><a href=/img/eino/graph_node_callback_run_place.png target=_blank><img src=/img/eino/graph_node_callback_run_place.png width=100%></a></p><h3 id=component-callback><strong>Component Callback</strong></h3><p>In the implementation code of the component, call <code>OnStart(), OnEnd(), OnError(), OnStartWithStreamInput(), OnEndWithStreamInput()</code> from the callbacks package. Taking Ark&rsquo;s ChatModel implementation as an example, in the Generate method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Generate</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>in</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>opts</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>outMsg</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... instantiate req conf</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#000>ctx</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Tools</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rawTools</span><span style=color:#000;font-weight:700>),</span> <span style=color:#8f5902;font-style:italic>// join tool info from call options</span>
</span></span><span style=display:flex><span>       <span style=color:#000>ToolChoice</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span>                 <span style=color:#8f5902;font-style:italic>// not support in api</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... invoke Ark chat API and get the response</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnEnd</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span>    <span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>TokenUsage</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>toModelCallbackUsage</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseMeta</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>outMsg</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>In the Stream method:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Stream</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>in</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>opts</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Option</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>    <span style=color:#000>outStream</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>],</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>defer</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnError</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}()</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... instantiate req conf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>ctx</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnStart</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000>in</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Tools</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cm</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rawTools</span><span style=color:#000;font-weight:700>),</span> <span style=color:#8f5902;font-style:italic>// join tool info from call options</span>
</span></span><span style=display:flex><span>       <span style=color:#000>ToolChoice</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span>                 <span style=color:#8f5902;font-style:italic>// not support in api</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Config</span><span style=color:#000;font-weight:700>:</span>     <span style=color:#000>reqConf</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// omit multiple lines... make request to Ark API and convert response stream to StreamReader[model.*CallbackOutput]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sr</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>OnEndWithStreamOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sr</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReaderWithConvert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>sr</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>fmodel</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>             <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrNoValue</span>
</span></span><span style=display:flex><span>          <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>),</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>As can be seen, when the Generate method is called, OnEnd is triggered, whereas in the Stream method, OnEndWithStreamOutput is triggered:</p><p>When triggering Callbacks within the component implementation:</p><ul><li><strong>When the component input is StreamReader, trigger OnStartWithStreamInput, otherwise trigger OnStart</strong></li><li><strong>When the component output is StreamReader, trigger OnEndWithStreamOutput, otherwise trigger OnEnd</strong></li></ul><p>Components that internally implement callback triggers should implement the Checker interface, returning true from IsCallbacksEnabled, to convey to the outside that &ldquo;I have internally implemented callback triggers&rdquo;:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Checker tells the callback aspect status of the component’s implementation.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// When the Checker interface is implemented and returns true, the framework will not start the default aspect.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// Instead, the component will decide the callback execution location and the information to be injected.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Checker</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>IsCallbacksEnabled</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>bool</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If a component implementation does not implement the Checker interface, or IsCallbacksEnabled returns false, it can be assumed that the component does not trigger callbacks internally, and Graph Node is needed to handle the injection and triggering (when used within the Graph).</p><h3 id=graph-node-trigger-node-callback>Graph Node Trigger (Node Callback)</h3><p>When a Component is organized into a Graph, it becomes a Node. At this time, if the Component itself triggers a callback, the Node will reuse the Component&rsquo;s callback handling. Otherwise, the Node will place a callback handler at the points outside the Component. These points correspond to the streaming paradigm of the Component itself. For example, a ChatModelNode will have OnStart/OnEnd/OnError outside the Generate method, and OnStart/OnEndWithStreamOutput/OnError outside the Stream method.</p><p>When the Graph is running, each component will operate in either Invoke or Transform paradigm, and will call the corresponding component methods based on the specific implementation of the component&rsquo;s business streaming paradigm. For example, if the Graph runs in Invoke, the Chat Model Node will run in Invoke, calling the Generate method. However, if the Graph runs in Stream, the Chat Model Node will run in Transform, but since the Chat Model&rsquo;s business streaming paradigm does not include Transform, it will automatically downgrade to calling the Stream method. Therefore:</p><p><strong>Which specific trigger points a Graph Node executes (OnStart or OnStartWithStreamInput) depends on the component&rsquo;s business streaming paradigm and the Graph running mode.</strong></p><p>For a detailed introduction to Eino&rsquo;s streaming programming, refer to <a href=/en/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials>Eino Points of Streaming Orchestration</a>.</p><h3 id=graph-self-trigger-graph-callback><strong>Graph Self Trigger (Graph Callback)</strong></h3><p>The Graph triggers the Callback Handler at its own start, end, and error moments. If the Graph is called in Invoke form, it triggers OnStart/OnEnd/OnError. If called in Stream/Collect/Transform form, it triggers OnStartWithStreamInput/OnEndWithStreamOutput/OnError. This is because <strong>the Graph will always execute internally in Invoke or Transform</strong>. See <a href=/en/docs/eino/core_modules/chain_and_graph_orchestration/stream_programming_essentials>Eino Points of Streaming Orchestration</a></p><p>It is worth noting that a graph is also a kind of component, so a graph callback is also a special form of component callback. According to the definition of Node Callback, when the component inside the Node implements the perception and processing of the trigger moments, the Node will directly reuse the Component&rsquo;s implementation and will not implement the Node Callback again. This means when a graph is added to another Graph as a Node through the AddGraphNode method, this Node will reuse the internal graph&rsquo;s graph callback.</p><h2 id=parsing-callback-input--output><strong>Parsing Callback Input & Output</strong></h2><p>As mentioned earlier, the underlying type of Callback Input & Output is Any, and different component types might pass in their specific types when triggering callbacks. Also, in the interface definition of the Callback Handler, the input parameters of various methods are also Callback Input & Output of type Any.</p><p>Therefore, in the specific Handler implementation, two things need to be done:</p><ol><li>Determine which component type triggered the callback using RunInfo. For example, RunInfo.Component == &ldquo;ChatModel&rdquo; or RunInfo.Type == &ldquo;xxx Chat Model&rdquo;.</li><li>Convert the Callback Input & Output of type any to the corresponding specific type. For instance, if RunInfo.Component == &ldquo;ChatModel&rdquo;:</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ConvCallbackInput converts the callback input to the model callback input.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>ConvCallbackInput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackInput</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is triggered within component implementation, the input is usually already a typed *model.CallbackInput</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is injected by graph node, not the component implementation itself, the input is the input of Chat Model interface, which is []*schema.Message</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>Messages</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ConvCallbackOutput converts the callback output to the model callback output.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>ConvCallbackOutput</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span> <span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackOutput</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>switch</span> <span style=color:#000>t</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>src</span><span style=color:#000;font-weight:700>.(</span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is triggered within component implementation, the output is usually already a typed *model.CallbackOutput</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>t</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#8f5902;font-style:italic>// when callback is injected by graph node, not the component implementation itself, the output is the output of Chat Model interface, which is *schema.Message</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>          <span style=color:#000>Message</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>t</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>       <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span>       <span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>If the Handler needs to add switch cases to determine RunInfo.Component and, for each case, call the corresponding conversion function to convert Any to the specific type, it does get somewhat complex. To reduce the repetitive labor of writing glue code, we provide two convenient utility functions for implementing Handlers.</p><h2 id=handler-implementation>Handler Implementation</h2><p>In addition to implementing the Handler interface directly, Eino provides two convenient tools for implementing Handlers.</p><h3 id=handlerhelper><strong>HandlerHelper</strong></h3><p>If the user&rsquo;s Handler only focuses on specific types of components, such as in the scenario of ReactAgent, which only focuses on ChatModel and Tool, it is recommended to use HandlerHelper to quickly create a Callback Handler for a specific type:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerHelper</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>ChatModel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>modelHandler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Tool</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>toolHandler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>Where modelHandler is a further encapsulation of the callback handler for the Chat Model component:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// ModelCallbackHandler is the handler for the model callback.</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>ModelCallbackHandler</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnStart</span>               <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>input</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackInput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEnd</span>                 <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnEndWithStreamOutput</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>output</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StreamReader</span><span style=color:#000;font-weight:700>[</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>model</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CallbackOutput</span><span style=color:#000;font-weight:700>])</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#000>OnError</span>               <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>runInfo</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>RunInfo</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The above ModelCallbackHandler encapsulates three operations:</p><ol><li>No longer needing to determine RunInfo.Component to select the callback triggered by ChatModel, as the filtering is already done automatically.</li><li>Only requiring the implementation of the trigger timings supported by the Chat Model component, here removing unsupported OnStartWithStreamInput. Additionally, if the user only focuses on specific trigger timings supported by the Chat Model, such as only OnStart, they can only implement OnStart.</li><li>Input/Output is no longer of any type but has been converted to model.CallbackInput, model.CallbackOutput.</li></ol><p>HandlerHelper supports all official components. The current list includes: ChatModel, ChatTemplate, Retriever, Indexer, Embedding, Document.Loader, Document.Transformer, Tool, ToolsNode.</p><p>For components like Lambda, Graph, Chain, which have indeterminate input and output types, you can also use HandlerHelper, but it can only achieve the first point mentioned above, i.e., automatic filtering by component type. Points 2 and 3 still need to be implemented by the user themselves:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerHelper</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Lambda</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>Graph</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>callbacks</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>Handler</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>At this time, NewHandlerHelper().Lambda() needs to pass in callbacks.Handler, which can be achieved using the HandlerBuilder below.</p><h3 id=handlerbuilder><strong>HandlerBuilder</strong></h3><p>If the user&rsquo;s Handler needs to focus on multiple component types but only on specific trigger timings, HandlerBuilder can be used:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>handler</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>NewHandlerBuilder</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>OnStartFn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000>Build</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><h2 id=best-practices><strong>Best Practices</strong></h2><h3 id=usage-in-graph><strong>Usage in Graph</strong></h3><ul><li>Actively use Global Handlers, registering handlers that are always in effect.</li><li>Inject Handlers at runtime using the <code>WithHandlers</code> option, and designate the Node, nested internal Graph, or internal Graph&rsquo;s Node where they apply using <code>DesignateNode</code> or <code>DesignateNodeByPath</code>.</li></ul><h3 id=usage-outside-of-graph><strong>Usage Outside of Graph</strong></h3><p>Use <code>InitCallbacks</code> to inject <code>RunInfo</code> and <code>Handlers</code>. You need to set the fields of <code>RunInfo</code> yourself。Global Handlers will be automatically injected。</p><pre tabindex=0><code>ctx = callbacks.InitCallbacks(ctx, runInfo, handlers...)
componentA.Invoke(ctx, input)
</code></pre><p>If componentA invokes componentB internally(e.g. ToolsNode invokes Tool), you need to replace <code>RunInfo</code> before invoking componentB:</p><pre tabindex=0><code>func ComponentARun(ctx, inputA) {
    // reuse handlers exist in ctx(including Global Handlers), only replace RunInfo
    ctx = callbacks.ReuseHandlers(ctx, newRunInfo)
    componentB.Invoke(ctx, inputB)
    
    // replace both RunInfo and Handlers
    ctx = callbacks.InitCallbacks(ctx, newRunInfo, newHandlers...)
    componentB.Invoke(ctx, inputB)
}
</code></pre><h3 id=handler-readingwriting-of-input--output><strong>Handler Reading/Writing of Input & Output</strong></h3><p>When Input & Output flow through a graph, it is a direct variable assignment. As shown in the figure below, NodeA.Output, NodeB.Input, NodeC.Input, as well as the input & output obtained in each Handler, if they are reference types such as structure pointers or Maps, are all the same piece of data. Therefore, whether inside a Node or a Handler, modifying Input & Output is not recommended, as it can lead to concurrency issues. Even in a synchronous situation, Node B and Node C may have concurrency, resulting in concurrency between handler1 and handler2 inside them. When there are asynchronous processing logics, there are even more possible concurrent scenarios.</p><p><a href=/img/eino/eino_callback_start_end_place.png target=_blank><img src=/img/eino/eino_callback_start_end_place.png width=100%></a></p><p>In the scenario of stream transmission, the input streams in all successor nodes and their handlers are streams obtained by StreamReader.Copy(n) and can be read independently of each other. However, for each chunk in the stream, it is a direct variable assignment. If the chunk is a reference type such as a struct pointer or a map, the streams after each copy will read the same data. Therefore, within Node and Handler, it is also not recommended to modify the chunk of the stream, as there are concurrency issues.</p><p><a href=/img/eino/eino_callback_stream_place.png target=_blank><img src=/img/eino/eino_callback_stream_place.png width=100%></a></p><h3 id=information-transfer-between-handlers><strong>Information Transfer Between Handlers</strong></h3><p>You can transfer information between different time points of the same Handler through <code>ctx</code>. For example, in <code>OnStart</code>, use <code>context.WithValue</code> to return a new context, and retrieve this value from the context in <code>OnEnd</code>.</p><p>There&rsquo;s no guaranteed execution order between different Handlers, so it&rsquo;s not advised to transfer information between Handlers via this mechanism. Essentially, you cannot ensure that the context returned by one Handler will definitely be used in the execution function of the next Handler.</p><p>Should you need to transfer information between Handlers, it’s recommended to set a global, request-scoped variable in the outermost context (like the context passed during graph execution) as a public information storage space. You can read and update this public variable as needed in each Handler. For streams, extra attention is needed to ensure the thread safety of this public variable.</p><h3 id=always-close-streams><strong>Always Close Streams</strong></h3><p>Take a node like <code>ChatModel</code>, which has true stream output, for example. When there is a Callback aspect, the output stream from <code>ChatModel</code>:</p><ul><li>Must be consumed as input by downstream nodes and also be consumed by the Callback aspect.</li><li>A single frame (Chunk) in a stream can only be consumed by one consumer, meaning the stream is not broadcast.</li></ul><p>Thus, the stream needs to be duplicated, with the duplication relationship as follows:</p><p><a href=/img/eino/en_eino_stream_copy_for_callback.png target=_blank><img src=/img/eino/en_eino_stream_copy_for_callback.png width=100%></a></p><ul><li>If one of the Callbacks does not close the corresponding stream, it may result in the original Stream being unable to close and release resources.</li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified
March 7, 2025
: <a href=https://github.com/cloudwego/cloudwego.github.io/commit/590388601ba4c26232b5ba3dcdef1bb571867ba4>doc: update plugin install guide (#1272) (5903886)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fab fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/main.min.9a8648b987db06195f5768f0d7516e8df7c27669e91e383e25c5d07cd6325605.js integrity="sha256-moZIuYfbBhlfV2jw11FujffCdmnpHjg+JcXQfNYyVgU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>