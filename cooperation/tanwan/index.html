<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.151.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>CloudWeGo's Application in Tanwan Game SDK Interface | CloudWeGo</title><meta name=description content="A leading practice for building enterprise cloud native middleware!"><meta property="og:url" content="https://www.cloudwego.io/cooperation/tanwan/"><meta property="og:site_name" content="CloudWeGo"><meta property="og:title" content="CloudWeGo's Application in Tanwan Game SDK Interface"><meta property="og:description" content="嘉宾介绍 本次分享主要分为以下四部分内容：
遇到的架构问题。QPS上不去，业务瞬时高并发，扩容慢。 语言架构的探索选型。原生go，go框架。 CloudWeGo 架构的落地。牛刀小试，积累经验，迅速扩展，修复问题。 给相似业务的参考建议。按团队思想、水平安排推进节奏，做好微服务拆分， 运维快学，善用外部资源，善用工具做好监控。 遇到的架构问题 公司业务 在这之前，我先简单介绍一下我们的公司“贪玩游戏”。我们公司贪玩游戏在业内比较知名，主要是因为玩家对我们的厚爱；其次，我们还有许多出圈的文案，例如“一刀999”、“是兄弟就来砍我”等。
公司业务重心： 我们致力于让玩家顺畅地进入游戏，享受游戏的乐趣。为玩家提供注册、登录、充值以及游戏内的各种服务。 公司业务性质： 我们是一家买量公司，业务上频繁开服并推送大量流量，因此对框架性能的要求也越来越高。 公司业务需求：我们技术团队专注于快速开发和迭代，不断跟进市场和运营的需求，不断探索创新，以满足客户的需求。 遇到的架构问题 此前使用的 php-fpm 的 QPS 瓶颈值低。 单台阿里云ecs机器(8c16G或16c32G) php-fpm 在业务侧压测及实际表现 QPS 在400-600之间。
瞬时高并发场景下，php - fpm 处理能力明显不够用。
场景1：游戏大推 。 比如邀请了一个很受欢迎的代言人，在今日头条、抖音、广点通、微信朋友圈等各个媒体里大推广告时，如果我们的平台无法承受压力，可能会导致资金浪费。 场景2：合作方集中推送游戏数据 。 因为我们是平台类应用，会关注用户各个方面的数据，合作方也会推送过来。合作方推送的数据通常是默认为 no problem，即合作方推送多少你都可以接多少。在这种情况下，如果我们的 php-fpm 处理能力较低，合作方的观感可能会受到影响。 场景3：合作方游戏更新大批量玩家验证 token、重登录。游戏通常每两周更新一次，更新时如果程序重新启动，可能会导致游戏掉线并重新启动。如果有 token，则需要提交 token 进行验证，同时需要具备高并发能力以应对大量瞬时上线的请求。 场景4：接口被刷。因为游戏中有一些生态，有些玩家会在游戏生态中找到存在或生存的方法，因此会储备大量账号。如果接口被刷，我们会有风控措施，但万一这些刷量的大量请求到达服务器时，我们也应该能够承受。 运维扩展时间成本高，不灵活。 例如处理不当或不足，可能导致单台服务器出现问题。为了解决这个问题，我们需要不断地增加服务器数量，这也会带来时间成本。如果完成了以下三个步骤，通常需要7分钟，这可能会导致玩家流失。- 3分钟，创建ecs服务 - 3分钟，部署环境+同步代码+基本测试 - 1分钟，上线现网环境
语言架构的探索选型 原生 Go 实践与应用
Golang
Golang 是一种注重高效和并发编程的编程语言，提供了内存安全、代码简洁、跨平台和易于部署等优点，适用于大规模、高并发的网络服务和系统编程。
我曾在15、16 年使用 Go 语言，当时大多数人都写的是原生的 Go 代码。因此，我们在这个场景下尝试将 Go 语言用于媒体点击，即投放广告时，广告媒体会向我们发送各种日志，我们从中收集信息并进行匹配分析。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="cooperation"><meta property="article:modified_time" content="2024-07-09T16:00:57+08:00"><meta itemprop=name content="CloudWeGo's Application in Tanwan Game SDK Interface"><meta itemprop=description content="嘉宾介绍 本次分享主要分为以下四部分内容：
遇到的架构问题。QPS上不去，业务瞬时高并发，扩容慢。 语言架构的探索选型。原生go，go框架。 CloudWeGo 架构的落地。牛刀小试，积累经验，迅速扩展，修复问题。 给相似业务的参考建议。按团队思想、水平安排推进节奏，做好微服务拆分， 运维快学，善用外部资源，善用工具做好监控。 遇到的架构问题 公司业务 在这之前，我先简单介绍一下我们的公司“贪玩游戏”。我们公司贪玩游戏在业内比较知名，主要是因为玩家对我们的厚爱；其次，我们还有许多出圈的文案，例如“一刀999”、“是兄弟就来砍我”等。
公司业务重心： 我们致力于让玩家顺畅地进入游戏，享受游戏的乐趣。为玩家提供注册、登录、充值以及游戏内的各种服务。 公司业务性质： 我们是一家买量公司，业务上频繁开服并推送大量流量，因此对框架性能的要求也越来越高。 公司业务需求：我们技术团队专注于快速开发和迭代，不断跟进市场和运营的需求，不断探索创新，以满足客户的需求。 遇到的架构问题 此前使用的 php-fpm 的 QPS 瓶颈值低。 单台阿里云ecs机器(8c16G或16c32G) php-fpm 在业务侧压测及实际表现 QPS 在400-600之间。
瞬时高并发场景下，php - fpm 处理能力明显不够用。
场景1：游戏大推 。 比如邀请了一个很受欢迎的代言人，在今日头条、抖音、广点通、微信朋友圈等各个媒体里大推广告时，如果我们的平台无法承受压力，可能会导致资金浪费。 场景2：合作方集中推送游戏数据 。 因为我们是平台类应用，会关注用户各个方面的数据，合作方也会推送过来。合作方推送的数据通常是默认为 no problem，即合作方推送多少你都可以接多少。在这种情况下，如果我们的 php-fpm 处理能力较低，合作方的观感可能会受到影响。 场景3：合作方游戏更新大批量玩家验证 token、重登录。游戏通常每两周更新一次，更新时如果程序重新启动，可能会导致游戏掉线并重新启动。如果有 token，则需要提交 token 进行验证，同时需要具备高并发能力以应对大量瞬时上线的请求。 场景4：接口被刷。因为游戏中有一些生态，有些玩家会在游戏生态中找到存在或生存的方法，因此会储备大量账号。如果接口被刷，我们会有风控措施，但万一这些刷量的大量请求到达服务器时，我们也应该能够承受。 运维扩展时间成本高，不灵活。 例如处理不当或不足，可能导致单台服务器出现问题。为了解决这个问题，我们需要不断地增加服务器数量，这也会带来时间成本。如果完成了以下三个步骤，通常需要7分钟，这可能会导致玩家流失。- 3分钟，创建ecs服务 - 3分钟，部署环境+同步代码+基本测试 - 1分钟，上线现网环境
语言架构的探索选型 原生 Go 实践与应用
Golang
Golang 是一种注重高效和并发编程的编程语言，提供了内存安全、代码简洁、跨平台和易于部署等优点，适用于大规模、高并发的网络服务和系统编程。
我曾在15、16 年使用 Go 语言，当时大多数人都写的是原生的 Go 代码。因此，我们在这个场景下尝试将 Go 语言用于媒体点击，即投放广告时，广告媒体会向我们发送各种日志，我们从中收集信息并进行匹配分析。"><meta itemprop=dateModified content="2024-07-09T16:00:57+08:00"><meta itemprop=wordCount content="581"><meta name=twitter:card content="summary"><meta name=twitter:title content="CloudWeGo's Application in Tanwan Game SDK Interface"><meta name=twitter:description content="嘉宾介绍 本次分享主要分为以下四部分内容：
遇到的架构问题。QPS上不去，业务瞬时高并发，扩容慢。 语言架构的探索选型。原生go，go框架。 CloudWeGo 架构的落地。牛刀小试，积累经验，迅速扩展，修复问题。 给相似业务的参考建议。按团队思想、水平安排推进节奏，做好微服务拆分， 运维快学，善用外部资源，善用工具做好监控。 遇到的架构问题 公司业务 在这之前，我先简单介绍一下我们的公司“贪玩游戏”。我们公司贪玩游戏在业内比较知名，主要是因为玩家对我们的厚爱；其次，我们还有许多出圈的文案，例如“一刀999”、“是兄弟就来砍我”等。
公司业务重心： 我们致力于让玩家顺畅地进入游戏，享受游戏的乐趣。为玩家提供注册、登录、充值以及游戏内的各种服务。 公司业务性质： 我们是一家买量公司，业务上频繁开服并推送大量流量，因此对框架性能的要求也越来越高。 公司业务需求：我们技术团队专注于快速开发和迭代，不断跟进市场和运营的需求，不断探索创新，以满足客户的需求。 遇到的架构问题 此前使用的 php-fpm 的 QPS 瓶颈值低。 单台阿里云ecs机器(8c16G或16c32G) php-fpm 在业务侧压测及实际表现 QPS 在400-600之间。
瞬时高并发场景下，php - fpm 处理能力明显不够用。
场景1：游戏大推 。 比如邀请了一个很受欢迎的代言人，在今日头条、抖音、广点通、微信朋友圈等各个媒体里大推广告时，如果我们的平台无法承受压力，可能会导致资金浪费。 场景2：合作方集中推送游戏数据 。 因为我们是平台类应用，会关注用户各个方面的数据，合作方也会推送过来。合作方推送的数据通常是默认为 no problem，即合作方推送多少你都可以接多少。在这种情况下，如果我们的 php-fpm 处理能力较低，合作方的观感可能会受到影响。 场景3：合作方游戏更新大批量玩家验证 token、重登录。游戏通常每两周更新一次，更新时如果程序重新启动，可能会导致游戏掉线并重新启动。如果有 token，则需要提交 token 进行验证，同时需要具备高并发能力以应对大量瞬时上线的请求。 场景4：接口被刷。因为游戏中有一些生态，有些玩家会在游戏生态中找到存在或生存的方法，因此会储备大量账号。如果接口被刷，我们会有风控措施，但万一这些刷量的大量请求到达服务器时，我们也应该能够承受。 运维扩展时间成本高，不灵活。 例如处理不当或不足，可能导致单台服务器出现问题。为了解决这个问题，我们需要不断地增加服务器数量，这也会带来时间成本。如果完成了以下三个步骤，通常需要7分钟，这可能会导致玩家流失。- 3分钟，创建ecs服务 - 3分钟，部署环境+同步代码+基本测试 - 1分钟，上线现网环境
语言架构的探索选型 原生 Go 实践与应用
Golang
Golang 是一种注重高效和并发编程的编程语言，提供了内存安全、代码简洁、跨平台和易于部署等优点，适用于大规模、高并发的网络服务和系统编程。
我曾在15、16 年使用 Go 语言，当时大多数人都写的是原生的 Go 代码。因此，我们在这个场景下尝试将 Go 语言用于媒体点击，即投放广告时，广告媒体会向我们发送各种日志，我们从中收集信息并进行匹配分析。"><script async src="https://www.googletagmanager.com/gtag/js?id=G-QYWRQRLPRM"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QYWRQRLPRM")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?f1808c42af827f368aa7eca3baae6d55",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><link rel=preload href=/scss/main.min.d82085885aff5076523f2bb4904f9e11bd16c28b46ecb5319ec0d01cb087e9de.css as=style><link href=/scss/main.min.d82085885aff5076523f2bb4904f9e11bd16c28b46ecb5319ec0d01cb087e9de.css rel=stylesheet integrity><script src=/js/jquery.min.js></script><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/docsearch.css></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand-xl navbar-dark td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><img src=/img/logo.png></span>
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#main_navbar aria-controls=main_navbar aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0 ml-auto"><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Documentation</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/docs/kitex/>Kitex</a>
<a class=dropdown-item href=/docs/hertz/>Hertz</a>
<a class=dropdown-item href=/docs/volo/>Volo</a>
<a class=dropdown-item href=/docs/netpoll/>Netpoll</a>
<a class=dropdown-item href=/docs/eino/>Eino</a></div></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/cooperation/><span class=active>Cooperation</span></a></li><li class="dropdown sub-menu"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><span>Security</span></a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/security/safety-bulletin/>safety-bulletin</a>
<a class=dropdown-item href=/security/vulnerability-reporting/>vulnerability-reporting</a></div></li><li class="nav-item dropdown mr-4"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/cooperation/tanwan/>中文</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><div id=docsearch></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div id=docsearch></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><div class="nav-item dropdown d-block d-lg-none"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/zh/cooperation/tanwan/>中文</a></div></div><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-cooperation-li><a href=/cooperation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-cooperation><span>Cooperation</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationhuaxingsec-li><input type=checkbox id=m-cooperationhuaxingsec-check checked>
<label for=m-cooperationhuaxingsec-check><a href=/cooperation/huaxingsec/ title="华兴证券：混合云原生架构下的 Kitex 实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationhuaxingsec><span>huaxingsec</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationsemir-li><input type=checkbox id=m-cooperationsemir-check checked>
<label for=m-cooperationsemir-check><a href=/cooperation/semir/ title="Kitex 在森马电商场景的落地实践" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationsemir><span>semir</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationfeishu-li><input type=checkbox id=m-cooperationfeishu-check checked>
<label for=m-cooperationfeishu-check><a href=/cooperation/feishu/ title="引入 CloudWeGo 后飞书管理后台平台化改造的演进史" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationfeishu><span>feishu</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-cooperationtanwan-li><input type=checkbox id=m-cooperationtanwan-check checked>
<label for=m-cooperationtanwan-check><a href=/cooperation/tanwan/ title="CloudWeGo's Application in Tanwan Game SDK Interface" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-cooperationtanwan><span class=td-sidebar-nav-active-item>Tanwan</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationshumei-li><input type=checkbox id=m-cooperationshumei-check checked>
<label for=m-cooperationshumei-check><a href=/cooperation/shumei/ title="Kitex's Application in Shumei Technology's Usability Governance" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationshumei><span>Shumei-Tech</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationfoundersc-li><input type=checkbox id=m-cooperationfoundersc-check checked>
<label for=m-cooperationfoundersc-check><a href=/cooperation/foundersc/ title="Founder Securities - Financial Technology Cloud-native Microservices Implementation" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationfoundersc><span>Founder-Securities</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-cooperationconstruct-li><input type=checkbox id=m-cooperationconstruct-check checked>
<label for=m-cooperationconstruct-check><a href=/cooperation/construct/ title="Construct's Microservice System Construction from 0 to 1 Based on Kitex + Istio" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-cooperationconstruct><span>Construct</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cloudwego/cloudwego.github.io/edit/main/content/en/cooperation/tanwan.md class="td-page-meta--edit td-page-meta__edit" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/new/main/content/en/cooperation?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class="td-page-meta--child td-page-meta__child" target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/cloudwego/cloudwego.github.io/issues/new?title=CloudWeGo%27s%20Application%20in%20Tanwan%20Game%20SDK%20Interface" class="td-page-meta--issue td-page-meta__issue" target=_blank rel=noopener><i class="fa-brands fa-github fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/cloudwego/kitex/issues/new/choose class="td-page-meta--project td-page-meta__project-issue" target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#嘉宾介绍>嘉宾介绍</a></li><li><a href=#遇到的架构问题>遇到的架构问题</a><ul><li><a href=#公司业务>公司业务</a></li><li><a href=#遇到的架构问题-1>遇到的架构问题</a></li><li><a href=#语言架构的探索选型>语言架构的探索选型</a></li><li><a href=#语言架构的探索选型-1>语言架构的探索选型</a></li><li><a href=#我们的选择-cloudwego>我们的选择 CloudWeGo</a></li><li><a href=#高性能的系列开源组件><strong>高性能的系列开源组件</strong></a></li><li><a href=#快速开发扩展性强>快速开发，扩展性强</a></li><li><a href=#专业辅助社区火热>专业辅助，社区火热</a></li></ul></li><li><a href=#cloudwego-架构的落地>CloudWeGo 架构的落地</a><ul><li><a href=#首次核心业务实践>首次核心业务实践</a></li><li><a href=#游戏-sdk-业务全面重构>游戏 SDK 业务全面重构</a></li></ul></li><li><a href=#运维之-slb-后端-pod-不优雅下线>运维之 SLB 后端 Pod 不优雅下线</a><ul><li><a href=#运维之滚动更新信号量处理>运维之滚动更新信号量处理</a></li><li><a href=#取-oss-文件效率问题的暴露>取 Oss 文件效率问题的暴露</a></li><li><a href=#整体收益>整体收益</a></li></ul></li><li><a href=#给相似业务的参考建议>给相似业务的参考建议</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://www.cloudwego.io/cooperation/>Cooperation</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://www.cloudwego.io/cooperation/tanwan/>Tanwan</a></li></ol></nav><div class=td-content><h1>CloudWeGo's Application in Tanwan Game SDK Interface</h1><header class=article-meta></header><h2 id=嘉宾介绍>嘉宾介绍</h2><p><img src=/img/users/tanwan/tanwan1.png alt=tanwan1></p><p>本次分享主要分为以下四部分内容：</p><ol><li><strong>遇到的架构问题</strong>。QPS上不去，业务瞬时高并发，扩容慢。</li><li><strong>语言架构的探索选型</strong>。原生go，go框架。</li><li><strong>CloudWeGo 架构的落地</strong>。牛刀小试，积累经验，迅速扩展，修复问题。</li><li><strong>给相似业务的参考建议</strong>。按团队思想、水平安排推进节奏，做好微服务拆分， 运维快学，善用外部资源，善用工具做好监控。</li></ol><h2 id=遇到的架构问题>遇到的架构问题</h2><h3 id=公司业务>公司业务</h3><p>在这之前，我先简单介绍一下我们的公司“贪玩游戏”。我们公司贪玩游戏在业内比较知名，主要是因为玩家对我们的厚爱；其次，我们还有许多出圈的文案，例如“一刀999”、“是兄弟就来砍我”等。</p><ol><li><strong>公司业务重心：</strong> 我们致力于让玩家顺畅地进入游戏，享受游戏的乐趣。为玩家提供注册、登录、充值以及游戏内的各种服务。</li><li><strong>公司业务性质：</strong> 我们是一家买量公司，业务上频繁开服并推送大量流量，因此对框架性能的要求也越来越高。</li><li><strong>公司业务需求</strong>：我们技术团队专注于快速开发和迭代，不断跟进市场和运营的需求，不断探索创新，以满足客户的需求。</li></ol><h3 id=遇到的架构问题-1>遇到的架构问题</h3><ol><li><p><strong>此前使用的 php-fpm 的</strong> <strong>QPS</strong> <strong>瓶颈值低。</strong> 单台阿里云ecs机器(8c16G或16c32G) php-fpm 在业务侧压测及实际表现 QPS 在400-600之间。</p></li><li><p><strong>瞬时高并发场景下，php</strong> <strong>-</strong> <strong>fpm 处理能力明显不够用</strong>。</p><ul><li>场景1：<strong>游戏大推</strong> <strong>。</strong> 比如邀请了一个很受欢迎的代言人，在今日头条、抖音、广点通、微信朋友圈等各个媒体里大推广告时，如果我们的平台无法承受压力，可能会导致资金浪费。</li><li>场景2：<strong>合作方集中推送游戏数据</strong> <strong>。</strong> 因为我们是平台类应用，会关注用户各个方面的数据，合作方也会推送过来。合作方推送的数据通常是默认为 no problem，即合作方推送多少你都可以接多少。在这种情况下，如果我们的 php-fpm <strong>处理能力</strong>较低，合作方的观感可能会受到影响。</li><li>场景3：<strong>合作方游戏更新大批量玩家验证 token、重登录</strong>。游戏通常每两周更新一次，更新时如果程序重新启动，可能会导致游戏掉线并重新启动。如果有 token，则需要提交 token 进行验证，同时需要具备高并发能力以应对大量瞬时上线的请求。</li><li>场景4：<strong>接口被刷</strong>。因为游戏中有一些生态，有些玩家会在游戏生态中找到存在或生存的方法，因此会储备大量账号。如果接口被刷，我们会有风控措施，但万一这些刷量的大量请求到达服务器时，我们也应该能够承受。</li></ul></li><li><p><strong>运维扩展时间成本高，不灵活。</strong>
例如处理不当或不足，可能导致单台服务器出现问题。为了解决这个问题，我们需要不断地增加服务器数量，这也会带来时间成本。如果完成了以下三个步骤，通常需要7分钟，这可能会导致玩家流失。- 3分钟，创建ecs服务 - 3分钟，部署环境+同步代码+基本测试 - 1分钟，上线现网环境</p></li></ol><h3 id=语言架构的探索选型>语言架构的探索选型</h3><p><strong>原生 Go 实践与应用</strong></p><p><strong>Golang</strong></p><p>Golang 是一种注重高效和并发编程的编程语言，提供了内存安全、代码简洁、跨平台和易于部署等优点，适用于大规模、高并发的网络服务和系统编程。</p><p>我曾在15、16 年使用 Go 语言，当时大多数人都写的是原生的 Go 代码。因此，我们在这个场景下尝试将 Go 语言用于媒体点击，即投放广告时，广告媒体会向我们发送各种日志，我们从中收集信息并进行匹配分析。</p><p><strong>背景</strong></p><p>媒体点击下发服务高峰时能达到6、7kQPS，单机 php-fpm 性能难以支撑这么高的并发量，只能通过不断增加服务器资源成本来解决。而 Go 在并发这块有出色的性能表现，能极大地节省资源成本。</p><p>在接收到日志信号的过程中，如果我们使用 php-fpm 来进行记录，它可能会达到几百个 QPS。因此，需要部署数十台服务器才能支撑如此高的 QPS，我们认为这不应该耗费这么多资源。因此，我们将 Go 语言用于实现一个简单的替换，即使用原生的 Go 语言编写一个 HTTP 服务，将日志请求转发到 Go 中，并将这些日志写到指定的 channel 中，然后返回。channel 后边有一个定时器不断地将信道里的日志写到指定的地方。</p><p><strong>使用</strong></p><p>通过使用 net/http 标准库 快递搭建一个 http 服务器，下发的数据通过 Channel 操作实时写入日志文件，然后通过 filebeat 采集同步到 kafka 进行数据清洗，重构后单台8核16g内存的服务器可以扛住 <strong>1w+ QPS</strong>。</p><p><img src=/img/users/tanwan/tanwan2.png alt=tanwan2></p><p><strong>业务重构</strong></p><p>接下来，将介绍整个实现流程。</p><ol><li><strong>nginx</strong> <strong>路由转发</strong>。首先就是 nginx 这一层，我们设置一个 location 转到新程序监听的 unix socket 上面。因为我们之前在ecs上面运行，部署监听是在 unix socket 上面，这个会比监听在端口更高效。</li></ol><p><img src=/img/users/tanwan/tanwan3.png alt=tanwan3></p><ol start=2><li><strong>channel操作</strong>。这个数据我们就塞到这个 channel 里面去了。</li></ol><p><img src=/img/users/tanwan/tanwan4.png alt=tanwan4></p><ol start=3><li><strong>定时器执行</strong> <strong>IO</strong> <strong>操作。</strong> 这个读数据出来，然后把它写入文件下边。</li></ol><p><img src=/img/users/tanwan/tanwan5.png alt=tanwan5></p><ol start=4><li><strong>压测</strong> <strong>效果 1w+</strong> <strong>QPS</strong> <strong>。</strong> 之前我们只有几百个 QPS，现在基本上能够达到1万个 QPS，即一台服务器能顶以前好几十台。对于小业务场景而言，这个表现非常好。</li></ol><p><img src=/img/users/tanwan/tanwan6.png alt=tanwan6></p><p><strong>token 验证接口</strong></p><p>还有一个使用场景，即我们使用的 token 验证接口。每逢到周四的某游戏更新日就会将玩家全部踢下线，等更新完成之后会有大量玩家在短时间内大量请求贪玩平台，我们的二次验证接口会校验这个 token 是否合法正常或是否已失效，认证不通过则需要重新登录。在短时间请求会批量涌过来，会导致原合法 token 变成异常返回，导致玩家会重复登陆，在下面两个图中表现出我们的 QPS 一直都居高不下。</p><p>假设因为程序响应不及时和返回异常时，会导致玩家不断地尝试，导致 QPS 呈倍数增长，多次请求后可能会触发雪崩。而前置的 waf 也会将过多请求进行拦截，玩家体验相当不好。</p><p><img src=/img/users/tanwan/tanwan7.png alt=tanwan7></p><p>在 waf 拦截之后，如果后续操作没有完成，它仍会保持这种请求量高的状态，高位不断抖动。</p><p><strong>04-28 事故</strong></p><p>4月28日事故中，更新的游戏版本出现一些问题导致有两次更新， 而每次更新后 QPS 数又重新起来了，而这次的用户量更大、请求量更大，玩家更加着急了。</p><p><img src=/img/users/tanwan/tanwan8.png alt=tanwan8></p><p><strong>处理方案</strong></p><p>从这个事件看得出，服务端的表现并不ok。我们要解决该问题，我们看一下我们的处理方式。</p><p>首先，php-fpm 确实存在没办法 hold 住高并发的问题，我们可能就做一些限流，比如说像地铁一样，你的车就只能载这么多人，那我就限流一下，不能不断地往里边塞。</p><ol><li><strong>nginx 加入限流</strong>，同一时刻只服务有限次数，另外的被放弃，用户后一次尝试可能成功，只要玩家一直试，洪峰总会过去。在 nginx 上设置限流，但限流还是有部分用户在外边进不来，用户可能一直等。但我们不能让忠实玩家一直都在等，那我们总要解决这个问题。</li></ol><p><img src=/img/users/tanwan/tanwan9.png alt=tanwan9></p><ol start=2><li><strong>使用 Go 重写相关逻辑平替掉该请求</strong>。根据我们当时的经验，我们决定使用 Go 语言重写该业务逻辑。我们将其作为一个小项目进行重写，重写过程与之前的操作大致相同，将业务逻辑写进代码中即可。我们很快完成了重写，可以看到后续的表现。我们遇到一瞬间有那么多的请求过来，这是正常的表现，我们及时接住了它们，接住这些请求，QPS 就会下去了。</li></ol><p><img src=/img/users/tanwan/tanwan10.png alt=tanwan10></p><p><strong>05-13平替后的效果</strong></p><p>看下图的 Nginx QPS 可以看到新的 Token 认证接口可以承受量有很大的突破，保证了接口的可用性，而第二个图是登录接口 QPS，也反向证明了提高 Token 认证可用性，不会导致其它连锁反应，到此这个问题就解决了。</p><p><img src=/img/users/tanwan/tanwan11.png alt=tanwan11></p><p>扛住了，请求量高起只一会，没有引发雪崩</p><p><img src=/img/users/tanwan/tanwan12.png alt=tanwan12></p><p>同时段 token 验证到失效了，要再次登录的请求量</p><h3 id=语言架构的探索选型-1>语言架构的探索选型</h3><h3 id=我们的选择-cloudwego>我们的选择 CloudWeGo</h3><p>那到目前这里，我们看到了我们自己的一些探索，在与语言的探索中，我们探索了 Go，明显看到Go 处理的在某些场景更加牛、更加高效。因为我们知道这个很牛，我们要在更多的场景使用它，我们团队需要统一的行动，大家一起把这个事情做得更好，那么就需要选一个框架。</p><p>我们进行了一些选型，业内有很多选择，在当前的情况下，知道业内强劲的企业，在它早期的时候会有一些分享，奠定这个行业面对相似的技术难题时的基本选择，会形成一个影响，一个参考。</p><p>业内强劲企业在其早期阶段的分享的影响:</p><ol><li>腾讯微信技术总监周颢：一亿用户增长背后的架构秘密</li><li>今日头条 Go 建千亿级微服务的实践</li></ol><p>我们会根据我们的经验来评估他们之前是否做过类似场景的开发，并查看他们是否开源了相关内容。在这种情况下，我们发现了字节跳动开源了 CloudWeGo 框架。</p><h3 id=高性能的系列开源组件><strong>高性能的系列开源组件</strong></h3><p>如果仅从普通框架的角度来看待它，一般认为上层建筑更为重要，但 CloudWeGo 会进行底层的优化，专注于打造高性能的框架和中间件。</p><p><strong>例如 Netpoll 和 Sonic 等，在精益求精、降本增效环境下极为重要</strong>。因此我们决定使用当前我们认为最好且底蕴最深厚的开源项目。</p><p><img src=/img/users/tanwan/tanwan13.png alt=tanwan13></p><h3 id=快速开发扩展性强>快速开发，扩展性强</h3><p>我们的诉求是，即可实现简易版单体应用开发，又可实现微服务架构拆分和高性能通信。</p><p>我们用的过程中也发现，CloudWeGo 能够快速开发，扩展性很强，简单几行代码就可以把相关功能做出来了。</p><p>以 HTTP 框架为例，从下图也可以看出，Hertz 的性能表现确实是相当不错的。</p><p><img src=/img/users/tanwan/tanwan14.png alt=tanwan14></p><h3 id=专业辅助社区火热>专业辅助，社区火热</h3><p>此外，CloudWeGo 社区也很活跃。有专业技术人士指引辅导，且基本2周一次社区开发者例会。</p><p>我们整个团队要统一思想去行动，我们要在更多的业务场景上去用 go，于是就选择了 CloudWeGo 框架，主要是基于它的高性能、快速开发，以及有专业的辅助。</p><p>没有最好的框架，只有最适合的框架！恰逢开源，热烈拥抱。</p><h2 id=cloudwego-架构的落地>CloudWeGo 架构的落地</h2><h3 id=首次核心业务实践>首次核心业务实践</h3><p><strong>选中 SDK-LOGIN 手游登录接口</strong></p><p>我们团队希望寻找一个场景来应用 CloudWeGo 架构，同时借此熟练并掌握这一套技术，以便更好地推广和应用。因此，我们选择了一个场景，即我们首次核心业务的实践，用于开发我们的手游 SDK 登录接口。</p><p>手游登录接口是整个游戏 SDK 业务流程中核心的功能，且具备较重的业务逻辑，同时我们认为这接口有较大的优化空间和实践意义。</p><p><strong>平行业务拆分</strong></p><p>化繁为简，按业务水平拆分成多个 Service，简化每个 Service 的业务复杂度同时增加并行处理的可能性。</p><p>我们可以看到下图中，上边部分是我们之前在 PHP 的一个实践，即在用户端调用 Api 接口时，我们接口服务器也调用其它服务Api接口。一定程度上等同于微服务，故而在新接口上我们也是按照这个理念去拆分服务，然后中间做了个注册中心，接口应用由 Hertz 框架去替代 HTTP 部分。而后面服务则用 Kitex 将这几个微服务做起来。</p><p><strong>核心业务逻辑：HTTP 服务采用 Hertz 框架，而 RPC 微服务采用 Kitex 框架。</strong></p><p><img src=/img/users/tanwan/tanwan15.png alt=tanwan15></p><p><strong>所用组件</strong></p><p>然后我们可以看一下我们用到的一些组件，例如微服务，必须具备服务注册、发现和配置等功能。</p><ol><li><strong>nacos</strong> <strong>服务注册发现，</strong> <strong>配置中心</strong> <strong>，kitex-contrib/registry-nacos</strong></li></ol><p>我们使用 nacos 作为组件，之前有阿里云的同学过来给我们讲一些分享，他们的销售或是技术支持，都会讲到nacos，因为它在国内使用最广泛、成熟。</p><p>同时，它具有现成的代码支持，并且可以与我们的框架结合使用。它也有sdk，但是要跟我们的框架结合起来，还是得用更加现成的，那就是 CloudWeGo 框架自带的 <strong>registry-nacos</strong>，帮我们把这些代码都写好了，只要拿过来用就可以了。</p><ol start=2><li><strong>OpenTelemetry</strong> <strong>链路追踪， kitex-contrib/obs-opentelemetry</strong></li></ol><p>我们讲到微服务框架时，通常会使用链路追踪。我们选择使用 OpenTelemetry，这是框架里边有现成的，而且写得很好。我们在使用过程中也为其做出了一些贡献。</p><ol start=3><li><strong>prometheus</strong> <strong>监控，kitex-contrib/monitor-prometheus</strong></li></ol><p>我们通常做一些服务时候都需要监控，我们使用 Prometheus 进行监控，这些都是在框架中已有的包，拿过来用就可以了，这些都是通过社区共建的方式实现和维护的。</p><ol start=4><li><strong>限流</strong>， <strong>cloudwego</strong> <strong>/</strong> <strong>kitex</strong> <strong>/pkg/limit</strong></li></ol><p>此外，可能会有一些限流。我们之前也有讲到限流，那在微服务里边也是希望它能够限一下流，不会让太多的请求进入，或者说太多的请求过来的时候我们就不处理，能够使我们服务更加坚挺，保证了大部分用户的请求是正常的。</p><ol start=5><li><strong>协议，</strong> <strong>Protobuf</strong> <strong>相对熟悉，</strong> <strong>kitex</strong> <strong>工具好使，支持及时。</strong></li></ol><p>协议的话，我们团队可能更加熟悉的是 <strong>Protobuf</strong>，而 <strong>CloudWeGo</strong> 也很好的兼容此协议，故而我们选用了<strong>Protobuf</strong>。</p><ol start=6><li>&mldr;</li></ol><p>我们使用的组件基本上是以上这些，还有更多，这里只是做一个展示。这里边有很多是 CloudWeGo 社区共建的，提供了现成的东西供我们参考或直接使用。</p><p><img src=/img/users/tanwan/tanwan16.png alt=tanwan16></p><p><img src=/img/users/tanwan/tanwan17.png alt=tanwan17></p><p>这是一个 settingservice 的监控图，跑了一些 CPU、内存监控，就是运维关注的一般的基础资源的使用情况。</p><p><img src=/img/users/tanwan/tanwan18.png alt=tanwan18></p><p>我们业务上可能会更加关心延延时，就是下边的图。 <strong>P95、P50 平均值基本上在几十毫秒或者三十</strong>。因为在 K8S 里面， 需要访问我们的一些阿里云服务，比如说数据库， Redis 这些的时候，它从里边到外边也是有一定的时延了。</p><p><img src=/img/users/tanwan/tanwan19.png alt=tanwan19></p><p>当然，这个 K8S 内外的服务调用是我们无法控制的，但我们控制的是我们业务逻辑代码中使用的时间。因此，这里可能会与我们在ECS上的表现有所不同，我们<strong>需要将那些耗在路上的时间也算进去</strong>。这样，<strong>整体上来看，业务逻辑处理的时间会比这个更低</strong>。</p><p>再看下面的图，我们看一下<strong>失败率</strong>，基本上偶尔有一两个跳点，<strong>它的占比</strong> <strong>逼近</strong> <strong>0%</strong> ，就是很低很低。</p><p><img src=/img/users/tanwan/tanwan20.png alt=tanwan20></p><p>然后我们看一下这个数据量，我们现在用的业务还不是太多，数据量一般，每分钟 100K 上下。我们首次业务实践的把整套基本上跑起来了，那我们把整套跑起来，就把这个框架基本上相对用熟了，我们团队就对框架的掌握也已经算是比较稳妥了。</p><p><img src=/img/users/tanwan/tanwan21.png alt=tanwan21></p><h3 id=游戏-sdk-业务全面重构>游戏 SDK 业务全面重构</h3><p>以上的实践表现很好，我们想要拓展在更多的业务上使用；前边实践就有点类似 小试牛刀；我们会将不熟悉的一般称为“坑”，并先踩过这些坑，以便在更大的业务场景上安全稳定地使用它们。在更大的业务场景上使用，我们需要把业务拆分得更细。现在，我们已经如下图将服务拆分为多个部分，并将多个业务接进来。可以看到，<strong>Kitex</strong> <strong>有几十个</strong> <strong>RPC</strong> <strong>服务，Hertz 的 HTTP 服务也上十个</strong>。</p><p><img src=/img/users/tanwan/tanwan22.png alt=tanwan22></p><p><strong>服务划分</strong>：每个服务是针对单一职责的业务能力封装，专注做好一件事情，可独立开发运行和扩展演化。</p><ol><li><strong>Kitex 微服务 RPC</strong></li></ol><ul><li>SettingService</li><li>AccountService</li><li>PayService &mldr; 几十个</li></ul><ol start=2><li><strong>Hertz 微服务 HTTP</strong></li></ol><ul><li>ApisdkPassport</li><li>ApiSdkLog</li><li>WebApi &mldr; 上十个</li></ul><p>当然，我们一直在持续推进做这件事。在这两个框架的支撑下，我们可以向其中塞入更多的业务。我们正在不断地向其中塞入更多的业务。如图所示是基本结构：Kitex 集成了一系列的微服务RPC，其中包含业务逻辑重心。对于前端来说，SDK 客户端或其它 HTTP 请求时，使用 Hertz 框架进行简单的接收和RPC调用后端处理逻辑，然后返回。这是我们SDK全面重构的一个实践，我们的团队实践后整体跑得都很稳定。</p><p>我们做的一部分事情的呈现就像下面的拓扑图，它是一张展示了我们的服务不断地调用的图。里面有很多服务，形成了一张类似网状的东西。当然，它是有迹可循的，如果一个请求发过来，它调用了几十个服务，那如果你要去排查一些东西，就需要用到链路追踪。</p><p><img src=/img/users/tanwan/tanwan23.png alt=tanwan23></p><p>Trace拓扑图</p><p><strong>Tracing</strong></p><p>微服务架构在对比单架构模式上的性能方面有较大提升，但对应业务复杂度随之上升，出现排查问题难度大，周期长，系统性能瓶颈分析难。 链路追踪是一种用于解决微服务架构中分布式系统调用链路追踪和性能分析的技术。通过在每个服务中加入一些跟踪信息，可以记录请求在各个服务之间的传输路径和所经过的时间，从而形成一个完整的调用链路，协助我们快速定位和解决性能瓶颈问题，进一步优化系统性能。</p><p>就像下图，它调用了哪些服务、中间耗的时间是多少、它的实施性是怎样、前置的服务调的是哪一个、在整个链条里边表现是怎样，在下面这个图就能够很清晰的看得到。目前这个图没有任何的不友好的颜色，就是说它没有任何的出错的地方，有出错它也会表现出来。</p><p>基本上，看一个报错信息是挺难的，就像刚刚前面那些图，偶尔来一两个跳点，那这个是怎么做出来的？当然，这个图是阿里云的 sls 服务里面做的。但它的底层就是用这个链路追踪，我们现在用的是 CloudWeGo 的 OpenTelemetry，它在 Hertz 和 Kitex 框架里都有提供完整的扩展包，我们把它用起来就可以了。</p><p><img src=/img/users/tanwan/tanwan24.png alt=tanwan24></p><p>链路追踪</p><p><strong>CloudWeGo</strong> <strong>与社区共建提供了系列组件，可使开发团队快速接入常用的链路追踪</strong>，如我们使用的 kitex-contrib/obs-opentelemetry 和 hertz-contrib/obs-opentelemetry ，提高我们的生产效率，让我们可以集中精力在编写业务相关代码。</p><p>社区共建的链路追踪组件对我们很有帮助，<strong>有什么问题就</strong> <strong>针对性加一些追踪</strong> <strong>，也就能看得出问题在哪里</strong>。否则几十个服务如果按照以前的方式，每台机器都去检查，哪怕把日志收集在一起，查到那一个后要把时序一步一步的对应起来，十分折腾。现在有了 CloudWeGo 和社区共建的这组件就很方便了，能够帮我们把事情做好。</p><p><strong>技术支持</strong></p><p>还提供了全面的技术支持 ^_^ 专群对接、业内大神多、 跟进迅速、效果显著&mldr;</p><p>我们当时选这个框架的时候，CloudWeGo 有一个大群，我们进去提问就有专人对接，最后给我们拉一个专群，里边大神很多。基本上我们的 QPS 可能就几千、几万，CloudWeGo 处理的 QPS可能达到3亿、 10 亿级别，他们面对的场景会比我们更加高并发，更加多用户，更有经验。</p><p>CloudWeGo 提供指导是很专业的，处理速度也比较快。当我们上午提出问题，CloudWeGo 当天下午就给出了答案，甚至下午就完成了代码的编写。</p><p>沟通落实起来非常高效，有时甚至比我们的同事更加高效，效果也很明显。下方左图可见，我们当时提出的问题很快就得到了审查并快速处理了。可见“opentelemetry”后边的数字是2，意味着是早期提出的东西，就很快地解决了。再次感谢 CloudWeGo 给予的大力支持。</p><p><img src=/img/users/tanwan/tanwan25.png alt=tanwan25></p><h2 id=运维之-slb-后端-pod-不优雅下线>运维之 SLB 后端 Pod 不优雅下线</h2><p>刚刚介绍了这一整套系统的落地过程。在落地过程中，可能会出现一些小问题，但这些问题是技术工作中常有的，不会影响整个系统大局的正常运行。先看下图，在上线过程中，我们可以进行压测，发现当滚动更新时，它就不优雅地下线，导致一些丢包。处理排查时，我们会发现它确实是一些设置上的问题。如果这个进程还在里面，我们可以让它延迟一下，因为它一直在提供服务，即使有请求过来，它也可以继续提供服务。</p><p>SLB 后端被移除的瞬间，客户端压测直接通过 SLB 的 IP 访问服务发生超时。经过团队协作抓包定位，发现超时的请求回复报文没有到达SLB后端，属于 SLB 后端不优雅下线情况下的丢包场景。</p><p><img src=/img/users/tanwan/tanwan26.png alt=tanwan26></p><blockquote><p>大家有兴趣的话可以参考一下阿里云的链接，如果有相似场景可以留意一下。</p><p>参考链接： <a href=https://help.aliyun.com/document_detail/86531.html>https://help.aliyun.com/document_detail/86531.html</a></p></blockquote><h3 id=运维之滚动更新信号量处理>运维之滚动更新信号量处理</h3><p>接着，我们再讲一个运维上的问题，就是在滚动更新时，有一个信号量的处理。我们期望在k8s滚动更新新版本时，让它优雅关闭，就是走到 graceful shutdown 而非 force exit 。在排查和调试时，我们会发现它走到了我不期望它走到的地方。</p><p>可能 K8S 与我们平常使用的 ECS 系统有所不同，因为在 K8S 中，信号量在发送终止指令或滚动更新时可能会不同。那么，我们希望程序能够正常处理这些情况。为了解决这个问题，我们修改了处理函数，并将其提交给了 CloudWeGo 团队。他们为我们提供了一个自定义函数，并将其集成到 PR 中。最后，该 PR 是Hertz0.2.0 发布。下边这个图就是我们当时的一些处理过程。</p><blockquote><p>Hertz v0.2.0 ：https://github.com/cloudwego/hertz/pull/143</p></blockquote><p><img src=/img/users/tanwan/tanwan27.png alt=tanwan27></p><h3 id=取-oss-文件效率问题的暴露>取 Oss 文件效率问题的暴露</h3><p>接下来分享我们实际在代码层面的一些优化，简单讲解优化事项。</p><p>抽一个事项来说，就是我们一开始这个服务上线的时候，能看得到</p><ol><li>基本要170ms左右，哪怕是内部调用也很慢</li><li>在内网测试环境一直没测出问题</li></ol><p>我们使用链路追踪，分段细化加入 span 记录链路时间，分析每个 span 的耗时，找出耗时过长的 span，然后查看线上相关数据。</p><ul><li><strong>找出问题：</strong></li></ul><ol><li>发现耗时都是在 SettingService 读取 oss 文件时</li><li>猜测并发时自身的 dataMap 经常有锁住</li><li>读取非必需的文件时，数据经常为空，具有缓存穿透问题</li><li>过多的缓存冷数据</li></ol><p><img src=/img/users/tanwan/tanwan28.png alt=tanwan28></p><ul><li><strong>问题优化</strong></li></ul><ol><li>初步使用 gcache 优化，阻止多个协程并发读取同一文件</li><li>根据 LRU 算法，区分冷热数据，按量使用 Goroutine 定时主动并行更新热点数据</li><li>对于非必需配置文件，进行缓存穿透处理，缓存 nil 值</li><li>加强 func 的单一职责，减少读取文件的数量</li></ol><p><strong>优化效果: 平均时延降低到10+ms</strong></p><p>我们确实是几十毫秒就搞定了，但是那个图是之前的，现在我们的业务能够达到 10 毫秒左右。</p><p><img src=/img/users/tanwan/tanwan29.png alt=tanwan29></p><p>这就是我们使用 CloudWeGo 架构的落地，从前边的这个一小点突破，到这个框架熟悉了后选择了一个很重要的业务场景去用它，然后我们的开发人员都熟悉了后在更大的业务场景下使用 CloudWeGo 重构了我们整个 SDK 接口。</p><p>第三个问题是我们在运维或技术代码方面存在一些小问题。因此，我们决定将整个流程走下来，整体运行得挺好的。</p><h3 id=整体收益>整体收益</h3><ol><li><strong>稳定性提升</strong></li></ol><ul><li><strong>上限提升</strong> <strong>压测</strong> <strong>单</strong> <strong>Pod</strong> <strong>1c2g 400+</strong> <strong>qps</strong> <strong>。</strong> 我们追求的是稳定性，即实现方式的上限提升，从而单台机器处理能力也更高了。现在，我们单台单个 Pod 可以测试出1核 2G 的内存，基本上可以测试到 400 个 QPS。在登录场景下，明显比php-fpm的处理效果要好。</li><li><strong>自动伸缩容。</strong> 第二个是 K8S 这一块的自动伸缩容，这一块是 K8S 天生以来的好东西。它请求量大了，会自动扩多个Pod并调度起来，从而可承载的业务请求量更大。</li><li><strong>可承载的业务请求量更大</strong></li></ul><ol start=2><li><strong>CloudWeGo</strong> <strong>提高开发成效</strong></li></ol><p>整体收益是使用 CloudWeGo 框架后，我们提高了开发效率、提升了性能可靠性、简化了部署流程，现在一键部署很方便。此外，我们还增加了业务弹性，可以往里面塞更多东西，从而降低成本，符合当前降本增效的主题，但需要不断地往里边塞更多业务。</p><ul><li>提升性能和可靠性</li><li>提高开发效率</li><li>简化部署和管理</li><li>增加业务弹性</li><li>降低IT成本</li><li>&mldr;&mldr;</li></ul><ol start=3><li><strong>团队能力提升</strong></li></ol><p>我们的人员已经具备一定的技术水平，他们确实需要扩充自己的技术栈，丰富团队的技术能力。我们学习了 Go 语言，并与 CloudWeGo 一起成长，我们自己才能在行业抢占先机。我们的定位不同，所以最终的结果也会不同。我们整个团队可以应对更广泛的业务场景，因为以前可能只能处理 a 类业务，现在我们团队也可以处理b、c、d、e类业务。</p><ul><li>丰富队伍的技术栈</li><li>强者 CloudWeGo 指引，自身更强</li><li>可应对更宽广的业务场景</li><li>&mldr;</li></ul><p>因此，我们用了 CloudWeGo 之后，整体收益还是比较不错的。</p><h2 id=给相似业务的参考建议>给相似业务的参考建议</h2><ol><li><strong>根据团队水平、确定团队推进的节奏。</strong></li></ol><p>有一些团队是很高水平的，因此他们可能就直接使用了这些技术，有些团队可能已经成功转型了。但是我们的团队可能还没有完全掌握这些技术，因此我们需要逐步推进，不断突破和运用，团队用熟之后，再整体扩大。类似要试点，试点完之后再扩大，控制好这种节奏。</p><ol start=2><li><strong>做好相关业务拆分的粒度。</strong></li></ol><p>业务拆分看各自团队的各自场景，像我们贪玩游戏，基本上我们能想得到的一般是拆服务。主要是用户相关服务拆一个服务、支付相关服务拆一个服务，当然你的配置也可以拆一个服务，当然还有更多，甚至于你的弹窗服务也可以拆一个服务。</p><p>像我们前一阵子也了解到字节跳动有好几万个服务，我们现在也才上百个服务，所以以后要做的事情还有很多，我们的业务也在不断地发展了。然后这个服务拆分这部分，根据各自的业务团队来，根据业务场景来自己 hold 住就比较 OK 了。</p><ol start=3><li><strong>运维团队的专业水平、学习速度，善用外部资源。</strong></li></ol><p>运维这一块，基本上我们写好代码，也要部署上去。如果手动的话，确实运维团队也要不断地学习。比如说你以前可能是在服务器上操作的，现在可能都在后台界面，不断地去使用新的工具，要不断地提升自己的学习速度、善用外部资源。</p><p>如果你不太熟，可以找别的人来教一下你。比如说云服务提供商，他要卖一个产品，肯定把这个产品用熟了之后才卖给你，那你跟他学到的东西就很多了。比如，我们和 CloudWeGo 就学到了很多，我们讲站在巨人的肩膀上，自己也可以看得更高，摸到的天花板就更高。</p><ol start=4><li><strong>技术业务表现的数据监控 及 相关工具的使用。(链路追踪)</strong></li></ol><p>在做实践落地的这个过程中，一定要做好这个数据监控，要用好相关工具。我们现在用到了比如说链路追踪，这个工具的体现就很好。</p><p>因为每个团队不一样，每个场景不一样，每个行业不一样，大家就按照自己的场景来做一下自己的参考。</p><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no"><a href=https://github.com/cloudwego/cloudwego.github.io/issues/new>Please tell us how we can improve</a>.</p></div><script>const yesButton=document.querySelector(".feedback--answer-yes"),noButton=document.querySelector(".feedback--answer-no"),yesResponse=document.querySelector(".feedback--response-yes"),noResponse=document.querySelector(".feedback--response-no"),disableButtons=()=>{yesButton.disabled=!0,noButton.disabled=!0},sendFeedback=e=>{if(typeof ga!="function")return;const t={command:"send",hitType:"event",category:"Helpful",action:"click",label:window.location.pathname,value:e};ga(t.command,t.hitType,t.category,t.action,t.label,t.value)};yesButton.addEventListener("click",()=>{yesResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(1)}),noButton.addEventListener("click",()=>{noResponse.classList.add("feedback--response__visible"),disableButtons(),sendFeedback(0)})</script><br><div class=td-page-meta__lastmod>Last modified July 9, 2024: <a data-proofer-ignore href=https://github.com/cloudwego/cloudwego.github.io/commit/a7edc8302c487ca742cd11a591fd3f27c9a361a8>website: add more use cases in en version. (#1104) (a7edc830)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Lark aria-label=Lark><a class=text-white target=_blank rel=noopener href="https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=693v2544-2664-4421-b50f-7f1912p745r6" aria-label=Lark><img src=/webfonts/lark.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/CloudWeGo aria-label=Twitter><img src=/webfonts/x-twitter.svg alt style=width:26px;line-height:32.5px;margin-bottom:6px;fill:#fff></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/cloudwego aria-label=GitHub><i class="fa-brands fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Discord aria-label=Discord><a class=text-white target=_blank rel=noopener href=https://discord.gg/jceZSE7DsW aria-label=Discord><i class="fa-brands fa-discord"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2026 The CloudWeGo Authors</small><p class="mt-2 text-white"><a class=cloudwego-link href=/about/ target=_blank rel=noopener>About</a>
|
<a class=cloudwego-link href=https://github.com/cloudwego/cloudwego.github.io/blob/main/LICENSE target=_blank rel=noopener>License</a></p></div></div></div></footer></div><script src=/js/popper.min.js></script><script src=/js/bootstrap.min.js></script><script src=https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js></script><script src=https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js></script><script src=/js/main.min.84ba9af565392cd38463af5d663ae483367bd953c1d38a4273aa09e0bfd62d65.js integrity="sha256-hLqa9WU5LNOEY69dZjrkgzZ72VPB04pCc6oJ4L/WLWU=" crossorigin=anonymous></script><script src=/js/prism.js></script><script src=/js/prism-custom.js></script><script src=/js/tabpane-persist.js></script><script src=/js/docsearch.js></script><script type=text/javascript>let siteLang=window.location.pathname.startsWith("/zh/")?"zh":"en";docsearch({appId:"V7I042F992",apiKey:"8380a7ac88106841cb43fb000fa2edb4",indexName:"cloudwego",container:"#docsearch",searchParameters:{hitsPerPage:5,facetFilters:[`lang:${siteLang}`]},transformItems(e){return e.map(e=>({...e,url:e.url.replace("www.cloudwego.io",location.host).replace("https:",location.protocol)}))}})</script><script src=/js/outbound-link.js></script><script src=/js/navScroll.js></script></body></html>