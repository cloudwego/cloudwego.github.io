<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>CloudWeGo – Kitex</title><link>https://www.cloudwego.io/projects/kitex/</link><description>Recent content in Kitex on CloudWeGo</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 03 Jan 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://www.cloudwego.io/projects/kitex/index.xml" rel="self" type="application/rss+xml"/><item><title>Blog: Kitex Release</title><link>https://www.cloudwego.io/blog/releases/kitex/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/releases/kitex/</guid><description/></item><item><title>Blog: Kitex Release v0.12.0</title><link>https://www.cloudwego.io/blog/2025/01/03/kitex-release-v0.12.0/</link><pubDate>Fri, 03 Jan 2025 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2025/01/03/kitex-release-v0.12.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="simplified-product-recommendation---remove-apache-thrift-dependency">Simplified Product Recommendation - Remove Apache Thrift Dependency&lt;/h3>
&lt;p>We strongly recommend removing Apache Codec to resolve the compilation issues caused by Apache&amp;rsquo;s incompatible changes and to &lt;strong>reduce the product size by 50%&lt;/strong>.&lt;/p>
&lt;p>Please replace it with Kitex&amp;rsquo;s own Thrift codec: FastCodec or Frugal, which does not rely on Apache Thrift Codec.&lt;/p>
&lt;p>Future version plans: Kitex will remove Apache products by default. User guide: &lt;a href="https://www.cloudwego.io/docs/kitex/best-practice/remove_apache_codec/">Kitex Remove Apache Thrift User Guide&lt;/a>&lt;/p>
&lt;h3 id="new-features">New Features&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>Thrift Streaming over TTHeader - Custom Streaming Protocol&lt;/strong>&lt;/p>
&lt;p>Supported streaming calls based on the TTHeader protocol, optimizing stability issues caused by the high complexity of the gRPC streaming protocol.&lt;/p>
&lt;p>Provided a new streaming interface, StreamX, to solve various user experience issues with the original streaming interface and provide best practices for streaming interfaces.&lt;/p>
&lt;p>For more details: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/streamx/">StreamX User Documentation and Best Practices&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Graceful Shutdown for gRPC Streaming&lt;/strong>&lt;/p>
&lt;p>Added support for a graceful shutdown feature to address upstream errors caused by service upgrades or updates.&lt;/p>
&lt;p>For usage: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/protocol/streaming/grpc/graceful_shutdown/">gRPC Streaming Graceful Shutdown&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>JSON Generic Call Supports gRPC Streaming&lt;/strong>&lt;/p>
&lt;p>JSON generic calls now support gRPC Streaming interfaces (client-side only). This is the official release after trial in v0.10.0.&lt;/p>
&lt;p>For usage: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/generic-call/generic_streaming/">User Guide to Generic Call for Streaming&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="experience-optimization">Experience Optimization&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>gRPC Streaming Log Optimization&lt;/strong>&lt;/p>
&lt;p>For streaming concatenation scenarios, if the downstream error is due to an exit of the upstream Stream exiting, the error will include the suffix &amp;ldquo;[triggered by {serviceName}]&amp;rdquo; will be included in the error, which is convenient for locating the problem.&lt;/p>
&lt;p>Errors returned by Send such as &lt;code>the stream is done&lt;/code> now reflect the actual error that caused the stream to close.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Code Generation Tool Kitex Tool&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Optimization of Generation Speed and Tool Installation&lt;/strong>: Now Thriftgo is built into Kitex, significantly improving generation speed, especially for scenarios with particularly large IDL files. There is no need to install or upgrade Thriftgo anymore.&lt;/p>
&lt;p>&lt;strong>Minimizing Product Size&lt;/strong>: To minimize product size, Frugal can be used. For gray scale adoption, it supports specifying certain structs to use Frugal serialization.
For more details, refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/code_generation/">Code Generation Tool&lt;/a> for instructions on -frugal-struct and -gen-frugal parameters.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="breaking-change---no-impact-for-99-of-users">Breaking Change - No Impact for 99% of Users&lt;/h3>
&lt;p>Kitex will strive to ensure compatibility with normal usage methods. Some users may have dependencies on certain code definitions of Kitex, and this version adjustment of Kitex will have an impact on these users.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Removing &lt;code>thrift.NewBinaryProtocol&lt;/code>
&lt;code>thrift.NewBinaryProtocol&lt;/code> is Kitex&amp;rsquo;s implementation of the Apache thrift.TProtocol interface. Because the trans part directly uses Kitex&amp;rsquo;s ByteBuffer, the performance is better than Apache thrift.TBinaryProtocol.
The Deprecation comment has been added to it in v0.11.0.&lt;/p>
&lt;p>&lt;strong>Removing Reason&lt;/strong>: To remove the Apache Thrift dependency, the implementation needs to be removed.&lt;/p>
&lt;p>&lt;strong>User Modification Method&lt;/strong>: This implementation was originally used with Apache Codec. If you still need to rely on Apache Codec, please directly use Apache&amp;rsquo;s TBinaryProtocol.
If you think that it has an impact on performance, you can fork the old version of Kitex, refer to github/cloudwego/kitex v0.10.0&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">import&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;github.com/apache/thrift/lib/go/thrift&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">tProt&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">thrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewTBinaryProtocol&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">thrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewTMemoryBufferLen&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1024&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">true&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>Removing &lt;code>generic.ServiceInfo&lt;/code>&lt;/strong>&lt;/p>
&lt;p>Generic removed an API &lt;code>generic.ServiceInfo&lt;/code>.&lt;/p>
&lt;p>&lt;strong>Removing Reason&lt;/strong>: To prepare for future multi-service registration on a generic server, the generic implementation has been refactored (v0.11.0), and this API is no longer used.&lt;/p>
&lt;p>&lt;strong>User Modification Method&lt;/strong>: This API was replaced by &lt;code>generic.ServiceInfoWithGeneric&lt;/code>. Please use it instead.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">import&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;github.com/cloudwego/kitex/pkg/generic&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8f5902;font-style:italic">// removed&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">ServiceInfo&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">pcType&lt;/span> &lt;span style="color:#000">serviceinfo&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PayloadCodec&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">serviceinfo&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ServiceInfo&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#8f5902;font-style:italic">// please use this instead&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">ServiceInfoWithGeneric&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">g&lt;/span> &lt;span style="color:#000">Generic&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">serviceinfo&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ServiceInfo&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1541">#1541&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1633">#1633&lt;/a>] feat(ttstream): support ttheader streaming and streamv2 interface&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1623">#1623&lt;/a>] feat(gRPC): optimize gRPC error prompt and metrics, assisting in troubleshooting problems&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1556">#1556&lt;/a>] feat(gRPC): support gRPC graceful shutdown&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1467">#1467&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1627">#1627&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1619">#1619&lt;/a>] feat(generic): support thrift streaming(over gRPC) for json generic client&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1607">#1607&lt;/a>] feat(tool): kitex tool support gen frugal codec for certain struct&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1526">#1526&lt;/a>] feat(generic): support an option to remove go.tag annotation&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1536">#1536&lt;/a>] feat(generic): support an option to set IDL ParseMode for each client&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1510">#1510&lt;/a>] feat: register service with service level middleware&lt;/p>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1635">#1635&lt;/a>] optimize: add two function for binary protocol to get bufiox reader and writer&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1630">#1630&lt;/a>] optimize(tool): implement no recursive generate to support incremental update&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1617">#1617&lt;/a>] optimize(retry): optimize UpdatePolicy and add test cases to check invalid retry policy. &amp;lt;v0.11.0, if the FailurePolicy is nil and type is 0 or &amp;gt;1, will trigger nil panic. The bug has been fixed in v0.11.0, this pr is to add test cases and optimize UpdatePolicy to ignore the nil panic&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1606">#1606&lt;/a>] optimize(tool): use embedded thriftgo as default option&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1595">#1595&lt;/a>] optimize(tool): optimize pb tool code&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1599">#1599&lt;/a>] optimize(tool): call FastWriteNocopy in FastWrite to avoid misuse by users&lt;/p>
&lt;h3 id="refactor">Refactor:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1615">#1615&lt;/a>] refactor: get rid of apache thrift in go.mod&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1611">#1611&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1614">#1614&lt;/a>] refactor: move ttheader codec logic to gopkg&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1553">#1553&lt;/a>] refactor(codec/thrift): unified typecodec implementation and adjust new file layout&lt;/p>
&lt;h3 id="perf">Perf:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1581">#1581&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1628">#1628&lt;/a>] perf(timeout): refactor new rpctimeout implementation to improve performance&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1564">#1564&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1567">#1567&lt;/a>] perf: reduce object allocation for circuitbreak middleware and retry context&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1557">#1557&lt;/a>] perf(rpcinfo): remove lock for rpcinfo.RPCStats&lt;/p>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1622">#1622&lt;/a>] fix(generic): use jsoniter instead of sonic for json generic-call, since sonic doesn&amp;rsquo;t support map[interface{}]interface{}&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1562">#1562&lt;/a>] fix: deep copy function of the generated code cannot copy the empty string&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1602">#1602&lt;/a>] fix(gRPC): check if the type assertion succeed in ProtocolMatch to avoid panic&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1598">#1598&lt;/a>] fix(retry): fix issue that mixed retry cannot update its config correctly&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1590">#1590&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1572">#1572&lt;/a>] fix(generic): set default values for optional fields of primitive types with generic with dynamicgo&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1580">#1580&lt;/a>] fix(netpoll): fix timeout caused by partial use of the Read method of remote.ByteBuffer&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1574">#1574&lt;/a>] fix(trace): stream event handler ignore io.EOF event&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1563">#1563&lt;/a>] fix(generic): fix the issue where the generic client sets the parse mode of CombineServices and then requests causes &amp;ldquo;unknown service&amp;rdquo; error&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1568">#1568&lt;/a>] fix(wpool): fix the issue of wpool object allocation, and incorrect ctx causing profiler errors.&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1558">#1558&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1555">#1555&lt;/a>] fix(bthrift): fix the issue of no recursion conversion of unknown field type under bthrift&lt;/p>
&lt;h3 id="chore">Chore:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1593">#1593&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1560">#1560&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1561">#1561&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1559">#1559&lt;/a>] chore(test): fix data race issue, unstable issue and long time running issue of some test cases&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1634">#1634&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1632">#1632&lt;/a>][&lt;a href="https://github.com/cloudwego/kitex/pull/1573">#1573&lt;/a>] chore(dep): upgrade frugal, localsession and other cloudwego dependency versions&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1616">#1616&lt;/a>] chore(generic): remove deprecated apis/interfaces/variables&lt;/p></description></item><item><title>Blog: Kitex Release v0.11.0</title><link>https://www.cloudwego.io/blog/2024/09/12/kitex-release-v0.11.0/</link><pubDate>Thu, 12 Sep 2024 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2024/09/12/kitex-release-v0.11.0/</guid><description>
&lt;blockquote>
&lt;p>Highly recommend upgrading Kitex version to v0.11.3 or higher, because there&amp;rsquo;s some bugfix on v0.11.0.&lt;/p>
&lt;/blockquote>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="new-feature">New Feature&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Mixed Retry&lt;/strong>: Supports enabling both &amp;ldquo;Failure Retry&amp;rdquo; and &amp;ldquo;Backup Request&amp;rdquo; strategies simultaneously, which can reduce tail requests while increasing the success rate of retries, for more detail: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/retry/">Retry&lt;/a>&lt;/li>
&lt;li>&lt;strong>Custom Payload Validation&lt;/strong>: To avoid inconsistencies in data transmission caused by hardware failures or data tampering, Kitex provides validation functionality for payload messages and supports custom extensions. For usage: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/payload_validator/">Payload Validator&lt;/a>.&lt;/li>
&lt;/ol>
&lt;h3 id="feature-optimization">Feature optimization&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Frugal ARM Optimization&lt;/strong>: Frugal v0.2.0 now supports a new implement by reflection&lt;/li>
&lt;li>&lt;strong>Kitex Tool Improvement&lt;/strong>: Kitex Tool provide a new param &lt;code>-rapid&lt;/code> to integrates Thriftgo and there&amp;rsquo;s a slightly improved speed.&lt;/li>
&lt;li>&lt;strong>Generating Multiple Handlers for Multiple Services&lt;/strong>：Since this version, Kitex tool provide each service with independent handler file and register them into server，for more details: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/multi_service/multi_handler/">Generating Multiple Handlers for Multiple Services&lt;/a>&lt;/li>
&lt;li>&lt;strong>Generic Streaming for JSON [on trial]&lt;/strong>：JSON generic streaming has now support streaming (client only)，currently we&amp;rsquo;re doing some optimization, you can have a try by following this doc: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/generic-call/generic_streaming/">Generic Streaming&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="others">Others&lt;/h3>
&lt;ol>
&lt;li>Support Go 1.18~1.23. Minimum support for Golang 1.18，if your golang version is lower than 1.18, you&amp;rsquo;ll see &lt;code>note: module requires Go 1.18&lt;/code> when you compile.&lt;/li>
&lt;li>Remove Apache Thrift，and refactor all related interface into github.com/cloudwego/gopkg/thrift.&lt;/li>
&lt;/ol>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1509">#1509&lt;/a>] feat(retry): support Mixed Retry which integrating Failure Retry and Backup Request&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1478">#1478&lt;/a>] feat: customized payload validator&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1514">#1514&lt;/a>] feat(grpc): server returns cancel reason&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1513">#1513&lt;/a>] feat(tool): support updating import path for PkgInfo&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1425">#1425&lt;/a>] feat(tool): support generating multiple handlers for multiple services&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1491">#1491&lt;/a>] feat(grpc): add GetTrailerMetadataFromCtx&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1492">#1492&lt;/a>] feat: add GetCallee to kitexutil to get the service name of callee&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1479">#1479&lt;/a>] feat(tool): embed thriftgo into kitex tool&lt;/p>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1485">#1485&lt;/a>] optimize: add cachekey to discovery event for debug&lt;/p>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1525">#1525&lt;/a>] fix: move json-iterator back to support marshal &lt;code>map[any]any&lt;/code>&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1471">#1471&lt;/a>] fix(streaming): resolve ctx diverge in server-side streaming&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1515">#1515&lt;/a>] fix(gRPC): pass error when client transport is closed&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1501">#1501&lt;/a>] fix(generic): judge business error directly&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1503">#1503&lt;/a>] fix: return an unknown service/method exception to client correctly under multi_service server scenario&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1487">#1487&lt;/a>] fix(generic): fix a generic serviceInfo compatible issue&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1489">#1489&lt;/a>] fix(codec): wrap trans error for apache thrift read error&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1486">#1486&lt;/a>] fix(trans/netpoll): log when panic in onConnRead&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1476">#1476&lt;/a>] fix: fix GetServerConn interface assert for streamWithMiddleware&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1481">#1481&lt;/a>] fix(gonet): adjust gonet server read timeout to avoid read error&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1466">#1466&lt;/a>] fix: allow HEADERS frame with empty header block fragment&lt;/p>
&lt;h3 id="refactor">Refactor:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1512">#1512&lt;/a>] refactor: thrift and generic codec uses bufiox interface for encoding and decoding&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1490">#1490&lt;/a>] refactor: optimized apache codec without reflection&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1483">#1483&lt;/a>] refactor: use github.com/cloudwego/gopkg/protocol/thrift/apache&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1474">#1474&lt;/a>] refactor: rm apache thrift in internal/mocks&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1470">#1470&lt;/a>] refactor: rm apache thrift in pkg/generic &amp;amp; netpollmux&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1450">#1450&lt;/a>] refactor(generic): remove apache thrift.TProtocol from generic&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1441">#1441&lt;/a>] refactor: deprecate bthrift, use cloudwego/gopkg&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1455">#1455&lt;/a>] refactor(test): perf optimize and log loc correct&lt;/p>
&lt;h3 id="tests">Tests:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1469">#1469&lt;/a>] test: replace judgement of mem stats of client finalizer by closed count check&lt;/p>
&lt;h3 id="perf">Perf:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1527">#1527&lt;/a>] perf(grpc): bdp ping rate limit&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1511">#1511&lt;/a>] perf(thrift): encodeBasicThrift write logic didn&amp;rsquo;t use kitex BinaryProtocol&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1504">#1504&lt;/a>] perf(grpc): zero allocation in hot path&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1497">#1497&lt;/a>] perf: add option to enable spancache for fastpb&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1495">#1495&lt;/a>] perf(thrift): use kitex BinaryProtocol replace apache BinaryProtocol for apache thrift codec&lt;/p>
&lt;h3 id="chore">Chore:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1532">#1532&lt;/a>] chore: update dependency&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1522">#1522&lt;/a>] chore(generic): make generic streaming APIs internal&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1465">#1465&lt;/a>] chore(generic): add an external method to create service info for generic streaming client&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1468">#1468&lt;/a>] build: adapt to go1.23rc2&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1482">#1482&lt;/a>] chore(generic): add generic base using gopkg base&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1463">#1463&lt;/a>] chore: fix grpc keepalive test by start server responsiblly&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1462">#1462&lt;/a>] chore(test): fix xorshift64 in consist_test.go&lt;/p>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1454">#1454&lt;/a>] chore(ci): speed up multiple ci processes 8min -&amp;gt; 1min&lt;/p></description></item><item><title>Blog: Kitex Release v0.10.0</title><link>https://www.cloudwego.io/blog/2024/06/12/kitex-release-v0.10.0/</link><pubDate>Wed, 12 Jun 2024 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2024/06/12/kitex-release-v0.10.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="performance-optimization">Performance Optimization&lt;/h3>
&lt;ol>
&lt;li>Long connection: conncurrency = 100, qps increased by 4%, p99 decreased by 18%&lt;/li>
&lt;li>connection multiplexing: conncurrency = 100, qps increased by 7%, p99 decreased by 24%&lt;/li>
&lt;li>gRPC: conncurrency = 100, qps increased by 8%，p99 decreased by 10%&lt;/li>
&lt;/ol>
&lt;h3 id="code-generation-simplification-and-optimization">Code Generation Simplification and Optimization&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Remove non-serialization code (By default)&lt;/strong>: the original kitex_gen Thrift code includes Processor code to maintain consistency with Apache Thrift. However, Kitex does not need these codes. To solve users&amp;rsquo; code generation painpoint, this version Kitex removes this part of the code, increasing the generation speed by about 10%.&lt;/li>
&lt;li>&lt;strong>Remove Apache Codec code (Remove if configured)&lt;/strong>：Kitex has custom FastCodec code, and the original Apache Codec is only required when using Buffered protocol. The new version of Kitex implements SkipDecoder. If enabled, the serialization will be completely independent of Apache Codec, reducing the generated code size by about 50%. Refer to this doc for usage &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/skip_decoder/">SkipDecoder&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="new-feature">New Feature&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Thrift Serialize Data Ondemands&lt;/strong>：Support defining FieldMask to achieve on-demand serialization of data (field clipping, merging, RPC Performance optimization, etc.), see details &lt;a href="https://github.com/cloudwego/thriftgo/tree/main/fieldmask">Thrift FieldMask RFC&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="feature-optimization">Feature optimization&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>CircuitBreaker&lt;/strong>： Support for customized circuit breaker error types.&lt;/li>
&lt;li>&lt;strong>Failure Retry&lt;/strong>：The code configuration of the customized result retry adds the ctx parameter to facilitate users to check whether to retry based on ctx information.&lt;/li>
&lt;li>&lt;strong>Remove cache from consistent hashing&lt;/strong>：Solve the issue of high latency and memory increase caused by scattered hash keys. After removing the cache, it can effectively reduce memory usage and cache management consumption in scenarios where keys are particularly scattered or even close to random distribution.&lt;/li>
&lt;/ol>
&lt;h3 id="user-experience-and-tool-optimization">User Experience and Tool Optimization&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Kitex tool compatibility check&lt;/strong>：Optimize the &amp;ldquo;undefined&amp;rdquo; compile error caused by introducing new definitions in old generated code. The Kitex tool will check the Kitex version used in go.mod before generating code. If the Kitex tool and Kitex version are incompatible, the code will not be generated and will provide corresponding upgrade and downgrade prompts and documentation.&lt;/li>
&lt;/ol>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1370">#1370&lt;/a>] feat(loadbalance): do not cache all the keys for Consistent Hash&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1359">#1359&lt;/a>] feat:(generic) jsonpb using dynamicgo support parse IDL from memory&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1353">#1353&lt;/a>] feat(retry): add ctx param for customized result retry funcs&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1352">#1352&lt;/a>] feat: add option to specify ip version for default HTTPResolver&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1316">#1316&lt;/a>] feat(kitex tool): support dependencies compatibility checking&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1346">#1346&lt;/a>] feat(generic): set dynamicgo parse mode&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1336">#1336&lt;/a>] feat(tool): fast-codec supports Thrift Fieldmask&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1313">#1313&lt;/a>, #1378] feat(thrift codec): implement skipDecoder to enable Frugal and FastCodec for standard Thrift Buffer Protocol&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1257">#1257&lt;/a>] feat: CBSuite custom GetErrorType func&lt;/li>
&lt;/ol>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1349">#1349&lt;/a>] optimize(gRPC): gRPC onError uses CtxErrorf to print log with information in ctx&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1326">#1326&lt;/a>] optimize(tool): remove thrift processor for less codegen&lt;/li>
&lt;/ol>
&lt;h3 id="perf">Perf:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1369">#1369&lt;/a>] perf(thrift): optimized skip decoder&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1314">#1314&lt;/a>] perf: use dirtmake to reduce memclr cost&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1322">#1322&lt;/a>] perf(codec): support fast write nocopy when using netpoll link buffer&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1276">#1276&lt;/a>] perf: linear allocator for fast codec ReadString/ReadBinary&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1320">#1320&lt;/a>] perf(codec): fast codec use batch alloc&lt;/li>
&lt;/ol>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1379">#1379&lt;/a>] fix: fix a bug &amp;ldquo;unknown service xxx&amp;rdquo; when using generic client by not writing IDLServiceName when it&amp;rsquo;s generic service&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1368">#1368&lt;/a>] fix(remote): modify the error message thrown when no target service is found&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1374">#1374&lt;/a>] fix: init default values when using liner allocator&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1361">#1361&lt;/a>] fix: span cache re-cap bytes when using Make&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1362">#1362&lt;/a>] fix(payloadCodec): replace the registered PayloadCodec if the type is same when using WithPayloadCodec for server-side&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1364">#1364&lt;/a>] fix: fix grpc compressor mcache free panic when data is empty&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1328">#1328&lt;/a>] fix(gRPC): release connection in DoFinish for grpc streaming to close the short connection&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1307">#1307&lt;/a>] fix(connpool): kitex long pool reset idleList element to nil to prevent conn leak&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1294">#1294&lt;/a>] fix(netpollmux): fix a bug that disables multi-service by assigning the first svcInfo to targetSvcInfo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1308">#1308&lt;/a>] fix(generic): not write generic method name for binary generic exception to align with method names of services not using binary generic&lt;/li>
&lt;/ol>
&lt;h3 id="refactor">Refactor:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1344">#1344&lt;/a>] refactor(tool): export thriftgo template definition in kitextool&lt;/li>
&lt;/ol>
&lt;h3 id="chore">Chore:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1385">#1385&lt;/a>] chore: update dynamicgo to v0.2.8&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1383">#1383&lt;/a>] chore: upgrade netpoll to v0.6.1&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1376">#1376&lt;/a>] chore: integration test use go 1.20 to solve the compatibility issue of official gRPC in kitex-tests repo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1355">#1355&lt;/a>] chore: upgrade netpoll to v0.6.1 pre-release version&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1338">#1338&lt;/a>] chore: correct the comment of FreezeRPCInfo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1347">#1347&lt;/a>] chore: use runtimex to replace choleraehyq/pid&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1342">#1342&lt;/a>] chore: update sonic/loader to v0.1.1&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1334">#1334&lt;/a>] chore: update dynamicgo to v0.2.3&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1324">#1324&lt;/a>] chore: update dynamicgo and sonic version&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1317">#1317&lt;/a>] chore: frugal v0.1.15 (with migrated iasm)&lt;/li>
&lt;/ol>
&lt;hr>
&lt;p>&lt;strong>Thanks a lot to those community contributors who submit some pull requests or share your ideas for this version:&lt;/strong>
@XiaoYi-byte&lt;/p></description></item><item><title>Blog: Kitex Release v0.9.0</title><link>https://www.cloudwego.io/blog/2024/03/04/kitex-release-v0.9.0/</link><pubDate>Mon, 04 Mar 2024 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2024/03/04/kitex-release-v0.9.0/</guid><description>
&lt;p>v0.9.0 provides two important features for Thrift: Thrift Streaming and Multi-Service. Multiple RC versions have been released for internal usage to collect feedback, so the final release version is delayed.&lt;/p>
&lt;p>Below are some important changes:&lt;/p>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="features">Features&lt;/h3>
&lt;p>&lt;strong>1. Thrift Streaming&lt;/strong>&lt;/p>
&lt;p>The Thrift Streaming feature based on gRPC (HTTP2) has been officially released. Users can use Thrift to define their own Streaming requests. To maintain compatibility with IDL parsing, Kitex chooses to use annotation to define stream method. See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/protocol/streaming/grpc/thrift_streaming/">Thrift Streaming Usage&lt;/a>. This version also improves the monitoring and reporting of Streaming requests, which also applies to gRPC-Protobuf. Note that Thrift is mainly used for data serialization and does not use the Thrift message protocol.&lt;/p>
&lt;p>Due to the complexity of the HTTP2 protocol, it has a certain impact on performance. We plan to release a self-developed Streaming protocol to improve performance in the future.&lt;/p>
&lt;p>&lt;strong>2. Full Thrift MultiService support&lt;/strong>&lt;/p>
&lt;p>In the v0.8.0 version, Kitex supports gRPC multi-service to align gRPC, while Thrift previously provided &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/combine_service/">Combine Service&lt;/a> as &amp;lsquo;Multi-Service&amp;rsquo; to ensure protocol compatibility. However, the use of this feature requires that the methods of different IDL services cannot be the same, and it is not real multi-Service.&lt;/p>
&lt;p>In this version, Kitex provides real multi-service functionality at the protocol level based on TTHeader, supporting the registration of multiple Thrift IDL Services in one server, while also being compatible with old CombineServices. See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/multi_service/">Multi-Service&lt;/a>.&lt;/p>
&lt;p>Note: Thrift Multi-Service requires the use of the TTHeader transport protocol.&lt;/p>
&lt;p>&lt;strong>3. Frugal&amp;rsquo;s experimental support for ARM64&lt;/strong>&lt;/p>
&lt;p>Supported the use of Frugal on ARM64 machines, temporarily supported by Fallback.&lt;/p>
&lt;p>&lt;strong>4. Server level context timeout&lt;/strong>&lt;/p>
&lt;p>Added server.WithEnableContextTimeout supports adding timeout to context at the server level. And in the new version, Kitex will default pass the client-side timeout in the TTHeader to server-side. Usage please see &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/timeout/">Timeout&lt;/a>.&lt;/p>
&lt;p>Note: TTHeader transport protocol is required.&lt;/p>
&lt;p>&lt;strong>5. KitexProtobuf protocol supports JSON generic call&lt;/strong>&lt;/p>
&lt;p>The new version also provides the JSON generic call for KitexProtobuf (TTHeader is required). Please see &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/generic-call/basic_usage/#jsonpbgeneric">JSONPbGeneric&lt;/a>.&lt;/p>
&lt;p>Note: TTHeader transport protocol is required.。&lt;/p>
&lt;p>&lt;strong>6. Adding a new LoadBalance policy&lt;/strong>&lt;/p>
&lt;p>Adding a new LoadBalance method of Alias Method to reduce the time complexity of random weight LoadBalance algorithm. Specified by &lt;code>client.WithLoadBalancer(loadbalance.NewWeightedRandomWithAliasMethodBalancer())&lt;/code>.&lt;/p>
&lt;h3 id="special-change">Special Change&lt;/h3>
&lt;p>Kitex v0.9.0 requires Go version must &amp;gt;= 1.17, no longer compatible with Go &amp;lt;= v1.16 (stability requirement must upgrade golang.org/x/library, which introduced Go version limit)&lt;/p>
&lt;h2 id="expand-the-ecosystem-of-config-center">&lt;strong>Expand the ecosystem of Config Center&lt;/strong>&lt;/h2>
&lt;blockquote>
&lt;p>Note that it is not related to v0.9.0 version, only synchronize the state of community expansion&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>Main configuration centers have finish integrated&lt;/strong>&lt;/p>
&lt;p>Kitex supports controlling the policies of Timeout, Retry, Circuit Breaker, Limiter through the remote configuration center. Thanks to the contributors of the CloudWeGo community, all the &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/third-party/config-center/">main configuration centers&lt;/a> have finish integrated. Usage please see &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/third-party/config-center/">Config Center&lt;/a>.&lt;/p>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1208">#1208&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/1251">#1251&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/1230">#1230&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/1226">#1226&lt;/a>] feat: support thrift streaming (replacing the protobuf payload of GRPC/HTTP2 with thrift binary)&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1217">#1217&lt;/a>] feat: support thrift and pb multi service&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1268">#1268&lt;/a>] feat(thrift): support frugal fallback for arm&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/951">#951&lt;/a>] feat(bizerr): support returning biz status error for json/map generic server&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1199">#1199&lt;/a>] feat(loadbalance): add loadbalancer using Alias Method (#1184)&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1244">#1244&lt;/a>] feat(timeout): add option server.WithEnableContextTimeout to enable server timeout&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1228">#1228&lt;/a>] feat(streaming): Adding Recv/End events to streaming requests to improve trace information&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1062">#1062&lt;/a>] feat(generic): supports JSON and Map generic call for the KitexProtobuf protocol.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1225">#1225&lt;/a>] feat(timeout): support timeout transparent transmission by default when using TTHeader transport protocol&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1211">#1211&lt;/a>] feat(hessian2): support nested struct for hessian2 customized Exception&lt;/li>
&lt;/ol>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1222">#1222&lt;/a>] optimize(frugal): enable frugal by default when the generated code is using slim template&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1209">#1209&lt;/a>] optimize: split encoder interface to customize meta and payload encoding implementation&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1206">#1206&lt;/a>] optimize(tool): add IsDir judge in readTemplate and add template register func&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1198">#1198&lt;/a>] optimize(kitexutil): add util api for getting real request and response&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1197">#1197&lt;/a>] optimize(kitexutil): add GetCallerIP util method in kitexutil to fetch Caller IP&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1195">#1195&lt;/a>] optimize(error): more specific instruction when panic in server handler&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1235">#1235&lt;/a>] optimize(tool): add IDLName field in PackageInfo for cwgo tool rendering&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1238">#1238&lt;/a>] optimize(bizerr): support biz status error for streaming mode&lt;/li>
&lt;/ol>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1236">#1236&lt;/a>] fix(hessian2): correct code-ref behavior when thrift file is not in project dir&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1234">#1234&lt;/a>] fix(hessian2): still perform replacement on handler.go when -service is not specified for hessian2&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1232">#1232&lt;/a>] fix(gRPC): append &amp;ldquo;h2&amp;rdquo; to next proto in gRPC tlsConfig to enable protocol negotiation in TLS&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1215">#1215&lt;/a>] fix: bugfix for hessian2 tpl codegen&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1203">#1203&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/1205">#1205&lt;/a>] fix: fix the issue where disabling rpcinfo reuse on the server side does not take effect&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1227">#1227&lt;/a>] fix: idl-ref overwritten when using hessian2&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1194">#1194&lt;/a>] fix(retry): always set RespOp &amp;amp;&amp;amp; preventive panic to avoid dead loop&lt;/li>
&lt;/ol>
&lt;h3 id="chore--tests">Chore &amp;amp; Tests&lt;/h3>
&lt;ol>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1273">#1273&lt;/a>] chore: upgrade netpoll to v0.6.0&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1263">#1263&lt;/a>] chore: update sonic to v1.11.1&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1255">#1255&lt;/a>] chore: upgrade netpoll to v0.6.0 pre-release version&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1252">#1252&lt;/a>] chore: upgrade golang.org/x/net&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1254">#1254&lt;/a>] chore: upgrade sonic to v1.11.0 to support go1.22&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1231">#1231&lt;/a>] chore: frugal support go1.22&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1220">#1220&lt;/a>] test: correct the cachekey in the benchmark test of balancer&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1196">#1196&lt;/a>] test: add just biz handler message error&lt;/li>
&lt;/ol>
&lt;hr>
&lt;p>&lt;strong>Thanks a lot to those community contributors who submit some pull requests or share your ideas for this version:&lt;/strong>
@DMwangnima @jizhuozhi @NX-Official @jieqiboh @Lvnszn @Skyenought&lt;/p></description></item><item><title>Blog: Kitex Release v0.8.0</title><link>https://www.cloudwego.io/blog/2023/11/30/kitex-release-v0.8.0/</link><pubDate>Thu, 30 Nov 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/11/30/kitex-release-v0.8.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="features">Features&lt;/h3>
&lt;p>&lt;strong>1. gRPC Multi-Service Support&lt;/strong>&lt;/p>
&lt;p>Implemented multi-service registration for Kitex gRPC, please refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/multi_service/">Multiple Services&lt;/a>.&lt;/p>
&lt;p>&lt;strong>2. Acquire Kitex RPCInfo&lt;/strong>&lt;/p>
&lt;p>Added methods for easy retrieval of RPC information from RPCInfo, please refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/acquire_rpcinfo/">Acquire RPC information&lt;/a>.&lt;/p>
&lt;h3 id="optimizations">Optimizations&lt;/h3>
&lt;p>&lt;strong>1. Map Generic Call&lt;/strong>&lt;/p>
&lt;p>Map generic call supports returning []byte for binary fields via SetBinaryWithByteSlice option.&lt;/p>
&lt;p>&lt;strong>2. RPCInfo asynchronous use&lt;/strong>&lt;/p>
&lt;p>Added an option to disable reusing RPCInfo, facilitating asynchronous usage, please refer to please refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/acquire_rpcinfo/#12-asynchronous-usage">Acquire RPC information&lt;/a>.&lt;/p>
&lt;h3 id="others">Others&lt;/h3>
&lt;p>Upgraded frugal to &lt;a href="https://github.com/cloudwego/frugal/releases/tag/v0.1.12">v0.1.12&lt;/a>, fixing some concurrency issues when compiling types, especially the issue when registering new modules which may conflict with sonic.&lt;br>
It&amp;rsquo;s STRONGLY SUGGESTED updating both frugal and sonic to the latest version by&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span> go get github.com/cloudwego/frugal@latest
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> go get github.com/bytedance/sonic@latest
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1051">#1051&lt;/a>] feat(grpc): support gRPC multi-service on a server&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1189">#1189&lt;/a>] feat(rpcinfo): add kitexutil methods for the convenience to fetch rpc information from RPCInfo&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1176">#1176&lt;/a>] feat(tool): add an environment variable to make it easier to debug kitex tool&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1173">#1173&lt;/a>] feat(rpcinfo): allow disable rpcinfo reuse for async reference&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1172">#1172&lt;/a>] feat(retry): client.WithSpecifiedResultRetry should have higher priority&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1150">#1150&lt;/a>] feat(proxy): add an interface to customize proxy middleware to replace the default implementation&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1159">#1159&lt;/a>] feat(generic): support returning []byte for binary fields in map generic&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1153">#1153&lt;/a>] feat(retry): add Extra for retry.FailurePolicy for better extension&lt;/p>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1187">#1187&lt;/a>] optimize(tool): add an option to keep resp for kitex tool&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1183">#1183&lt;/a>] optimize(meshheader): retrieve rip from meshheader and write it to TransInfo&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1178">#1178&lt;/a>] optimize(bizErr): recurse to obtain BizErr to avoid additional Error encapsulation in the middle, resulting in unwrap results that are not BizErr&lt;/p>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1126">#1126&lt;/a>] fix(generic): the issue of structs cache of generic call has dirty data under multiple services scene&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1168">#1168&lt;/a>] fix(tool): remove the pointer to java.Object in generated file for &lt;a href="https://github.com/kitex-contrib/codec-dubbo">CodecDubbo&lt;/a>&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1169">#1169&lt;/a>] fix(tool): empty struct generate wrong struct&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1166">#1166&lt;/a>] fix(generic): issue of deep copy function generation when map key type is binary&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1155">#1155&lt;/a>] fix(tool): add import package &amp;lsquo;context&amp;rsquo; for gRPC client.go&lt;/p>
&lt;h3 id="tests">Tests:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1177">#1177&lt;/a>] test: avoid port conflict&lt;/p>
&lt;h3 id="chore">Chore:&lt;/h3>
&lt;p>[&lt;a href="https://github.com/cloudwego/kitex/pull/1190">#1190&lt;/a>] chore: update thriftgo version to v0.3.3&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1186">#1186&lt;/a>] chore: update readme with examples and new blogs&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1185">#1185&lt;/a>] chore: add ci for windows&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1182">#1182&lt;/a>] chore: update dynamicgo to v0.1.6&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1152">#1152&lt;/a>] chore: update dynamicgo and sonic version&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1164">#1164&lt;/a>] chore: update frugal to v0.1.12 and allow disable frugal by build tag&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1161">#1161&lt;/a>] chore: update frugal to v0.1.10&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1157">#1157&lt;/a>] chore: update frugal to v0.1.9&lt;br>
[&lt;a href="https://github.com/cloudwego/kitex/pull/1151">#1151&lt;/a>] chore(test): upgrade mockey to latest to compatible with Go1.21&lt;/p></description></item><item><title>Blog: Kitex Release v0.7.2</title><link>https://www.cloudwego.io/blog/2023/09/27/kitex-release-v0.7.2/</link><pubDate>Wed, 27 Sep 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/09/27/kitex-release-v0.7.2/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="features">Features&lt;/h3>
&lt;p>&lt;strong>1. Retry: limit perncetage of retry requests&lt;/strong>&lt;/p>
&lt;p>The feature improves the usability of backup requests: if a request exceeds the retry delay threshold, a backup request will be sent; but if the request succeeds within the timeout threshold, it will not be treated as an error. Therefore large amount of backup requests may be sent due to a network jitter, which increases the pressure on the server and could even cause an avanlache.&lt;/p>
&lt;p>It&amp;rsquo;s recommended to update your current implementation:&lt;/p>
&lt;ol>
&lt;li>Initialize a RetryContainer with &lt;code>retry.NewRetryContainerWithPercentageLimit()&lt;/code> to limit the percentage of retry requests;&lt;/li>
&lt;li>Add an option &lt;code>client.WithCloseCallbacks(container.Close)&lt;/code> when initializing a client, in order to release relevant resources when the client is recycled.&lt;/li>
&lt;/ol>
&lt;h3 id="optimizations">Optimizations&lt;/h3>
&lt;p>&lt;strong>1. gRPC&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Send END_STREAM flag in unary call&lt;/li>
&lt;li>Fix grpc streaming tps decreasing and the selection logic of compressor&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>2. Long Connection Pool&lt;/strong>&lt;/p>
&lt;p>If &lt;code>MaxIdleGlobal&lt;/code> is not set, it is not limited by default, simplifying the configuration of long connection pools.&lt;/p>
&lt;h3 id="miscellaneous">Miscellaneous&lt;/h3>
&lt;ul>
&lt;li>Upgrade netpoll to &lt;a href="https://github.com/cloudwego/netpoll/releases/tag/v0.5.0">v0.5.0&lt;/a>&lt;/li>
&lt;li>Upgrade frugal to &lt;a href="https://github.com/cloudwego/frugal/releases/tag/v0.1.8">v0.1.8&lt;/a>, enable frugal when compiled on go1.21 (note: old versions of frugal are not adapted to go1.21)&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="full-release-log">Full Release Log&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1117">#1117&lt;/a>] feat(retry): support retry percentage limit&lt;/li>
&lt;/ul>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1033">#1033&lt;/a>] optimize: no need to check svcInfo twice&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1115">#1115&lt;/a>] optimize: rm outdated framed suggestion&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1095">#1095&lt;/a>] optimize: add K_METHOD in serviceinline ctx&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1107">#1107&lt;/a>] optimize(connpool): set maxIdleGlobal to no limit if not set&lt;/li>
&lt;/ul>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1116">#1116&lt;/a>] fix: use the last rpcinfo to trace&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1104">#1104&lt;/a>] fix: move limiter handler to the last of the inbound handler to get rpcinfo in custom limiter&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1103">#1103&lt;/a>] fix: reset all fields of netpoll byte buffer when recycle it&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1106">#1106&lt;/a>] fix(grpc): fix grpc streaming tps decreasing and the selection logic of compressor&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1114">#1114&lt;/a>] fix(gRPC): client send END_STREAM flag in unary call (#1066)&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1096">#1096&lt;/a>] fix(tool): add backquote to handle filepath string invalid syntax under windows os&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1098">#1098&lt;/a>] fix(tool): fix import for codegen template when using slim and unknown fields&lt;/li>
&lt;/ul>
&lt;h3 id="tests">Tests:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1124">#1124&lt;/a>] test: fix codegen script&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1122">#1122&lt;/a>] test: add codegen test&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1119">#1119&lt;/a>] test(connpool): modify the idleTimeout&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1133">#1133&lt;/a>] chore: update version v0.7.2&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1125">#1125&lt;/a>] chore: upgrade netpoll to v0.5.0&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1123">#1123&lt;/a>] perf: replace concurrent string builder with lock&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1118">#1118&lt;/a>] perf: optimize remote addr setter interface to reduce lock cost of Address()&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1110">#1110&lt;/a>] chore: upgrade netpoll to v0.4.2 pre-release&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1061">#1061&lt;/a>] chore: netpoll pre release v0.4.2&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1100">#1100&lt;/a>] chore: enable frugal on go1.21&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.7.0</title><link>https://www.cloudwego.io/blog/2023/08/14/kitex-release-v0.7.0/</link><pubDate>Mon, 14 Aug 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/08/14/kitex-release-v0.7.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="features">Features&lt;/h3>
&lt;p>&lt;strong>1. gRPC Compression Support&lt;/strong>&lt;/p>
&lt;p>Implemented compression support for Kitex gRPC, allowing compression methods like gzip to reduce payload size.&lt;/p>
&lt;p>&lt;strong>2. GLS (Goroutine Local Storage)&lt;/strong>&lt;/p>
&lt;p>Utilized the &lt;a href="https://github.com/cloudwego/localsession">local-session&lt;/a> component for context propagation in fallback requests, addressing the issue of broken microservice chains caused by missing ctx.&lt;/p>
&lt;h3 id="optimizations">Optimizations&lt;/h3>
&lt;p>&lt;strong>1. Unserialized Unknown Fields&lt;/strong>&lt;/p>
&lt;p>Implemented unserialization of unknown fields, resulting in a performance improvement of approximately 6x to 7x on FastCodec. See details in &lt;a href="https://github.com/cloudwego/kitex/pull/1017">#1017&lt;/a>.&lt;/p>
&lt;p>&lt;strong>2. Integration with DynamicGo&lt;/strong>&lt;/p>
&lt;p>Integrated &lt;a href="https://github.com/cloudwego/dynamicgo">dynamicgo&lt;/a> into Kitex&amp;rsquo;s generic module to enhance performance of JSON/HTTP generic invocations (+50% to 200%).&lt;/p>
&lt;h3 id="others">Others&lt;/h3>
&lt;p>Upgraded Thriftgo library dependency to v0.3.0, adding support for Thriftgo reflection, enabling runtime access to IDL metadata.&lt;/p>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature">Feature:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1053">#1053&lt;/a>] feat(retry): support to distinguish local retry request&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1058">#1058&lt;/a>] feat(retry): support delete retry policy dynamically&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1000">#1000&lt;/a>] feat(grpc): support grpc compress&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1018">#1018&lt;/a>] feat: use local-session to backup request context in case of missing&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1045">#1045&lt;/a>] feat(generic): support base64 codec for map generic&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1035">#1035&lt;/a>] feat(config): provide the ability to dynamically configure the rpctimeout config on the method hierarchy&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/825">#825&lt;/a>] feat(generic): integrate dynamicgo into kitex generic call&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1019">#1019&lt;/a>] feat(lb): interleaved weighted round-robin load balancer&lt;/li>
&lt;/ul>
&lt;h3 id="optimize">Optimize:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1064">#1064&lt;/a>] optimize: check header max size when ttheader encode&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1017">#1017&lt;/a>] optimize: implement unknown field function without serialization&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1036">#1036&lt;/a>] optimize(protobuf): ignore err when (un)marshal empty req/resp&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1056">#1056&lt;/a>] optimize(tool): optimize struct ref&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1043">#1043&lt;/a>] optimize: add method info to the error message of the server handler panic for easy troubleshooting&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1025">#1025&lt;/a>] optimize: use Tags of ServerBasicInfo as default Tags of RegistryInfo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1020">#1020&lt;/a>] optimize: add nil check for MethodInfo which get from ServiceInfo in client.Call to ignore panic&lt;/li>
&lt;/ul>
&lt;h3 id="fix">Fix:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1073">#1073&lt;/a>] fix: fix failure retryer dump panic&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1067">#1067&lt;/a>] fix: slim template with deepcopy&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1055">#1055&lt;/a>] fix: ignore SIGHUP when run with nohup&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1048">#1048&lt;/a>] fix(retry): keep the behavior of retry policy consistent between initing and updating&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1047">#1047&lt;/a>] fix(tool): cli warning for unknown suffix&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1038">#1038&lt;/a>] fix(config): correct the function signature of the rpcinfo.TimeoutProvider implementation&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1034">#1034&lt;/a>] fix(generic): add case int16 into buildinTypeIntoString&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1023">#1023&lt;/a>] fix(generic): avoid dead-loop when marshal self-referenced struct&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1028">#1028&lt;/a>] fix:modify .licenserc.yaml&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1012">#1012&lt;/a>] fix: skip frugal on go 1.21&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/992">#992&lt;/a>] fix(grpc): use mcache to fix memory leak caused by grpc codec buffer to reuse memory incorrectly&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/994">#994&lt;/a>] fix(tool): fix kitex tool git repo pulling logic&lt;/li>
&lt;/ul>
&lt;h3 id="chore">Chore:&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1074">#1074&lt;/a>] chore: update thriftgo to v0.3.0&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1031">#1031&lt;/a>] chore: remove wechat group in readme&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1008">#1008&lt;/a>] chore: update dynamicgo to v0.1.1&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1006">#1006&lt;/a>] chore: remove unnecessary replace for frugal&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/1007">#1007&lt;/a>] chore: upgrade netpoll to v0.4.1&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.6.1</title><link>https://www.cloudwego.io/blog/2023/06/19/kitex-release-v0.6.1/</link><pubDate>Mon, 19 Jun 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/06/19/kitex-release-v0.6.1/</guid><description>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h2 id="hotfix">Hotfix:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/988">#988&lt;/a>] hotfix(code_gen): fix the problem of code generation with slim template failure&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.6.0</title><link>https://www.cloudwego.io/blog/2023/06/14/kitex-release-v0.6.0/</link><pubDate>Wed, 14 Jun 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/06/14/kitex-release-v0.6.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="feature">&lt;strong>Feature&lt;/strong>&lt;/h3>
&lt;p>&lt;strong>1. GRPC Metainfo Pass Through&lt;/strong>&lt;/p>
&lt;p>The gRPC client sets the header to ctx by default, and external methods can use &lt;code>GetHeaderMetadataFromCtx&lt;/code> to obtain meta information. It can be used to obtain meta information within transmeta and set it to rpcinfo, or to obtain header information within middlewares.&lt;/p>
&lt;p>&lt;strong>2. Kitex configuration module refactoring&lt;/strong>&lt;/p>
&lt;p>Added config items for retry, circuit breaker, timeout, and flow limiting to support [configmanager] (&lt;a href="https://github.com/cloudwego/configmanager">https://github.com/cloudwego/configmanager&lt;/a>) Middleware defined interfaces to support extended integration with external configuration centers.&lt;/p>
&lt;p>&lt;strong>3. Kitex - Tools&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Support for inserting deep copy function of an object in thrift generation code for deep copying source objects to destination objects. The use method is to add &lt;code>-deep-copy-api&lt;/code> parameter to the kitex command;&lt;/li>
&lt;li>Support for inserting IDL descriptor registration code into thrift generation code, which is used to register IDL descriptor information into the &lt;code>github.com/cloudwego/kitex/pkg/reflection/thrift&lt;/code> package after loading the corresponding generated code at runtime, and obtain descriptor information through the exposed functions. The use method is to add &lt;code>generate-reflection-info=true&lt;/code> to the &lt;code>thrift&lt;/code> parameter of kitex command, such as &lt;code>kitex -thrift generate-reflection-info=true&lt;/code>&amp;hellip; Kitex only supports IDL descriptor information registration in v1.12.0, richer query interfaces will be released in subsequent versions, and IDL descriptor registration function generation will also be modified to default generation.&lt;/li>
&lt;/ul>
&lt;h3 id="optimization">&lt;strong>Optimization&lt;/strong>&lt;/h3>
&lt;p>&lt;strong>1. Refactor the detection server to support detection of multiple protocols&lt;/strong>&lt;/p>
&lt;p>The old version of the detection server only supports http2 as the detection protocol. The v1.12.0 version supports users to pass-in the &lt;code>remote.ServerTransHandlerFactory&lt;/code> corresponding to the &lt;code>remote.ServerTransHandler&lt;/code> which implement &lt;code>detection.DetectableServerTransHandler&lt;/code> interface as indefinite parameters, and cooperate with the default &lt;code>remote.ServerTransHandler&lt;/code> to handle unmatched protocols to achieve a Kitex Server compatible with multiple protocols.&lt;/p>
&lt;p>&lt;strong>2. Consistency hash&lt;/strong>&lt;/p>
&lt;p>Function &lt;code>buildVirtualNodes&lt;/code> in Kitex consistency hash load balancer uses &lt;code>virtualFactorLen&lt;/code> to initialize a bytes array, and there may be insufficient space to accommodate the VirtualNodeLen number, resulting in the address part being overwritten.&lt;/p>
&lt;p>&lt;strong>3. Long Connection Pool Metrics&lt;/strong>&lt;/p>
&lt;p>Fix the issue that the records that long connection pool reuses connections successfully didn&amp;rsquo;t report.&lt;/p>
&lt;h3 id="other">&lt;strong>Other&lt;/strong>&lt;/h3>
&lt;p>Upgrade netpoll library dependency to v0.4.0 and support for [configmanager] ( &lt;a href="https://github.com/cloudwego/configmanager">https://github.com/cloudwego/configmanager&lt;/a> ) v0.2.0.&lt;/p>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h2 id="feature-1">Feature:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/923">#923&lt;/a>] feat(grpc): grpc client set header and trailer to context by default and provide api to get header from ctx&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/891">#891&lt;/a>] feat: support to service-inline rpc client and server, which can transfer the rpc call as func call. The feature needs to be used with the generation tool&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/946">#946&lt;/a>] feat: default server handler support executing Read function by trans pipeline&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/936">#936&lt;/a>] feat(config): add config items for retry/cb/rcptimeout/limiter&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/924">#924&lt;/a>] [&lt;a href="https://github.com/cloudwego/kitex/pull/939">#939&lt;/a>] feat(code_gen): support generating deepcopy apis&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/926">#926&lt;/a>] feat: support thrift reflection info registry&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/897">#897&lt;/a>] feat: support loop_service in custom template&lt;/li>
&lt;/ul>
&lt;h2 id="optimize">Optimize:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/961">#961&lt;/a>] optimize(tool): optimize kitex tool tpl with -use param&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/966">#966&lt;/a>] optimize(ttheader): add type check for headerFlags of TTheader&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/919">#919&lt;/a>] optimize: replace go func with GoFunc to avoid panic&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/960">#960&lt;/a>] optimize: make stats package public to reuse it in expanded repo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/955">#955&lt;/a>] optimize: remove redundant onRead error log in gonet transerver&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/954">#954&lt;/a>] optimize: dont return error when transHandler not implement graceful shutdown&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/941">#941&lt;/a>] optimize(callopt): optimize the debug info of callopt to reduce the possibility of slice grow&lt;/li>
&lt;/ul>
&lt;h2 id="fix">Fix:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/963">#963&lt;/a>] fix(generic): generic-map writeInt8 fails on byte&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/901">#901&lt;/a>] fix(mux): mux connection asynccallback dont create new goroutine and server wait all crrst packets received by client&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/921">#921&lt;/a>] fix(loadbalance): fix consisthash byte[] length&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/922">#922&lt;/a>] fix(mux): fix the problem that output unreasonable error when exit if enable mux and use Kitex Protobuf&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/927">#927&lt;/a>] fix(connpool): long connection pool reports reuse success using reporter&lt;/li>
&lt;/ul>
&lt;h2 id="refactor">Refactor:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/958">#958&lt;/a>] refactor(errorHandler): refactor the definition of error handler to get more information to handle error&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/943">#943&lt;/a>] refactor(client): refactor client.Call to improve readability&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/560">#560&lt;/a>] refactor: refactor server detection trans handler to support custom registration&lt;/li>
&lt;/ul>
&lt;h2 id="tests">Tests:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/900">#900&lt;/a>] test(generic): add thrift reflection (using dynamicgo) generic call example&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/976">#976&lt;/a>] chore: upgrade netpoll to v0.4.0 and thriftgo to v0.2.11&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/956">#956&lt;/a>] chore: update configmanager version to v0.2.0&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/948">#948&lt;/a>] chore: format with goimports -local github.com/cloudwego/kitex&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.5.3</title><link>https://www.cloudwego.io/blog/2023/04/21/kitex-release-v0.5.3/</link><pubDate>Fri, 21 Apr 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/04/21/kitex-release-v0.5.3/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="feature">&lt;strong>Feature&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>Failure retry：add configuration to support disable timeout retry when do failure retry, which is for the non-idempotent request&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Codegen tool：support codegen in windows.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Error code: fine grained rpc timeout error code&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Thrift Fast Codec: support unknown fields&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Background of &amp;ldquo;unknown fields&amp;rdquo;: In Thrift, adding fields in the IDL is transparent to the party that has not updated the IDL. Updating the IDL and generating code is necessary to access new fields, which requires all downstream nodes to upgrade when a node on the invocation Chain updates the IDL.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&amp;ldquo;Unknown fields&amp;rdquo; supports retaining unrecognized fields. For fields that do not exist in the IDL, they are read and set in the &lt;code>_unknownFields&lt;/code> field of the struct.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Usage: &lt;code>kitex -thrift keep_unknown_fields your.thrift&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="fix">&lt;strong>Fix&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>Result retry: fix the issue that the result retry becomes invalid after failure retry policy is modified dynamically&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h2 id="feature-1">Feature:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/887">#887&lt;/a>] feat(retry): add configuration to support disable timeout retry when do failure retry, which is for the non-idempotent request&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/881">#881&lt;/a>] feat(tool): support codegen in windows&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/880">#880&lt;/a>] feat(rpctimeout): fine grained rpc timeout error code&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/872">#872&lt;/a>] feat(thrift): support unknown fields in fast codec&lt;/li>
&lt;/ul>
&lt;h2 id="optimize">Optimize:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/884">#884&lt;/a>] optimize(rpcinfo): RPCInfo.To().Tag() use instance tag instead of remoteinfo tag firstly&lt;/li>
&lt;/ul>
&lt;h2 id="fix-1">Fix:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/896">#896&lt;/a>] fix(remoteinfo): fix the race problem caused by non-deepcopy CopyFrom of remoteinfo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/892">#892&lt;/a>] fix(grpc): comment error log for the error of ReadFrame.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/889">#889&lt;/a>] fix(retry): result retry doesn’t work after failure retry policy is modified dynamically&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/866">#866&lt;/a>] fix(grpc): no need to set context return by sendMsg/recvMsg to the context of stream&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore:&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/898">#898&lt;/a>] chore: modify template for PR to check the modification of user doc&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/854">#854&lt;/a>] style(nphttp2): keep struct receiver name same&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.5.0</title><link>https://www.cloudwego.io/blog/2023/03/08/kitex-release-v0.5.0/</link><pubDate>Wed, 08 Mar 2023 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2023/03/08/kitex-release-v0.5.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="feature">&lt;strong>Feature&lt;/strong>&lt;/h3>
&lt;p>&lt;strong>1. Fallback: Support fallback for client-side&lt;/strong>&lt;/p>
&lt;p>When the RPC requests fail, users usually have some degradation measures to ensure the effective response (for example, construct the default response after the request timeout or circuit breaker).
Kitex&amp;rsquo;s Fallback supports the processing of all error requests. At the same time, because business errors are usually returned through the Resp (BaseResp field), Kitex also supports the processing of Resp.
Refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/fallback/">Fallback&lt;/a>.&lt;/p>
&lt;p>&lt;strong>2. Kitex - gRPC: Client add TLS option configuration&lt;/strong>&lt;/p>
&lt;p>Setup via client.WithGRPCTLSConfig option.&lt;/p>
&lt;p>&lt;strong>3. Kitex - Tool&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Support customized scaffold templates&lt;/strong>, refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/custom_tpl/">Custom Scaffold Template&lt;/a>&lt;/li>
&lt;li>&lt;strong>Support specifying the directory for generating code&lt;/strong>, refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/code_generation/#-gen-path">Code Generation Tool -gen-path&lt;/a>&lt;/li>
&lt;li>&lt;strong>Support using protoc plugin&lt;/strong>, refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/code_generation/#-protobuf-plugin">Code Generation Tool -protobuf-plugin&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="optimization">&lt;strong>Optimization&lt;/strong>&lt;/h3>
&lt;p>&lt;strong>1. Loadbalance：Use Weighted Round Robin algo as default Loadbalance policy&lt;/strong>&lt;/p>
&lt;p>The old version uses Weight Random to do the loadbalance by default. Random can achieve the global balance. However, in the case of a small number of server instances, there is a large probability of random continuous access to the same instance, resulting in an increase in the maximum concurrent requests of downstream nodes. Therefore, the new version adjusts the default policy to Weight Round Robin.
Refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/loadbalance/">Loadbalance&lt;/a>&lt;/p>
&lt;p>&lt;strong>2. Goroutine Resource of Connection Pool&lt;/strong>&lt;/p>
&lt;p>When the old version uses a long connection, each client corresponds to a goroutine resource cleaning connection. When there are many clients, it will cause too many goroutines. The new version changes to share the goroutine to avoid the number of goroutines increasing with the number of clients.&lt;/p>
&lt;h3 id="other">&lt;strong>Other&lt;/strong>&lt;/h3>
&lt;p>Upgrade the frugal and pid dependency lib to support go 1.20.&lt;/p>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature-1">Feature&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/840">#840&lt;/a>] feat(fallback): support fallback ability for kitex client-side, usage guide refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/fallback/">Fallback&lt;/a>&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/841">#841&lt;/a>] feat(tool): add GetResult() and GetFirstArgument() methods for service params of protobuf&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/791">#791&lt;/a>] feat(tool): merge two ways of passing extensions, to support two ways at sametime&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/797">#797&lt;/a>] feat(loadbalance): use smooth weighted round robin algo as default Loadbalance policy&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/760">#760&lt;/a>] feat(grpc): support TLS config in kitex grpc client&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/781">#781&lt;/a>] feat(tool): supports custom templates&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/783">#783&lt;/a>] feat(ttheader): add encode logic for gdpr token in TransInfo&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/775">#775&lt;/a>] feat(tool): support custom generate path&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/687">#687&lt;/a>] feat(tool): add protoc plugin flag&lt;/li>
&lt;/ul>
&lt;h3 id="optimize">Optimize&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/750">#750&lt;/a>] optimize(generic): generic call write zero value for required and default fields to meet the specification of apache thrift and keep consistent with normal thrift encode of Kitex.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/739">#739&lt;/a>] optimize(generic): modify the url routing to align with Hertz for HTTP generic call&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/752">#752&lt;/a>] optimize(ttheader): attach part of ttheader binary into error when readKVInfo failed, which is useful for troubleshooting&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/821">#821&lt;/a>] optimize(config): add DeepCopy() &amp;amp; Equals() to circuitbreaker.CBConfig and retry.Policy&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/827">#827&lt;/a>] optimize: revise the remoteInfo of retry call, using the remoteInfo of the RPCCall that returns&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/762">#762&lt;/a>] optimize(tool): add go mod auto replace to thrift 0.13 in thrift mode&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/755">#755&lt;/a>] optimize: improve client error msg when ctx cancel or timeout&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/756">#756&lt;/a>] optimize: use sync.Cond as the profiler event trigger&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/753">#753&lt;/a>] optimize: add recover for client&amp;rsquo;s Close&lt;/li>
&lt;/ul>
&lt;h3 id="fix">Fix&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/734">#734&lt;/a>] fix(retry): fix the panic problem caused by concurrent read and write of rpcinfo under backup retry&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/837">#837&lt;/a> &lt;a href="https://github.com/cloudwego/kitex/pull/842">#842&lt;/a>] fix(metahandler): adjust MetainfoHandler to the top of the MetaHandlers array to ensure that the logic of custom MetaHandlers that depends on MetainfoHandler works&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/812">#812&lt;/a>] fix: use detectionHandler to perform protocol detection in windows environment to support gRPC&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/851">#851&lt;/a>] fix: upgrade frugal to v0.1.6 for missing stop field&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/845">#845&lt;/a>] fix: fix the problem that RPCStat report status as success when biz handler return err&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/822">#822&lt;/a>] fix(loadbalance): don&amp;rsquo;t share balancer factory when loadbalance is defined by user&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/732">#732&lt;/a>] fix(mux): mux server waits for shardqueue close before shutdown&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/795">#795&lt;/a>] fix(grpc): zero first byte of grpc data frame, which could be random data from mcache&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/668">#668&lt;/a>] fix: fix race problem in queue.go/queue @dugenkui03&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/743">#743&lt;/a>] fix: use sharedTicker for long conn pool to prevent goroutine numbers increase as the number of client increases&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/799">#799&lt;/a>] fix(util): should return when get at least one GOPATH @StellarisW&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/807">#807&lt;/a>] fix(codec): fix fastpb nil ptr when struct fields are all default values&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/794">#794&lt;/a>] fix(tool): fix fastpb codegen by updating dependency&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/787">#787&lt;/a>] fix(tool): the import did not use the new method to render when template append content&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/785">#785&lt;/a>] fix(tool): remove useless combine service files&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/754">#754&lt;/a>] fix: fix the usage of metainfo in grpc scene&lt;/li>
&lt;/ul>
&lt;h3 id="refactor">Refactor&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/814">#814&lt;/a> &lt;a href="https://github.com/cloudwego/kitex/pull/843">#843&lt;/a>] refactor(trans): return error in onRead of defaultServerHandler and close conn in outer method&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/816">#816&lt;/a>] refactor(utils): add utils.GetEnvLogDir and deprecate utils.GetLogDir&lt;/li>
&lt;/ul>
&lt;h3 id="test--docs--chore">Test &amp;amp; Docs &amp;amp; Chore&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/839">#839&lt;/a> &lt;a href="https://github.com/cloudwego/kitex/pull/693">#693&lt;/a>] test: import mockey repo and add usage demo of mockey unit test&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/806">#806&lt;/a>] test(transmeta):add some test cases for tansmeta package&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/761">#761&lt;/a>] docs: update README.md @fuergaosi233&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/817">#817&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/832">#832&lt;/a>] chore: upgrade dependency lib to adapt go 1.20&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/772">#772&lt;/a>] chore: modify kitex gen code meta file name from kitex.yaml to kitex_info.yaml&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Proxyless Practice：Traffic Lane Implementation with Istio and OpenTelemetry</title><link>https://www.cloudwego.io/blog/2022/12/20/kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry/</link><pubDate>Tue, 20 Dec 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/12/20/kitex-proxyless-practicetraffic-lane-implementation-with-istio-and-opentelemetry/</guid><description>
&lt;blockquote>
&lt;p>Preface: Kitex Proxyless enables the Kitex service to interact directly with istiod without envoy sidecar. It dynamically obtains service governance rules
delivered by the control plane based on the xDS protocol and converts them to Kitex rules to implement some service governance functions, such as traffic routing.
Based on Kitex Proxyless, Kitex can be managed by Service Mesh without sidecar. Besides, the governance rule Spec, governance control plane, governance delivery protocol,
and heterogeneous data governance capability can be unified under multiple deployment modes. By rewriting the bookinfo project using Kitex and Hertz, it demonstrates how to implement a traffic lane using xDS protocol.&lt;/p>
&lt;/blockquote>
&lt;h2 id="01-introduction">01 Introduction&lt;/h2>
&lt;h3 id="kitex-proxyless">&lt;strong>Kitex Proxyless&lt;/strong>&lt;/h3>
&lt;p>&lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a> is a Golang RPC framework open-sourced by ByteDance that already natively supports the xDS standard protocol and can be managed by Service Mesh in Proxyless way.
Refer to this doc for detailed design: &lt;a href="https://github.com/cloudwego/kitex/issues/461">Proposal: Kitex support xDS Protocol&lt;/a>.
Official doc is also available here at &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/xds/">Kitex/Tutorials/Advanced Feature/xDS Support&lt;/a>&lt;/p>
&lt;p>Kitex Proxyless Simply means that Kitex services can interact directly with istiod without envoy sidecar and dynamically obtain service governance rules delivered by the control plane based on the xDS protocol.
And those rules will be translated into Kitex corresponding rules to implement some service governance functions (such as traffic routing which is the focus of this blog).&lt;/p>
&lt;p>Based on Kitex Proxyless, Kitex application can be managed by Service Mesh in a unified manner without sidecar, and thus the governance rule Spec, governance control plane,
governance delivery protocol, and heterogeneous data governance capability can be unified under multiple deployment modes.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/unify_architecture.svg" alt="image">&lt;/p>
&lt;h3 id="traffic-routing">Traffic Routing&lt;/h3>
&lt;p>Traffic routing refers to the ability to route traffic to a specified destination based on its specific metadata identifier.&lt;/p>
&lt;p>Traffic routing is one of the core capabilities in service governance and one of the scenarios that Kitex Proxyless supports in the first place.&lt;/p>
&lt;p>The approach of &lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a> implementing traffic routing base on xDS is as follows:&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/2.png" alt="image">&lt;/p>
&lt;p>Specific procedure:&lt;/p>
&lt;ol>
&lt;li>Add an xDS Router MW to Pick Cluster (routing) and watch LDS and RDS of target services.&lt;/li>
&lt;li>Aware of LDS changes and extract the Filter Chain and inline RDS in the LDS of the target service.&lt;/li>
&lt;li>Aware of RDS changes and obtain the route configuration of the target service based on VirtualHost and ServiceName matching. (Prefix, suffix, exact, and wildcard are supported)&lt;/li>
&lt;li>The routing rules in the matched RDS are traversed and processed. The routing rules are divided into two parts (refer to the routing specification definition) :&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>Match:
&lt;ul>
&lt;li>Path(required): Extract Method from rpcinfo for matching;&lt;/li>
&lt;li>HeaderMatcher(optional): Extract the corresponding metadata KeyValue from the metainfo and match it.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Route：
&lt;ul>
&lt;li>Cluster ：Standard Cluster.&lt;/li>
&lt;li>WeightedClusters(Weight routing) : cluster is selected according to weight within MW.&lt;/li>
&lt;li>Write the selected Cluster to the EndpointInfo.Tag for later service discovery.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>As you can see, traffic routing is a process of selecting the corresponding SubCluster according to certain rules.&lt;/p>
&lt;h2 id="02-traffic-lane">02 Traffic Lane&lt;/h2>
&lt;p>Based on traffic routing capability, we can extend many usage scenarios, such as: A/B testing, canary release, blue-green release, etc., and the focus of this paper: Traffic Lane.&lt;/p>
&lt;p>The traffic lane can be understood as splitting a group of service instances in a certain way (such as deployment environment), and based on the routing capability and global metadata,
so that traffic can flow in the specified service instance lanes in accordance with the exact rules (logically similar to lanes in a swimming pool). Traffic lane can be used for full-path grey release.&lt;/p>
&lt;p>In Istio we typically group instances with DestinationRule subset, splitting a service into multiple subsets (e.g. Based on attributes such as version and region)
and then work with VirtualService to define the corresponding routing rules and route the traffic to the corresponding subset. In this way, the single-hop routing capability in the lane is realized.&lt;/p>
&lt;p>However, traffic routing capability alone is not enough to realize traffic lane. We need a good mechanism to accurately identify the traffic
and configure routing rules for each hop traffic based on this feature when a request spans multiple services.&lt;/p>
&lt;p>As shown in the following figure: Suppose we want to implement a user request that is accurately route to the v1 version of service-b.
The first thought might be to put a &lt;code>uid = 100&lt;/code> in the request header and configure the corresponding VirtualService to match the &lt;code>uid = 100&lt;/code> in the header.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/3.png" alt="image">&lt;/p>
&lt;p>But it has several obvious drawbacks for this approach:&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Not common enough&lt;/strong>: If a specific business attribute (such as uid) is used as a traffic route matching rule, the business attribute must be manually transmitted through the full path.
This is highly intrusive to business and requires business cooperation. In addition, when we want to use other business attributes, all services on the full path need to change to adapt. Therefore, it is a very unusual practice.&lt;/li>
&lt;li>Routing rules are prone to frequent changes, resulting in &lt;strong>rule overcrowding&lt;/strong>. Routing rules are identified by specific business attributes (for example: uid) is used as a traffic route matching rule.
If you want to change a business attribute or set a routing rule for other users, you need to modify the original routing rule or repeatedly define multiple routing rules for different business attributes, which easily causes route rule overcrowding and is difficult to maintain.&lt;/li>
&lt;/ol>
&lt;p>Therefore, in order to achieve uniform traffic routing across the full path, we also need to use a more general traffic dyeing and the capability to transmit the dye identifier through the full path.&lt;/p>
&lt;h3 id="traffic-dyeing">Traffic Dyeing&lt;/h3>
&lt;p>Traffic dyeing refers to marking the request traffic with a special identifier and carrying this identifier in the full request path.
The so-called traffic lane means that all services in the path sets traffic routing rules based on the uniform gray traffic dyeing identifier so that the traffic can be accurately controlled in different lanes.&lt;/p>
&lt;p>Usually, traffic dyeing is done at the gateway layer, and the metadata in the original request is converted into corresponding dye identifiers according to certain rules (conditions and proportions).&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Dyeing by conditions&lt;/strong>: when the request metadata meets certain conditions (such as &lt;code>uid = 100&lt;/code> in the request header and cookie matching), the current request is marked with a dye identifier.&lt;/li>
&lt;li>&lt;strong>Dyeing by proportions&lt;/strong>: the request is marked with a dye identifier in proportion.&lt;/li>
&lt;/ul>
&lt;p>With a unified traffic dyeing mechanism, we do not need to care about specific business attribute identifiers when configuring routing rules. We only need to configure routes based on the dye identifiers.
The specific service attributes are abstracted into conditional dyeing rules to be more universal. Even if the business attributes change, the routing rules do not need to change frequently.&lt;/p>
&lt;h4 id="dye-identifier-transmitting">Dye Identifier Transmitting&lt;/h4>
&lt;p>The dyed identifier is usually transmitted through the Tracing Baggage, which is used to pass business custom KV attributes through the entire call chain (full-path), such as traffic dyeing identifiers and business identifiers such as AccountID.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/4.png" alt="image">&lt;/p>
&lt;p>We usually use the Tracing Baggage mechanism to transmit the corresponding dye identifiers through the full-path. Most of the Tracing frameworks support the Baggage concept, such as: OpenTelemetry, Skywalking, Jaeger, etc.&lt;/p>
&lt;p>With a set of universal full-path transmitting mechanism, the service only needs to config the tracing once, and there is no need to adapt every time the service attribute identifier changes.&lt;/p>
&lt;p>Next part introduces and demonstrates how to implement the traffic lane based on Kitex Proxyless and OpenTelemetry Baggage by using a specific engineering example.&lt;/p>
&lt;h2 id="03-demo-introductionbookinfo">03 Demo Introduction：Bookinfo&lt;/h2>
&lt;p>The demo is a rewriting of the &lt;a href="https://istio.io/latest/zh/docs/examples/bookinfo/">Istio Bookinfo&lt;/a> project using &lt;a href="https://github.com/cloudwego/hertz">Hertz&lt;/a> and &lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a>:&lt;/p>
&lt;ul>
&lt;li>Use &lt;strong>istiod&lt;/strong> as the xDS server and the entry for CRD configuration and delivery.&lt;/li>
&lt;li>Use &lt;strong>wire&lt;/strong> to implement dependency injection;&lt;/li>
&lt;li>Use &lt;strong>opentelemetry&lt;/strong> to implement full path tracing;&lt;/li>
&lt;li>Use &lt;a href="https://github.com/kitex-contrib/xds">Kitex-xds&lt;/a> and &lt;strong>opentelemetry baggage&lt;/strong> to implement a traffic lane in proxyless mode;&lt;/li>
&lt;li>Implement a &lt;a href="https://github.com/cloudwego/biz-demo/blob/main/bookinfo/README_CN.md">Bookinfo&lt;/a> UI using &lt;strong>arco-design&lt;/strong> and &lt;strong>react&lt;/strong>.&lt;/li>
&lt;/ul>
&lt;h3 id="business-architecture">Business Architecture&lt;/h3>
&lt;p>In keeping with Bookinfo, the overall business architecture is divided into four separate microservices:&lt;/p>
&lt;ul>
&lt;li>&lt;code>productpage&lt;/code> - This microservice calls &lt;code>details&lt;/code> and &lt;code>reviews&lt;/code>;&lt;/li>
&lt;li>&lt;code>details&lt;/code> - This microservice contains information about the book;&lt;/li>
&lt;li>&lt;code>reviews&lt;/code> - This microservice contains book related reviews. It also calls &lt;code>ratings&lt;/code>;&lt;/li>
&lt;li>&lt;code>ratings&lt;/code> - This microservice contains ratings information consisting of book reviews.&lt;/li>
&lt;/ul>
&lt;p>&lt;code>reviews&lt;/code> are available in three versions:&lt;/p>
&lt;ul>
&lt;li>The v1 version calls the ratings service and uses one ⭐️ to display the ratings.&lt;/li>
&lt;li>The v2 version invokes the ratings services, and use five ⭐⭐⭐⭐⭐⭐ to display the ratings.&lt;/li>
&lt;li>The v3 version won&amp;rsquo;t call the ratings service&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/bookinfo.svg" alt="image">&lt;/p>
&lt;h3 id="diagram-of-traffic-lanes">Diagram of Traffic Lanes&lt;/h3>
&lt;p>The whole call chain is divided into 2 lanes:&lt;/p>
&lt;ul>
&lt;li>Base lane: Undyed traffic is routed to the base lane.&lt;/li>
&lt;li>Branch lane: dyed traffic is routed to the branch lane of reviews-v2 -&amp;gt;ratings-v2.&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/lane.svg" alt="image">&lt;/p>
&lt;h3 id="traffic-dyeing-1">Traffic Dyeing&lt;/h3>
&lt;p>The gateway is responsible for traffic dyeing. For example, the request with &lt;code>uid=100&lt;/code> in the request header is dyed and carries baggage of &lt;code>env=dev&lt;/code>.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/dyeing.svg" alt="image">&lt;/p>
&lt;p>The dye mode may vary according to different gateways. For example, when we select istio ingress as the gateway, we can use &lt;strong>EnvoyFilter + Lua&lt;/strong> to write the gateway dye rules.&lt;/p>
&lt;h3 id="workload-labeling">Workload Labeling&lt;/h3>
&lt;ol>
&lt;li>Label the workload with corresponding version identifier.&lt;/li>
&lt;/ol>
&lt;p>Take service &lt;code>reviews&lt;/code> as an example. You only need to label the corresponding pod with &lt;code>version: v1&lt;/code>.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/8.png" alt="image">&lt;/p>
&lt;ol start="2">
&lt;li>Set a series of subsets for the service based on the DestinationRule:&lt;/li>
&lt;/ol>
&lt;ul>
&lt;li>Productpage: v1&lt;/li>
&lt;li>Reviews: v1、v2、v3&lt;/li>
&lt;li>Ratings: v1、v2&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/9.png" alt="image">&lt;/p>
&lt;h3 id="traffic-routing-rules">Traffic Routing Rules&lt;/h3>
&lt;p>The gateway has already dyed the request header with &lt;code>uid=100&lt;/code> and automatically loaded &lt;code>env=dev&lt;/code> baggage,
so we only need to match the route according to the header. Here is an example of the route rule configuration:&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/10.png" alt="image">&lt;/p>
&lt;h3 id="check-the-effect">Check the Effect&lt;/h3>
&lt;ol>
&lt;li>Base Lane&lt;/li>
&lt;/ol>
&lt;p>Requests without &lt;code>uid=100&lt;/code> header in the inbound traffic are automatically routed to the base lane, which is a round-robin of v1 and v3 of &lt;code>reviews&lt;/code> service resulting in a round-robin score of 0 and 1.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/bookstore_base.png" alt="image">&lt;/p>
&lt;ol start="2">
&lt;li>Branch Lane&lt;/li>
&lt;/ol>
&lt;p>We use the &lt;strong>mod-header&lt;/strong> plug-in of the browser to simulate the scenario where the &lt;code>uid=100&lt;/code> is carried in the inbound traffic request header.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/12.png" alt="image">&lt;/p>
&lt;p>Click the refresh button again, you can find that the request hits the branch lane, and the traffic lane takes effect successfully.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/Kitex_Proxyless/bookstore_branch.jpeg" alt="image">&lt;/p>
&lt;h2 id="04-summary-and-outlook">04 Summary and Outlook&lt;/h2>
&lt;p>So far, we have implemented a complete full-path traffic lane based on Kitex Proxyless and OpenTelemetry.
And we can set corresponding routing rules for Kitex based on Istio standard governance rule Spec without Envoy sidecar.&lt;/p>
&lt;p>In addition to traffic routing capabilities, Kitex Proxyless is also continuously iterating and optimizing to meet more requirements for data plane governance capabilities.
As an exploration and practice of Service Mesh data plane, Proxyless not only can enrich the deployment form of data plane, but also hopes to continuously polish &lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a>,
enhance its ability in open source ecological compatibility, and create a more open and inclusive microservice ecosystem.&lt;/p>
&lt;h2 id="05-relevant-project">05 Relevant Project&lt;/h2>
&lt;p>Here is a list of the projects involved in the demo:&lt;/p>
&lt;ul>
&lt;li>biz-demo: &lt;a href="https://github.com/cloudwego/biz-demo">https://github.com/cloudwego/biz-demo&lt;/a>&lt;/li>
&lt;li>kitex: &lt;a href="https://github.com/cloudwego/kitex">https://github.com/cloudwego/kitex&lt;/a>&lt;/li>
&lt;li>hertz: &lt;a href="https://github.com/cloudwego/hertz">https://github.com/cloudwego/hertz&lt;/a>&lt;/li>
&lt;li>kitex-xds: &lt;a href="https://github.com/kitex-contrib/xds">https://github.com/kitex-contrib/xds&lt;/a>&lt;/li>
&lt;li>kitex-opentelemetry: &lt;a href="https://github.com/kitex-contrib/obs-opentelemetry">https://github.com/kitex-contrib/obs-opentelemetry&lt;/a>&lt;/li>
&lt;li>hertz-opentelemetry: &lt;a href="https://github.com/hertz-contrib/obs-opentelemetry">https://github.com/hertz-contrib/obs-opentelemetry&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>This demo has been submitted in the biz-demo repository, and will be optimised continuously. biz-demo will include some complete demos based on CloudWeGo technology stack with certain business scenarios.
The original intention is to provide valuable references for enterprise users to use CloudWeGo in production. Contributors are always welcomed to participate in the contribution of CloudWeGo biz-demo. Let&amp;rsquo;s try something fun together.&lt;/p></description></item><item><title>Blog: Kitex Release v0.4.3</title><link>https://www.cloudwego.io/blog/2022/11/02/kitex-release-v0.4.3/</link><pubDate>Wed, 02 Nov 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/11/02/kitex-release-v0.4.3/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="feature">&lt;strong>Feature&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Extend the Generated Code of client/server&lt;/strong>: Add a new feature which can extend generated client.go/server.go with config file. It is applicable to the scenario for customizing the unified suite. See &lt;a href="[/docs/kitex/tutorials/code-gen/template_extension/]">Extend the Templates of Service Generated Code&lt;/a> for details.&lt;/li>
&lt;li>&lt;strong>Biz Customized Exception&lt;/strong> : Add supporting to return customized biz error which can distinguish with RPC error. See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/basic-feature/bizstatuserr/">Business Exception&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/issues/511">Proposal&lt;/a>.&lt;/li>
&lt;li>&lt;strong>Request Profiler&lt;/strong> : Add a new feature to do profiler for requests which can be used for cost statistics.&lt;/li>
&lt;li>&lt;strong>Context Middleware&lt;/strong> : Add Context Middleware which is used for adding request-level middlewares.&lt;/li>
&lt;/ol>
&lt;h3 id="optimization">&lt;strong>Optimization&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Frugal Performance Optimization&lt;/strong> : Support frugal precompile (pretouch) when new client or server, which is to reduce the impact of dynamic compilation on latency.&lt;/li>
&lt;li>&lt;strong>Connpool Optimiztion&lt;/strong> : Refactor connection pool to improve the idle connections cleanup.&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature-1">Feature&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/691">#691&lt;/a>] feat(client): add context middleware which is used for adding request-level middlewares.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/649">#649&lt;/a>] feat(connpool): new long connection pool with minIdle config and idle connections cleanup.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/672">#672&lt;/a>] feat(grpc): add kitex grpc metadata api to get header, tailer, and peer address metadata.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/613">#613&lt;/a>] feat(exception): support customized biz error which can distinguish with RPC error.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/670">#670&lt;/a>] feat(exception): support error format.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/678">#678&lt;/a>] feat(tool): add git and record param for cmd.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/662">#662&lt;/a>] feat(tool): support frugal precompile (pretouch) when new client or server.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/657">#657&lt;/a>] feat(tool): support template extension.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/527">#527&lt;/a>] feat(profiler): profiler for rpc request which can be used for cost statistics.&lt;/li>
&lt;/ul>
&lt;h3 id="optimize">Optimize&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/690">#690&lt;/a>] optimize(meta): remove error logic for adding default metaHandler in #503.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/638">#638&lt;/a>] optimize(generic): httppb generic support map/list elem type as struct.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/641">#641&lt;/a>] optimize(tool): add warnings comments for oneway methods.&lt;/li>
&lt;/ul>
&lt;h3 id="fix">Fix&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/611">#611&lt;/a>] fix(client): fix resource leaks caused by Finalizer not being triggered in the scenario where clients are created frequently.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/698">#698&lt;/a>] fix(connpool): adjust globalIdle based on the number of connections decreased during the Get.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/636">#636&lt;/a>] fix(connpool): CloseCallback and statistical reporting of connection pool are invalid when the connection pool is reset in &lt;code>ForwardProxy&lt;/code>.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/647">#647&lt;/a>] fix(grpc): update grpc connection window size when initial and synchronize grpc pr #5459.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/639">#639&lt;/a>] fix(generic): marshalling list&lt;byte> in generic and enabling forJSON reader option for MapThriftGeneric.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/655">#655&lt;/a>] fix(generic): numeric constant parsing fails when used as generic default value.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/654">#654&lt;/a>] fix(frugal): fix compilation error when using lower go version.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/682">#682&lt;/a>] fix(profiler): profiler stops pprof profile.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/637">#637&lt;/a>] fix(tool): fix imports in handler.go template.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/630">#630&lt;/a>] fix(tool): remove redundant kitex comments for file that do not declare an interface.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/627">#627&lt;/a>] fix(tool): fix import missing when having different alias for the same path.&lt;/li>
&lt;/ul>
&lt;h3 id="refactor">Refactor&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/651">#651&lt;/a>] refactor(server): server handler read/write interface return new context.&lt;/li>
&lt;/ul>
&lt;h3 id="docs">Docs&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/656">#656&lt;/a>] docs: remove wrong message in CONTRIBUTING.md.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/683">#683&lt;/a>] docs(kerrors): fix kerrors WithCauseAndExtraMsg method comment.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/625">#625&lt;/a>] chore: fix grammar of pull request template.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/623">#623&lt;/a>] chore: modify the template of pull request.&lt;/li>
&lt;/ul>
&lt;h3 id="test--ci">Test &amp;amp; CI&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/646">#646&lt;/a>] test: fix ut failure caused by InitRPCInfoFunc not setting rpcinfo.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/680">#680&lt;/a>] test: fix retry test race.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/661">#661&lt;/a>] test: make wpool tests more stable.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/643">#643&lt;/a>] test: add test for detection server handler.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/632">#632&lt;/a>] test: replace handwritten mock classes with gomock auto-generated classes.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/697">#697&lt;/a>] chore(ci): fixed skywalking-eyes version.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/652">#652&lt;/a>] chore(ci): delete repeated tests to reduce unit tests cost times.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/588">#588&lt;/a>] chore(ci): support codecov.&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex: Unifying Open Source Practice for a High-Performance RPC Framework</title><link>https://www.cloudwego.io/blog/2022/09/30/kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework/</link><pubDate>Fri, 30 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/09/30/kitex-unifying-open-source-practice-for-a-high-performance-rpc-framework/</guid><description>
&lt;h2 id="from-development-to-open-source-transition">From Development to Open Source Transition&lt;/h2>
&lt;p>Many researchers and practitioners may have just learned about CloudWeGo, so let&amp;rsquo;s first introduce the relationship between CloudWeGo and &lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a>.&lt;/p>
&lt;h2 id="cloudwego-and-kitex">CloudWeGo and Kitex&lt;/h2>
&lt;p>Kitex is CloudWeGo&amp;rsquo;s first open-source microservice framework, designed to empower developers in building high-performance and extensible microservices using Golang. Kitex encompasses the entire stack, including the network library, serialization library, and framework implementation, making it a comprehensive self-developed RPC framework.&lt;/p>
&lt;p>One notable feature of Kitex is its support for the gRPC protocol. Leveraging the official gRPC source code, Kitex optimizes the gRPC implementation, resulting in superior performance compared to the official gRPC framework. This sets Kitex apart from other Golang frameworks that offer open-source support for the gRPC protocol. Developers seeking both gRPC functionality and high-performance capabilities will find Kitex to be an excellent choice.&lt;/p>
&lt;p>In addition to Kitex, CloudWeGo has recently introduced two other projects to its open-source lineup: &lt;a href="https://github.com/cloudwego/hertz">Hertz&lt;/a>, a Golang HTTP framework, and &lt;a href="https://github.com/cloudwego/volo">Volo&lt;/a>, a Rust RPC framework. Alongside these microservice frameworks, CloudWeGo offers various high-performance foundational libraries and general microservice capabilities as open-source resources. To explore more of CloudWeGo&amp;rsquo;s open-source sub-projects, visit the &lt;a href="https://www.cloudwego.io/">official CloudWeGo website&lt;/a> for additional information and resources.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/1.png" alt="image">&lt;/p>
&lt;p>Based on feedback from the community, there have been discussions surrounding whether Kitex is an open-source Key Performance Indicator (KPI) project of ByteDance, as well as concerns about its stability and continuity. We can responsibly state that Kitex is not a KPI project, but rather a genuine project derived from ByteDance&amp;rsquo;s extensive internal practical experience. Since its open-source release, we have consistently maintained consistency between the internal and external development efforts of Kitex. This consistency, coupled with the alignment of internal and external codebases, has ensured the continuous iteration and improvement of Kitex. To address any remaining concerns, let us provide you with a detailed overview of Kitex&amp;rsquo;s development and open-source process.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/2.png" alt="image">&lt;/p>
&lt;h2 id="kitex-development-history">Kitex Development History&lt;/h2>
&lt;p>In 2014, ByteDance began adopting Golang as a programming language. The internal services of ByteDance were established in 2015, where the Thrift protocol was chosen for RPC (Remote Procedure Call) scenarios, and an internal RPC framework was supported. In 2016, the first Golang RPC framework called Kite was officially launched. During the initial stages of rapid company growth, the primary focus is on quickly implementing requirements and addressing relatively simple scenarios. Therefore, there may not be extensive considerations in the design process. This approach is reasonable since the exploration phase lacks complete clarity on which scenarios will require support, and excessive consideration can lead to over-design issues.&lt;/p>
&lt;p>As business scenarios became more complex, the demand for diversified functionalities increased, resulting in a rise in the number of access services and calls each year. Kite, the initial Golang RPC framework, eventually proved inadequate to support subsequent iterations. Recognizing this, a new project called Kitex was initiated in 2019, following over three years of online service. The official version of Kitex was released in early 2020, and by the end of the same year, over 10,000 services within Byte were connected to Kitex, showcasing its widespread adoption.&lt;/p>
&lt;p>From 2014 to 2020, Golang has served as the primary programming language for business development within ByteDance, positioning the company as one of the industry leaders in terms of Golang application adoption. Our service framework enables reliable communication among tens of thousands of Golang microservices. Through extensive verification of numerous microservices and handling substantial traffic, we have developed relatively mature microservice best practices. To contribute to the cloud-native community and enrich the Golang product ecosystem, we decided to open-source our internal practices. In 2021, under the CloudWeGo brand, we officially released Kitex as the first open-sourced service framework. As of August this year, Kitex has provided support for over &lt;strong>60,000&lt;/strong> internal services at ByteDance, reaching peak &lt;strong>QPS (Queries Per Second) in the hundreds of millions&lt;/strong>.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/3.png" alt="image">&lt;/p>
&lt;p>You might still have lingering questions regarding the comprehensive microservice system and its integration with the fundamental cloud ecosystem. Whether it&amp;rsquo;s in a public or private cloud environment, additional services are essential to support microservice governance. These services include governance platforms, registration centers, configuration centers, monitoring tools, traceability systems, service grids, and other customized specifications. ByteDance has developed a comprehensive set of internal services to support its microservice system. However, due to constraints, these services cannot be open-sourced in the short term.&lt;/p>
&lt;p>Now, how does CloudWeGo maintain a unified codebase internally and externally while ensuring seamless iteration?
In addressing this issue, let&amp;rsquo;s examine the module division of Kitex. The Kitex module is divided into three distinct parts. Firstly, there is &lt;strong>Kitex Core&lt;/strong>, situated in the middle. This component defines the hierarchical structure of the framework, implements the core logic of the interface, and provides the default implementation of the interface.&lt;/p>
&lt;p>On the left, we have &lt;strong>Kitex Tool&lt;/strong>, which encompasses the implementation related to the generated code. The generated code tool is acquired by compiling this package and includes features such as IDL parsing, verification, code generation, and plug-in support.&lt;/p>
&lt;p>To enhance user convenience and offer more flexible extensions, the main capabilities have been separated as independent open-source basic libraries. Some examples include Thriftgo, Thrift-validator plug-in, and Fastpb. These independent libraries enable users to leverage specific functionalities and extend Kitex as needed.&lt;/p>
&lt;p>On the right, Kitex Byted represents an extended implementation of Byte&amp;rsquo;s internal basic &lt;strong>capabilities&lt;/strong> integration. At the outset, we consolidated internal capabilities as extensions within a single package, allowing for streamlined integration.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/4.png" alt="image">&lt;/p>
&lt;p>By following this approach, we have been able to open-source specific parts of Kitex, namely Kitex Core and Tool. We achieved this by splitting the codebase, migrating the core code and tools of Kitex to the open-source library, and integrating internal extension modules as Kitex extensions while keeping them in the internal library. Additionally, we encapsulated a shell layer within the internal library to ensure seamless upgrades for internal users without significant impact.&lt;/p>
&lt;p>However, Kitex&amp;rsquo;s open-source journey goes beyond simple code splitting. In February 2021, we initiated preparations for Kitex&amp;rsquo;s open-source release. Despite the scalability of Kitex allowing for decoupling and integration with internal infrastructure, Kitex still relies on certain internal basic libraries. Therefore, to facilitate the open-source process, we first identified the dependent libraries and collaborated with relevant developers to open-source the &lt;a href="https://github.com/bytedance/gopkg">bytedance/gopkg&lt;/a> library. This library is jointly maintained by CloudWeGo and ByteDance&amp;rsquo;s language team and includes enhancements to the capabilities of the Golang standard library. Interested developers can follow and utilize this library as a valuable resource.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/5.png" alt="image">&lt;/p>
&lt;p>After successfully open-sourcing the gopkg library, we made necessary code adjustments to ensure compatibility for open-source adaptation. In July 2021, Kitex was officially open-sourced, and the internal version began utilizing the open-source library. However, considering the substantial number of internal microservices relying on Kitex, we prioritized a smooth transition for internal services. Consequently, we opted not to make an initial public announcement about the open-source release. Once we confirmed the stability and compatibility of the open-source version, we proceeded with an official public release in September 2021. The announcement confirmed the open-source nature of Kitex and welcomed external developers to explore and contribute.&lt;/p>
&lt;p>By providing insights into Kitex&amp;rsquo;s development and open-source history, our aim is to address concerns that external developers may have regarding whether Kitex is a KPI project. We want to assure them that Kitex is a community-driven open-source project backed by our commitment to stability, compatibility, and continuous improvement.&lt;/p>
&lt;h3 id="the-value-of-open-source">The Value of Open Source&lt;/h3>
&lt;p>Towards the end of the first part, let&amp;rsquo;s briefly discuss the value that open source brings to us. Although Kitex was not initially developed solely for open source purposes, its implementation has been oriented towards open source from the start. &lt;strong>Kitex&lt;/strong> itself is a project that has undergone extensive internal implementation within our organization. By open sourcing Kitex, our aim is to enable more users to swiftly build microservices internally.&lt;/p>
&lt;p>At the same time, open source allows us to gather valuable feedback from communities and enterprises. It also attracts external developers to contribute their expertise and insights. This collective engagement helps drive the evolution of Kitex towards supporting multiple scenarios and enriching its capabilities, making it applicable to a wider range of contexts and organizations.&lt;/p>
&lt;p>This symbiotic process of open source fosters a positive cycle of mutual benefit and facilitates a win-win scenario for all involved parties.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/6.png" alt="image">&lt;/p>
&lt;h2 id="a-year-long-review-of-open-source-changes">A Year-long Review of Open Source Changes&lt;/h2>
&lt;h3 id="framework-metrics">Framework Metrics&lt;/h3>
&lt;p>Before delving into the one-year open source changes of Kitex, let us first discuss the key metrics that should be considered when choosing a framework.&lt;/p>
&lt;h3 id="scalability">Scalability&lt;/h3>
&lt;p>A framework&amp;rsquo;s scalability is crucial in determining its suitability for different platforms. If a framework is tightly coupled with internal capabilities and cannot be easily transplanted or expanded to support various scenarios, it may present challenges when used externally.&lt;/p>
&lt;h3 id="usability">Usability&lt;/h3>
&lt;p>The ease of use of a framework can be evaluated from two perspectives. Firstly, for business developers, a framework that requires meticulous attention to its internal details may not be suitable for teams with high research and development efficiency requirements. Secondly, for framework-oriented secondary developers who provide custom support, a framework with excessive expansion capabilities or insufficient scalability may impose limitations and high expansion costs.&lt;/p>
&lt;h3 id="richness-of-functions">Richness of Functions&lt;/h3>
&lt;p>While a framework can be customized based on extensibility, it is important to consider that not all developers have the capacity for extensive custom development. An ideal framework should offer a range of options for different expansion capabilities, allowing developers to select and combine them according to their underlying infrastructure and specific environment.&lt;/p>
&lt;h3 id="high-performance">High Performance&lt;/h3>
&lt;p>While the preceding three points are crucial considerations during the initial framework selection, as service scale and resource consumption increase, performance becomes an indispensable factor. It is imperative to prioritize performance when choosing a framework to avoid future issues such as the need for framework replacement or forced customized maintenance.&lt;/p>
&lt;p>Regarding the measurement indicators mentioned above, Kitex may not have achieved perfection in all areas, but these four elements have been carefully considered during its design and implementation. We are committed to ensuring a well-rounded framework that addresses these aspects without compromising on any one of them.&lt;/p>
&lt;h2 id="features">Features&lt;/h2>
&lt;p>The following is an overview of several significant functional features that have been introduced in Kitex&amp;rsquo;s open source journey over the past year.&lt;/p>
&lt;h3 id="proxyless">Proxyless&lt;/h3>
&lt;p>Proxyless is a feature in Kitex that caters to open source scenarios. During the initial stages of Kitex&amp;rsquo;s open source release, there were internal discussions on whether to support xDS integration with &lt;a href="https://github.com/istio/istio">Istio&lt;/a>. For external users, leveraging Istio allows for the quick establishment of a basic microservices architecture, resolving issues such as service discovery, traffic routing, and configuration delivery. However, utilizing the complete Istio solution necessitates the introduction of Envoy, which can increase operational and maintenance costs. Moreover, using the official Envoy solution directly may result in performance degradation, additional CPU overhead, and increased latency.&lt;/p>
&lt;p>If Kitex can directly connect to Istio, users would be able to benefit from some of Istio&amp;rsquo;s capabilities while avoiding the performance loss, deployment complexity, and maintenance costs associated with Envoy. However, in the early days of open source, we did not encounter clear user demands, so we did not provide high-quality support for this.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/7.png" alt="image">&lt;/p>
&lt;p>Later on, the gRPC team also introduced Proxyless support, and Istio officials adopted Proxyless as a recommended approach for Istio usage. Kitex has now implemented support for Proxyless, primarily focusing on service discovery integration. The extensions supported by xDS have been open sourced separately in the &lt;a href="https://github.com/kitex-contrib/xds">kitex-contrib/xds&lt;/a> library and will undergo further enhancements in the future. To learn how to use Kitex to connect with Istio, please refer to the &lt;a href="https://github.com/istio/istio/blob/master/README.md">README&lt;/a> documentation.&lt;/p>
&lt;h3 id="json-and-protobuf-generalized-call-support">JSON and Protobuf generalized Call Support&lt;/h3>
&lt;p>Initially, Kitex provided support for HTTP generalization in gateway scenarios, as well as Map and binary generalization for common service scenarios. However, after open sourcing Kitex, user feedback highlighted the need for JSON and Protobuf generalization, leading to their subsequent implementation.&lt;/p>
&lt;p>The generalization of Protobuf is also used in API gateway scenarios. While the original data format for HTTP generalization is JSON, the serialization of JSON can be bulky and inefficient, which negatively impacts performance. As a result, many mobile interfaces opt to transmit data using Protobuf due to its more compact representation. To address this demand, Kitex now includes support for Protobuf generalization.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/8.png" alt="image">&lt;/p>
&lt;p>Currently, Kitex&amp;rsquo;s generalization primarily focuses on the back-end Thrift service. Whether it&amp;rsquo;s Protobuf, Map, or JSON, Kitex combines IDL analysis on the calling side to encode the data mappings into Thrift packets and send them to the back-end service.&lt;/p>
&lt;p>Now, you may wonder why the generalization is implemented on the calling side instead of the server side. Typically, when we think of generalization, we imagine the server parsing and processing the generalized request, with the caller providing a corresponding generalized client. However, generalization comes with a certain cost, making it less suitable for regular RPC scenarios. Moreover, generalization is meant for all back-end services, including those written in different languages like Golang, Java, C++, Python, Rust, and more. If every language framework had to support generalization, the cost would be significantly high. Additionally, achieving convergence across different language frameworks is a lengthy process. Considering these factors, Kitex supports generalization on the calling side. This approach allows for greater flexibility and enables users to take advantage of generalization selectively based on their specific needs.&lt;/p>
&lt;h3 id="enhanced-retry-capability">Enhanced Retry Capability&lt;/h3>
&lt;p>When Kitex was open sourced last year, it already supported the retry function. Initially, there were two types of retries available: timeout retry and Backup Request.
For timeout retry, only the timeout exception was retried. However, to further improve the success rate of requests, users expressed the need to retry other exceptions or based on specific user-defined status codes. It became evident that supporting only timeout retry was insufficient to meet user requirements. In response, Kitex introduced retries with specified results. Users can now specify other exceptions or a particular type of response for which they want retries, and the framework will retry according to the specified results.&lt;/p>
&lt;p>Additionally, when users configure retries, if they set retries through code configuration, it will take effect for all RPC methods of the entire Client. However, users desired the ability to apply different retry strategies to different RPC methods. Different RPC methods may have varying requirements for indicators. For instance, some users may prefer using Backup Request to reduce delay, while others may prioritize exception retry to improve the success rate. To address this need, the new version of Kitex supports request granular configuration for retries.
The example below illustrates the usage of request granularity retry configuration. For example, if the RPC method is Mock, then when initiating an RPC call, we can configure a calloptspecified, and this request will adopt the specified retry strategy.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/9.png" alt="image">&lt;/p>
&lt;h3 id="thrift-validator">Thrift Validator&lt;/h3>
&lt;p>Thrift-gen-validator is a tool plug-in for Thriftgo, that enhances the code generation process. It allows users to describe and enforce constraints on the generated &lt;code>struct&lt;/code>&amp;rsquo;s &lt;code>IsValid()&lt;/code> error method based on annotations defined in the Thrift IDL. This ensures the legality of field values. Usually when making an RPC call, the user may verify the validity of some fields. If the user directly writes these verification codes, the investment cost will be high. To address this, we provide annotation support. As long as users define annotations in IDL according to the specified format, Kitex can help users generate verification code.&lt;/p>
&lt;p>The example below demonstrates the usage of code generation commands and an IDL annotation definition. By specifying the Thrift Validator plugin during code generation, our tool will parse the annotations and generate the required validation code. We are also currently contributing the Thrift Validator functionality to Apache Thrift.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/10.png" alt="image">&lt;/p>
&lt;h2 id="performance-optimization">Performance Optimization&lt;/h2>
&lt;p>After highlighting the important functional features, let&amp;rsquo;s move on to discussing several performance optimization features.&lt;/p>
&lt;h3 id="thrift-high-performance-codec">Thrift High-Performance Codec&lt;/h3>
&lt;p>&lt;a href="https://github.com/cloudwego/frugal">Frugal&lt;/a> is a dynamic Thrift codec that offers high-performance capabilities by leveraging Just-in-Time (JIT) compilation, eliminating the need for code generation. While we have already optimized the official Thrift codec and introduced FastThrift as part of our pre-open source optimization efforts, we wanted to further enhance performance by incorporating the design principles from our open source high-performance JSON library, Sonic. As a result, we have implemented the Thrift JIT codec in Frugal.
The table below illustrates a performance comparison between Frugal, combined with Kitex, and FastThrift.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/frugal.png" alt="image">&lt;/p>
&lt;p>It is evident that Frugal offers superior RPC performance in most scenarios. In addition to its performance advantages, Frugal provides another benefit: it eliminates the need to generate codec code. Compared to Protobuf, Thrift&amp;rsquo;s generated code tends to be heavier. A complex IDL can generate files with tens of thousands of lines of code, which users are responsible for maintaining. Frugal simplifies this process by only requiring the generation of structure code, removing the need for codec code generation.&lt;/p>
&lt;p>To learn how to use Frugal in conjunction with Kitex, you can refer to the repository&amp;rsquo;s &lt;a href="https://github.com/cloudwego/frugal#readme">Readme&lt;/a> file. users can also utilize Frugal as a standalone high-performance codec for Thrift. In the future, &lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a> may consider incorporating Frugal as the default codec option.&lt;/p>
&lt;h3 id="protobuf-high-performance-codec">Protobuf High-Performance Codec&lt;/h3>
&lt;p>We primarily focused on supporting Thrift internally; however, we recognized that external users are more inclined towards using Protobuf or gRPC after the open-source release. Consequently, taking inspiration from Kitex FastThrift&amp;rsquo;s optimization approach, we re-implemented the generated code for Protobuf.
Starting from version v0.4.0, if users employ Kitex tools to generate Protobuf code, the default generation will include &lt;a href="https://github.com/cloudwego/fastpb">Fastpb&lt;/a> codec code. Furthermore, when initiating RPC calls, Kitex will also utilize &lt;a href="https://github.com/cloudwego/fastpb">Fastpb&lt;/a> as the default serialization option.&lt;/p>
&lt;p>The figures below illustrate a performance comparison between &lt;a href="https://github.com/cloudwego/fastpb">Fastpb&lt;/a> and the official Protobuf serialization library. It is evident that Fastpb outperforms the official library in terms of efficiency, memory allocation, encoding, and decoding.&lt;/p>
&lt;ul>
&lt;li>FastWrite: &lt;strong>(ns/op) ↓67.8% ，(B/op) ↓83.9%&lt;/strong>&lt;/li>
&lt;li>FastRead: &lt;strong>(ns/op) ↓41.5% ，(B/op) ↓4.5%&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h3 id="grpc-performance-optimization">gRPC Performance Optimization&lt;/h3>
&lt;p>In the early days of open sourcing Kitex, our focus on stability and performance optimization for gRPC was relatively limited, as there were fewer internal use cases. However, after receiving feedback from numerous external users, we made dedicated efforts to address issues and optimize the performance of gRPC. In the middle of this year, we officially contributed these optimizations to the open-source library, which was released in version v0.4.0.&lt;/p>
&lt;p>The figure below provides a comparison of unary request throughput between Kitex-gRPC and the official gRPC framework before and after optimization. On the left side, you can see the throughput comparison before optimization.&lt;/p>
&lt;p>The figure below provides a comparison of unary request throughput between Kitex-gRPC and the official gRPC framework before and after optimization. On the left side, you can see the throughput comparison before optimization. At relatively low concurrency, Kitex&amp;rsquo;s throughput does not exhibit an advantage over the official gRPC framework. However, when using Fastpb, Kitex&amp;rsquo;s throughput performance improves compared to the pre-optimization stage. Despite this improvement, the low-concurrency throughput is still lower than that of the official gRPC framework. On the right side of the figure, you can observe the throughput comparison after optimization. The throughput has increased by 46% - 70% compared to the pre-optimization stage, and when compared to the official gRPC framework, the throughput has increased by 51% - 70%.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/13.png" alt="image">&lt;/p>
&lt;p>The right side of the figure below presents a comparison of latency for the optimized Unary requests. In scenarios where Kitex achieves a much higher throughput than the official gRPC framework, Kitex also demonstrates significantly lower latency compared to gRPC. Additionally, after optimization, Kitex exhibits improved delay performance overall.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/14.png" alt="image">&lt;/p>
&lt;p>Now let&amp;rsquo;s examine the performance comparison of streaming requests in a stress test. Prior to optimization, Kitex&amp;rsquo;s performance for streaming requests, even under low concurrency, did not outperform the gRPC framework. However, after optimization, Kitex&amp;rsquo;s throughput surpasses that of the official gRPC, as demonstrated in the figure below. It is worth noting that while Kitex achieves high throughput under low concurrency, the latency remains relatively consistent. However, as concurrency increases, the latency diverges. Consequently, in terms of performance, Kitex&amp;rsquo;s implementation of the gRPC protocol exhibits clear advantages over the official framework.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/15.png" alt="image">&lt;/p>
&lt;p>While Kitex may not have achieved complete functional alignment at this stage, it is capable of fulfilling the requirements of the majority of scenarios. Moreover, we are committed to ongoing efforts to further align and enhance its functionality in the future.&lt;/p>
&lt;h2 id="development-with-community-and-advancement-of-ecosystem-and-enterprise-integration">Development with Community and Advancement of Ecosystem and Enterprise Integration&lt;/h2>
&lt;h3 id="kitexs-community-driven-ecosystem-expansion">Kitex&amp;rsquo;s Community-Driven Ecosystem Expansion&lt;/h3>
&lt;p>Since its open-source release, we have been thrilled by the enthusiastic response from developers. Recognizing our team&amp;rsquo;s limitations in rapidly building an extensive Kitex ecosystem for external users, we have relied on the invaluable support of the community over the past year. Through collaborative efforts, Kitex has received significant contributions in areas such as service registration/discovery, observability, and service governance, with notable advancements in service registration/discovery. We have successfully integrated with mainstream open-source registration centers, and although further enhancements are required, we now possess the capability to help external users build robust microservice architectures, leveraging our existing support and expanding feature set.&lt;/p>
&lt;p>While we acknowledge the need for further enrichment in our docking capabilities, we are proud to state that, in conjunction with our existing support, Kitex already possesses the necessary features to facilitate the construction of microservice architectures for external users.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/16.png" alt="image">&lt;/p>
&lt;p>We extend our heartfelt appreciation to the developers who have actively contributed to the growth of the CloudWeGo community. To explore the extensive ecosystem surrounding Kitex, we invite you to visit the &lt;a href="https://github.com/kitex-contrib">kitex-contrib&lt;/a> repository in our open-source warehouse.&lt;/p>
&lt;h3 id="working-with-external-companies">Working with External Companies&lt;/h3>
&lt;p>Our primary goal with the open-source release of Kitex was to assist external companies in swiftly establishing enterprise-level cloud-native architectures. Since then, we have been delighted to receive interest and engagement from notable organizations such as Semir, Huaxing Securities, Tanwan Games, and Heduo Technology. Their valuable feedback and specific requirements have shed light on unique usage scenarios and challenges distinct from our internal use cases, necessitating our attention, support, and optimization efforts.&lt;/p>
&lt;p>We are thrilled to witness the successful application of Kitex in these enterprise environments. In fact, during the CloudWeGo Meetup held on June 25th of this year, R&amp;amp;D professionals from &lt;a href="https://mp.weixin.qq.com/s/JAurW4P2E3NIduFaVY6jew">Semir&lt;/a> and &lt;a href="https://mp.weixin.qq.com/s/QqGdzp-7rTdlxedy6bsXiw">Huaxing Securities&lt;/a> shared their internal experiences and practical use cases, further validating the effectiveness and value of Kitex in real-world scenarios.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/17.png" alt="image">&lt;/p>
&lt;p>In addition to the above companies, we have also provided consultation to private inquiries from various organizations regarding usage issues. We are very grateful for the support and feedback from these corporate users. As mentioned earlier, gathering feedback from the community and enterprises plays a crucial role in driving the evolution of Kitex to support a wide range of scenarios. If enterprise users have any specific needs or requirements, we encourage them to reach out to us.&lt;/p>
&lt;h2 id="how-to-use-kitex-to-integrate-with-existing-infrastructure">How to use Kitex to Integrate with Existing Infrastructure&lt;/h2>
&lt;p>Here is a brief introduction on how to use Kitex to integrate with your internal infrastructure. Let&amp;rsquo;s take ByteDance as an example, there are extensions in the open source library within the internal warehouse. These extensions are designed to integrate internal capabilities specific to ByteDance. Within the BytedSuite, Kitex can be initialized to cater to various scenarios. Users simply need to add an option configuration while constructing the Client and Server components to achieve seamless integration. To ensure a hassle-free experience, we have incorporated this configuration within the generated scaffolding code. This means that users no longer need to specifically focus on integrating internal capabilities. Furthermore, we plan to share details about how this configuration is embedded in the generated code. By doing so, secondary developers working with external frameworks will be able to provide integration capabilities to business development teams in a similar manner.
&lt;img src="https://www.cloudwego.io/img/blog/Kitex_architecture_explained_en/18.png" alt="image">&lt;/p>
&lt;h2 id="summary-and-future-perspectives">Summary and Future Perspectives&lt;/h2>
&lt;h3 id="summarize">Summarize&lt;/h3>
&lt;p>This blog introduces the following key points:&lt;/p>
&lt;ol>
&lt;li>The transition of Kitex from an internally used framework to an open-source framework while ensuring compatibility between internal and external versions.&lt;/li>
&lt;li>Overview of important functional features and performance optimizations released during the past year of open source.&lt;/li>
&lt;li>The origination and development of Kitex&amp;rsquo;s ecosystem with contributions from the community, examples of enterprise adoption, and elegant integration of internal capabilities using Kitex.&lt;/li>
&lt;/ol>
&lt;h3 id="future-perspectives">Future Perspectives&lt;/h3>
&lt;ol>
&lt;li>Collaborate with the community to further enrich the ecosystem and foster active participation from developers.&lt;/li>
&lt;li>Enhance the usability of Kitex by incorporating engineering practices and providing greater convenience for microservice developers.&lt;/li>
&lt;li>Continuously improve the BDThrift ecosystem and optimize support for Protobuf and gRPC.&lt;/li>
&lt;li>Explore and implement additional feature support and open sourcing, such as ShmIPC (shared memory IPC), QUIC (Quick UDP Internet Connections), and generalization for Protobuf.&lt;/li>
&lt;/ol>
&lt;p>By pursuing these goals, Kitex aims to meet the evolving needs of users and further strengthen its position as a reliable and efficient framework for building cloud-native architectures.&lt;/p></description></item><item><title>Blog: Kitex Release v0.4.0</title><link>https://www.cloudwego.io/blog/2022/08/26/kitex-release-v0.4.0/</link><pubDate>Fri, 26 Aug 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/08/26/kitex-release-v0.4.0/</guid><description>
&lt;h2 id="introduction-to-key-changes">&lt;strong>Introduction to Key Changes&lt;/strong>&lt;/h2>
&lt;h3 id="feature">&lt;strong>Feature&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Retry enhancement&lt;/strong>: Support user-defined result retry; Support request-level configuration (priority is higher than Neptune). See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/service-governance/retry/">retry guide&lt;/a> for details&lt;/li>
&lt;li>&lt;strong>Frugal (Thrift)&lt;/strong>: Support default value of IDL; No codec code is supported by using frugal. See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/codec_frugal/">frugal&lt;/a> for details&lt;/li>
&lt;li>&lt;strong>Tool-Protobuf&lt;/strong>: Support depend on external libraries with go_package, see &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/code_generation/#notes-for-using-protobuf-idls">Notes for Using Protobuf IDLs&lt;/a>; Support Guess IDL type from the file extension, it is unnecessary to specify the type param when generating the protobuf code&lt;/li>
&lt;li>&lt;strong>Fastpb(protobuf)&lt;/strong>: Support fastpb to optimize performance of protobuf, and it is integrated into Kite by default. See &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/fastpb/">fastpb&lt;/a> for details&lt;/li>
&lt;li>&lt;strong>Generic Call&lt;/strong>: Support HTTP+Protobuf generic call&lt;/li>
&lt;li>&lt;strong>Kitex lib supports Windows&lt;/strong>: You can use kitex running on Windows (Kitex tool still doesn&amp;rsquo;t support)&lt;/li>
&lt;/ol>
&lt;h3 id="optimization--bugfix">&lt;strong>Optimization &amp;amp; Bugfix&lt;/strong>&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>Performance Optimization&lt;/strong>: gRPC unary throughput increased by 46-70%, and 51% - 70% higher than the official gRPC framework throughput. See &lt;a href="https://github.com/cloudwego/kitex-benchmark">benchmark&lt;/a> for details&lt;/li>
&lt;li>&lt;strong>Generic Call&lt;/strong>: Support default value defined in thrift IDL for HTTP / Map / JSON Generic&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="full-release-log">&lt;strong>Full Release Log&lt;/strong>&lt;/h2>
&lt;h3 id="feature-1">Feature&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/571">#571&lt;/a>] feat(protobuf): integrate &lt;a href="https://github.com/cloudwego/fastpb">fastpb&lt;/a> into kitex, refer to &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/code-gen/fastpb/">doc&lt;/a>.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/592">#592&lt;/a>] feat(generic): add default value defined in thrift idl for HTTP/Map/JSON generic call.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/600">#600&lt;/a>] feat(thrift): support no codec gen-code when using frugal.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/607">#607&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/610">#610&lt;/a>] feat(proxyless): add option for xDS extension. Support traffic route, timeout config and service discovery based on xDS.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/541">#541&lt;/a>] feat(trans): Add the go net extension to the transport layer, and choose it as the transmission mode by default in Windows OS.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/540">#540&lt;/a>] feat(retry): support retry with specified error or response and add retry option for setup method retry policy.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/533">#533&lt;/a>] feat(generic): js_conv annotation of generic call supports map type conversion.&lt;/li>
&lt;/ul>
&lt;h3 id="optimize">Optimize&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/522">#522&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/538">#538&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/605">#605&lt;/a>] perf(grpc): optimize performance for gRPC protocol.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/590">#590&lt;/a>] optimize(tool): guess IDL type from file extension.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/559">#559&lt;/a>] optimize(timeout): use wrap func to check timeout err in timeout middleware which can ignore logs customized timeout err.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/581">#581&lt;/a>] optimize(tool): kitex tool usage add cmd example.&lt;/li>
&lt;/ul>
&lt;h3 id="bugfix">Bugfix&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/564">#564&lt;/a>] fix(oneway): discard oneway conn after sending complete, or subsequent requests that send to the same connection may get blocked until the oneway request gets processed by the server.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/577">#577&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/584">#584&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/602">#602&lt;/a>] fix(rpcinfo): fix rpcinfo reuse problem in longconn scene.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/578">#578&lt;/a>] fix: fix long pool dump panic.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/583">#583&lt;/a>] fix(tool): fix misusing of package name in protobuf generated code.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/587">#587&lt;/a>] fix(tool): skip proto files with external import paths when generates code.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/594">#594&lt;/a>] fix(generic): support the tag format of the escape double quotes in single quotes to be compatible with the logic of the old version.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/595">#595&lt;/a>] fix: fix nil union panic in BLength.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/589">#589&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/596">#596&lt;/a>] fix(frugal): fix frugal build tag.&lt;/li>
&lt;/ul>
&lt;h3 id="refactor">Refactor&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/566">#566&lt;/a>] refactor(metainfo): remove noused metakeys of HTTP2 Header.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/593">#593&lt;/a>] refactor(trans): support specify Listener for server by option WithListener, the priority is higher than WithServiceAddr.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/582">#582&lt;/a>] refactor(tool): use templates by embedding and export APIs for external usage for kitex tool.&lt;/li>
&lt;/ul>
&lt;h3 id="test">Test&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/579">#579&lt;/a>] test: add ut for long pool dump function.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/608">#608&lt;/a>] test: fix data race in TestClientConnDecoupledFromApplicationRead.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/609">#609&lt;/a>] test: fix gonet ut avoid testing port conflicts.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/480">#480&lt;/a>] test: add unit test for client package.&lt;/li>
&lt;/ul>
&lt;h3 id="chore">Chore&lt;/h3>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/558">#558&lt;/a>] ci: fix setup-python github action.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/487">#487&lt;/a>] ci: workflow add golangci-lint.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/580">#580&lt;/a>] chore: fix the typos in remote module about go net.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/601">#601&lt;/a>] chore: fixed some typos and replaced some defunct functions.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/604">#604&lt;/a>] chore: upgrade fastpb to v0.0.2.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/603">#603&lt;/a>] chore: upgrade frugal to v0.1.2.&lt;/li>
&lt;/ul>
&lt;h3 id="dependency-change">Dependency Change&lt;/h3>
&lt;p>github.com/cloudwego/frugal v0.1.1 -&amp;gt; v0.1.3&lt;/p>
&lt;p>github.com/cloudwego/netpoll v0.2.5 -&amp;gt; v0.2.6&lt;/p>
&lt;p>github.com/cloudwego/thriftgo v0.1.2 -&amp;gt; v0.2.0&lt;/p>
&lt;p>google.golang.org/protobuf v1.26.0 -&amp;gt; v1.28.0&lt;/p>
&lt;p>github.com/choleraehyq/pid v0.0.13 -&amp;gt; v0.0.15&lt;/p>
&lt;p>new imported:&lt;/p>
&lt;p>github.com/cloudwego/fastpb v0.0.2&lt;/p>
&lt;p>github.com/jhump/protoreflect v1.8.2&lt;/p></description></item><item><title>Blog: Kitex Release v0.3.2</title><link>https://www.cloudwego.io/blog/2022/06/02/kitex-release-v0.3.2/</link><pubDate>Thu, 02 Jun 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/06/02/kitex-release-v0.3.2/</guid><description>
&lt;h2 id="feature">Feature&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/473">#473&lt;/a>] feat(grpc): support short connection for gRPC unary.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/431">#431&lt;/a>] feat(limiter): extend outside limiter implementation and fix problems of rate limiter of multiplexed server.&lt;/li>
&lt;/ul>
&lt;h2 id="optimize">Optimize&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/465">#465&lt;/a>] optimize(ttheader): set remote address for client-side after decoding TTHeader.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/466">#466&lt;/a>] optimize(mux): wrap ErrReadTimeout with ErrRPCTimeout in mux scenario.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/425">#425&lt;/a>] optimize(limiter): promise tokens of the first second don&amp;rsquo;t exceed limit significantly.&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/485">#485&lt;/a>] fix(grpc): fix the incorrect integer conversion.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/474">#474&lt;/a>] fix(trans): fix detection handler panic when conn inactive early.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/445">#445&lt;/a>] fix(retry): race problems of callTimes in retry and some fields of rpcStats.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/471">#471&lt;/a>] fix(retry): callCosts race in backup request.&lt;/li>
&lt;/ul>
&lt;h2 id="test">Test&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/404">#404&lt;/a>] test: add unit test for pkg/retry.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/439">#439&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/472">#472&lt;/a>] test: add unit test for pkg/remote/remotecli.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/462">#462&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/457">#457&lt;/a>] test: add unit test for pkg/remote/trans/nphttp2/grpc.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/420">#420&lt;/a>] test: add ut for pkg/remote/trans/nphttp2.&lt;/li>
&lt;/ul>
&lt;h2 id="refactor">Refactor&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/464">#464&lt;/a>] refactor(ttheader): change protocol id of Kitex Protobuf in TTHeader and promise the change is compatible with the old version.&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/453">#453&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/475">#475&lt;/a>] chore: upgrade netpoll and bytedance/gopkg.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/458">#458&lt;/a>] chore: fix ci reviewdog and pr ut didn&amp;rsquo;t run.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/454">#454&lt;/a>] chore: use self-hosted ci to optimize speed.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/449">#449&lt;/a>] chore: fix github issue template.&lt;/li>
&lt;/ul>
&lt;h2 id="style">Style&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/486">#486&lt;/a>] style(trans): add comment for detection trans handler.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/482">#482&lt;/a>] docs: update FAQ of readme.&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change&lt;/h2>
&lt;ul>
&lt;li>github.com/cloudwego/netpoll: v0.2.2 -&amp;gt; v0.2.4&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.3.0</title><link>https://www.cloudwego.io/blog/2022/04/29/kitex-release-v0.3.0/</link><pubDate>Fri, 29 Apr 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/04/29/kitex-release-v0.3.0/</guid><description>
&lt;h2 id="feature">Feature&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/366">#366&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/426">#426&lt;/a> ] feat(client): support warming-up for kitex client&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/395">#395&lt;/a> ] feat(mux): support gracefully shutdown in connection multiplexing&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/399">#399&lt;/a> ] feat(protobuf): add fastpb protocol API and support it in the pkg/remote/codec module&lt;/li>
&lt;/ul>
&lt;h2 id="optimise">Optimise&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/402">#402&lt;/a> ] optimize(connpool): export getCommonReporter in pkg/remote/connpool&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/389">#389&lt;/a> ] optimize(rpcinfo): fill TransportProtocol, PackageName fields into RPCInfo of the server side after decoding&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/413">#413&lt;/a> ] fix(mux): set PayloadCodec for sendMsg in NetpollMux trans handler to fix generic request codec error.&lt;a href="https://github.com/cloudwego/kitex/issues/411">issue #411&lt;/a>&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/406">#406&lt;/a> ] fix(grpc): fix the sending and receiving logic about http2 framer, such as preventing the peer unable to receive the framer in time&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/398">#398&lt;/a> ] fix(utils): fix the bug that Dump() func in ring.go can&amp;rsquo;t dump the accurate data in ring shards&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/428">#428&lt;/a> ] fix(trans): close connection when flush data fails to avoid memory leak&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/340">#340&lt;/a> ] tool(protobuf): redesign and implement new protobuf gen code called fastpb which doesn&amp;rsquo;t use reflection and only supports proto3&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/396">#396&lt;/a> ] chore: replace cespare/xxhash with xxhash3 from bytedance/gopkg&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/400">#400&lt;/a> ] chore: upgrade go version of workflow to 1.18&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/407">#407&lt;/a> ] chore: add a separate file to declare the use of gRPC source code&lt;/li>
&lt;/ul>
&lt;h2 id="test">Test&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/401">#401&lt;/a> ] test: add ut for kitex/server package&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/393">#393&lt;/a> ] test: add ut for pkg/remote/bound package&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/403">#403&lt;/a> ] test: add netpollmux unit test&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/401">#401&lt;/a> ] test: add klog unit test&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/392">#392&lt;/a> ] test(utils): add UT for utils and fix inaccurate err throw in json.go&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/373">#373&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/432">#432&lt;/a>, &lt;a href="https://github.com/cloudwego/kitex/pull/434">#434&lt;/a> ] test(grpc): add gRPC transport unit tests, promoting the coverage to 76%&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/424">#424&lt;/a> ] test(transmeta): supplementary of unit tests for http2 and ttheader implementations of MetaHandler/StreamingMetaHandler in pkg/transmeta.&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change&lt;/h2>
&lt;ul>
&lt;li>github.com/cloudwego/netpoll: v0.2.0 -&amp;gt; v0.2.2&lt;/li>
&lt;li>github.com/bytedance/gopkg: 20210910103821-e4efae9c17c3 -&amp;gt; 20220413063733-65bf48ffb3a7&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.2.1</title><link>https://www.cloudwego.io/blog/2022/03/24/kitex-release-v0.2.1/</link><pubDate>Thu, 24 Mar 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/03/24/kitex-release-v0.2.1/</guid><description>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/383">#383&lt;/a> ] fix(generic): detect circular dependency in thrift IDL when using generic call.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/359">#359&lt;/a> ] fix(tool): fix streaming import missing in protobuf combine service.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/363">#363&lt;/a> ] fix(client): fix a bug that sequence ID of oneway requests are not encoded and lower the loss rate of oneway requests.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/367">#367&lt;/a> ] fix(generic/tool): combine services may have duplicate loading of the same service.&lt;/li>
&lt;/ul>
&lt;h2 id="optimise">Optimise&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/362">#362&lt;/a> ] optimize(diagnosis): lbcache is global, it doesn&amp;rsquo;t need register ProbeFunc for diagnosis.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/374">#374&lt;/a> ] optimize(rpcinfo): RPCInfo.To().Tag() use instance tag instead of remoteinfo tag firstly.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/355">#355&lt;/a> ] optimize(connpool): adjust minMaxIdleTimeout to 2s.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/354">#354&lt;/a> ] optimize(hook): adding locks to onServerStart and onShutdown, acquire the corresponding lock when doing some read and write operations like RegisterStartHook and range in server.Run().&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/331">#331&lt;/a> ] optimize(discovery): add error definition ErrInstanceNotFound which is used in the service discovery module.&lt;/li>
&lt;/ul>
&lt;h2 id="refactor">Refactor&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/352">#352&lt;/a> ] refactor(event): delete additional atomic operations and replace them with a normal operation.&lt;/li>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/343">#343&lt;/a> ] refactor(loadbalancer): merge BuildWeightedVirtualNodes function into buildVirtualNodes function, make it easier to maintain.&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/376">#376&lt;/a> ] chore: upgrade choleraehyq/pid for Go 1.18.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs&lt;/h2>
&lt;ul>
&lt;li>[&lt;a href="https://github.com/cloudwego/kitex/pull/364">#364&lt;/a> ] docs: update readme with new blog.&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.2.0</title><link>https://www.cloudwego.io/blog/2022/02/24/kitex-release-v0.2.0/</link><pubDate>Thu, 24 Feb 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/02/24/kitex-release-v0.2.0/</guid><description>
&lt;h2 id="feature">Feature&lt;/h2>
&lt;ul>
&lt;li>Feat(grpc): support options to set the internal params of gRPC&lt;/li>
&lt;li>Feat(kerror): add new func WithCauseAndExtraMsg for basicError&lt;/li>
&lt;li>Feat(rpcinfo): add FreezeRPCInfo to support asynchronous context usage&lt;/li>
&lt;li>Feat(codec): default codec supports size limit&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>Fix(remotecli): fix bug that released connections may be reused&lt;/li>
&lt;li>Fix(generic): generic call supports extended services&lt;/li>
&lt;li>Fix(generic): fix generic call oneway flag&lt;/li>
&lt;/ul>
&lt;h2 id="optimise">Optimise&lt;/h2>
&lt;ul>
&lt;li>Optimize(retry): improve retry success rate when do failure retry&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>Chore: upgrade netpoll to v0.2.0&lt;/li>
&lt;li>Chore:add third party license&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.1.4</title><link>https://www.cloudwego.io/blog/2022/01/18/kitex-release-v0.1.4/</link><pubDate>Tue, 18 Jan 2022 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2022/01/18/kitex-release-v0.1.4/</guid><description>
&lt;h2 id="improvement">Improvement&lt;/h2>
&lt;ul>
&lt;li>Optimize(log): don&amp;rsquo;t print timeout log in rpctimeout middleware&lt;/li>
&lt;li>Optimize(log): adjust default log level to info&lt;/li>
&lt;li>Optimize(gRPC): lock the sendAt avoid grpc bdp data race&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>Fix(client-connection): fix a connection leaking bug that happens when clients fail at Send&lt;/li>
&lt;li>Fix(timeout): fix TimeoutAdjust won&amp;rsquo;t work when set in middleware builder&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool&lt;/h2>
&lt;ul>
&lt;li>Fix(tool): fix protobuf handler arguments name
&lt;blockquote>
&lt;p>kitex will generate a stream type named &amp;ldquo;{{.ServiceName}}{{.Name}}Server&amp;rdquo; for each streaming server,
but in handler.go kitex use &amp;ldquo;{{.ServiceName}}{{.RawName}}Server&amp;rdquo; as stream name.&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>Style: remove unnecessary type conversions&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.1.3</title><link>https://www.cloudwego.io/blog/2021/12/30/kitex-release-v0.1.3/</link><pubDate>Thu, 30 Dec 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/12/30/kitex-release-v0.1.3/</guid><description>
&lt;h2 id="feature">Feature&lt;/h2>
&lt;ul>
&lt;li>Transmit the Base from client to server for getting the caller info in JSON generic&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>Fix(grpc): fix metric missing method tag in streaming&lt;/li>
&lt;li>Fix(generic): fix the incompatible modification about base64 binary in the JSON and HTTP generic&lt;/li>
&lt;li>Fix(grpc): fix the bug of grpc flow control, which brings the problem of continuous timeout&lt;/li>
&lt;/ul>
&lt;h2 id="ci">CI&lt;/h2>
&lt;ul>
&lt;li>Add scenario tests&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>update the &lt;a href="https://github.com/cloudwego/kitex/blob/develop/ROADMAP.md">ROADMAP&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.1.2</title><link>https://www.cloudwego.io/blog/2021/12/22/kitex-release-v0.1.2/</link><pubDate>Wed, 22 Dec 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/12/22/kitex-release-v0.1.2/</guid><description>
&lt;h2 id="hotfix">Hotfix&lt;/h2>
&lt;ul>
&lt;li>Fix some gRPC request bugs which are involved by v0.1.0&lt;/li>
&lt;li>Fix mistake gRPC method path when no package definition in IDL&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change&lt;/h2>
&lt;ul>
&lt;li>Chore: upgrade netpoll-http2 to fix the problem about large request package (&amp;gt;4K) in streaming&lt;/li>
&lt;/ul>
&lt;h2 id="chore">Chore&lt;/h2>
&lt;ul>
&lt;li>Chore: use GitHub&amp;rsquo;s &lt;code>PULL_REQUEST_TEMPLATE&lt;/code> to create a PR&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.1.0</title><link>https://www.cloudwego.io/blog/2021/12/13/kitex-release-v0.1.0/</link><pubDate>Mon, 13 Dec 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/12/13/kitex-release-v0.1.0/</guid><description>
&lt;h2 id="feature">Feature&lt;/h2>
&lt;h3 id="generic-call">Generic Call&lt;/h3>
&lt;ul>
&lt;li>Support combined services&lt;/li>
&lt;li>Export SetSeqID and add GetSeqID for binary generic call of server side&lt;/li>
&lt;li>Support close generic client to avoid memory leak&lt;/li>
&lt;/ul>
&lt;h3 id="log">Log&lt;/h3>
&lt;ul>
&lt;li>Use key=value style in log messages&lt;/li>
&lt;li>Use klog as global log in some logs&lt;/li>
&lt;li>Use the global default logger across kitex&lt;/li>
&lt;li>Print detail loginfo by ctx&lt;/li>
&lt;li>Pass service info to go func which is used to output for troubleshooting&lt;/li>
&lt;/ul>
&lt;h3 id="option">Option&lt;/h3>
&lt;ul>
&lt;li>Add NewThriftCodecDisableFastMode to disable FastWrite/Read&lt;/li>
&lt;li>Add server option - WithReusePort&lt;/li>
&lt;li>Default rpc timeout = 0&lt;/li>
&lt;/ul>
&lt;h3 id="proxy">Proxy&lt;/h3>
&lt;ul>
&lt;li>Proxy add ContextHandler interface to support passing initialization context to mwBuilder&lt;/li>
&lt;li>Register Dump in lbcache to diagnosis&lt;/li>
&lt;li>Pass RPCConfig to proxy.Config&lt;/li>
&lt;/ul>
&lt;h2 id="improvement">Improvement&lt;/h2>
&lt;ul>
&lt;li>Reduce heap allocation&lt;/li>
&lt;li>Optimize mux performance&lt;/li>
&lt;li>Recycle grpc codec buffer by close linkbuffer&lt;/li>
&lt;li>Distinguish ErrRPCFinish in cost info of backup request&lt;/li>
&lt;li>Move mux.ShardQueue to netpoll, rename sharedMap to shardMap&lt;/li>
&lt;li>Add container length encoding guard in fast api&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix&lt;/h2>
&lt;ul>
&lt;li>Enable server error handle middleware&lt;/li>
&lt;li>Adjust Balancer initialization in lbcache&lt;/li>
&lt;li>Init TraceCtl when it is nil (only affect unit test)&lt;/li>
&lt;li>Set default rpctimeout and disable timeout logic if rpctimeout == 0&lt;/li>
&lt;li>Defaultlogger wrong calldepth&lt;/li>
&lt;li>Rename BackwardProxy to ReverseProxy&lt;/li>
&lt;li>Avoid nil panic in grpc keepalive&lt;/li>
&lt;li>Fix hidden dangers about grpc&lt;/li>
&lt;li>Fix exception missing in void method&lt;/li>
&lt;li>Fix mistake dump info when instances change.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs&lt;/h2>
&lt;ul>
&lt;li>Fix link in readme_zh&lt;/li>
&lt;li>Remove docs; maintain cloudwego.io only&lt;/li>
&lt;/ul>
&lt;h2 id="netpoll-api-change">Netpoll API Change&lt;/h2>
&lt;ul>
&lt;li>Adapt netpoll.Writer.Append API&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change&lt;/h2>
&lt;ul>
&lt;li>github.com/cloudwego/netpoll: v0.0.4 -&amp;gt; v0.1.2&lt;/li>
&lt;/ul></description></item><item><title>Blog: Getting Started With Kitex's Practice: Performance Testing Guide</title><link>https://www.cloudwego.io/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/</link><pubDate>Wed, 24 Nov 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/11/24/getting-started-with-kitexs-practice-performance-testing-guide/</guid><description>
&lt;blockquote>
&lt;p>On September 8, 2021, ByteDance announced the launch of CloudWeGo open source project.
CloudWeGo is a set of microservice middleware developed by ByteDance with high performance, strong scalability and stability.
It focuses on microservice communication and governance, and meets the demands of different services in various scenarios.
CloudWeGo currently has 4 Repos: Kitex, Netpoll, Thriftgo and netpoll-http2, featuring the RPC framework &amp;ndash; Kitex and the network library &amp;ndash; Netpoll.&lt;/p>
&lt;/blockquote>
&lt;p>Recently, ByteDance Service Framework Team officially announced the open source of CloudWeGo. It includes the Golang microservice RPC framework &amp;ndash; Kitex, which has been deeply used in Douyin and Toutiao.&lt;/p>
&lt;p>This article aims to share the scenarios and technical issues that developers need to know when stress testing Kitex.
These guides will help users adjust and optimize Kitex to better match their business needs, and maximize Kitex&amp;rsquo;s performance in real RPC scenarios.
Users can also refer to the official stress test project &amp;ndash; &lt;a href="https://github.com/cloudwego/kitex-benchmark">kitex-benchmark&lt;/a> for more details.&lt;/p>
&lt;h2 id="the-characteristics-of-microservice-scenario">The Characteristics of Microservice Scenario&lt;/h2>
&lt;p>Kitex was born in ByteDance&amp;rsquo;s large-scale microservices architecture practice. The scenario it is aimed at is naturally a microservices scenario.
Therefore, the following will first introduce the characteristics of microservices, so that developers can understand Kitex&amp;rsquo;s design thinking in depth.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>RPC Communication Model&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>The communication between microservices is usually based on PingPong model. So, in addition to the conventional throughput performance index, developers also need to consider the average latency of each RPC.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Complex Call Chain&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>An RPC call often requires multiple microservices to collaborate, and downstream services have their own dependencies, so the entire call chain will be a complex network structure.&lt;/p>
&lt;p>In this kind of complex call chains, the latency fluctuation of one intermediate node may be transmitted to the entire chain，resulting in an overall timeout.
When there are many nodes on the chain, even if the fluctuation probability of each node is very low, the timeout probability that eventually converges on the chain will be magnified.
Therefore, the latency fluctuation of a single service, notably P99, is also a key indicator that has a significant impact on online services.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Size of Data Package&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>Although the size of transmitted data packages depends on the actual business scenario, the internal statistics of ByteDance found that most online requests are small packages (&amp;lt;2KB).
So we focused on optimizing the performance in the small data package scenarios while taking the large package scenarios into account.&lt;/p>
&lt;h2 id="stress-test-for-microservice-scenarios">Stress Test for Microservice Scenarios&lt;/h2>
&lt;h3 id="determine-stress-test-objects">Determine Stress Test Objects&lt;/h3>
&lt;p>Measuring the performance of an RPC framework requires consideration from two perspectives: Client and Server.
In large-scale business architectures, upstream clients are not necessarily using the same frameworks as downstream, and same goes to the downstream services scheduled by developers.
The situation becomes more complicated when Service Mesh is involved.&lt;/p>
&lt;p>Some stress test projects often generate performance data for the &lt;strong>entire framework&lt;/strong> by mixing Client and Server processes, which is likely to be inconsistent with the actual online operation.&lt;/p>
&lt;p>If you want to stress test Server, you should give Client as many resources as possible to push Server to its limit, and vice versa.
If both Client and Server are only provided 4-core CPUs for stress tests, it will be impossible for developers to determine the performance data is referring to either Client or Server.
Thus, the test result will not have practical value for online services.&lt;/p>
&lt;h3 id="alignment-of-connection-model">Alignment of Connection Model&lt;/h3>
&lt;p>Conventional RPCs have three major connection models:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Short connection&lt;/strong>: Each request creates a new connection and closes the connection immediately after the return is received.&lt;/li>
&lt;li>&lt;strong>Persistent connection pool&lt;/strong>: A single connection can process only one complete request &amp;amp; return at once.&lt;/li>
&lt;li>&lt;strong>Connection multiplexing&lt;/strong>: A single connection can process multiple requests &amp;amp; returns asynchronously at the same time.&lt;/li>
&lt;/ul>
&lt;p>Each type of connection model is not absolutely good or bad, it depends on the actual usage scenario.
Although connection multiplexing generally performs the best, the application must rely on the protocol being able to support package serial numbers,
and some older framework services may not support multiplexing calls.&lt;/p>
&lt;p>In order to ensure maximum compatibility, Kitex initially used short connections on the Client side by default, while other mainstream open source frameworks used connection multiplexing by default.
It resulted in large performance data deviations for some users when stress testing with default configuration.&lt;/p>
&lt;p>Later, in order to accommodate the common scenario of open source users, Kitex supported &lt;a href="https://github.com/cloudwego/kitex/pull/40/files">persistent connection&lt;/a> by default in v0.0.2.&lt;/p>
&lt;h3 id="alignment-of-serialization-strategy">Alignment of Serialization Strategy&lt;/h3>
&lt;p>For RPC frameworks, regardless of service governance, the computation overhead is mainly generated in serialization and deserialization.&lt;/p>
&lt;p>Kitex uses the &lt;a href="https://github.com/golang/protobuf">Go protobuf library&lt;/a> to serialize Protobuf.
And for serialization of Thrift, Kitex has specific performance optimization, which is introduced in the &lt;a href="https://www.cloudwego.io/blog/2021/09/23/performance-optimization-on-kitex/#serializationdeserialization-optimization-of-thrift">blog post&lt;/a> on our official web.&lt;/p>
&lt;p>Most of the current open source frameworks support Protobuf in preference, and some built-in Protobuf are actually &lt;a href="https://github.com/gogo/protobuf">gogo/protobuf&lt;/a> versions with performance optimizations.
However, gogo/protobuf is currently at risk of &lt;a href="https://github.com/gogo/protobuf/issues/691">maintenance absence&lt;/a>.
Therefore, due to maintainability concerns, we decided to use the official protobuf library only. Certainly, we will plan to optimize Protobuf in the future.&lt;/p>
&lt;h3 id="use-exclusive-cpu">Use Exclusive CPU&lt;/h3>
&lt;p>Although multiple processes would usually utilize the CPU capability at the same time for online applications.
But in stress test scenarios, both Client and Server processes are extremely busy.
Sharing the CPU will result in a large number of context switching, which makes the output data less reliable and prone to large fluctuations.&lt;/p>
&lt;p>Therefore, we recommend that the Client and Server processes should be isolated on different CPUs or different exclusive machines.
If you want to further avoid the impact of other processes, you can add the nice -n -20 command to adjust the scheduling priority of the stress testing process.&lt;/p>
&lt;p>In addition, if possible, using physical machines makes the test results more precise and reproducible compared to using virtual machines on cloud platforms.&lt;/p>
&lt;h2 id="performance-data-demonstration">Performance Data Demonstration&lt;/h2>
&lt;p>On the premise of meeting the above requirements, we compared the stress test results of multiple frameworks using Protobuf.
The stress test source code can be found in &lt;a href="https://github.com/gogo/protobuf/issues/691">kitex-benchmark&lt;/a> repo.
When Server is fully loaded, P99 Latency of Kitex in connection pool mode is the lowest of all frameworks. In multiplexing mode, Kitex also performs well in each indicator.&lt;/p>
&lt;p>&lt;strong>Configuration&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Client 16 CPUs，Server 4 CPUs&lt;/li>
&lt;li>1KB Request Package Size, Echo Scenario&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Reference Data&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>KITEX: Connection Pool Model (Default Setting)&lt;/li>
&lt;li>KITEX-MUX: Connection Multiplexing&lt;/li>
&lt;li>Connection Multiplexing for all other Frameworks&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/kitex_performance_testing/qps.png" alt="image">
&lt;img src="https://www.cloudwego.io/img/blog/kitex_performance_testing/tp99.png" alt="image">&lt;/p>
&lt;h2 id="summary">Summary&lt;/h2>
&lt;p>Each mainstream Golang open source RPC framework actually has its own focus in terms of design goals: some focus on generality,
some on scenarios with light business logic like Redis, some on throughput performance, and some on P99 latency.&lt;/p>
&lt;p>In the daily iteration of ByteDance&amp;rsquo;s business, it is common for a feature to cause one indicator to rise and another indicator to decline.
Therefore, Kitex was more inclined to solve various problems in large-scale microservice scenarios at the beginning of its design.&lt;/p>
&lt;p>Since the launch of Kitex, we have received a large amount of self-testing data from our users. We appreciate the community for their attention and support.
We also encourage developers to use the testing guide provided in this article, and select appropriate tools for their own scenarios. For more questions, please make an Issue on GitHub.&lt;/p>
&lt;h2 id="pertinent-links">Pertinent Links&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.cloudwego.io/">CloudWeGo Official Website&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cloudwego/kitex">Kitex&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cloudwego/netpoll">Netpoll&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cloudwego/kitex-benchmark">kitex-benchmark&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cloudwego/netpoll-benchmark">netpoll-benchmark&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/protobuf">Go Protobuf Library&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/cloudwego/thriftgo">Thriftgo&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.8</title><link>https://www.cloudwego.io/blog/2021/11/05/kitex-release-v0.0.8/</link><pubDate>Fri, 05 Nov 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/11/05/kitex-release-v0.0.8/</guid><description>
&lt;h2 id="improvement">Improvement:&lt;/h2>
&lt;ul>
&lt;li>Use shard rings to reduce lock overhead in connpool.&lt;/li>
&lt;li>Fill upstream information to rpcinfo from TTheader, for printing useful log when decode error happened.&lt;/li>
&lt;li>Move unlink uds operation to CreateListener.&lt;/li>
&lt;li>Replace sync.Mutex by sync.RWMutex of event.go and ring_single.go.&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix:&lt;/h2>
&lt;ul>
&lt;li>Fix netpollmux shard index overflow.&lt;/li>
&lt;li>Remove reflection of &lt;code>WithCircuitBreaker&lt;/code> option arguments to prevent data-race.&lt;/li>
&lt;li>Fix rpc finished error may happen small probability in failure retry scenario &amp;amp;&amp;amp; add sample check for retry circuit breaking.&lt;/li>
&lt;li>Fix a test case mistake in endpoint_test.go.&lt;/li>
&lt;li>Modify longconn variable name to conn.&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool:&lt;/h2>
&lt;ul>
&lt;li>Kitex codegen tool supports passing through thrift-go plugin arguments.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs:&lt;/h2>
&lt;ul>
&lt;li>Use a link to the the kitex-benchmark repository to replace the performance section in README.&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change:&lt;/h2>
&lt;ul>
&lt;li>github.com/tidwall/gjson: v1.8.0 -&amp;gt; v1.9.3&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.5</title><link>https://www.cloudwego.io/blog/2021/09/26/kitex-release-v0.0.5/</link><pubDate>Sun, 26 Sep 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/09/26/kitex-release-v0.0.5/</guid><description>
&lt;h2 id="feature">Feature:&lt;/h2>
&lt;ul>
&lt;li>Add default ErrorHandler to wrap remote error when no ErrorHandler is specified.&lt;/li>
&lt;li>Backward metainfo is supported.&lt;/li>
&lt;li>JSON generic call is supported. Usage guide: &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/generic-call/#4-json-mapping-generic-call">link&lt;/a>.&lt;/li>
&lt;/ul>
&lt;h2 id="improvement">Improvement:&lt;/h2>
&lt;ul>
&lt;li>Use new netpoll API to improve throughput and reduce latency for mux.&lt;/li>
&lt;li>Backward and forward metainfo is supported for mux.&lt;/li>
&lt;li>Client will use RPCTimeout middleware when necessary.&lt;/li>
&lt;li>Add validity verification of idle connection in ConnectionPool.&lt;/li>
&lt;li>QPS limiter token will be reset when QPS limit updates.&lt;/li>
&lt;li>Reduce the deviation of QPS Limiter.&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix:&lt;/h2>
&lt;ul>
&lt;li>Fix WithExitWaitTime won&amp;rsquo;t set exit wait time correctly.&lt;/li>
&lt;li>Fix goroutine leak when update interval of QPS limiter.&lt;/li>
&lt;li>Use actual listen address to build registry info.&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool:&lt;/h2>
&lt;ul>
&lt;li>Fix code generating error when no stream method in protobuf file.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs:&lt;/h2>
&lt;ul>
&lt;li>English is available for README and all other documents.&lt;/li>
&lt;li>Guide for generic call. &lt;a href="https://www.cloudwego.io/docs/kitex/tutorials/advanced-feature/generic-call/">English&lt;/a> | &lt;a href="https://www.cloudwego.io/zh/docs/kitex/tutorials/advanced-feature/generic-call/">中文&lt;/a>&lt;/li>
&lt;li>Landscape and Roadmap in README.&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change:&lt;/h2>
&lt;ul>
&lt;li>github.com/cloudwego/netpoll: v0.0.3 -&amp;gt; v0.0.4&lt;/li>
&lt;li>github.com/bytedance/gopkg: v0.0.0-20210709064845-3c00f9323f09 -&amp;gt; v0.0.0-20210910103821-e4efae9c17c3&lt;/li>
&lt;/ul></description></item><item><title>Blog: Performance Optimization on Kitex</title><link>https://www.cloudwego.io/blog/2021/09/23/performance-optimization-on-kitex/</link><pubDate>Thu, 23 Sep 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/09/23/performance-optimization-on-kitex/</guid><description>
&lt;h2 id="preface">Preface&lt;/h2>
&lt;p>Kitex is the next generation high-performance and extensible Go RPC framework developed by ByteDance Service Framework Team. Compared with other RPC frameworks, in addition to its rich features for service governance, it has the following characteristics: integrated with the self-developed network library - Netpoll; supports multiple Message Protocols (Thrift, Protobuf) and Interactive Models (Ping-Pong, Oneway, Streaming); provides a more flexible and extensible code generator.&lt;/p>
&lt;p>Currently, Kitex has been widely used by the major lines of business in ByteDance, and statistics shows that the number of service access is up to 8K. We&amp;rsquo;ve been continuously improving Kitex&amp;rsquo;s performance since its launch. This article will share our work on optimizing Netpoll and serialization.&lt;/p>
&lt;h2 id="optimization-of-the-network-library---netpoll">Optimization of the Network Library - Netpoll&lt;/h2>
&lt;p>Netpoll, the self-developed network library based on Epoll. Compared with the previous version and the go net library, its performance has been significantly improved. Test results indicated that compared with the last version (2020.05), the latest version (2020.12) has ↑30% throughput capacity, ↓25% AVG latency, and ↓67% TP99 . Its performance is far better than the Go Net library. Below, we&amp;rsquo;ll share two solutions that can significantly improve its performance.&lt;/p>
&lt;h3 id="optimizing-scheduling-delays-when-calling-epoll_wait">Optimizing Scheduling Delays When Calling &amp;ldquo;epoll_wait&amp;rdquo;&lt;/h3>
&lt;p>When Netpoll was newly released, it encountered the problem of low AVG latency but high TP99. Through our research and analysis on &amp;ldquo;epoll_wait&amp;rdquo;, we found that such a problem could be mitigated by integrating &amp;ldquo;polling&amp;rdquo; and &amp;ldquo;event trigger&amp;rdquo;. With such improvements in scheduling strategy, the latency can be reduced considerably.&lt;/p>
&lt;p>Let&amp;rsquo;s have a look at the &amp;ldquo;syscall.EpollWait&amp;rdquo; method provided by Go first:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">EpollWait&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">epfd&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">events&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#000">EpollEvent&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">n&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Three parameters are provided here, they represent &amp;ldquo;epoll fd&amp;rdquo;, “callback events”, and &amp;ldquo;milliseconds to wait&amp;rdquo; respectively. Only &amp;ldquo;msec&amp;rdquo; is dynamic.&lt;/p>
&lt;p>Normally, we would set &amp;ldquo;msec = -1&amp;rdquo; when we are actively calling &amp;ldquo;EpollWait&amp;rdquo;, as we want to wait for the event infinitely. In fact, many open-source net libraries were also using it in this way. But our research showed that setting &amp;ldquo;msec =-1&amp;rdquo; was not the optimal solution.&lt;/p>
&lt;p>The kernel source (below) of &amp;ldquo;epoll_wait&amp;rdquo; shows that setting &amp;ldquo;msec = -1&amp;rdquo; arises extra &amp;ldquo;fetch_events&amp;rdquo; checks than setting &amp;ldquo;msec = 0&amp;rdquo;, and therefore consumes more time.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">static&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">ep_poll&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000">eventpoll&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">ep&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000">epoll_event&lt;/span> &lt;span style="color:#000">__user&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">events&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000">maxevents&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">long&lt;/span> &lt;span style="color:#000">timeout&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">timeout&lt;/span> &lt;span style="color:#000;font-weight:bold">&amp;gt;&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span> &lt;span style="color:#204a87;font-weight:bold">else&lt;/span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">timeout&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">==&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">goto&lt;/span> &lt;span style="color:#000">send_events&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">fetch_events&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">eavail&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">goto&lt;/span> &lt;span style="color:#000">send_events&lt;/span>&lt;span style="color:#000;font-weight:bold">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">send_events&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The Benchmark shows that when an event is triggered, setting &amp;ldquo;msec = 0&amp;rdquo; is about 18% faster than setting &amp;ldquo;msec = -1&amp;rdquo;. Thus, when triggering complex events, setting &amp;ldquo;msec = 0&amp;rdquo; is obviously a better choice.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Benchmark&lt;/th>
&lt;th style="text-align: left">time/op&lt;/th>
&lt;th style="text-align: left">bytes/op&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">BenchmarkEpollWait, msec=0&lt;/td>
&lt;td style="text-align: left">270 ns/op&lt;/td>
&lt;td style="text-align: left">0 B/op&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkEpollWait, msec=-1&lt;/td>
&lt;td style="text-align: left">328 ns/op&lt;/td>
&lt;td style="text-align: left">0 B/op&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">EpollWait Delta&lt;/td>
&lt;td style="text-align: left">-17.68%&lt;/td>
&lt;td style="text-align: left">~&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>However, setting &amp;ldquo;msec = 0&amp;rdquo; would lead to infinite polling when no event is triggered, consumes lots of resources.&lt;/p>
&lt;p>Taking the previously mentioned factors into account, it&amp;rsquo;s preferred to set &amp;ldquo;msec = 0&amp;rdquo; when an event is triggered and &amp;ldquo;msec = -1&amp;rdquo; when no event is triggered to reduce polling. The pseudocode is demonstrated as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">n&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">syscall&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">EpollWait&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">epfd&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">events&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">msec&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">n&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Nevertheless, our experiments have proved that the improvement is insignificant. Setting &amp;ldquo;msec = 0&amp;rdquo; merely reduces the delay of a single call by 50ns, which is not a considerable improvement. If we want to further reduce latency, adjustment must be made in Go runtime scheduling.
Thus, let&amp;rsquo;s further explore this issue:
In the pseudocode above, setting &amp;ldquo;msec= -1&amp;rdquo; with no triggered event, and &amp;ldquo;continue&amp;rdquo; directly will immediately execute &amp;ldquo;EpollWait&amp;rdquo; again. Since there is no triggered event while &amp;ldquo;msec = -1&amp;rdquo;, the current &amp;ldquo;goroutine&amp;rdquo; will block and be switched by &amp;ldquo;P&amp;rdquo; passively. However, it is less efficient, and we can save time if we actively switch &amp;ldquo;goroutine&amp;rdquo; for &amp;ldquo;P&amp;rdquo; before &amp;ldquo;continue&amp;rdquo;. So we modified the above pseudocode as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">var&lt;/span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">for&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">n&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">syscall&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">EpollWait&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">epfd&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">events&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">msec&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">n&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">runtime&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Gosched&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msec&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The test results of the modified code showed that throughput ↑12% and TP99 ↓64%. The latency was significantly reduced.&lt;/p>
&lt;h3 id="utilizing-unsafepointer">Utilizing &amp;ldquo;unsafe.Pointer&amp;rdquo;&lt;/h3>
&lt;p>Through further study of &amp;ldquo;epoll_wait&amp;rdquo;, we find that the &amp;ldquo;syscall.EpollWait&amp;rdquo; published by Go and the &amp;ldquo;epollwait&amp;rdquo; used by &amp;ldquo;runtime&amp;rdquo; are two different versions, as they use different &amp;ldquo;EpollEvent&amp;rdquo;. They are demonstrated as follows:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// @syscall&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">EpollEvent&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Events&lt;/span> &lt;span style="color:#204a87;font-weight:bold">uint32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Fd&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Pad&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// @runtime&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">epollevent&lt;/span> &lt;span style="color:#204a87;font-weight:bold">struct&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">events&lt;/span> &lt;span style="color:#204a87;font-weight:bold">uint32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">data&lt;/span> &lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">8&lt;/span>&lt;span style="color:#000;font-weight:bold">]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span> &lt;span style="color:#8f5902;font-style:italic">// unaligned uintptr&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As we can see, the &amp;ldquo;epollevent&amp;rdquo; used by &amp;ldquo;runtime&amp;rdquo; is the original structure defined by &amp;ldquo;epoll&amp;rdquo; at system layer. The published version encapsulates it and splits &amp;ldquo;epoll_data(epollevent.data)&amp;rdquo; into two fixed fields: &amp;ldquo;Fd&amp;rdquo; and &amp;ldquo;Pad&amp;rdquo;. For &amp;ldquo;runtime&amp;rdquo;, in its source code we found the following logic:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">**&lt;/span>&lt;span style="color:#000">pollDesc&lt;/span>&lt;span style="color:#000;font-weight:bold">)(&lt;/span>&lt;span style="color:#000">unsafe&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Pointer&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">ev&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">data&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">pd&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000">pd&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">**&lt;/span>&lt;span style="color:#000">pollDesc&lt;/span>&lt;span style="color:#000;font-weight:bold">)(&lt;/span>&lt;span style="color:#000">unsafe&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Pointer&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">ev&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">data&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Obviously, &amp;ldquo;runtime&amp;rdquo; uses &amp;ldquo;epoll_data(&amp;amp;ev.data)&amp;rdquo; to store the pointer of the corresponding structure (pollDesc) of &amp;ldquo;fd&amp;rdquo; directly. Thus, when an event is triggered, the &amp;ldquo;struct&amp;rdquo; object can be found directly with the corresponding logic being executed. However, the external version can only obtain the encapsulated &amp;ldquo;fd&amp;rdquo; parameters. So it needs to introduce additional &amp;ldquo;Map&amp;rdquo; to manipulate the &amp;ldquo;struct&amp;rdquo; object, and the performance will be diminished.&lt;/p>
&lt;p>Therefore, we abandoned &amp;ldquo;syscall.EpollWait&amp;rdquo; and designed our own &amp;ldquo;EpollWait&amp;rdquo; call by referring to &amp;ldquo;runtime&amp;rdquo;. We also use &amp;ldquo;unsafe.Pointer&amp;rdquo; to access &amp;ldquo;struct&amp;rdquo; objects. The test results showed that our &amp;ldquo;EpollWait&amp;rdquo; call contributed to ↑10% throughput and ↓10% TP99, which has significantly improved efficiency.&lt;/p>
&lt;h2 id="serializationdeserialization-optimization-of-thrift">Serialization/Deserialization Optimization of Thrift&lt;/h2>
&lt;p>Serialization refers to the process of converting a data structure or object into a binary or textual form. Deserialization is the opposite process. A serialization protocol needs to be agreed during RPC communication. The serialization process is executed before the client sends requests. The bytes are transmitted to the server over the network, and the server will logic-process the bytes to complete an RPC request. Thrift supports &amp;ldquo;Binary&amp;rdquo;, &amp;ldquo;Compact&amp;rdquo;, and &amp;ldquo;JSON&amp;rdquo; serialization protocols. Since &amp;ldquo;Binary&amp;rdquo; is the most common protocol used in Bytedance, we will only discuss about &amp;ldquo;Binary&amp;rdquo; protocol.&lt;/p>
&lt;p>&amp;ldquo;Binary&amp;rdquo; protocol is &amp;ldquo;TLV&amp;rdquo; (&amp;ldquo;Type&amp;rdquo;, &amp;ldquo;Length&amp;rdquo;, &amp;ldquo;Value&amp;rdquo;) encoded, that is, each field is described using &amp;ldquo;TLV&amp;rdquo; structure. It emphasizes that the &amp;ldquo;Value&amp;rdquo; can also be a &amp;ldquo;TLV&amp;rdquo; structure, where the &amp;ldquo;Type&amp;rdquo; and &amp;ldquo;Length&amp;rdquo; are fixed in length, and the length of &amp;ldquo;Value&amp;rdquo; is determined by the input value of &amp;ldquo;Length&amp;rdquo;. The TLV coding structure is simple, clear, and scalable. However, since it requires the input of &amp;ldquo;Type&amp;rdquo; and &amp;ldquo;Length&amp;rdquo;, there is extra memory overhead incurred. It wastes considerable memory especially when most fields are in base types.&lt;/p>
&lt;p>The performance of serialization and deserialization can be optimized from two dimensions - &amp;ldquo;time&amp;rdquo; &amp;amp; &amp;ldquo;space&amp;rdquo;. To be compatible with the existing &amp;ldquo;binary&amp;rdquo; protocols, optimization in &amp;ldquo;space&amp;rdquo; seems to be infeasible. Improvement can only be made in &amp;ldquo;time&amp;rdquo;, it includes:&lt;/p>
&lt;ul>
&lt;li>Reduce the frequency of operations on memory, notably memory allocation and copying. Try to pre-allocate memory to reduce unnecessary time consumption.&lt;/li>
&lt;li>Reduce the frequency of function calls by adjusting code structure or using &amp;ldquo;inline&amp;rdquo; etc.&lt;/li>
&lt;/ul>
&lt;h3 id="research-on-serialization-strategy">Research on Serialization Strategy&lt;/h3>
&lt;p>Based on &amp;ldquo;go_serialization_benchmarks&amp;rdquo;, we investigated a number of serialization schemes that performed well to guide the optimization of our serialization strategy.&lt;/p>
&lt;p>Analysis of &amp;ldquo;protobuf&amp;rdquo;, &amp;ldquo;gogoprotobuf&amp;rdquo;, and &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; has provided us the following results:&lt;/p>
&lt;ul>
&lt;li>Considering I/O, the transmitted data is usually compressed in size during network transmission. &amp;ldquo;protobuf&amp;rdquo; uses &amp;ldquo;Varint&amp;rdquo; encoding and has good data compression capabilities in most scenarios.&lt;/li>
&lt;li>&amp;ldquo;gogoprotobuf&amp;rdquo; uses precomputation to reduce memory allocations and copies during serialization. Thus, it eliminates the cost of system calls, locks and GC arisen from memory allocations.&lt;/li>
&lt;li>&amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; directly operates buffer, which also reduces memory allocations and copies. In addition, it also designs &amp;ldquo;struct pointer&amp;rdquo; in a way that processes fixed-length data and non-fixed-length data separately, which enables fast processing for fixed-length data.&lt;/li>
&lt;/ul>
&lt;p>For compatibility reasons, it is impossible to change the existing &amp;ldquo;TLV&amp;rdquo; encoding format, so data compression is not feasible. But finding 2 and 3 are inspiring to our optimization work, and in fact we have taken a similar approach.&lt;/p>
&lt;h3 id="approaches">Approaches&lt;/h3>
&lt;h4 id="reducing-operations-on-memory">Reducing Operations on Memory&lt;/h4>
&lt;p>&lt;strong>Buffer management&lt;/strong>&lt;br>
Both serialization and deserialization involve copying data from one piece of memory to another. It involves memory allocation and memory copying. Avoiding memory operations can reduce unnecessary overhead such as system calls, locks, and GC.&lt;/p>
&lt;p>In fact, Kitex has provided &amp;ldquo;LinkBuffer&amp;rdquo; for buffer management purposes. &amp;ldquo;LinkBuffer&amp;rdquo; is designed with a linked structure and consists of multiple blocks, among which blocks are memory chunks with a fixed size. Object pool is constructed to maintain unoccupied block and support block multiplexing, thus, reduce memory usage and GC.&lt;/p>
&lt;p>Initially we simply used &amp;ldquo;sync.Pool&amp;rdquo; to multiplex the &amp;ldquo;LinkBufferNode&amp;rdquo; of netpoll, but it didn&amp;rsquo;t significantly contribute to multiplexing in large data package scenarios (large nodes can&amp;rsquo;t be reclaimed or it would cause memory leaking). At present, we have changed our strategy to maintain a group of &amp;ldquo;sync.Pool&amp;rdquo;, and the buffer size in each chunk is different. When new blocks are created, it is obtained from the pool with the closest size to the required size, so that the memory can be multiplexed as much as possible. And the test results also proved that it contributed to significant improvement in terms of memory allocation and GC.&lt;/p>
&lt;p>&lt;strong>Copy-free String / Binary&lt;/strong>&lt;br>
For some services, such as video-related services, during its request or return processes, large-size &amp;ldquo;Binary&amp;rdquo; data will be arisen, representing the processed video or image data. Meanwhile, some services will return large-size &amp;ldquo;String&amp;rdquo; data (such as full-text information, etc.). In this scenario, all the hot spots we see through the flame graph are on the copies of the data. So we thought, can we reduce the frequency of such copies?&lt;/p>
&lt;p>The answer is positive. Since our underlying buffer is a linked list, it is easy to insert a node in the middle of the list.&lt;/p>
&lt;p>&lt;img src="https://www.cloudwego.io/img/blog/buffer-linkerd-list.png" alt="!image">&lt;/p>
&lt;p>Thus, we have taken a similar approach, when a &amp;ldquo;string&amp;rdquo; or &amp;ldquo;binary&amp;rdquo; data exists during serialization processes. First, split the node&amp;rsquo;s buffer into two segments and then insert the buffer of the &amp;ldquo;string&amp;rdquo; / &amp;ldquo;binary&amp;rdquo; objects in the middle correspondingly. This avoids the copy of large &amp;ldquo;string&amp;rdquo; / &amp;ldquo;binary&amp;rdquo; .&lt;/p>
&lt;p>Furthermore, a copy will occur if we convert a string to &amp;ldquo;[]byte&amp;rdquo; using &amp;ldquo;[]byte(string)&amp;rdquo;. Because &amp;ldquo;string&amp;rdquo; is immutable and &amp;ldquo;[]byte&amp;rdquo; is mutable in Golang language. &amp;ldquo;unsafe&amp;rdquo; is needed if you don&amp;rsquo;t want to copy during the conversion:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000">StringToSliceByte&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">s&lt;/span> &lt;span style="color:#204a87;font-weight:bold">string&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#204a87">len&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">s&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span>&lt;span style="color:#000;font-weight:bold">)(&lt;/span>&lt;span style="color:#000">unsafe&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Pointer&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">reflect&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">SliceHeader&lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Data&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">reflect&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">StringHeader&lt;/span>&lt;span style="color:#000;font-weight:bold">)(&lt;/span>&lt;span style="color:#000">unsafe&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Pointer&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#000">s&lt;/span>&lt;span style="color:#000;font-weight:bold">))).&lt;/span>&lt;span style="color:#000">Data&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Len&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">l&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">Cap&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000">l&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The meaning of this demonstrated code is to take the address of the string first, and then give it a slice byte header, so that the &amp;ldquo;string&amp;rdquo; can be converted into &amp;ldquo;[]byte&amp;rdquo; without copying the data. Note that the resulting &amp;ldquo;[]byte&amp;rdquo; is not writable, or the behavior is undefined.&lt;/p>
&lt;p>&lt;strong>Pre-Calculation&lt;/strong>&lt;br>
Some services support transmissions of large data package, which incurs considerable serialization / deserialization overhead. Generally, large packages are associated with the large size of the container type. If the buffer can be pre-calculated, some O(n) operations can be reduced to O(1), and further reduce the frequency of function calls. In the case of large data packages, the number of memory allocation can also be greatly reduced, bringing considerable benefits.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Base types&lt;/p>
&lt;ul>
&lt;li>If the container element is defined as base type (bool, byte, i16, i32, i64, double), the total size can be pre-calculated during serialization as its size is fixed, and enough buffer can be allocated at once. The number of &amp;ldquo;malloc&amp;rdquo; operations of O(n) can be reduced to O(1), thus greatly reducing the frequency of &amp;ldquo;malloc&amp;rdquo; operations. Similarly, the number of &amp;ldquo;next&amp;rdquo; operations can be reduced during deserialization.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Rearrangement of &amp;ldquo;Struct&amp;rdquo; Fields&lt;/p>
&lt;ul>
&lt;li>The above optimizations are valid only for container elements that are defined as base types. Can they be optimized for &amp;ldquo;struct&amp;rdquo; elements? The answer is yes.&lt;/li>
&lt;li>If there are fields of base type in &amp;ldquo;struct&amp;rdquo;, we can pre-calculate the size of these fields, then allocate buffer for these fields in advance during serialization and write these fields in the first order. We can also reduce the frequency of &amp;ldquo;malloc&amp;rdquo;.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Size calculation&lt;/p>
&lt;ul>
&lt;li>The optimization mentioned above is for base types. If you first iterate over all the fields of the request during serialization, you can calculate the size of the entire request, allocate buffer in advance, and directly manipulate buffer during serialization and deserialization, so that the optimization effect can be achieved for non-base types.&lt;/li>
&lt;li>Define a new &amp;ldquo;codec&amp;rdquo; interface:&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">type&lt;/span> &lt;span style="color:#000">thriftMsgFastCodec&lt;/span> &lt;span style="color:#204a87;font-weight:bold">interface&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">BLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#8f5902;font-style:italic">// count length of whole req/resp&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">FastWrite&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">FastRead&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#204a87;font-weight:bold">int&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Change the &amp;ldquo;Marshal&amp;rdquo; and &amp;ldquo;Unmarshal&amp;rdquo; interfaces accordingly:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">c&lt;/span> &lt;span style="color:#000">thriftCodec&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">Marshal&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">message&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Message&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">out&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ByteBuffer&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">msg&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">data&lt;/span>&lt;span style="color:#000;font-weight:bold">.(&lt;/span>&lt;span style="color:#000">thriftMsgFastCodec&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span> &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msgBeginLen&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">MessageBeginLength&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">methodName&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">thrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TMessageType&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">msgType&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#204a87">int32&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">seqID&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msgEndLen&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">MessageEndLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">out&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Malloc&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">msgBeginLen&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+&lt;/span> &lt;span style="color:#000">msg&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">BLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+&lt;/span> &lt;span style="color:#000">msgEndLen&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>&lt;span style="color:#8f5902;font-style:italic">// malloc once&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">perrors&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewProtocolErrorWithMsg&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">fmt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Sprintf&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;thrift marshal, Malloc failed: %s&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">WriteMessageBegin&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">methodName&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">thrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">TMessageType&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">msgType&lt;/span>&lt;span style="color:#000;font-weight:bold">),&lt;/span> &lt;span style="color:#204a87">int32&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">seqID&lt;/span>&lt;span style="color:#000;font-weight:bold">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">msg&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FastWrite&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">WriteMessageEnd&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">c&lt;/span> &lt;span style="color:#000">thriftCodec&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">Unmarshal&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">ctx&lt;/span> &lt;span style="color:#000">context&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Context&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">message&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Message&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">in&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ByteBuffer&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">error&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">data&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">message&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Data&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">msg&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">data&lt;/span>&lt;span style="color:#000;font-weight:bold">.(&lt;/span>&lt;span style="color:#000">thriftMsgFastCodec&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span> &lt;span style="color:#000">ok&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#000">message&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PayloadLen&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">msgBeginLen&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">MessageBeginLength&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">methodName&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">msgType&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">seqID&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#000">tProt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">next&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">message&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PayloadLen&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span> &lt;span style="color:#000">msgBeginLen&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">MessageEndLength&lt;/span>&lt;span style="color:#000;font-weight:bold">())&lt;/span> &lt;span style="color:#8f5902;font-style:italic">// next once&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewTransError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PROTOCOL_ERROR&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">())&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">_&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">msg&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FastRead&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewTransError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PROTOCOL_ERROR&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">())&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#000;font-weight:bold">=&lt;/span> &lt;span style="color:#000">tProt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">ReadMessageEnd&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">err&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">NewTransError&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">remote&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">PROTOCOL_ERROR&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">err&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Error&lt;/span>&lt;span style="color:#000;font-weight:bold">())&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">tProt&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Recycle&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">err&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>Modify the generated code accordingly:&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">p&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">Demo&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">BLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">StructBeginLength&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;Demo&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">p&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">field1Length&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">field2Length&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">field3Length&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#ce5c00;font-weight:bold">...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">FieldStopLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">l&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">StructEndLength&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">l&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">func&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">p&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span>&lt;span style="color:#000">Demo&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000">FastWrite&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span> &lt;span style="color:#000;font-weight:bold">[]&lt;/span>&lt;span style="color:#204a87;font-weight:bold">byte&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#204a87;font-weight:bold">int&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">:=&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">0&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">WriteStructBegin&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:],&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Demo&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">if&lt;/span> &lt;span style="color:#000">p&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">!=&lt;/span> &lt;span style="color:#204a87;font-weight:bold">nil&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">fastWriteField2&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">fastWriteField4&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">fastWriteField1&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">p&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">fastWriteField3&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">WriteFieldStop&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#000">offset&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">+=&lt;/span> &lt;span style="color:#000">bthrift&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">Binary&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">WriteStructEnd&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">buf&lt;/span>&lt;span style="color:#000;font-weight:bold">[&lt;/span>&lt;span style="color:#000">offset&lt;/span>&lt;span style="color:#000;font-weight:bold">:])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000">offset&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="optimizing-thrift-encoding-with-simd">Optimizing Thrift Encoding with SIMD&lt;/h4>
&lt;p>&amp;ldquo;list&amp;lt;i64/i32&amp;gt;&amp;rdquo; is widely used in the company to carry the ID list, and the encoding method of &amp;ldquo;list&amp;lt;i64/i32&amp;gt;&amp;rdquo; is highly consistent with the rule of vectorization. Thus, we use SIMD to optimize the encoding process of list&amp;lt;i64/i32&amp;gt;.&lt;/p>
&lt;p>We implement &amp;ldquo;avx2&amp;rdquo; to improve the encoding process, and the improved results are significant. When dealing with large amounts of data, the performance can be improved by 6 times for i64 and 12 times for i32. In the case of small data volume, the improvement is more obvious, which achieves 10 times for i64 and 20 times for I32.&lt;/p>
&lt;h4 id="reducing-function-calls">Reducing Function Calls&lt;/h4>
&lt;p>&lt;strong>inline&lt;/strong>&lt;br>
The purpose of &amp;ldquo;inline&amp;rdquo; is to expand a function call during its compilation and replace it with the implementation of the function. It improves program performance by reducing the overhead of the function call.&lt;/p>
&lt;p>&amp;ldquo;inline&amp;rdquo; can&amp;rsquo;t be implemented on all functions in Go. Run the process with the argument - (gflags=&amp;quot;-m&amp;quot;) to display the functions that are inlined. The following conditions cannot be inlined:&lt;/p>
&lt;ul>
&lt;li>A function containing a loop;&lt;/li>
&lt;li>Functions that include: closure calls, select, for, defer, coroutines created by the go keyword;&lt;/li>
&lt;li>For Functions over a certain length, by default when parsing the AST, Go applies 80 nodes. Each node consumes one unit of inline budget. For example, a = a + 1 contains five nodes: AS, NAME, ADD, NAME, LITERAL. When the overhead of a function exceeds this budget, it cannot be inlined.&lt;/li>
&lt;/ul>
&lt;p>You can specify the intensity (go 1.9+) of the compiler&amp;rsquo;s inlined code by specifying &amp;ldquo;-l&amp;rdquo; at compile time. But it is not recommended, as in our test scenario, it is buggy and does not work:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// The debug[&amp;#39;l&amp;#39;] flag controls the aggressiveness. Note that main() swaps level 0 and 1, making 1 the default and -l disable. Additional levels (beyond -l) may be buggy and are not supported.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// 0: disabled&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// 1: 80-nodes leaf functions, oneliners, panic, lazy typechecking (default)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// 2: (unassigned)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// 3: (unassigned)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">// 4: allow non-leaf functions&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Although using &amp;ldquo;inline&amp;rdquo; can reduce the overhead of function calls, it may also lead to lower CPU cache hit rate due to code redundancy. Therefore, excessive usage of &amp;ldquo;inline&amp;rdquo; should not be blindly pursued, and specific analysis should be carried out based on &amp;ldquo;profile&amp;rdquo; results.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>go &lt;span style="color:#204a87">test&lt;/span> -gcflags&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;-m=2&amp;#39;&lt;/span> -v -test.run TestNewCodec 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep &lt;span style="color:#4e9a06">&amp;#34;function too complex&amp;#34;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> wc -l
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">48&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>go &lt;span style="color:#204a87">test&lt;/span> -gcflags&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#39;-m=2 -l=4&amp;#39;&lt;/span> -v -test.run TestNewCodec 2&amp;gt;&lt;span style="color:#000;font-weight:bold">&amp;amp;&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> grep &lt;span style="color:#4e9a06">&amp;#34;function too complex&amp;#34;&lt;/span> &lt;span style="color:#000;font-weight:bold">|&lt;/span> wc -l
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#0000cf;font-weight:bold">25&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see, from the output above, increasing the inline intensity does reduce the &amp;ldquo;function too complex&amp;rdquo;. Following are the benchmark results:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Benchmark&lt;/th>
&lt;th style="text-align: left">time/op&lt;/th>
&lt;th style="text-align: left">bytes/op&lt;/th>
&lt;th style="text-align: left">allocs/op&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">BenchmarkOldMarshal-4&lt;/td>
&lt;td style="text-align: left">309 µs ± 2%&lt;/td>
&lt;td style="text-align: left">218KB&lt;/td>
&lt;td style="text-align: left">11&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkNewMarshal-4&lt;/td>
&lt;td style="text-align: left">310 µs ± 3%&lt;/td>
&lt;td style="text-align: left">218KB&lt;/td>
&lt;td style="text-align: left">11&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>It reveals that turning on the highest level of inlining intensity does eliminate many functions that cannot be inlined due to &amp;ldquo;function too complex&amp;rdquo;, but the test results show that the improvement is insignificant.&lt;/p>
&lt;h3 id="testing-results">Testing Results&lt;/h3>
&lt;p>We built benchmarks to compare performance before and after optimization, and here are the results.
Testing Environment:
Go 1.13.5 darwin/amd64 on a 2.5 GHz Intel Core i7 16GB&lt;/p>
&lt;p>&lt;strong>Small Data Size&lt;/strong>&lt;/p>
&lt;p>Data size: 20KB&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Benchmark&lt;/th>
&lt;th style="text-align: left">time/op&lt;/th>
&lt;th style="text-align: left">bytes/op&lt;/th>
&lt;th style="text-align: left">allocs/op&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">BenchmarkOldMarshal-4&lt;/td>
&lt;td style="text-align: left">138 µs ± 3%&lt;/td>
&lt;td style="text-align: left">25.4KB&lt;/td>
&lt;td style="text-align: left">19&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkNewMarshal-4&lt;/td>
&lt;td style="text-align: left">29 µs ± 3%&lt;/td>
&lt;td style="text-align: left">26.4KB&lt;/td>
&lt;td style="text-align: left">11&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Marshal Delta&lt;/td>
&lt;td style="text-align: left">-78.97%&lt;/td>
&lt;td style="text-align: left">3.87%&lt;/td>
&lt;td style="text-align: left">-42.11%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkOldUnmarshal-4&lt;/td>
&lt;td style="text-align: left">199 µs ± 3%&lt;/td>
&lt;td style="text-align: left">4720&lt;/td>
&lt;td style="text-align: left">1360&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkNewUnmarshal-4&lt;/td>
&lt;td style="text-align: left">94µs ± 5%&lt;/td>
&lt;td style="text-align: left">4700&lt;/td>
&lt;td style="text-align: left">1280&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Unmarshal Delta&lt;/td>
&lt;td style="text-align: left">-52.93%&lt;/td>
&lt;td style="text-align: left">-0.24%&lt;/td>
&lt;td style="text-align: left">-5.38%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>Large Data Size&lt;/strong>&lt;/p>
&lt;p>Data size: 6MB&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Benchmark&lt;/th>
&lt;th style="text-align: left">time/op&lt;/th>
&lt;th style="text-align: left">bytes/op&lt;/th>
&lt;th style="text-align: left">allocs/op&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">BenchmarkOldMarshal-4&lt;/td>
&lt;td style="text-align: left">58.7ms ± 5%&lt;/td>
&lt;td style="text-align: left">6.96MB&lt;/td>
&lt;td style="text-align: left">3350&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkNewMarshal-4&lt;/td>
&lt;td style="text-align: left">13.3ms ± 3%&lt;/td>
&lt;td style="text-align: left">6.84MB&lt;/td>
&lt;td style="text-align: left">10&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Marshal Delta&lt;/td>
&lt;td style="text-align: left">-77.30%&lt;/td>
&lt;td style="text-align: left">-1.71%&lt;/td>
&lt;td style="text-align: left">-99.64%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkOldUnmarshal-4&lt;/td>
&lt;td style="text-align: left">56.6ms ± 3%&lt;/td>
&lt;td style="text-align: left">17.4MB&lt;/td>
&lt;td style="text-align: left">391000&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkNewUnmarshal-4&lt;/td>
&lt;td style="text-align: left">26.8ms ± 5%&lt;/td>
&lt;td style="text-align: left">17.5MB&lt;/td>
&lt;td style="text-align: left">390000&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">Unmarshal Delta&lt;/td>
&lt;td style="text-align: left">-52.54%&lt;/td>
&lt;td style="text-align: left">0.09%&lt;/td>
&lt;td style="text-align: left">-0.37%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="copy-free-serialization">Copy-free Serialization&lt;/h2>
&lt;p>In some services with large request and response data, the cost of serialization and deserialization is high. There are two ways for optimization:&lt;/p>
&lt;ul>
&lt;li>Implement the optimization strategy on serialization and deserialization as described earlier.&lt;/li>
&lt;li>Scheduling by copy-free serialization.&lt;/li>
&lt;/ul>
&lt;h3 id="research-on-copy-free-serilization">Research on Copy-free Serilization&lt;/h3>
&lt;p>RPC through copy-free serialization, which originated from the &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; project of Kenton Varda. &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; provides a set of data exchange formats and corresponding codec libraries.&lt;/p>
&lt;p>In essence, &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; creates a bytes slice as buffer, and all read &amp;amp; write operations on data structures are directly operated on buffer. After reading &amp;amp; writing, information contained by the buffer is added to the head and can be sent directly. And the peer end can read it after receiving it. Since there is no Go structure as an intermediate storage, serialization and deserialization are not required.&lt;/p>
&lt;p>To briefly summarize the characteristics of &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo;:&lt;/p>
&lt;ul>
&lt;li>All data is read and written to a contiguous memory.&lt;/li>
&lt;li>The serialization operation is preceded. &amp;ldquo;Get/Set&amp;rdquo; data and encoding process in parallel.&lt;/li>
&lt;li>In the data exchange format, pointer (&amp;ldquo;offset&amp;rdquo; at the data memory) mechanism is used to store data at any location in the contiguous memory, so that data in the structure can be read and written in any order.
&lt;ul>
&lt;li>Fixed-size fields of a structure are rearranged so that they are stored in contiguous memory.&lt;/li>
&lt;li>Fields with indeterminate size of a structure (e.g. list), are represented by a fixed-size pointer that stores information including the location of the data.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>First of all, &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; has no Go language structure as an intermediate carrier, which can reduce a copy. Then, &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; operates on a contiguous memory, and the read and write of coded data can be completed at once. Because of these two reasons, Cap &amp;rsquo;n Proto has excellent performance.&lt;/p>
&lt;p>Here are the benchmarks of &amp;ldquo;Thrift&amp;rdquo; and &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; for the same data structure. Considering that &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; presets the codec operation, we compare the complete process including data initialization. That is, structure data initialization + (serialization) + write buffer + read from buffer + (deserialization) + read from structure.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-Thrift" data-lang="Thrift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">struct&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">MyTest&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">i64&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Num&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Ano&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Ano&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">3&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">list&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;lt;&lt;/span>&lt;span style="color:#204a87;font-weight:bold">i64&lt;/span>&lt;span style="color:#000;font-weight:bold">&amp;gt;&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Nums&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#8f5902;font-style:italic">// 长度131072 大小1MB
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#8f5902;font-style:italic">&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">struct&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Ano&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000;font-weight:bold">{&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">i64&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">Num&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#000;font-weight:bold">}&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Benchmark&lt;/th>
&lt;th style="text-align: left">Iter&lt;/th>
&lt;th style="text-align: left">time/op&lt;/th>
&lt;th style="text-align: left">bytes/op&lt;/th>
&lt;th style="text-align: left">alloc/op&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">BenchmarkThriftReadWrite&lt;/td>
&lt;td style="text-align: left">172&lt;/td>
&lt;td style="text-align: left">6855840 ns/op&lt;/td>
&lt;td style="text-align: left">3154209 B/op&lt;/td>
&lt;td style="text-align: left">545 allocs/op&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">BenchmarkCapnpReadWrite&lt;/td>
&lt;td style="text-align: left">1500&lt;/td>
&lt;td style="text-align: left">844924 ns/op&lt;/td>
&lt;td style="text-align: left">2085713 B/op&lt;/td>
&lt;td style="text-align: left">9 allocs/op&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">ReadWrite Delta&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">-87.68%&lt;/td>
&lt;td style="text-align: left">-33.88%&lt;/td>
&lt;td style="text-align: left">-98.35%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>(deserialization) + read data, depending on the size of data package,&amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; performance is about 8-9 times better than &amp;ldquo;Thrift&amp;rdquo;. Write data + (serialization), depending on the size of data package, &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; performance is approximately 2-8 times better than &amp;ldquo;Thrift&amp;rdquo;. Overall performance of &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; is approximately 4-8 times better than &amp;ldquo;Thrift&amp;rdquo;.&lt;/p>
&lt;p>Previously, we discussed the advantages of &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo;. We will then summarize some problems existing in &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo;:&lt;/p>
&lt;ul>
&lt;li>One problem with the contiguous memory of Cap &amp;rsquo;n Proto is that when the data of variable size is resized, and the required space is larger than the original space, the space of the original data can only be reallocated later. As a result, the original space becomes a hole that cannot be removed. This problem gets worse as the call link is resized, and can only be solved with strict constraints throughout the link: avoid resizing variable size fields, and when resize is necessary, rebuild a structure and make a deep copy of the data.&lt;/li>
&lt;li>&amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; has no Go language structure as an intermediate carrier, so all fields can only be read and written through the interface, resulting in poor user experience.&lt;/li>
&lt;/ul>
&lt;h3 id="thrift-protocols-compatible-copy-free-serialization">Thrift Protocol‘s Compatible Copy-free Serialization&lt;/h3>
&lt;p>In order to support copy-free serialization better and more efficiently, &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; uses a self-developed codec format, but it is difficult to be implemented in the current environment where &amp;ldquo;Thrift&amp;rdquo; and &amp;ldquo;ProtoBuf&amp;rdquo; are dominant. In order to achieve the performance of copy-free serialization with protocol compatibility, we started the exploration of copy-free serialization that is compatible with &amp;ldquo;Thrift&amp;rdquo; protocol.&lt;/p>
&lt;p>&amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; is a benchmark for copy-free serialization, so let&amp;rsquo;s see if the optimizations on &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; can be applied to Thrift:&lt;/p>
&lt;ul>
&lt;li>Nature is the core of copy-free serialization, which does not use Go structure as intermediate carriers to reduce one copy. This optimization is not about a particular protocol and can be applied to any existing protocol (So it&amp;rsquo;s naturally compatible with the Thrift protocol), but the user experience of &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; reflects that it needs to be carefully polished.&lt;/li>
&lt;li>&amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; is operated on a contiguous memory. The read &amp;amp; write of the encoded data can be completed at once. &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; can operate on contiguous memory because there is a pointer mechanism that allows data to be stored anywhere, allowing fields to be written in any order without affecting decoding. However, it is very likely to leave a hole in the resize due to misoperation on contiguous memory. Besides, &amp;ldquo;Thrift&amp;rdquo; has no pointer alike mechanism, so it has stricter requirements on data layout. Here are two ways to approach such problems:
&lt;ul>
&lt;li>Insist on operating in contiguous memory, while imposing strict regulations on users&amp;rsquo; usage: 1. Resize operation must rebuild the data structure; 2. When a structure is nested, there are strict requirements on the order in which the fields are written (we can think of it as unfolding a nested structure from the outside in, and being written in the same order) . In addition, due to TLV encoding such as Binary, when writing begins for each nesting, it requires declaration (such as &amp;ldquo;StartWriteFieldX&amp;rdquo;).&lt;/li>
&lt;li>Operating not entirely in contiguous memory, alterable fields are allocated a separate piece of memory. Since memory is not completely contiguous, the write operation can&amp;rsquo;t complete the output at once. In order to get closer to the performance of writing data at once, we adopted a linked buffer scheme. On the one hand, when the variable field resize occurs, only one node of the linked buffer is replaced, and there is no need to reconstruct the structure like &amp;ldquo;Cap &amp;rsquo;n Proto”. On the other hand, there is no need to clarify the actual structure like &amp;ldquo;Thrift&amp;rdquo; when the output is needed, just write the buffer on the link.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>To summarize what we have determined previously: 1. Do not use Go structure as the intermediate carrier, directly operate the underlying memory through the interface, and complete the codec at the same time of &amp;ldquo;Get/Set&amp;rdquo;. 2. Data is stored through a linked buffer.&lt;/p>
&lt;p>Then let&amp;rsquo;s take a look at the remaining issues:&lt;/p>
&lt;ul>
&lt;li>Degradation of the user experience caused by not using Go structures.
&lt;ul>
&lt;li>Solution: Improve the user experience of &amp;ldquo;Get/Set&amp;rdquo; interface and make it as easy to use as the Go structure.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Binary Format of &amp;ldquo;Cap &amp;rsquo;n Proto&amp;rdquo; is designed specifically for copy-free serialization scenarios, and although decoding is performed once for every Get, the decoding costs are minimal. The &amp;ldquo;Thrift&amp;rdquo; protocol (taking &amp;ldquo;Binary&amp;rdquo; as an example) has no mechanism that is similar to pointer. When there are multiple fields of variable size or nesting, they must be resolved sequentially instead of directly calculating the offset to get the field data location. Moreover, the cost of sequential resolution for each Get is too high.
&lt;ul>
&lt;li>Solution: In addition to recording the structure&amp;rsquo;s buffer nodes, we also add an index that records the pointer to the buffer node at the beginning of each field with unfixed size. The following is the ultimate performance comparison test between the current copy-free serialization scheme and &amp;ldquo;FastRead/Write&amp;rdquo; under the condition of 4 cores:&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align: left">Package Size&lt;/th>
&lt;th style="text-align: left">Type&lt;/th>
&lt;th style="text-align: left">QPS&lt;/th>
&lt;th style="text-align: left">TP90&lt;/th>
&lt;th style="text-align: left">TP99&lt;/th>
&lt;th style="text-align: left">TP999&lt;/th>
&lt;th style="text-align: left">CPU&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align: left">1KB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">70,700&lt;/td>
&lt;td style="text-align: left">1 ms&lt;/td>
&lt;td style="text-align: left">3 ms&lt;/td>
&lt;td style="text-align: left">6 ms&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">82,490&lt;/td>
&lt;td style="text-align: left">1 ms&lt;/td>
&lt;td style="text-align: left">2 ms&lt;/td>
&lt;td style="text-align: left">4 ms&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">2KB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">65,000&lt;/td>
&lt;td style="text-align: left">1 ms&lt;/td>
&lt;td style="text-align: left">4 ms&lt;/td>
&lt;td style="text-align: left">9 ms&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">72,000&lt;/td>
&lt;td style="text-align: left">1 ms&lt;/td>
&lt;td style="text-align: left">2 ms&lt;/td>
&lt;td style="text-align: left">8 ms&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">4KB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">56,400&lt;/td>
&lt;td style="text-align: left">2 ms&lt;/td>
&lt;td style="text-align: left">5 ms&lt;/td>
&lt;td style="text-align: left">10 ms&lt;/td>
&lt;td style="text-align: left">380%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">52,700&lt;/td>
&lt;td style="text-align: left">2 ms&lt;/td>
&lt;td style="text-align: left">4 ms&lt;/td>
&lt;td style="text-align: left">10 ms&lt;/td>
&lt;td style="text-align: left">380%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">32KB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">27,400&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">19,500&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;td style="text-align: left">/&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">1MB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">986&lt;/td>
&lt;td style="text-align: left">53 ms&lt;/td>
&lt;td style="text-align: left">56 ms&lt;/td>
&lt;td style="text-align: left">59 ms&lt;/td>
&lt;td style="text-align: left">260%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">942&lt;/td>
&lt;td style="text-align: left">55 ms&lt;/td>
&lt;td style="text-align: left">59 ms&lt;/td>
&lt;td style="text-align: left">62 ms&lt;/td>
&lt;td style="text-align: left">290%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">10MB&lt;/td>
&lt;td style="text-align: left">Non-serialization&lt;/td>
&lt;td style="text-align: left">82&lt;/td>
&lt;td style="text-align: left">630 ms&lt;/td>
&lt;td style="text-align: left">640 ms&lt;/td>
&lt;td style="text-align: left">645 ms&lt;/td>
&lt;td style="text-align: left">240%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align: left">&lt;/td>
&lt;td style="text-align: left">FastWrite/FastRead&lt;/td>
&lt;td style="text-align: left">82&lt;/td>
&lt;td style="text-align: left">630 ms&lt;/td>
&lt;td style="text-align: left">640 ms&lt;/td>
&lt;td style="text-align: left">640 ms&lt;/td>
&lt;td style="text-align: left">270&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Summary of the test results:&lt;/p>
&lt;ul>
&lt;li>In small data package scenario, performance of non-serialization is poorer - about 85% of FastWrite/FastRead&amp;rsquo;s performance.&lt;/li>
&lt;li>In large data package scenario, the performance of non-serialization is better. When processing packages larger than 4K, the performance of non-serialization is 7%-40% better compared with &amp;ldquo;FastWrite/FastRead&amp;rdquo;.&lt;/li>
&lt;/ul>
&lt;h2 id="postscript">Postscript&lt;/h2>
&lt;p>Hope the above sharing can be helpful to the community. At the same time, we are trying to share memory-based IPC, io_uring, TCP zero copy, RDMA, etc., to better improve Kitex performance. And we will also focus on improving the communication scenarios of the same device and container. Welcome to join us and contribute to Go ecology together!&lt;/p>
&lt;h2 id="reference">Reference&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/alecthomas/go_serialization_benchmarks">https://github.com/alecthomas/go_serialization_benchmarks&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://capnproto.org/">https://capnproto.org/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top/compiler-reference/intrinsics/intrinsics-for-intel-advanced-vector-extensions-2/intrinsics-for-shuffle-operations-1/mm256-shuffle-epi8.html">Intel C++ Compiler Classic Developer Guide and Reference&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.4</title><link>https://www.cloudwego.io/blog/2021/08/26/kitex-release-v0.0.4/</link><pubDate>Thu, 26 Aug 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/08/26/kitex-release-v0.0.4/</guid><description>
&lt;h2 id="improvement">Improvement:&lt;/h2>
&lt;ul>
&lt;li>Make transMetaHandler executed before customized boundHandlers to ensure the customized boundHandlers could get metainfo.&lt;/li>
&lt;li>TransError uses internal error typeID if exist.&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix:&lt;/h2>
&lt;ul>
&lt;li>Not reset stats level when clear RPCInfo in netpollmux to fix metric missing bug when use netpollmux.&lt;/li>
&lt;li>Remove stale addresses in long pool.&lt;/li>
&lt;li>Add an EOF condition to eliminate a redundant warning.&lt;/li>
&lt;li>Modify error types check of service circuit breaker to fix the bug that fuse cannot be triggered.&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool:&lt;/h2>
&lt;ul>
&lt;li>Adjust protobuf generated code of unary to support both Kitex Protobuf and gRPC.&lt;/li>
&lt;li>Upgrade version of thriftgo to fix golint style.&lt;/li>
&lt;li>Fix typo in thrift generated code.&lt;/li>
&lt;li>Fix a bug that streaming generated code missing transport option.&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs:&lt;/h2>
&lt;ul>
&lt;li>Add Golang setup section and Golang version requirement&lt;/li>
&lt;li>Some docs are updated.&lt;/li>
&lt;li>Add some English documents.&lt;/li>
&lt;/ul>
&lt;h2 id="dependency-change">Dependency Change:&lt;/h2>
&lt;ul>
&lt;li>Thriftgo: v0.0.2-0.20210726073420-0145861fcd04 -&amp;gt; v0.1.2&lt;/li>
&lt;li>Netpoll: v0.0.2 -&amp;gt; v0.0.3&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.3</title><link>https://www.cloudwego.io/blog/2021/08/01/kitex-release-v0.0.3/</link><pubDate>Sun, 01 Aug 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/08/01/kitex-release-v0.0.3/</guid><description>
&lt;h2 id="bugfix">Bugfix:&lt;/h2>
&lt;ul>
&lt;li>Prevent connection pool from being overridden.&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.2</title><link>https://www.cloudwego.io/blog/2021/07/30/kitex-release-v0.0.2/</link><pubDate>Fri, 30 Jul 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/07/30/kitex-release-v0.0.2/</guid><description>
&lt;h2 id="improvement">Improvement:&lt;/h2>
&lt;ul>
&lt;li>Kitex now disables all stats to improve performance when no tracer is provided.&lt;/li>
&lt;li>The Kitex client now will reuse connections by default.&lt;/li>
&lt;/ul>
&lt;h2 id="bugfix">Bugfix:&lt;/h2>
&lt;ul>
&lt;li>A nil-pointer bug in lbcache has been fixed.&lt;/li>
&lt;li>A data-race issue in the retry(backup request) is fixed.&lt;/li>
&lt;/ul>
&lt;h2 id="tool">Tool:&lt;/h2>
&lt;ul>
&lt;li>The kitex tool no longer generates a default config file.&lt;/li>
&lt;li>The kitex tool now uses the latest API of thriftgo which fixes several bad corner cases in code generation.&lt;/li>
&lt;li>The kitex tool now checks the existence of the go command instead of assuming it. Thanks to @anqiansong&lt;/li>
&lt;/ul>
&lt;h2 id="docs">Docs:&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>We have updated some documentations in this version.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Several lint issues and typos are fixed thanks to @rleungx @Huangxuny1 @JeffreyBool.&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>Blog: Kitex Release v0.0.1</title><link>https://www.cloudwego.io/blog/2021/07/12/kitex-release-v0.0.1/</link><pubDate>Mon, 12 Jul 2021 00:00:00 +0000</pubDate><guid>https://www.cloudwego.io/blog/2021/07/12/kitex-release-v0.0.1/</guid><description>
&lt;p>Kitex project initialization.&lt;/p></description></item></channel></rss>